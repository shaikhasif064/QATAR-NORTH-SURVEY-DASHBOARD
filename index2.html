<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Maintenance Command Center ‚Äì Traffic, ITS & Structures</title>
  <meta name="viewport"content="width=device-width,initial-scale=1"/>

  <!-- Leaflet (for Map View) -->
  <link rel="stylesheet"href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root {
      --bg-main: #050816;
      --bg-elevated: rgba(15, 23, 42, 0.85);
      --bg-elevated-soft: rgba(15, 23, 42, 0.65);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-traffic: #f97316;
      --accent-its: #0ea5e9;
      --accent-structures: #a855f7;
      --text-main: #f9fafb;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148,163,184,0.42);
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.65);
      --radius-xl: 18px;
      --radius-xxl: 26px;
      --blur-level: 18px;
      --transition-fast: 180ms ease-out;
    }

    body.theme-light {
      --bg-main: #f3f4f6;
      --bg-elevated: rgba(255, 255, 255, 0.92);
      --bg-elevated-soft: rgba(255, 255, 255, 0.86);
      --accent: #16a34a;
      --accent-soft: rgba(22, 163, 74, 0.12);
      --text-main: #020617;
      --text-soft: #6b7280;
      --border-subtle: rgba(148,163,184,0.35);
      --shadow-soft: 0 14px 30px rgba(15,23,42,0.18);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1d283a 0, #020617 48%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background 260ms ease-out, color 140ms ease-out;
    }

    .app-shell {
      display: flex;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: linear-gradient(160deg, rgba(15,23,42,0.98), rgba(15,23,42,0.86));
      border-right: 1px solid var(--border-subtle);
      backdrop-filter: blur(var(--blur-level));
      box-shadow: var(--shadow-soft);
      padding: 18px 16px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      z-index: 20;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(148,163,184,0.45);
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 20%, #4ade80, #22c55e 40%, #0f766e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ecfdf5;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 12px 24px rgba(34,197,94,0.5);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .brand-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .brand-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .sidebar-section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      margin: 6px 2px 4px;
    }

    .nav-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      width: 100%;
    }

    .nav-link {
      width: 100%;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text-soft);
      text-decoration: none;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform 120ms ease-out, border var(--transition-fast), box-shadow var(--transition-fast);
    }

    .nav-link span.icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: rgba(15,23,42,0.7);
    }

    .nav-link.active {
      color: var(--accent);
      background: radial-gradient(circle at 0 0, var(--accent-soft), transparent 60%);
      border-color: rgba(34,197,94,0.55);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.3), 0 10px 30px rgba(22,163,74,0.5);
      transform: translateY(-1px);
    }

    .nav-link:hover:not(.active) {
      background: rgba(15,23,42,0.9);
      border-color: rgba(148,163,184,0.55);
      transform: translateY(-1px);
    }

    .nav-group {
      margin-top: 2px;
      padding-top: 4px;
      border-top: 1px dashed rgba(75,85,99,0.65);
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid rgba(148,163,184,0.4);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 10px;
      align-items: center;
    }

    .legend-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .legend-color.traffic {background: var(--accent-traffic);}
    .legend-color.its {background: var(--accent-its);}
    .legend-color.structures {background: var(--accent-structures);}

    /* Main area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      background:
        radial-gradient(circle at top left, rgba(59,130,246,0.22), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.18), transparent 60%);
      position: relative;
      overflow: hidden;
    }

    /* Header */
    .main-header {
      position: sticky;
      top: 0;
      z-index: 15;
      backdrop-filter: blur(22px);
      background: linear-gradient(90deg, rgba(15,23,42,0.94), rgba(15,23,42,0.85), rgba(15,23,42,0.9));
      border-bottom: 1px solid rgba(148,163,184,0.55);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .header-title-block {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .header-title {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .header-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .header-badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .header-badge {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
    }

    .header-badge.accent {
      border-color: rgba(34,197,94,0.9);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .header-badge.traffic {border-color: var(--accent-traffic); color: var(--accent-traffic);}
    .header-badge.its {border-color: var(--accent-its); color: var(--accent-its);}
    .header-badge.structures {border-color: var(--accent-structures); color: var(--accent-structures);}

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .search-box {
      position: relative;
      flex: 1;
      max-width: 260px;
    }

    .search-box input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      padding: 7px 28px 7px 24px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .search-box input::placeholder {
      color: var(--text-soft);
    }

    .search-box::before {
      content: "‚åï";
      position: absolute;
      left: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: var(--text-soft);
    }

    .search-box input:focus {
      border-color: rgba(34,197,94,0.8);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4);
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      cursor: pointer;
    }

    .theme-toggle input {
      display: none;
    }

    .toggle-pill {
      width: 34px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: radial-gradient(circle at 0 50%, #38bdf8, #0f172a);
      position: relative;
      transition: background var(--transition-fast), border var(--transition-fast);
    }

    .toggle-thumb {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.4);
      transition: transform var(--transition-fast);
    }

    body.theme-light .toggle-pill {
      background: radial-gradient(circle at 100% 50%, #fbbf24, #fed7aa);
      border-color: rgba(234,179,8,0.7);
    }

    body.theme-light .toggle-thumb {
      transform: translateX(14px);
    }

    .user-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 11px;
      cursor: default;
    }

    .user-avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ecfdf5;
      font-size: 11px;
      font-weight: 600;
    }

    .user-meta {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .user-name {
      font-size: 11px;
    }

    .user-role {
      font-size: 10px;
      color: var(--text-soft);
    }

    /* Main content area */
    .main-content {
      padding: 14px 18px 20px;
      overflow-y: auto;
      height: calc(100vh - 56px);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .view {
      display: none;
      animation: fadeIn 260ms ease-out;
    }
    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(4px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .grid {
      display: grid;
      gap: 14px;
    }
    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    @media (max-width: 1100px) {
      .grid-3 {grid-template-columns: repeat(2,minmax(0,1fr));}
    }
    @media (max-width: 768px) {
      .grid-3, .grid-2 {grid-template-columns: minmax(0,1fr);}
    }

    .card {
      background: var(--bg-elevated);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 12px 14px;
      backdrop-filter: blur(var(--blur-level));
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-soft);
    }

    .pill.accent {
      border-color: rgba(34,197,94,0.9);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .pill.traffic {
      border-color: var(--accent-traffic);
      color: var(--accent-traffic);
    }
    .pill.its {
      border-color: var(--accent-its);
      color: var(--accent-its);
    }
    .pill.structures {
      border-color: var(--accent-structures);
      color: var(--accent-structures);
    }

    /* KPI cards */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 1150px) {
      .kpi-row {grid-template-columns: repeat(2,minmax(0,1fr));}
    }
    @media (max-width: 720px) {
      .kpi-row {grid-template-columns: minmax(0,1fr);}
    }

    .kpi-card {
      position: relative;
      background: var(--bg-elevated);
      border-radius: var(--radius-xxl);
      padding: 11px 13px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 5px;
      overflow: hidden;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .kpi-main {
      display: flex;
      align-items: baseline;
      gap: 7px;
    }

    .kpi-value {
      font-size: 22px;
      font-weight: 700;
    }

    .kpi-tag {
      font-size: 10px;
      text-transform: uppercase;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.65);
      color: var(--text-soft);
    }

    .kpi-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--text-soft);
    }

    .kpi-progress {
      margin-top: 4px;
      height: 5px;
      border-radius: 999px;
      background: rgba(30,64,175,0.55);
      overflow: hidden;
    }

    .kpi-progress-bar {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      width: 0;
      transition: width 320ms ease-out;
    }

    .kpi-badge-corner {
      position: absolute;
      right: -8px;
      top: -16px;
      width: 60px;
      height: 60px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: radial-gradient(circle at 30% 30%, rgba(34,197,94,0.45), transparent 60%);
      opacity: 0.35;
      pointer-events: none;
    }

    /* Tables */
    .table-wrapper {
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      background: var(--bg-elevated-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    thead {
      background: linear-gradient(90deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
    }

    th, td {
      padding: 7px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(31,41,55,0.8);
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      font-weight: 600;
      color: #e5e7eb;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.6);
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.98);
    }

    .status-pill {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid transparent;
    }

    .status-open {
      border-color: rgba(248, 250, 252, 0.45);
      color: #facc15;
      background: rgba(234, 179, 8, 0.12);
    }

    .status-in-progress {
      border-color: rgba(56, 189, 248, 0.7);
      color: #0ea5e9;
      background: rgba(56, 189, 248, 0.12);
    }

    .status-completed {
      border-color: rgba(34, 197, 94, 0.7);
      color: #22c55e;
      background: rgba(34, 197, 94, 0.12);
    }

    .priority-high {
      color: #f97316;
    }
    .priority-critical {
      color: #ef4444;
    }
    .priority-normal {
      color: var(--text-soft);
    }

    .table-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .btn-chip {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      transition: background var(--transition-fast), transform 120ms ease-out, box-shadow var(--transition-fast);
    }

    .btn-chip:hover {
      background: rgba(34,197,94,0.12);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.45);
      transform: translateY(-1px);
    }

    .btn-chip.ghost {
      background: transparent;
    }

    .btn-chip.primary {
      border-color: rgba(34,197,94,0.85);
      background: linear-gradient(90deg, #22c55e, #4ade80);
      color: #022c22;
      font-weight: 500;
    }

    .btn-chip.primary:hover {
      box-shadow: 0 12px 32px rgba(22,163,74,0.75);
    }

    /* Filters bar */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .filter-group label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .filter-group select,
    .filter-group input[type="date"] {
      min-width: 140px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      font-size: 11px;
      padding: 4px 9px;
      outline: none;
    }

    .tabs {
      display: inline-flex;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 2px;
    }

    .tab-button {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: none;
      background: transparent;
      color: var(--text-soft);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .tab-button.active {
      background: rgba(15,23,42,0.9);
      color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.7);
    }

    /* Teams / planning */
    .team-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      display: inline-flex;
      gap: 5px;
      align-items: center;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .badge-dot.day {background: #38bdf8;}
    .badge-dot.night {background: #f97316;}

    .team-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .team-list strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    /* Map */
    #maintenanceMap {
      width: 100%;
      height: 340px;
      border-radius: var(--radius-xl);
      overflow: hidden;
      border: 1px solid var(--border-subtle);
    }

    /* Responsive: collapse sidebar */
    .sidebar-toggle-btn {
      display: none;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 12px;
      padding: 4px 8px;
      cursor: pointer;
    }

    @media (max-width: 940px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        transform: translateX(0);
        transition: transform 200ms ease-out;
      }
      .sidebar.collapsed {
        transform: translateX(-100%);
      }
      .main {
        margin-left: 0;
      }
      .sidebar-toggle-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
    }

  </style>
</head>
<body class="theme-dark">
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="brand-logo">M</div>
        <div class="brand-text">
          <div class="brand-title">Maintenance Command Center</div>
          <div class="brand-subtitle">Traffic ¬∑ ITS ¬∑ Structures</div>
        </div>
      </div>

      <div>
        <div class="sidebar-section-label">Navigation</div>
        <ul class="nav-list">
          <li class="nav-item">
            <button class="nav-link active" data-view="dashboard">
              <span class="icon">üìä</span>
              <span>Dashboard</span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-view="workorders">
              <span class="icon">üßæ</span>
              <span>Work Orders (CM / PPM / Patrolling)</span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-view="assets">
              <span class="icon">üìç</span>
              <span>Asset Registry (Traffic ¬∑ ITS ¬∑ Structures)</span>
            </button>
          </li>
        </ul>

        <div class="nav-group">
          <div class="sidebar-section-label">Operations</div>
          <ul class="nav-list">
            <li class="nav-item">
              <button class="nav-link" data-view="teams">
                <span class="icon">üë∑</span>
                <span>Teams & Shifts</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-view="planning">
                <span class="icon">üìÖ</span>
                <span>Planning & Calendar</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-view="map">
                <span class="icon">üó∫Ô∏è</span>
                <span>Live Map ‚Äì Sites & Routes</span>
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-view="reports">
                <span class="icon">üìë</span>
                <span>Reports & Exports</span>
              </button>
            </li>
          </ul>
        </div>

        <div class="nav-group">
          <div class="sidebar-section-label">Configuration</div>
          <ul class="nav-list">
            <li class="nav-item">
              <button class="nav-link" data-view="admin">
                <span class="icon">‚öôÔ∏è</span>
                <span>Admin & System Setup</span>
              </button>
            </li>
          </ul>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="legend">
          <span class="legend-badge">
            <span class="legend-color traffic"></span> Traffic
          </span>
          <span class="legend-badge">
            <span class="legend-color its"></span> ITS
          </span>
          <span class="legend-badge">
            <span class="legend-color structures"></span> Structures
          </span>
        </div>
        <div>All times local ¬∑ SLA clock visible in Work Orders view.</div>
      </div>
    </aside>

    <!-- MAIN AREA -->
    <div class="main">
      <!-- HEADER -->
      <header class="main-header">
        <div class="header-left">
          <button class="sidebar-toggle-btn" id="sidebarToggle">‚ò∞ Menu</button>
          <div class="header-title-block">
            <div class="header-title">Traffic, ITS & Structures ‚Äì Maintenance Command Center</div>
            <div class="header-subtitle">
              CM ¬∑ PPM ¬∑ Patrolling ‚Äì Real-time status, planning & progress for field teams and management
            </div>
            <div class="header-badge-row">
              <span class="header-badge accent">Live Operational View</span>
              <span class="header-badge traffic">Traffic Junctions</span>
              <span class="header-badge its">ITS Systems</span>
              <span class="header-badge structures">Structures & Pedestrian Facilities</span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <div class="search-box">
            <input id="globalSearch" type="text" placeholder="Quick search ‚Äì WO ID, Asset ID, Location‚Ä¶" />
          </div>

          <label class="theme-toggle">
            <div>Theme</div>
            <input type="checkbox" id="themeToggle" />
            <div class="toggle-pill">
              <div class="toggle-thumb"></div>
            </div>
          </label>

          <div class="user-pill">
            <div class="user-avatar">AS</div>
            <div class="user-meta">
              <div class="user-name">Maintenance Lead</div>
              <div class="user-role">CM / PPM / Patrolling</div>
            </div>
          </div>
        </div>
      </header>

      <!-- CONTENT -->
      <main class="main-content">
        <!-- DASHBOARD VIEW -->
        <section class="view active" id="view-dashboard">
          <div class="kpi-row">
            <div class="kpi-card">
              <div class="kpi-label">Open Corrective Work Orders (CM)</div>
              <div class="kpi-main">
                <div class="kpi-value" id="kpiOpenCM">0</div>
                <div class="kpi-tag">Network-wide</div>
              </div>
              <div class="kpi-meta">
                <span id="kpiOpenCMText">High priority breakdowns</span>
                <span id="kpiOpenCMSLA">SLA ‚â• 30 min reach</span>
              </div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiOpenCMBar"></div>
              </div>
              <div class="kpi-badge-corner"></div>
            </div>

            <div class="kpi-card">
              <div class="kpi-label">Planned Preventive Tasks (PPM)</div>
              <div class="kpi-main">
                <div class="kpi-value" id="kpiPPMToday">0</div>
                <div class="kpi-tag">Scheduled today</div>
              </div>
              <div class="kpi-meta">
                <span id="kpiPPMTodayText">Night shift ‚Äì Traffic & ITS</span>
                <span id="kpiPPMCompletion">0% completed</span>
              </div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiPPMBar"></div>
              </div>
              <div class="kpi-badge-corner"></div>
            </div>

            <div class="kpi-card">
              <div class="kpi-label">Patrolling Routes</div>
              <div class="kpi-main">
                <div class="kpi-value" id="kpiPatrollingActive">0</div>
                <div class="kpi-tag">Active this shift</div>
              </div>
              <div class="kpi-meta">
                <span>Coverage of high-risk corridors</span>
                <span id="kpiPatrollingCompletion">0% completed</span>
              </div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiPatrollingBar"></div>
              </div>
              <div class="kpi-badge-corner"></div>
            </div>

            <div class="kpi-card">
              <div class="kpi-label">Overdue Work Orders</div>
              <div class="kpi-main">
                <div class="kpi-value" id="kpiOverdue">0</div>
                <div class="kpi-tag">Past SLA</div>
              </div>
              <div class="kpi-meta">
                <span id="kpiOverdueText">Focus these first</span>
                <span id="kpiOverduePercent">0% of total</span>
              </div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiOverdueBar"></div>
              </div>
              <div class="kpi-badge-corner"></div>
            </div>
          </div>

          <div class="grid grid-3">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">System Health ‚Äì Traffic</div>
                  <div class="card-subtitle">Controllers, signals, loops, SPS, EVPS, UPS</div>
                </div>
                <span class="pill traffic">Traffic</span>
              </div>
              <ul class="team-list">
                <li><strong id="trafficTotal">0</strong> junctions under O&M</li>
                <li><strong id="trafficCMOpen">0</strong> open CM, <strong id="trafficPPMOpen">0</strong> pending PPM</li>
                <li><strong id="trafficUptime">0%</strong> uptime (last 24h snapshot)</li>
              </ul>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">System Health ‚Äì ITS</div>
                  <div class="card-subtitle">CCTV, AID, DMS, LCS, RWIS, AQM, WIM</div>
                </div>
                <span class="pill its">ITS</span>
              </div>
              <ul class="team-list">
                <li><strong id="itsTotal">0</strong> ITS assets monitored</li>
                <li><strong id="itsCMOpen">0</strong> open CM, <strong id="itsPPMOpen">0</strong> pending PPM</li>
                <li><strong id="itsUptime">0%</strong> uptime (last 24h snapshot)</li>
              </ul>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">System Health ‚Äì Structures</div>
                  <div class="card-subtitle">Pedestrian bridges & underpasses, stairs, lifts, escalators</div>
                </div>
                <span class="pill structures">Structures</span>
              </div>
              <ul class="team-list">
                <li><strong id="structuresTotal">0</strong> structures under O&M</li>
                <li><strong id="structuresCMOpen">0</strong> open CM, <strong id="structuresPPMOpen">0</strong> pending PPM</li>
                <li><strong id="structuresUptime">0%</strong> availability ‚Äì lifts/escalators</li>
              </ul>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">High Priority & SLA-Critical Work Orders</div>
                <div class="card-subtitle">Top issues for immediate attention across Traffic, ITS & Structures</div>
              </div>
              <button class="btn-chip primary" data-view-jump="workorders">
                Go to Work Orders
              </button>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>WO ID</th>
                    <th>System</th>
                    <th>Asset</th>
                    <th>Location</th>
                    <th>Type</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>SLA Left</th>
                    <th>Team</th>
                  </tr>
                </thead>
                <tbody id="dashboardCriticalTableBody">
                  <!-- filled by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- WORK ORDERS VIEW -->
        <section class="view" id="view-workorders">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Work Orders ‚Äì Corrective, Preventive & Patrolling</div>
                <div class="card-subtitle">
                  Filter by system, region, priority, type, and SLA. Use this screen during live operations.
                </div>
              </div>
              <div style="display:flex;gap:6px;align-items:center;">
                <button class="btn-chip" id="btnNewWO">+ New Work Order</button>
                <button class="btn-chip ghost">Export (CSV / XLSX / PDF)</button>
              </div>
            </div>

            <div class="filter-bar">
              <div class="filter-group">
                <label for="woFilterSystem">System</label>
                <select id="woFilterSystem">
                  <option value="">All</option>
                  <option value="Traffic">Traffic</option>
                  <option value="ITS">ITS</option>
                  <option value="Structures">Structures</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="woFilterType">Type</label>
                <select id="woFilterType">
                  <option value="">All</option>
                  <option value="CM">CM</option>
                  <option value="PPM">PPM</option>
                  <option value="Patrolling">Patrolling</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="woFilterStatus">Status</label>
                <select id="woFilterStatus">
                  <option value="">All</option>
                  <option value="Open">Open</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="woFilterPriority">Priority</label>
                <select id="woFilterPriority">
                  <option value="">All</option>
                  <option value="Critical">Critical</option>
                  <option value="High">High</option>
                  <option value="Normal">Normal</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="woFilterDateFrom">From</label>
                <input type="date" id="woFilterDateFrom" />
              </div>
              <div class="filter-group">
                <label for="woFilterDateTo">To</label>
                <input type="date" id="woFilterDateTo" />
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>WO ID</th>
                    <th>System</th>
                    <th>Asset</th>
                    <th>Location</th>
                    <th>Municipality</th>
                    <th>Type</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Planned Date</th>
                    <th>SLA Left</th>
                    <th>Team</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="workOrdersTableBody">
                  <!-- JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ASSETS VIEW -->
        <section class="view" id="view-assets">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Asset Registry ‚Äì Traffic, ITS & Structures</div>
                <div class="card-subtitle">
                  Master list of assets for CM, PPM & Patrolling. Use this as reference in the field.
                </div>
              </div>
              <div class="tabs">
                <button class="tab-button active" data-asset-tab="Traffic">Traffic</button>
                <button class="tab-button" data-asset-tab="ITS">ITS</button>
                <button class="tab-button" data-asset-tab="Structures">Structures</button>
              </div>
            </div>

            <div class="filter-bar">
              <div class="filter-group">
                <label for="assetFilterRegion">Region</label>
                <select id="assetFilterRegion">
                  <option value="">All</option>
                  <option value="Doha">Doha</option>
                  <option value="North">North</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="assetFilterStatus">Status</label>
                <select id="assetFilterStatus">
                  <option value="">All</option>
                  <option value="In Operation">In Operation</option>
                  <option value="Under Snag">Under Snag</option>
                  <option value="Out of Service">Out of Service</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="assetFilterType">Asset Type</label>
                <select id="assetFilterType">
                  <option value="">All</option>
                </select>
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Asset ID</th>
                    <th>Name / Description</th>
                    <th>System</th>
                    <th>Type</th>
                    <th>Region</th>
                    <th>Zone</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>PPM Frequency</th>
                  </tr>
                </thead>
                <tbody id="assetsTableBody">
                  <!-- JS -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- TEAMS & SHIFTS -->
        <section class="view" id="view-teams">
          <div class="grid grid-3">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">CM Teams ‚Äì Traffic & ITS</div>
                  <div class="card-subtitle">24/7 coverage ‚Äì breakdowns & incidents</div>
                </div>
                <span class="pill">CM</span>
              </div>
              <ul class="team-list" id="cmTeamsList"></ul>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">PPM Teams ‚Äì Night Shift</div>
                  <div class="card-subtitle">Planned maintenance (Traffic & ITS)</div>
                </div>
                <span class="pill">PPM</span>
              </div>
              <ul class="team-list" id="ppmTeamsList"></ul>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Patrolling Teams</div>
                  <div class="card-subtitle">Tunnel / corridor / structure patrols</div>
                </div>
                <span class="pill">Patrolling</span>
              </div>
              <ul class="team-list" id="patrollingTeamsList"></ul>
            </div>
          </div>
        </section>

        <!-- PLANNING & CALENDAR -->
        <section class="view" id="view-planning">
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Upcoming PPM ‚Äì Next 7 Days</div>
                  <div class="card-subtitle">Night shift activities grouped by system</div>
                </div>
                <span class="pill">PPM Plan</span>
              </div>
              <ul class="team-list" id="ppmPlanList"></ul>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Upcoming CM Hotspots</div>
                  <div class="card-subtitle">Junctions / ITS sites with repeated CM in last week</div>
                </div>
                <span class="pill accent">CM Focus</span>
              </div>
              <ul class="team-list" id="cmHotspotList"></ul>
            </div>
          </div>
        </section>

        <!-- MAP VIEW -->
        <section class="view" id="view-map">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Live Map ‚Äì Traffic, ITS & Structures</div>
                <div class="card-subtitle">
                  View asset clusters, open work orders and patrolling routes. Map is centered on Qatar.
                </div>
              </div>
              <div style="display:flex;gap:6px;align-items:center;">
                <span class="team-tag">
                  <span class="badge-dot day"></span>Day CM
                </span>
                <span class="team-tag">
                  <span class="badge-dot night"></span>Night PPM
                </span>
              </div>
            </div>
            <div id="maintenanceMap"></div>
          </div>
        </section>

        <!-- REPORTS -->
        <section class="view" id="view-reports">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Reports & Exports</div>
                <div class="card-subtitle">
                  High-level exports for management ‚Äì CM log, PPM completion, Structures availability, SLA compliance.
                </div>
              </div>
            </div>
            <ul class="team-list">
              <li><strong>CM Daily Report</strong> ‚Äì list of breakdown WOs with root cause, response time, fix time.</li>
              <li><strong>PPM Completion Report</strong> ‚Äì system-wise monthly PPM completion with pending list.</li>
              <li><strong>Structures Availability Report</strong> ‚Äì lifts/escalators uptime by structure.</li>
              <li><strong>SLA Compliance</strong> ‚Äì % of WOs attended & closed within SLA time.</li>
            </ul>
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn-chip primary">Export CM Daily (CSV)</button>
              <button class="btn-chip primary">Export PPM Monthly (XLSX)</button>
              <button class="btn-chip primary">Export SLA Summary (PDF)</button>
              <button class="btn-chip ghost">Configure Report Templates</button>
            </div>
          </div>
        </section>

        <!-- ADMIN -->
        <section class="view" id="view-admin">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Admin & System Setup</div>
                <div class="card-subtitle">
                  Use this section to configure teams, PPM frequencies, priority rules and SLA thresholds.
                </div>
              </div>
            </div>
            <ul class="team-list">
              <li><strong>Team Configuration:</strong> define CM / PPM / Patrolling teams, vehicles, zones and shifts.</li>
              <li><strong>PPM Templates:</strong> set PPM frequency per asset type (e.g., monthly, quarterly, semi-annual).</li>
              <li><strong>Priority Rules:</strong> map device types to default priority (e.g., tunnel ventilation = Critical).</li>
              <li><strong>SLA Rules:</strong> define response and rectification time per system and priority.</li>
              <li><strong>Integrations:</strong> link to Maximo, Google Sheets, or other data sources (future step).</li>
            </ul>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // --------------------------
    // Demo data (replace later with live data from your sheets / Maximo / APIs)
    // --------------------------
    const workOrders = [
      {
        id: "WO-TRF-0001",
        system: "Traffic",
        assetId: "TJ-0101",
        assetName: "Signal Junction 101 ‚Äì Corniche",
        location: "Corniche / Grand Hamad",
        municipality: "Doha",
        type: "CM",
        priority: "Critical",
        status: "In Progress",
        plannedDate: "2025-11-29",
        slaLeft: "00:25",
        slaCritical: true,
        team: "CM-Traffic-Shift-A",
        region: "Doha"
      },
      {
        id: "WO-ITS-0002",
        system: "ITS",
        assetId: "CCTV-DOH-017",
        assetName: "Tunnel CCTV P060-CAM-17",
        location: "P060 ‚Äì Tunnel Bore 1",
        municipality: "Doha",
        type: "CM",
        priority: "High",
        status: "Open",
        plannedDate: "2025-11-29",
        slaLeft: "00:40",
        slaCritical: false,
        team: "CM-ITS-Shift-A",
        region: "Doha"
      },
      {
        id: "WO-ITS-PPM-001",
        system: "ITS",
        assetId: "DMS-NRT-004",
        assetName: "DMS ‚Äì North Route 4",
        location: "North Road",
        municipality: "North",
        type: "PPM",
        priority: "Normal",
        status: "In Progress",
        plannedDate: "2025-11-29",
        slaLeft: "04:00",
        slaCritical: false,
        team: "PPM-ITS-Night-1",
        region: "North"
      },
      {
        id: "WO-TRF-PPM-010",
        system: "Traffic",
        assetId: "TJ-0420",
        assetName: "Signal Junction 420 ‚Äì Industrial Area",
        location: "Industrial Area",
        municipality: "Doha",
        type: "PPM",
        priority: "Normal",
        status: "Open",
        plannedDate: "2025-11-29",
        slaLeft: "06:00",
        slaCritical: false,
        team: "PPM-Traffic-Night-1",
        region: "Doha"
      },
      {
        id: "WO-STR-0003",
        system: "Structures",
        assetId: "PB-P060-01",
        assetName: "Pedestrian Bridge ‚Äì P060",
        location: "Al Bait Stadium",
        municipality: "North",
        type: "CM",
        priority: "High",
        status: "Open",
        plannedDate: "2025-11-28",
        slaLeft: "Overdue",
        slaCritical: true,
        team: "CM-Structures-Shift-A",
        region: "North"
      },
      {
        id: "WO-PAT-001",
        system: "Traffic",
        assetId: "PAT-ROUTE-01",
        assetName: "Night Patrolling ‚Äì Doha Corniche Corridor",
        location: "Corniche",
        municipality: "Doha",
        type: "Patrolling",
        priority: "Normal",
        status: "In Progress",
        plannedDate: "2025-11-29",
        slaLeft: "01:30",
        slaCritical: false,
        team: "Patrol-Doha-01",
        region: "Doha"
      }
    ];

    const assets = [
      // Traffic examples
      {
        system: "Traffic",
        assetId: "TJ-0101",
        name: "Junction 101 ‚Äì Corniche / Grand Hamad",
        type: "Signalised Junction",
        region: "Doha",
        zone: "Zone 1",
        location: "Corniche",
        status: "In Operation",
        ppmFrequency: "Quarterly"
      },
      {
        system: "Traffic",
        assetId: "TJ-0420",
        name: "Junction 420 ‚Äì Industrial Area",
        type: "Signalised Junction",
        region: "Doha",
        zone: "Zone 3",
        location: "Industrial Area",
        status: "In Operation",
        ppmFrequency: "Quarterly"
      },
      // ITS examples
      {
        system: "ITS",
        assetId: "DMS-NRT-004",
        name: "DMS ‚Äì North Route 4",
        type: "DMS",
        region: "North",
        zone: "Zone N1",
        location: "North Road",
        status: "In Operation",
        ppmFrequency: "Monthly"
      },
      {
        system: "ITS",
        assetId: "CCTV-DOH-017",
        name: "Tunnel CCTV P060-CAM-17",
        type: "CCTV",
        region: "Doha",
        zone: "Zone TUN",
        location: "P060 Tunnel Bore 1",
        status: "In Operation",
        ppmFrequency: "Monthly"
      },
      // Structures examples
      {
        system: "Structures",
        assetId: "PB-P060-01",
        name: "Pedestrian Bridge ‚Äì P060 Al Bait Stadium",
        type: "Pedestrian Bridge",
        region: "North",
        zone: "Zone PB-N1",
        location: "Al Bait Stadium",
        status: "In Operation",
        ppmFrequency: "Semi-Annual"
      },
      {
        system: "Structures",
        assetId: "UP-P017-01",
        name: "Underpass ‚Äì P017-C2",
        type: "Underpass",
        region: "Doha",
        zone: "Zone UP-1",
        location: "Industrial Area",
        status: "Under Snag",
        ppmFrequency: "Annual"
      }
    ];

    const teams = {
      cm: [
        {
          name: "CM-Traffic-Shift-A",
          description: "Day CM for Traffic junctions (Doha)",
          shift: "Day",
          coverage: "Doha Region",
          vehicle: "2√ó Pick-ups + 1√ó TMA"
        },
        {
          name: "CM-ITS-Shift-A",
          description: "Day CM for ITS (Doha + North)",
          shift: "Day",
          coverage: "Doha & North",
          vehicle: "2√ó Pick-ups"
        },
        {
          name: "CM-Structures-Shift-A",
          description: "Day CM for structures (bridges & underpasses)",
          shift: "Day",
          coverage: "Doha & North",
          vehicle: "1√ó Pick-up + 1√ó Boom lift"
        }
      ],
      ppm: [
        {
          name: "PPM-Traffic-Night-1",
          description: "Night PPM for Traffic (Doha junctions)",
          shift: "Night",
          coverage: "Doha Region",
          vehicle: "2√ó Pick-ups"
        },
        {
          name: "PPM-ITS-Night-1",
          description: "Night PPM for ITS (Doha & North)",
          shift: "Night",
          coverage: "Tunnels + Expressways",
          vehicle: "2√ó Pick-ups"
        }
      ],
      patrolling: [
        {
          name: "Patrol-Doha-01",
          description: "Night patrolling for Doha corridors + tunnels",
          shift: "Night",
          coverage: "Corniche, C-Ring, Tunnels",
          vehicle: "1√ó Pick-up"
        },
        {
          name: "Patrol-North-01",
          description: "North corridor patrolling",
          shift: "Night",
          coverage: "North Road, Al Shamal",
          vehicle: "1√ó Pick-up"
        }
      ]
    };

    // Simple PPM planning demo
    const ppmPlan = [
      {
        date: "2025-11-29",
        system: "Traffic",
        title: "PPM ‚Äì 10 Doha junctions (Area 1 & 2)",
        team: "PPM-Traffic-Night-1"
      },
      {
        date: "2025-11-29",
        system: "ITS",
        title: "PPM ‚Äì DMS & CCTV in Lusail Expressway",
        team: "PPM-ITS-Night-1"
      },
      {
        date: "2025-11-30",
        system: "Structures",
        title: "PPM ‚Äì P060 Pedestrian Bridges",
        team: "CM-Structures-Shift-A"
      }
    ];

    const cmHotspots = [
      {
        site: "Junction 101 ‚Äì Corniche",
        count: 3,
        system: "Traffic",
        remark: "Recurrent controller communication fault"
      },
      {
        site: "P060 Tunnel CCTV",
        count: 2,
        system: "ITS",
        remark: "CCTV video loss during peak hours"
      }
    ];

    // --------------------------
    // Utility
    // --------------------------
    function $(selector) {
      return document.querySelector(selector);
    }
    function $all(selector) {
      return Array.from(document.querySelectorAll(selector));
    }

    function formatStatusPill(status) {
      const base = "status-pill ";
      if (status === "Open") return base + "status-open";
      if (status === "In Progress") return base + "status-in-progress";
      if (status === "Completed") return base + "status-completed";
      return base;
    }

    function formatPriorityClass(priority) {
      if (priority === "Critical") return "priority-critical";
      if (priority === "High") return "priority-high";
      return "priority-normal";
    }

    // --------------------------
    // Navigation between views
    // --------------------------
    function setActiveView(viewId) {
      $all(".view").forEach(v => v.classList.remove("active"));
      const viewEl = $("#view-" + viewId);
      if (viewEl) viewEl.classList.add("active");

      $all(".nav-link").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.view === viewId);
      });
    }

    $all(".nav-link").forEach(btn => {
      btn.addEventListener("click", () => {
        const view = btn.dataset.view;
        if (!view) return;
        setActiveView(view);
      });
    });

    // Dashboard "Go to Work Orders"
    $all("[data-view-jump='workorders']").forEach(btn => {
      btn.addEventListener("click", () => setActiveView("workorders"));
    });

    // Sidebar toggle (mobile)
    const sidebar = $("#sidebar");
    const sidebarToggleBtn = $("#sidebarToggle");
    if (sidebarToggleBtn) {
      sidebarToggleBtn.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
      });
    }

    // --------------------------
    // Theme handling
    // --------------------------
    const themeToggle = $("#themeToggle");

    function applySavedTheme() {
      const saved = localStorage.getItem("maintenanceTheme");
      if (saved === "light") {
        document.body.classList.remove("theme-dark");
        document.body.classList.add("theme-light");
        themeToggle.checked = true;
      } else {
        document.body.classList.remove("theme-light");
        document.body.classList.add("theme-dark");
        themeToggle.checked = false;
      }
    }
    applySavedTheme();

    themeToggle.addEventListener("change", () => {
      const isLight = themeToggle.checked;
      if (isLight) {
        document.body.classList.remove("theme-dark");
        document.body.classList.add("theme-light");
        localStorage.setItem("maintenanceTheme", "light");
      } else {
        document.body.classList.remove("theme-light");
        document.body.classList.add("theme-dark");
        localStorage.setItem("maintenanceTheme", "dark");
      }
    });

    // --------------------------
    // Dashboard metrics
    // --------------------------
    function updateDashboardMetrics() {
      const openCM = workOrders.filter(w => w.type === "CM" && w.status !== "Completed");
      const ppmsToday = workOrders.filter(w => w.type === "PPM" && w.plannedDate === "2025-11-29");
      const patrolActive = workOrders.filter(w => w.type === "Patrolling" && w.status === "In Progress");
      const overdue = workOrders.filter(w => w.slaLeft === "Overdue" || w.slaLeft === "00:00");

      $("#kpiOpenCM").textContent = openCM.length;
      $("#kpiPPMToday").textContent = ppmsToday.length;
      $("#kpiPatrollingActive").textContent = patrolActive.length;
      $("#kpiOverdue").textContent = overdue.length;

      const totalWOs = workOrders.length || 1;
      const ppmCompleted = workOrders.filter(w => w.type === "PPM" && w.status === "Completed").length;
      const ppmTotal = workOrders.filter(w => w.type === "PPM").length || 1;
      const ppmPercent = Math.round((ppmCompleted / ppmTotal) * 100);
      $("#kpiPPMCompletion").textContent = ppmPercent + "% completed";
      $("#kpiPPMBar").style.width = ppmPercent + "%";

      const patrolCompleted = workOrders.filter(w => w.type === "Patrolling" && w.status === "Completed").length;
      const patrolTotal = workOrders.filter(w => w.type === "Patrolling").length || 1;
      const patrolPercent = Math.round((patrolCompleted / patrolTotal) * 100);
      $("#kpiPatrollingCompletion").textContent = patrolPercent + "% completed";
      $("#kpiPatrollingBar").style.width = patrolPercent + "%";

      const overduePercent = Math.round((overdue.length / totalWOs) * 100);
      $("#kpiOverduePercent").textContent = overduePercent + "% of total";
      $("#kpiOverdueBar").style.width = overduePercent + "%";

      const openCMPercent = Math.max(0, 100 - overduePercent);
      $("#kpiOpenCMBar").style.width = openCMPercent + "%";

      // System health quick numbers (can be tuned later)
      const trafficAssets = assets.filter(a => a.system === "Traffic").length;
      const itsAssets = assets.filter(a => a.system === "ITS").length;
      const structuresAssets = assets.filter(a => a.system === "Structures").length;

      $("#trafficTotal").textContent = trafficAssets;
      $("#itsTotal").textContent = itsAssets;
      $("#structuresTotal").textContent = structuresAssets;

      $("#trafficCMOpen").textContent = openCM.filter(w => w.system === "Traffic").length;
      $("#itsCMOpen").textContent = openCM.filter(w => w.system === "ITS").length;
      $("#structuresCMOpen").textContent = openCM.filter(w => w.system === "Structures").length;

      $("#trafficPPMOpen").textContent = workOrders.filter(w => w.system === "Traffic" && w.type === "PPM" && w.status !== "Completed").length;
      $("#itsPPMOpen").textContent = workOrders.filter(w => w.system === "ITS" && w.type === "PPM" && w.status !== "Completed").length;
      $("#structuresPPMOpen").textContent = workOrders.filter(w => w.system === "Structures" && w.type === "PPM" && w.status !== "Completed").length;

      // For now set uptime to fixed snapshots ‚Äì you can later compute from your real data
      $("#trafficUptime").textContent = "99.4%";
      $("#itsUptime").textContent = "99.1%";
      $("#structuresUptime").textContent = "98.8%";

      $("#structuresUptime").textContent = "98.8%";
    }

    function renderDashboardCriticalTable() {
      const tbody = $("#dashboardCriticalTableBody");
      tbody.innerHTML = "";

      const critical = workOrders
        .filter(w => (w.priority === "Critical" || w.slaCritical) && w.status !== "Completed")
        .slice(0, 6);

      critical.forEach(w => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${w.id}</td>
          <td>${w.system}</td>
          <td>${w.assetId}<br/><span style="color:var(--text-soft);font-size:10px;">${w.assetName}</span></td>
          <td>${w.location}</td>
          <td>${w.type}</td>
          <td class="${formatPriorityClass(w.priority)}">${w.priority}</td>
          <td><span class="${formatStatusPill(w.status)}">${w.status}</span></td>
          <td>${w.slaLeft}</td>
          <td>${w.team}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --------------------------
    // Work Orders table
    // --------------------------
    function renderWorkOrdersTable() {
      const tbody = $("#workOrdersTableBody");
      tbody.innerHTML = "";

      const system = $("#woFilterSystem").value;
      const type = $("#woFilterType").value;
      const status = $("#woFilterStatus").value;
      const priority = $("#woFilterPriority").value;
      const dateFrom = $("#woFilterDateFrom").value;
      const dateTo = $("#woFilterDateTo").value;
      const globalSearch = ($("#globalSearch").value || "").toLowerCase();

      let items = [...workOrders];

      items = items.filter(w => {
        if (system && w.system !== system) return false;
        if (type && w.type !== type) return false;
        if (status && w.status !== status) return false;
        if (priority && w.priority !== priority) return false;
        if (dateFrom && w.plannedDate < dateFrom) return false;
        if (dateTo && w.plannedDate > dateTo) return false;

        if (globalSearch) {
          const text = (w.id + " " + w.assetId + " " + w.assetName + " " + w.location + " " + w.municipality + " " + w.team).toLowerCase();
          return text.includes(globalSearch);
        }
        return true;
      });

      items.forEach(w => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${w.id}</td>
          <td>${w.system}</td>
          <td>${w.assetId}<br/><span style="color:var(--text-soft);font-size:10px;">${w.assetName}</span></td>
          <td>${w.location}</td>
          <td>${w.municipality}</td>
          <td>${w.type}</td>
          <td class="${formatPriorityClass(w.priority)}">${w.priority}</td>
          <td><span class="${formatStatusPill(w.status)}">${w.status}</span></td>
          <td>${w.plannedDate}</td>
          <td>${w.slaLeft}</td>
          <td>${w.team}</td>
          <td>
            <div class="table-actions">
              <button class="btn-chip">View</button>
              <button class="btn-chip ghost">Update</button>
              <button class="btn-chip ghost">Close</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    ["woFilterSystem","woFilterType","woFilterStatus","woFilterPriority","woFilterDateFrom","woFilterDateTo"]
      .forEach(id => {
        const el = $("#" + id);
        if (el) el.addEventListener("change", renderWorkOrdersTable);
      });

    // --------------------------
    // Assets table & tabs
    // --------------------------
    let currentAssetTab = "Traffic";

    function renderAssetTypeOptions() {
      const select = $("#assetFilterType");
      if (!select) return;

      const types = Array.from(new Set(
        assets
          .filter(a => a.system === currentAssetTab)
          .map(a => a.type)
      ));

      select.innerHTML = `<option value="">All</option>` +
        types.map(t => `<option value="${t}">${t}</option>`).join("");
    }

    function renderAssetsTable() {
      const tbody = $("#assetsTableBody");
      tbody.innerHTML = "";

      const region = $("#assetFilterRegion").value;
      const status = $("#assetFilterStatus").value;
      const type = $("#assetFilterType").value;
      const globalSearch = ($("#globalSearch").value || "").toLowerCase();

      let items = assets.filter(a => a.system === currentAssetTab);

      items = items.filter(a => {
        if (region && a.region !== region) return false;
        if (status && a.status !== status) return false;
        if (type && a.type !== type) return false;
        if (globalSearch) {
          const text = (a.assetId + " " + a.name + " " + a.location + " " + a.zone).toLowerCase();
          return text.includes(globalSearch);
        }
        return true;
      });

      items.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.assetId}</td>
          <td>${a.name}</td>
          <td>${a.system}</td>
          <td>${a.type}</td>
          <td>${a.region}</td>
          <td>${a.zone}</td>
          <td>${a.location}</td>
          <td>${a.status}</td>
          <td>${a.ppmFrequency}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    $all("[data-asset-tab]").forEach(btn => {
      btn.addEventListener("click", () => {
        currentAssetTab = btn.dataset.assetTab;
        $all("[data-asset-tab]").forEach(b => b.classList.toggle("active", b === btn));
        renderAssetTypeOptions();
        renderAssetsTable();
      });
    });

    ["assetFilterRegion","assetFilterStatus","assetFilterType"].forEach(id => {
      const el = $("#" + id);
      if (el) el.addEventListener("change", renderAssetsTable);
    });

    // --------------------------
    // Teams & planning
    // --------------------------
    function renderTeams() {
      const cmList = $("#cmTeamsList");
      const ppmList = $("#ppmTeamsList");
      const patList = $("#patrollingTeamsList");
      cmList.innerHTML = "";
      ppmList.innerHTML = "";
      patList.innerHTML = "";

      teams.cm.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${t.name}</strong> ‚Äì ${t.description}<br/>
          Shift: <span class="badge-dot ${t.shift === "Night" ? "night" : "day"}"></span> ${t.shift}, Coverage: ${t.coverage}, Vehicles: ${t.vehicle}`;
        cmList.appendChild(li);
      });

      teams.ppm.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${t.name}</strong> ‚Äì ${t.description}<br/>
          Shift: <span class="badge-dot ${t.shift === "Night" ? "night" : "day"}"></span> ${t.shift}, Coverage: ${t.coverage}, Vehicles: ${t.vehicle}`;
        ppmList.appendChild(li);
      });

      teams.patrolling.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${t.name}</strong> ‚Äì ${t.description}<br/>
          Shift: <span class="badge-dot ${t.shift === "Night" ? "night" : "day"}"></span> ${t.shift}, Coverage: ${t.coverage}, Vehicles: ${t.vehicle}`;
        patList.appendChild(li);
      });
    }

    function renderPlanning() {
      const ppmList = $("#ppmPlanList");
      const cmList = $("#cmHotspotList");
      ppmList.innerHTML = "";
      cmList.innerHTML = "";

      ppmPlan.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${p.date}</strong> ‚Äì [${p.system}] ${p.title}<br/>Team: ${p.team}`;
        ppmList.appendChild(li);
      });

      cmHotspots.forEach(h => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${h.site}</strong> ‚Äì ${h.count} CM in last 7 days [${h.system}]<br/>Note: ${h.remark}`;
        cmList.appendChild(li);
      });
    }

    // --------------------------
    // Map (Leaflet)
    // --------------------------
    let map;
    function initMap() {
      const mapContainer = $("#maintenanceMap");
      if (!mapContainer) return;
      // Center on Qatar (roughly)
      map = L.map(mapContainer).setView([25.2854, 51.5310], 10);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18
      }).addTo(map);

      // Add sample markers based on assets
      assets.forEach(a => {
        // Fake coordinates for demo: you will replace with your real Lat / Lon
        let lat = 25.2854;
        let lon = 51.5310;
        if (a.region === "North") {
          lat += 0.8;
          lon -= 0.2;
        } else if (a.location.includes("Industrial")) {
          lat -= 0.3;
          lon -= 0.2;
        }

        const color =
          a.system === "Traffic" ? "orange" :
          a.system === "ITS" ? "deepskyblue" :
          "violet";

        const marker = L.circleMarker([lat, lon], {
          radius: 7,
          color,
          fillColor: color,
          fillOpacity: 0.85
        }).addTo(map);

        marker.bindPopup(`<strong>${a.assetId}</strong><br/>${a.name}<br/>System: ${a.system}<br/>Location: ${a.location}`);
      });

      // Limit pan roughly to Qatar region
      const southWest = L.latLng(24.3, 50.4);
      const northEast = L.latLng(26.3, 52.1);
      const bounds = L.latLngBounds(southWest, northEast);
      map.setMaxBounds(bounds);
      map.on("drag", function() {
        map.panInsideBounds(bounds, { animate: false });
      });
    }

    // --------------------------
    // Global Search
    // --------------------------
    $("#globalSearch").addEventListener("input", () => {
      renderWorkOrdersTable();
      renderAssetsTable();
      renderDashboardCriticalTable();
    });

    // --------------------------
    // Init
    // --------------------------
    function init() {
      updateDashboardMetrics();
      renderDashboardCriticalTable();
      renderWorkOrdersTable();
      renderAssetTypeOptions();
      renderAssetsTable();
      renderTeams();
      renderPlanning();
      initMap();
    }

    document.addEventListener("DOMContentLoaded", init);

    // For "New Work Order" (placeholder for now)
    $("#btnNewWO").addEventListener("click", () => {
      alert("In the real system this will open a detailed New Work Order form (CM / PPM / Patrolling) with asset selection, checklists, attachments, etc.");
    });
  </script>
</body>
</html>