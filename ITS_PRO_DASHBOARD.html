<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ITS Field Ops - Pro Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/dark/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    :root {
      --bg: #0f172a; --card: #1e293b; --border: #334155; --text: #f8fafc;
      --accent: #38bdf8; --green: #22c55e; --red: #ef4444; --orange: #f59e0b;
    }
    body[data-theme="light"] {
      --bg: #f1f5f9; --card: #ffffff; --border: #cbd5e1; --text: #0f172a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', system-ui, sans-serif; }
    body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

    /* Layout Modes */
    #main-container { display: flex; height: 100vh; width: 100vw; transition: all 0.3s ease; }
    .view-pane { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); position: relative; overflow: hidden; }

    /* Split View Specifics */
    body.mode-split #main-container { flex-direction: row; }
    body.mode-split .mobile-preview { max-width: 420px; border-left: 4px solid var(--accent); }

    /* Header & Controls */
    header { padding: 12px 20px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .controls { padding: 10px 20px; background: var(--card); display: flex; gap: 10px; flex-wrap: wrap; border-bottom: 1px solid var(--border); }

    /* Map & Table */
    .map-area { flex: 2; position: relative; min-height: 300px; }
    .table-area { flex: 1; overflow: auto; background: var(--card); border-top: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { position: sticky; top: 0; background: var(--bg); padding: 10px; text-align: left; border-bottom: 2px solid var(--border); }
    td { padding: 8px 10px; border-bottom: 1px solid var(--border); cursor: pointer; }
    tr:hover { background: rgba(56, 189, 248, 0.1); }

    /* UI Elements */
    .btn { padding: 8px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-size: 12px; font-weight: 600; }
    .btn-primary { background: var(--accent); color: #000; border: none; }
    .btn-warn { background: var(--orange); color: #000; }
    input, select { padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }

    /* Auth Overlay */
    .auth-overlay { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; }
    .auth-card { background: var(--card); padding: 30px; border-radius: 12px; width: 350px; border: 1px solid var(--border); }
    .auth-overlay.show { display: flex; }

    /* Mobile Specific Overrides in Split/Mobile Mode */
    .mobile-preview .controls { flex-direction: column; }
    .mobile-preview header { font-size: 14px; }

    /* View Switcher Floating */
    .view-switcher { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; gap: 5px; background: var(--card); padding: 5px; border-radius: 30px; border: 1px solid var(--accent); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .view-switcher button { border: none; background: none; color: var(--text); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 11px; }
    .view-switcher button.active { background: var(--accent); color: #000; }

    .hidden-field { filter: blur(4px); user-select: none; opacity: 0.5; }
  </style>
</head>
<body class="mode-desktop">

  <div id="authOverlay" class="auth-overlay">
    <div class="auth-card">
      <h2 style="margin-bottom:15px">ITS Sign In</h2>
      <form id="authForm">
        <input id="authEmail" type="email" placeholder="Email" required style="width:100%; margin-bottom:10px">
        <input id="authPassword" type="password" placeholder="Password" required style="width:100%; margin-bottom:10px">
        <input id="deviceName" type="text" placeholder="Device Name (Optional)" style="width:100%; margin-bottom:15px">
        <button class="btn btn-primary" type="submit" style="width:100%">Login</button>
        <div id="authMsg" style="margin-top:10px; font-size:12px; color:var(--red)"></div>
      </form>
    </div>
  </div>

  <div id="main-container">
    <!-- Desktop Pane -->
    <div class="view-pane desktop-pane">
      <header>
        <div><strong>ITS FIELD OPS</strong> <span style="font-size:10px; opacity:0.6">DESKTOP</span></div>
        <div id="kpi-summary" style="font-size:12px">Loading...</div>
        <div style="display:flex; gap:10px">
          <button class="btn" onclick="toggleTheme()">Theme</button>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </header>
      <div class="controls">
        <input id="search-d" type="text" placeholder="Search assets..." style="flex:1">
        <select id="filter-d"><option value="__ALL__">All Types</option></select>
        <button class="btn btn-primary" onclick="locateMe()">Locate Me</button>
        <button class="btn btn-warn" id="trackBtn">Start Tracking</button>
        <button class="btn" onclick="exportCSV()">CSV</button>
      </div>
      <div class="map-area"><div id="map-d" style="height:100%"></div></div>
      <div class="table-area">
        <table id="table-d"><thead><tr id="head-d"></tr></thead><tbody id="body-d"></tbody></table>
      </div>
    </div>

    <!-- Mobile Pane (Hidden in Desktop mode via CSS/JS) -->
    <div class="view-pane mobile-preview" id="mobile-pane" style="display:none">
      <header style="background:#0f172a; color:#fff">
        <strong>ITS MOBILE</strong>
        <span id="kpi-m" style="font-size:10px"></span>
      </header>
      <div class="map-area"><div id="map-m" style="height:100%"></div></div>
      <div class="controls">
        <input id="search-m" type="text" placeholder="Search..." style="width:100%">
        <button class="btn btn-primary" onclick="locateMe()" style="width:100%">Locate Me</button>
      </div>
      <div class="table-area">
        <table id="table-m"><thead><tr id="head-m"></tr></thead><tbody id="body-m"></tbody></table>
      </div>
    </div>
  </div>

  <div class="view-switcher">
    <button id="btn-desktop" class="active" onclick="setView('desktop')">Desktop</button>
    <button id="btn-mobile" onclick="setView('mobile')">Mobile</button>
    <button id="btn-split" onclick="setView('split')">Split View</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDi3nqYLnlDPEzhFquWHo0Be5t2Bhmyvs",
      authDomain: "qatar-north-its-dashboard.firebaseapp.com",
      projectId: "qatar-north-its-dashboard",
      storageBucket: "qatar-north-its-dashboard.firebasestorage.app",
      messagingSenderId: "1038045527292",
      appId: "1:1038045527292:web:087b3d29d3e7c15686ab79"
    };
    const app = initializeApp(firebase_config);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.fb = { auth, db, signOut };

    // Auth Logic
    const authOverlay = document.getElementById('authOverlay');
    const authForm = document.getElementById('authForm');

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authOverlay.classList.remove('show');
        initDashboard();
      } else {
        authOverlay.classList.add('show');
      }
    });

    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('authEmail').value;
      const pass = document.getElementById('authPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        document.getElementById('authMsg').textContent = err.message;
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
  </script>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSKAtXDwzYQCNXtLlFOz5fkof4kCLCtzkf7GokGaINUmrurF7CFPbsm6bF8HXXV3MA8PyfYOzMVK8Q/pub?gid=223122268&single=true&output=csv";
    let rawData = [];
    let filteredData = [];
    let mapD, viewD, mapM, viewM;
    let sensitiveFields = ["password", "username", "pass", "user"];

    function setView(mode) {
      document.body.className = 'mode-' + mode;
      const mPane = document.getElementById('mobile-pane');
      const btns = document.querySelectorAll('.view-switcher button');
      btns.forEach(b => b.classList.remove('active'));
      document.getElementById('btn-' + mode).classList.add('active');

      if (mode === 'desktop') { mPane.style.display = 'none'; }
      else if (mode === 'mobile') { mPane.style.display = 'flex'; document.querySelector('.desktop-pane').style.display = 'none'; }
      else { mPane.style.display = 'flex'; document.querySelector('.desktop-pane').style.display = 'flex'; }

      // Trigger map resize
      setTimeout(() => { if(viewD) viewD.container = document.getElementById('map-d'); if(viewM) viewM.container = document.getElementById('map-m'); }, 100);
    }

    function toggleTheme() {
      const curr = document.body.getAttribute('data-theme');
      document.body.setAttribute('data-theme', curr === 'light' ? 'dark' : 'light');
    }

    async function initDashboard() {
      await initMaps();
      loadData();
    }

    async function initMaps() {
      require(["esri/Map", "esri/views/MapView"], (Map, MapView) => {
        mapD = new Map({ basemap: "satellite" });
        viewD = new MapView({ container: "map-d", map: mapD, center: [51.18, 25.35], zoom: 10 });

        mapM = new Map({ basemap: "satellite" });
        viewM = new MapView({ container: "map-m", map: mapM, center: [51.18, 25.35], zoom: 10 });
      });
    }

    async function loadData() {
      const res = await fetch(CSV_URL);
      const text = await res.text();
      const rows = text.split('\n').map(r => r.split(','));
      const headers = rows[0].map(h => h.trim());
      rawData = rows.slice(1).map(r => {
        let obj = {};
        headers.forEach((h, i) => obj[h] = r[i]);
        return obj;
      });
      filteredData = [...rawData];
      renderUI();
    }

    function renderUI() {
      const headers = Object.keys(rawData[0] || {});
      const headD = document.getElementById('head-d');
      headD.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

      const bodyD = document.getElementById('body-d');
      bodyD.innerHTML = filteredData.map(row => {
        return `<tr>${headers.map(h => {
          const isSensitive = sensitiveFields.some(s => h.toLowerCase().includes(s));
          return `<td class="${isSensitive ? 'hidden-field' : ''}">${row[h] || ''}</td>`;
        }).join('')}</tr>`;
      }).join('');

      document.getElementById('kpi-summary').textContent = `Total: ${filteredData.length} Devices`;
    }

    function exportCSV() {
      let csv = Object.keys(rawData[0]).join(',') + '\n';
      filteredData.forEach(row => {
        csv += Object.values(row).join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('href', url);
      a.setAttribute('download', 'ITS_Export.csv');
      a.click();
    }

    function locateMe() {
      navigator.geolocation.getCurrentPosition(pos => {
        const pt = [pos.coords.longitude, pos.coords.latitude];
        viewD.goTo({ center: pt, zoom: 15 });
        if(viewM) viewM.goTo({ center: pt, zoom: 15 });
      });
    }
  </script>
</body>
</html>