<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ITS Field Operations Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet (same map approach as your ITS.html) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg1:#020617;
      --bg2:#0b1224;
      --glass: rgba(15,23,42,0.78);
      --glass2: rgba(15,23,42,0.92);
      --border: rgba(148,163,184,0.45);
      --shadow: 0 22px 55px rgba(0,0,0,0.55);

      --text:#e5e7eb;
      --muted:#9ca3af;

      --accent:#38bdf8;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --radius: 16px;
      --radius2: 12px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    html,body{ height:100%; background: var(--bg1); color: var(--text); }

    body{
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,0.20), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(236,72,153,0.16), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249,115,22,0.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(168,85,247,0.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg1));
      background-attachment: fixed;
    }

    .wrap{
      max-width: 1900px;
      margin: 0 auto;
      padding: 12px 14px 18px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height:100vh;
    }

    header{
      background:
        linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.90)),
        linear-gradient(90deg, rgba(56,189,248,0.28), rgba(168,85,247,0.24), rgba(236,72,153,0.18));
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
      text-align:center;
      flex:1;
    }
    .title h1{
      font-size: 16px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: #f9fafb;
      font-weight: 800;
    }
    .title .sub{
      font-size: 11px;
      color: var(--muted);
      letter-spacing: .06em;
      text-transform: uppercase;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.60);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.18), transparent 55%),
        rgba(15,23,42,0.92);
      color: var(--text);
      font-size: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.35);
      white-space:nowrap;
    }

    .status-dot{
      width:9px; height:9px; border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 12px rgba(245,158,11,0.9);
    }

    .card{
      background:
        radial-gradient(circle at top left, rgba(248,250,252,0.12), transparent 45%),
        linear-gradient(145deg, rgba(15,23,42,0.92), rgba(15,23,42,0.86));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 10px 12px;
    }

    /* KPI row (flash cards) */
    .kpis{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }
    .kpi{
      border-radius: var(--radius2);
      border: 1px solid rgba(148,163,184,0.52);
      background:
        linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.90)),
        linear-gradient(120deg, rgba(56,189,248,0.16), rgba(168,85,247,0.12), rgba(236,72,153,0.10));
      padding: 10px 10px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
      min-height: 78px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 4px;
    }
    .kpi .label{
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 700;
    }
    .kpi .value{
      font-size: 22px;
      font-weight: 800;
      color: #f9fafb;
      line-height: 1.05;
    }
    .kpi .hint{
      font-size: 11px;
      color: var(--muted);
    }

    /* Controls */
    .controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap: 8px;
    }
    .controls .grow{ flex: 1 1 320px; }
    input[type="text"], select{
      width: 100%;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.60);
      background:
        radial-gradient(circle at 0 0, rgba(248,250,252,0.07), transparent 60%),
        rgba(15,23,42,0.92);
      color: var(--text);
      outline: none;
      font-size: 12px;
    }
    input[type="text"]::placeholder{ color: rgba(156,163,175,0.90); }

    .btn{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.85);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.26), transparent 55%),
        linear-gradient(135deg, rgba(37,99,235,0.94), rgba(56,189,248,0.92));
      color: #ecfeff;
      font-size: 12px;
      font-weight: 700;
      cursor:pointer;
      box-shadow: 0 16px 40px rgba(30,64,175,0.35);
      user-select:none;
      white-space:nowrap;
    }
    .btn.secondary{
      border: 1px solid rgba(148,163,184,0.60);
      background:
        radial-gradient(circle at 0 0, rgba(248,250,252,0.08), transparent 55%),
        rgba(15,23,42,0.92);
      color: var(--text);
      box-shadow: 0 16px 40px rgba(0,0,0,0.25);
      font-weight: 600;
    }

    /* Map */
    #map{
      width:100%;
      height: 460px;
      border-radius: var(--radius2);
      border: 1px solid rgba(148,163,184,0.55);
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,0.55);
    }

    .map-wrap{ position:relative; }
    .legend{
      position:absolute;
      right: 12px;
      top: 12px;
      z-index: 500;
      min-width: 210px;
      max-width: 320px;
      background: rgba(15,23,42,0.88);
      border: 1px solid rgba(148,163,184,0.45);
      border-radius: 12px;
      padding: 10px 10px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .legend .t{
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 800;
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .legend .row{
      display:flex;
      align-items:center;
      gap: 8px;
      margin: 6px 0;
      font-size: 12px;
      color: var(--text);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .swatch{
      width: 12px; height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.30);
      box-shadow: 0 0 12px rgba(0,0,0,0.35);
      flex: 0 0 auto;
    }
    .swatch.me{
      width: 12px; height: 12px;
      border-radius: 3px;
      border: 2px solid rgba(255,255,255,0.45);
    }

    /* Table */
    .table-wrap{
      border: 1px solid rgba(148,163,184,0.45);
      border-radius: var(--radius2);
      overflow:auto;
      max-height: 430px;
      background: rgba(3,7,18,0.86);
      box-shadow: 0 18px 55px rgba(0,0,0,0.55);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      color: var(--text);
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(15,23,42,0.96);
      border-bottom: 1px solid rgba(148,163,184,0.35);
      padding: 8px 10px;
      text-align:left;
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted);
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(31,41,55,0.85);
      padding: 7px 10px;
      white-space: nowrap;
      max-width: 420px;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    tbody tr:nth-child(even){ background: rgba(15,23,42,0.58); }
    tbody tr:nth-child(odd){ background: rgba(3,7,18,0.80); }
    tbody tr:hover{
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.16), transparent 60%),
        rgba(3,7,18,0.92);
      cursor:pointer;
    }

    .footer-note{
      font-size: 11px;
      color: var(--muted);
      padding-top: 6px;
    }

    /* Leaflet popup tweaks to match theme */
    .leaflet-popup-content-wrapper{
      background: rgba(15,23,42,0.92);
      color: var(--text);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 18px 55px rgba(0,0,0,0.55);
      border-radius: 12px;
    }
    .leaflet-popup-tip{
      background: rgba(15,23,42,0.92);
    }
    .pop h3{
      font-size: 13px;
      margin-bottom: 8px;
      letter-spacing: .04em;
    }
    .pop .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 6px 10px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .pop .k{ color: var(--muted); }
    .pop .v{ color: var(--text); overflow-wrap:anywhere; }
    .pop .links{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .pop a{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.92);
      color: var(--text);
      font-size: 12px;
      font-weight: 700;
      cursor:pointer;
    }
    .pop a.primary{
      border: 1px solid rgba(56,189,248,0.85);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.22), transparent 55%),
        rgba(15,23,42,0.92);
      color: #e0f2fe;
    }

    @media (max-width: 900px){
      #map{ height: 380px; }
      header{ flex-wrap:wrap; }
      .title{ text-align:left; }
    }
    @media (max-width: 520px){
      #map{ height: 330px; }
      .legend{ right: 10px; left: 10px; top: 10px; min-width: unset; max-width: unset; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="pill" title="Data load status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Loading CSV…</span>
      </div>

      <div class="title">
        <h1>ITS FIELD OPERATIONS DASHBOARD</h1>
        <div class="sub">Map + Full Data Table + Global Search + GFCODE Filter + My Location</div>
      </div>

      <div class="pill" title="Last sync time">
        <span style="opacity:.85;">Last Sync:</span>
        <span id="lastSync">–</span>
      </div>
    </header>

    <!-- Flash KPI cards (total + each type) -->
    <div class="card">
      <div class="kpis" id="kpiRow">
        <div class="kpi">
          <div class="label">Total Devices</div>
          <div class="value" id="kpiTotal">–</div>
          <div class="hint" id="kpiShown">Shown: –</div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="controls">
        <div class="grow">
          <input id="searchBox" type="text" placeholder="Global search (IP / ID / logic id / ASSETTAG / DESCRIPTION / any field)..." />
        </div>
        <div style="min-width:220px; flex:0 0 220px;">
          <select id="typeFilter">
            <option value="__ALL__">All Device Types (GFCODE)</option>
          </select>
        </div>
        <button class="btn" id="locateBtn" type="button">Locate Me</button>
        <button class="btn secondary" id="clearBtn" type="button">Clear</button>
        <button class="btn secondary" id="reloadBtn" type="button">Reload</button>
      </div>
      <div class="footer-note" id="noteLine">Tip: Click a marker to get Google Maps / Waze navigation.</div>
    </div>

    <!-- Map -->
    <div class="card map-wrap">
      <div id="map"></div>
      <div class="legend" id="legendBox" aria-label="Legend">
        <div class="t">Legend</div>
        <div class="row"><span class="swatch me" style="background:#22c55e;"></span> My Location</div>
        <div id="legendRows"></div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="footer-note" id="tableTitle">All Data (from live CSV)</div>
      <div class="table-wrap">
        <table id="dataTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="footer-note" id="countLine">–</div>
    </div>
  </div>

  <script>
    // ============================
    // CONFIG
    // ============================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSKAtXDwzYQCNXtLlFOz5fkof4kCLCtzkf7GokGaINUmrurF7CFPbsm6bF8HXXV3MA8PyfYOzMVK8Q/pub?gid=223122268&single=true&output=csv";

    // Map: ESRI World Imagery (same style approach you used)
    const ESRI_IMAGERY = "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}";
    const ESRI_LABELS  = "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}";

    // Coordinate columns to use (your dataset varies by sheet)
    const LAT_KEYS = ["Latitude WGS84", "Latitude", "Lat", "LAT", "Y"];
    const LON_KEYS = ["Longitude WGS84", "Longitude", "Lon", "LON", "X"];

    const TYPE_KEY_CANDIDATES = ["GFCODE", "Device Type", "Type", "ASSETTYPE", "Asset Type"];
    const SEARCH_HINT_KEYS = ["ID", "ASSETTAG", "DESCRIPTION", "IP Address", "logic id", "Project id", "MXASSETNUM", "Camera ID"];

    // ============================
    // STATE
    // ============================
    let rawRows = [];
    let headers = [];
    let markers = [];
    let markerByKey = new Map(); // key => marker
    let filteredRows = [];
    let typeKey = "GFCODE";
    let latKey = null;
    let lonKey = null;

    let map, deviceLayer, myLayer;
    let myMarker = null;
    let myCircle = null;

    // ============================
    // HELPERS
    // ============================
    const $ = (id) => document.getElementById(id);

    function asText(v){
      const s = (v === null || v === undefined) ? "" : String(v);
      const trimmed = s.trim();
      return trimmed ? trimmed : "N/A";
    }

    function norm(v){
      return (v === null || v === undefined) ? "" : String(v).trim().toLowerCase();
    }

    function pickKey(obj, candidates){
      for (const k of candidates){
        if (Object.prototype.hasOwnProperty.call(obj, k)) return k;
      }
      return null;
    }

    function parseCoord(v){
      if (v === null || v === undefined) return NaN;
      const s = String(v).trim();
      if (!s) return NaN;
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function getLatLon(row){
      const lat = parseCoord(row[latKey]);
      const lon = parseCoord(row[lonKey]);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return {lat, lon};
    }

    function rowKey(row){
      // stable-ish key for mapping row <-> marker
      // prefer ID, else ASSETTAG, else Sr No, else fallback
      const candidates = ["ID", "ASSETTAG", "MXASSETNUM", "Sr No.", "Sr No", "SrNo", "Asset ID", "Camera ID"];
      for (const k of candidates){
        if (row[k] && String(row[k]).trim()) return `${k}:${String(row[k]).trim()}`;
      }
      // fallback: coordinates + index-like entropy
      const coords = getLatLon(row);
      return coords ? `LL:${coords.lat.toFixed(6)},${coords.lon.toFixed(6)}|${Math.random().toString(16).slice(2)}` : `R:${Math.random().toString(16).slice(2)}`;
    }

    function googleMapsDirLink(lat, lon){
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat + "," + lon)}`;
    }
    function wazeLink(lat, lon){
      return `https://waze.com/ul?ll=${encodeURIComponent(lat + "," + lon)}&navigate=yes`;
    }

    // Device type (GFCODE) normalization for grouping
    function typeVal(row){
      const v = row[typeKey];
      const s = (v === null || v === undefined) ? "" : String(v).trim();
      return s ? s : "N/A";
    }

    // Color palette per device type (stable)
    const BASE_COLORS = [
      "#38bdf8", "#22c55e", "#f59e0b", "#ef4444", "#a855f7", "#ec4899",
      "#10b981", "#f97316", "#60a5fa", "#f43f5e", "#14b8a6", "#eab308"
    ];
    const typeColor = new Map();
    function getTypeColor(t){
      const key = (t || "N/A").toUpperCase();
      if (!typeColor.has(key)){
        const idx = typeColor.size % BASE_COLORS.length;
        typeColor.set(key, BASE_COLORS[idx]);
      }
      return typeColor.get(key);
    }

    function setStatus(state, msg){
      const dot = $("statusDot");
      const text = $("statusText");
      text.textContent = msg;

      if (state === "ok"){
        dot.style.background = "var(--good)";
        dot.style.boxShadow = "0 0 12px rgba(34,197,94,0.9)";
      } else if (state === "bad"){
        dot.style.background = "var(--bad)";
        dot.style.boxShadow = "0 0 12px rgba(239,68,68,0.9)";
      } else {
        dot.style.background = "var(--warn)";
        dot.style.boxShadow = "0 0 12px rgba(245,158,11,0.9)";
      }
    }

    function setLastSync(){
      const d = new Date();
      $("lastSync").textContent = d.toLocaleString("en-US", {
        weekday:"short", day:"2-digit", month:"short", year:"numeric",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }

    function buildTypeFilter(){
      const sel = $("typeFilter");
      sel.innerHTML = `<option value="__ALL__">All Device Types (${typeKey})</option>`;

      const set = new Set();
      for (const r of rawRows){
        set.add(typeVal(r));
      }
      const list = Array.from(set).sort((a,b)=> a.localeCompare(b));
      for (const t of list){
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      }
    }

    function buildLegend(){
      const holder = $("legendRows");
      holder.innerHTML = "";

      // Show only types present in current filtered set (more useful)
      const set = new Set(filteredRows.map(r => typeVal(r)));
      const list = Array.from(set).sort((a,b)=> a.localeCompare(b));

      for (const t of list){
        const row = document.createElement("div");
        row.className = "row";
        const sw = document.createElement("span");
        sw.className = "swatch";
        sw.style.background = getTypeColor(t);
        row.appendChild(sw);
        const label = document.createElement("span");
        label.textContent = `${t}`;
        row.appendChild(label);
        holder.appendChild(row);
      }
    }

    function buildKpis(){
      const kpiRow = $("kpiRow");
      const totalAll = rawRows.length;
      const totalShown = filteredRows.length;

      $("kpiTotal").textContent = String(totalAll);
      $("kpiShown").textContent = `Shown: ${totalShown}`;

      // remove old type KPIs (keep the first "Total Devices" card)
      const keepFirst = kpiRow.firstElementChild;
      kpiRow.innerHTML = "";
      kpiRow.appendChild(keepFirst);

      // counts by type
      const counts = new Map();
      for (const r of filteredRows){
        const t = typeVal(r);
        counts.set(t, (counts.get(t) || 0) + 1);
      }

      // Sort by count desc, then name
      const entries = Array.from(counts.entries()).sort((a,b)=>{
        if (b[1] !== a[1]) return b[1] - a[1];
        return a[0].localeCompare(b[0]);
      });

      for (const [t, c] of entries){
        const el = document.createElement("div");
        el.className = "kpi";
        el.innerHTML = `
          <div class="label">${escapeHtml(t)}</div>
          <div class="value">${c}</div>
          <div class="hint">Type count (filtered)</div>
        `;
        // subtle left border using color
        el.style.borderColor = "rgba(148,163,184,0.52)";
        el.style.boxShadow = "0 16px 40px rgba(0,0,0,0.30)";
        el.style.background =
          `linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.90)),
           radial-gradient(circle at 0 0, ${hexToRgba(getTypeColor(t), 0.20)}, transparent 60%)`;
        kpiRow.appendChild(el);
      }
    }

    function hexToRgba(hex, a){
      const h = hex.replace("#","");
      const r = parseInt(h.slice(0,2),16);
      const g = parseInt(h.slice(2,4),16);
      const b = parseInt(h.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ============================
    // TABLE
    // ============================
    function buildTable(){
      const theadRow = $("theadRow");
      const tbody = $("tbody");
      theadRow.innerHTML = "";
      tbody.innerHTML = "";

      // Build headers
      headers.forEach(h=>{
        const th = document.createElement("th");
        th.textContent = h;
        theadRow.appendChild(th);
      });

      // Rows
      filteredRows.forEach((row, idx)=>{
        const tr = document.createElement("tr");
        tr.dataset.rowIndex = String(idx);
        const key = row.__key;

        headers.forEach(h=>{
          const td = document.createElement("td");
          td.textContent = asText(row[h]);
          tr.appendChild(td);
        });

        tr.addEventListener("click", ()=>{
          const m = markerByKey.get(key);
          const ll = getLatLon(row);
          if (m && ll){
            map.setView([ll.lat, ll.lon], Math.max(map.getZoom(), 16), {animate:true});
            m.openPopup();
          }
        });

        tbody.appendChild(tr);
      });

      $("countLine").textContent = `Showing ${filteredRows.length} of ${rawRows.length} records.`;
    }

    // ============================
    // MAP
    // ============================
    function initMap(){
      map = L.map("map", { zoomControl:true });

      const imagery = L.tileLayer(ESRI_IMAGERY, { maxZoom: 19, attribution: "Esri, Maxar, Earthstar Geographics, OpenStreetMap contributors" });
      const labels  = L.tileLayer(ESRI_LABELS,  { maxZoom: 19, attribution: "" });

      imagery.addTo(map);
      labels.addTo(map);

      deviceLayer = L.layerGroup().addTo(map);
      myLayer = L.layerGroup().addTo(map);

      // Qatar-ish initial view
      map.setView([25.30, 51.45], 9);
    }

    function clearDeviceMarkers(){
      deviceLayer.clearLayers();
      markers = [];
      markerByKey.clear();
    }

    function buildPopupHtml(row, lat, lon){
      // Required fields in popup
      const id = asText(row["ID"]);
      const gf = asText(row["GFCODE"]);
      const tag = asText(row["ASSETTAG"]);
      const desc = asText(row["DESCRIPTION"]);
      const ip = asText(row["IP Address"]);

      const gLink = googleMapsDirLink(lat, lon);
      const wLink = wazeLink(lat, lon);

      return `
        <div class="pop">
          <h3>${escapeHtml(gf)} • ${escapeHtml(id)}</h3>
          <div class="kv">
            <div class="k">ID</div><div class="v">${escapeHtml(id)}</div>
            <div class="k">GFCODE</div><div class="v">${escapeHtml(gf)}</div>
            <div class="k">ASSETTAG</div><div class="v">${escapeHtml(tag)}</div>
            <div class="k">DESCRIPTION</div><div class="v">${escapeHtml(desc)}</div>
            <div class="k">IP Address</div><div class="v">${escapeHtml(ip)}</div>
            <div class="k">Coordinates</div><div class="v">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
          </div>
          <div class="links">
            <a class="primary" href="${escapeHtml(gLink)}" target="_blank" rel="noopener">Open in Google Maps</a>
            <a href="${escapeHtml(wLink)}" target="_blank" rel="noopener">Open in Waze</a>
          </div>
        </div>
      `;
    }

    function addDeviceMarkers(){
      clearDeviceMarkers();

      const bounds = [];
      filteredRows.forEach(row=>{
        const ll = getLatLon(row);
        if (!ll) return;
        const t = typeVal(row);
        const color = getTypeColor(t);

        const m = L.circleMarker([ll.lat, ll.lon], {
          radius: 7,
          color: "rgba(255,255,255,0.55)",
          weight: 1,
          fillColor: color,
          fillOpacity: 0.95
        });

        const html = buildPopupHtml(row, ll.lat, ll.lon);
        m.bindPopup(html, { maxWidth: 420, closeButton: true });

        m.addTo(deviceLayer);

        markers.push(m);
        markerByKey.set(row.__key, m);
        bounds.push([ll.lat, ll.lon]);
      });

      if (bounds.length){
        const b = L.latLngBounds(bounds);
        map.fitBounds(b.pad(0.12), {animate:true});
      }
    }

    function setMyLocation(lat, lon){
      myLayer.clearLayers();

      // Green square marker for "My Location"
      const icon = L.divIcon({
        className: "",
        iconSize: [18,18],
        html: `
          <div style="
            width:18px;height:18px;border-radius:4px;
            background:#22c55e;border:2px solid rgba(255,255,255,0.65);
            box-shadow: 0 0 14px rgba(34,197,94,0.85);
          "></div>
        `
      });

      myMarker = L.marker([lat, lon], { icon }).addTo(myLayer).bindPopup(
        `<div class="pop">
          <h3>My Location</h3>
          <div class="kv">
            <div class="k">Coordinates</div><div class="v">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
          </div>
        </div>`,
        { maxWidth: 320 }
      );

      // Circle around my location (visual identification)
      myCircle = L.circle([lat, lon], {
        radius: 120,
        color: "#22c55e",
        weight: 2,
        fillColor: "#22c55e",
        fillOpacity: 0.12
      }).addTo(myLayer);

      map.setView([lat, lon], Math.max(map.getZoom(), 15), {animate:true});
    }

    function locateMe(){
      if (!navigator.geolocation){
        setStatus("bad", "Geolocation not supported");
        return;
      }
      setStatus("mid", "Locating…");
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          setStatus("ok", "Loaded");
          setMyLocation(pos.coords.latitude, pos.coords.longitude);
        },
        (err)=>{
          console.error(err);
          setStatus("bad", "Location denied/unavailable");
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:10000 }
      );
    }

    // ============================
    // FILTER / SEARCH
    // ============================
    function applyFilters(){
      const q = norm($("searchBox").value);
      const type = $("typeFilter").value;

      filteredRows = rawRows.filter(r=>{
        if (type !== "__ALL__" && typeVal(r) !== type) return false;

        if (!q) return true;

        // Global search across all fields
        for (const h of headers){
          const v = r[h];
          if (norm(v).includes(q)) return true;
        }
        return false;
      });

      addDeviceMarkers();
      buildLegend();
      buildKpis();
      buildTable();

      $("noteLine").textContent = (q || type !== "__ALL__")
        ? `Filters applied. Search: ${q ? `"${q}"` : "—"} | Type: ${type !== "__ALL__" ? type : "All"}`
        : "Tip: Click a marker to get Google Maps / Waze navigation.";
      $("kpiShown").textContent = `Shown: ${filteredRows.length}`;
    }

    // ============================
    // LOAD CSV
    // ============================
    function inferKeysFromFirstRow(row){
      // lat/lon
      latKey = pickKey(row, LAT_KEYS);
      lonKey = pickKey(row, LON_KEYS);

      // type key
      const tk = pickKey(row, TYPE_KEY_CANDIDATES);
      typeKey = tk || "GFCODE";
    }

    function loadCsv(){
      setStatus("mid", "Loading CSV…");
      $("reloadBtn").disabled = true;

      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        complete: (results)=>{
          const data = Array.isArray(results.data) ? results.data : [];
          if (!data.length){
            setStatus("bad", "CSV empty / failed");
            $("reloadBtn").disabled = false;
            return;
          }

          // Clean headers and keep original order
          headers = Object.keys(data[0] || {});
          rawRows = data.map((r)=>{
            const obj = {...r};
            obj.__key = null;
            return obj;
          });

          inferKeysFromFirstRow(rawRows[0]);

          if (!latKey || !lonKey){
            setStatus("bad", "Missing Lat/Lon columns");
            $("reloadBtn").disabled = false;
            console.error("Latitude key:", latKey, "Longitude key:", lonKey, "Headers:", headers);
            return;
          }

          // Attach stable keys
          rawRows.forEach(r => r.__key = rowKey(r));

          // Build filter options
          buildTypeFilter();

          // Default filtered rows: all rows that have coordinates
          rawRows = rawRows.filter(r => !!getLatLon(r));

          filteredRows = [...rawRows];

          // UI updates
          setStatus("ok", "Loaded");
          setLastSync();

          // Render
          applyFilters();

          $("reloadBtn").disabled = false;
        },
        error: (err)=>{
          console.error(err);
          setStatus("bad", "CSV load failed");
          $("reloadBtn").disabled = false;
        }
      });
    }

    // ============================
    // INIT
    // ============================
    function init(){
      initMap();

      // Events
      $("searchBox").addEventListener("input", ()=>{
        // small debounce
        window.clearTimeout(window.__t);
        window.__t = window.setTimeout(applyFilters, 140);
      });
      $("typeFilter").addEventListener("change", applyFilters);

      $("locateBtn").addEventListener("click", locateMe);
      $("clearBtn").addEventListener("click", ()=>{
        $("searchBox").value = "";
        $("typeFilter").value = "__ALL__";
        applyFilters();
      });
      $("reloadBtn").addEventListener("click", loadCsv);

      loadCsv();
    }

    init();
  </script>
</body>
</html>
