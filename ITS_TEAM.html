<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ITS Field Operations Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ArcGIS JS (Esri Map) -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/dark/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    :root{
      --bg0:#020617;
      --glass:rgba(15,23,42,.72);
      --glass2:rgba(15,23,42,.90);
      --border:rgba(148,163,184,.45);
      --shadow:0 22px 45px rgba(15,23,42,.65);
      --radius-lg:18px;
      --radius-md:14px;

      --text0:#f9fafb;
      --text1:#e5e7eb;
      --text2:#9ca3af;
      --text3:#6b7280;

      --accent-blue:#38bdf8;
      --accent-green:#22c55e;
      --accent-red:#ef4444;

      --trans:180ms cubic-bezier(.22,.61,.36,1);
    }
    body[data-theme="light"]{
      --bg0:#f3f4f6;
      --glass:rgba(255,255,255,.90);
      --glass2:rgba(255,255,255,.96);
      --border:rgba(148,163,184,.55);
      --shadow:0 18px 50px rgba(15,23,42,.16);

      --text0:#020617;
      --text1:#111827;
      --text2:#374151;
      --text3:#6b7280;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    html,body{height:100%}
    body{min-height:100vh;background:var(--bg0);color:var(--text1);overflow-x:hidden}
    .page{
      min-height:100vh;
      background:
        linear-gradient(180deg, rgba(2,6,23,.35), rgba(2,6,23,.55)),
        url("bg-image.png") center / cover no-repeat fixed,
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(236,72,153,.14), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249,115,22,.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(168,85,247,.14), transparent 60%);
      padding-bottom:18px;
    }
    .shell{max-width:1880px;margin:0 auto;padding:12px 16px 24px}

    header{
      width:100%;
      border-radius:20px;
      margin-bottom:10px;
      padding:10px 20px;
      background:
        linear-gradient(135deg, rgba(15,23,42,.97), rgba(15,23,42,.92)),
        linear-gradient(90deg, rgba(56,189,248,.35), rgba(168,85,247,.35), rgba(236,72,153,.26));
      box-shadow:0 24px 60px rgba(15,23,42,.85), 0 0 0 1px rgba(148,163,184,.35);
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
    }
    body[data-theme="light"] header{
      background:
        linear-gradient(135deg, rgba(255,255,255,.94), rgba(255,255,255,.92)),
        linear-gradient(90deg, rgba(56,189,248,.22), rgba(168,85,247,.20), rgba(236,72,153,.18));
    }

    .header-left,.header-right{flex:0 0 auto;display:flex;align-items:center;gap:8px}
    .header-center{flex:1 1 auto;text-align:center}
    .header-logo{max-height:52px;height:auto;filter:drop-shadow(0 8px 20px rgba(15,23,42,.8))}
    .header-logo-small{max-height:44px}
    .header-title{
      font-size:clamp(18px,2vw,26px);
      font-weight:800;
      letter-spacing:.08em;
      color:var(--text0);
      text-transform:uppercase;
    }
    .header-subtitle{
      font-size:11px;
      color:var(--text2);
      margin-top:4px;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .header-meta{font-size:11px;color:rgba(199,210,254,.95);margin-top:4px}
    body[data-theme="light"] .header-meta{color:rgba(55,65,81,.95)}

    .top-row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0;flex-wrap:wrap
    }
    .pill{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      padding:6px 12px;
      font-size:11px;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.20), transparent 55%),
        linear-gradient(135deg, rgba(15,23,42,.96), rgba(15,23,42,.98));
      color:var(--text2);
      box-shadow:0 16px 35px rgba(15,23,42,.55);
      display:inline-flex;align-items:center;gap:8px;user-select:none;
    }
    body[data-theme="light"] .pill{
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.12), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.96), rgba(243,244,246,.96));
      box-shadow:0 12px 28px rgba(148,163,184,.28);
    }
    .status-dot{width:10px;height:10px;border-radius:999px;background:rgba(148,163,184,.8);box-shadow:0 0 12px rgba(148,163,184,.35)}
    .status-dot.ok{background:var(--accent-green);box-shadow:0 0 12px rgba(34,197,94,.75)}
    .status-dot.bad{background:var(--accent-red);box-shadow:0 0 12px rgba(239,68,68,.75)}
    .theme-toggle{
      padding:6px 14px;border-radius:999px;font-size:10px;letter-spacing:.12em;text-transform:uppercase;
      border:1px solid rgba(148,163,184,.75);
      background-image:
        radial-gradient(circle at top left, rgba(56,189,248,.18), transparent 60%),
        linear-gradient(135deg, rgba(15,23,42,.96), rgba(15,23,42,.98));
      color:var(--text2);
      cursor:pointer;
      transition:transform var(--trans), box-shadow var(--trans), border-color var(--trans);
      white-space:nowrap;
    }
    .theme-toggle:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(15,23,42,.45);border-color:rgba(248,250,252,.75)}
    body[data-theme="light"] .theme-toggle{
      background-image:
        radial-gradient(circle at top left, rgba(59,130,246,.14), transparent 60%),
        linear-gradient(135deg,#fff,#f9fafb);
      color:rgba(55,65,81,.95);
      border-color:rgba(148,163,184,.9);
    }

    .glass-card{
      position:relative;
      background:
        radial-gradient(circle at top left, rgba(248,250,252,.14), transparent 42%),
        linear-gradient(145deg, var(--glass2), var(--glass));
      border-radius:var(--radius-lg);
      padding:10px 14px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      overflow:hidden;
    }

    /* KPI cards: wrap to 2+ lines (no horizontal scroll) */
    .kpi-wrap{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:stretch;
      padding-bottom:2px;
    }
    .kpi{
      flex:0 0 auto;
      min-width:172px;
      max-width:220px;
      border-radius:var(--radius-md);
      padding:10px 12px;
      border:1px solid rgba(148,163,184,.55);
      background:
        linear-gradient(145deg, rgba(15,23,42,.96), rgba(15,23,42,.90)),
        linear-gradient(120deg, rgba(56,189,248,.18), rgba(168,85,247,.14), rgba(236,72,153,.12));
      box-shadow:0 16px 35px rgba(15,23,42,.6);
    }
    body[data-theme="light"] .kpi{
      background:
        linear-gradient(145deg, rgba(255,255,255,.96), rgba(243,244,246,.96)),
        linear-gradient(120deg, rgba(56,189,248,.12), rgba(168,85,247,.10), rgba(236,72,153,.10));
      box-shadow:0 14px 30px rgba(148,163,184,.22);
    }
    .kpi-label{
      font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--text2);
      display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .kpi-badge{
      width:10px;height:10px;border-radius:3px;border:1px solid rgba(255,255,255,.5);
      box-shadow:0 0 14px rgba(15,23,42,.55);flex:0 0 auto;
    }
    body[data-theme="light"] .kpi-badge{border-color:rgba(2,6,23,.25)}
    .kpi-value{font-size:24px;font-weight:800;margin-top:4px;color:var(--text0)}

    .controls-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
    .search{flex:1 1 420px;min-width:220px}
    .search input{
      width:100%;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      font-size:12px;
      background:
        radial-gradient(circle at 0 0, rgba(248,250,252,.06), transparent 60%),
        rgba(15,23,42,.96);
      color:var(--text1);
      outline:none;
      transition:border-color var(--trans), box-shadow var(--trans), transform var(--trans);
    }
    body[data-theme="light"] .search input{background:rgba(255,255,255,.96);color:var(--text1);border-color:rgba(148,163,184,.85)}
    .search input:focus{border-color:rgba(56,189,248,.9);box-shadow:0 0 0 1px rgba(56,189,248,.55);transform:translateY(-1px)}
    .search input::placeholder{color:rgba(148,163,184,.9)}

    .filter{flex:0 0 auto;display:flex;align-items:center;gap:8px}
    .filter select{
      padding:10px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.7);
      font-size:12px;background:rgba(15,23,42,.96);color:var(--text1);outline:none;min-width:240px;
      transition:border-color var(--trans), box-shadow var(--trans), transform var(--trans);
      appearance:none;-webkit-appearance:none;
    }
    body[data-theme="light"] .filter select{background:rgba(255,255,255,.96);color:var(--text1);border-color:rgba(148,163,184,.85)}
    .filter select:focus{border-color:rgba(56,189,248,.9);box-shadow:0 0 0 1px rgba(56,189,248,.55);transform:translateY(-1px)}

    .btn{
      padding:10px 14px;border-radius:999px;border:1px solid rgba(56,189,248,.9);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.32), transparent 55%),
        linear-gradient(135deg, rgba(37,99,235,.96), rgba(56,189,248,.95));
      color:#ecfeff;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 16px 35px rgba(30,64,175,.55);
      transition:transform var(--trans), box-shadow var(--trans), filter var(--trans);
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 22px 48px rgba(30,64,175,.65);filter:brightness(1.04)}
    .btn.secondary{
      border-color:rgba(148,163,184,.7);
      background:rgba(15,23,42,.88);
      color:var(--text2);
      box-shadow:0 16px 35px rgba(15,23,42,.35);
    }
    body[data-theme="light"] .btn.secondary{background:rgba(255,255,255,.92);color:rgba(55,65,81,.95);box-shadow:0 14px 30px rgba(148,163,184,.22)}
    .export-group{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}

    .map-card{padding:10px}
    .map-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:4px 6px 10px;flex-wrap:wrap}
    .map-title{
      font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:var(--text2);
      display:flex;align-items:center;gap:8px;
    }
    .map-title .dot{width:8px;height:8px;border-radius:999px;background:linear-gradient(135deg,var(--accent-blue),var(--accent-green));box-shadow:0 0 12px rgba(56,189,248,.65)}
    .map-box{
      position:relative;width:100%;height:520px;border-radius:var(--radius-md);overflow:hidden;
      border:1px solid rgba(148,163,184,.55);
      box-shadow:0 16px 40px rgba(15,23,42,.65);
      background:rgba(0,0,0,.12);
    }

    .map-footer{padding:10px 6px 2px;font-size:11px;color:var(--text3);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}

    .table-card{padding:12px 14px}
    .table-title{
      font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:var(--text2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap;
    }
    .table-hint{font-size:11px;color:var(--text3);letter-spacing:.02em;text-transform:none}
    .table-wrap{
      width:100%;max-height:380px;overflow:auto;border-radius:12px;border:1px solid rgba(55,65,81,.9);
      background:radial-gradient(circle at top left, rgba(15,23,42,.86), rgba(3,7,18,.96));
      box-shadow:0 18px 45px rgba(15,23,42,.55);
    }
    body[data-theme="light"] .table-wrap{
      background:rgba(255,255,255,.92);
      border-color:rgba(148,163,184,.55);
      box-shadow:0 18px 45px rgba(148,163,184,.18);
    }
    table{width:100%;border-collapse:collapse;font-size:12px;color:var(--text1)}
    thead{position:sticky;top:0;z-index:2}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(31,41,55,.6);text-align:left;white-space:nowrap}
    th{
      background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.92));
      font-weight:800;text-transform:uppercase;letter-spacing:.12em;font-size:10px;color:var(--text2);
    }
    body[data-theme="light"] th{
      background:linear-gradient(180deg, rgba(243,244,246,.98), rgba(229,231,235,.98));
      color:rgba(55,65,81,.95);
      border-bottom-color:rgba(148,163,184,.55);
    }
    tbody tr:nth-child(even){background:rgba(15,23,42,.72)}
    tbody tr:nth-child(odd){background:rgba(3,7,18,.92)}
    body[data-theme="light"] tbody tr:nth-child(even){background:rgba(249,250,251,.98)}
    body[data-theme="light"] tbody tr:nth-child(odd){background:rgba(243,244,246,.98)}
    tbody tr:hover{
      background:radial-gradient(circle at 0 0, rgba(56,189,248,.14), transparent 55%), rgba(3,7,18,.96);
      cursor:pointer;
    }
    body[data-theme="light"] tbody tr:hover{
      background:radial-gradient(circle at 0 0, rgba(56,189,248,.10), transparent 55%), rgba(255,255,255,.98);
    }

    .small-muted{color:var(--text3);font-size:11px}

    .esri-popup__main-container{
      border-radius:14px !important;
      border:1px solid rgba(148,163,184,.35) !important;
      overflow:hidden !important;
      box-shadow:0 18px 45px rgba(15,23,42,.55) !important;
      max-width:520px !important;
    }
    body[data-theme="light"] .esri-popup__main-container{box-shadow:0 18px 45px rgba(148,163,184,.22) !important}

    .popup-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .popup-link{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:8px 10px;border-radius:999px;border:1px solid rgba(56,189,248,.9);
      background:radial-gradient(circle at 0 0, rgba(56,189,248,.28), transparent 55%), linear-gradient(135deg, rgba(37,99,235,.96), rgba(56,189,248,.95));
      color:#ecfeff !important;text-decoration:none !important;font-weight:700;font-size:12px;
      box-shadow:0 14px 30px rgba(30,64,175,.45);
      white-space:nowrap;
    }
    .popup-link.waze{
      border-color:rgba(168,85,247,.9);
      background:radial-gradient(circle at 0 0, rgba(168,85,247,.28), transparent 55%), linear-gradient(135deg, rgba(147,51,234,.96), rgba(168,85,247,.95));
      box-shadow:0 14px 30px rgba(88,28,135,.35);
    }

    .popup-kv{
      margin-top:8px;
      border:1px solid rgba(148,163,184,.25);
      border-radius:12px;
      overflow:hidden;
    }
    .popup-kv table{width:100%;border-collapse:collapse;font-size:12px}
    .popup-kv td{
      padding:6px 10px;
      border-bottom:1px solid rgba(148,163,184,.18);
      vertical-align:top;
      white-space:normal;
    }
    .popup-kv tr:last-child td{border-bottom:none}
    .popup-kv td:first-child{
      width:40%;
      color:rgba(156,163,175,.95);
      font-weight:700;
      letter-spacing:.02em;
    }
    body[data-theme="light"] .popup-kv td:first-child{color:rgba(55,65,81,.85)}
    .popup-details{
      margin-top:10px;
      border:1px solid rgba(148,163,184,.22);
      border-radius:12px;
      overflow:hidden;
    }
    .popup-details summary{
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:rgba(156,163,175,.95);
      background:rgba(15,23,42,.35);
      user-select:none;
      list-style:none;
    }
    .popup-details summary::-webkit-details-marker{display:none}
    body[data-theme="light"] .popup-details summary{background:rgba(243,244,246,.75);color:rgba(55,65,81,.85)}
    .popup-details .inner{padding:8px 10px}

    @media (max-width:980px){
      header{flex-wrap:wrap;padding:10px 14px}
      .header-center{text-align:left}
      .map-box{height:440px}
      .filter select{min-width:220px}
      .legend{width:280px}
    }
    @media (max-width:640px){
      .shell{padding:10px 10px 20px}
      .map-box{height:380px}
      .legend{right:10px;left:10px;width:auto;bottom:10px;top:auto;max-height:48%}
      .legend.is-collapsed{width:auto}
      .legend-body{max-height:220px}
      .filter select{min-width:100%}
      .controls-bar{gap:8px}
      .export-group{width:100%;justify-content:flex-start;margin-left:0}
      .btn{width:100%;justify-content:center}
      .btn.secondary{width:100%;justify-content:center}
    }
  </style>
</head>

<body data-theme="dark">
  <div class="page">
    <div class="shell">
      <header>
        <div class="header-left">
          <img src="aktor-logo.png" alt="Aktor Qatar" class="header-logo" />
        </div>

        <div class="header-center">
          <div class="header-title">ITS FIELD OPERATIONS DASHBOARD</div>
          <div class="header-subtitle">Live from Google Sheet — Map + Full Data Table + Global Search + Type Filter + My Location</div>
          <div class="header-meta"><span id="currentDateTime"></span></div>
        </div>

        <div class="header-right">
          <img src="MRTC-AKTOR JV.png" alt="MRTC-AKTOR JV" class="header-logo header-logo-small" />
        </div>
      </header>

      <div class="top-row">
        <div class="pill">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Not loaded</span>
        </div>

        <button class="theme-toggle" id="themeToggle" type="button">Dark</button>

        <div class="pill">
          <span class="small-muted">Last Sync:</span>
          <span id="lastSync">—</span>
        </div>
      </div>

      <div class="glass-card">
        <div class="kpi-wrap" id="kpiWrap"></div>

        <div class="controls-bar">
          <div class="search">
            <input id="globalSearch" type="text" placeholder="Global search (IP / logic id / ID / ASSETTAG / DESCRIPTION / any field)..." />
          </div>

          <div class="filter">
            <select id="typeFilter">
              <option value="__ALL__">All Device Types (GFCODE)</option>
            </select>
          </div>

          <button class="btn" id="locateBtn" type="button">Locate Me</button>
          <button class="btn secondary" id="clearBtn" type="button">Clear</button>
          <button class="btn secondary" id="reloadBtn" type="button">Reload</button>

          <div class="export-group">
            <button class="btn" id="exportCsvBtn" type="button">CSV</button>
            <button class="btn" id="exportPdfBtn" type="button">PDF</button>
          </div>
        </div>

        <div class="small-muted" style="margin-top:6px;" id="hintText">
          Tip: Use the Layers button on the map to toggle boundaries/areas. Click a marker (or a table row) for navigation options (Google Maps / Waze).
        </div>
      </div>

      <div class="glass-card map-card" style="margin-top:12px;">
        <div class="map-header">
          <div class="map-title"><span class="dot"></span><span>ESRI MAP (SATELLITE) — LOCKED TO QATAR</span></div>
          <div class="small-muted" id="deviceCountLabel">0 devices</div>
        </div>

        <div class="map-box">
          <div id="mapView" style="width:100%;height:100%;"></div>
        </div>
</div>
        </div>

        <div class="map-footer">
          <div id="mapFooterLeft">Map is constrained to Qatar extent. Use “Layers” to toggle boundaries/areas. Use “Locate Me” to center on current position.</div>
          <div class="small-muted">Data source: Google Sheet (CSV)</div>
        </div>
      </div>

      <div class="glass-card table-card" style="margin-top:12px;">
        <div class="table-title">
          <div>All Data (from Excel/CSV)</div>
          <div class="table-hint">Click a row to zoom to the device and open navigation options.</div>
        </div>
        <div class="table-wrap">
          <table id="dataTable">
            <thead><tr id="tableHeadRow"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSKAtXDwzYQCNXtLlFOz5fkof4kCLCtzkf7GokGaINUmrurF7CFPbsm6bF8HXXV3MA8PyfYOzMVK8Q/pub?gid=223122268&single=true&output=csv";

    // Qatar extent (buffered) - WGS84
    const QATAR_EXTENT_WGS84 = { xmin: 50.45, ymin: 24.25, xmax: 52.15, ymax: 26.35, wkid: 4326 };

    // High-contrast palette + shapes
    const COLOR_PALETTE = [
      "#22c55e","#38bdf8","#f97316","#a855f7","#ef4444","#fbbf24",
      "#06b6d4","#e11d48","#16a34a","#2563eb","#7c3aed","#ea580c",
      "#0ea5e9","#db2777","#84cc16","#f43f5e","#14b8a6","#9333ea",
      "#fb7185","#f59e0b"
    ];
    const SHAPES = ["circle","square","diamond","triangle","cross","x"];

    // Priority fields in popup (match your typical Excel names)
    const POPUP_PRIORITY = [
      "Sr No.","SR NO","SrNo","SrNo.","Serial No.","Serial Number",
      "Project id","Project ID","PROJECT ID","project id",
      "logic id","Logic id","Logic ID","LOGIC ID",
      "MXASSETNUM","MxAssetNum","Maximo Asset","Maximo Asset Number",
      "IP Address","IP","IPAddress","Ip Address",
      "ASSETTAG","Asset Tag","AssetTag",
      "ID","Id","id",
      "DESCRIPTION","Description","description",
      "Camera ID","CAMERA ID","camera id",
      "User","USER","username","Username",
      "Password","PASSWORD","pass","Pass",
      "GFCODE","gfcode","Gfcode",
      "Type","TYPE","Device Type","DEVICE TYPE",
      "Latitude WGS84","Longitude WGS84","Latitude","Longitude"
    ];

    // ===================== STATE =====================
    let rawRows = [];
    let headers = [];
    let filteredRows = [];
    let skippedNoCoords = 0;

    let view, devicesLayer, myLayer;
    const deviceGraphicsByKey = new Map();
    let selectedGraphic = null;

    // Export libs
    let jsPDF = null;
    let autoTableLoaded = false;

    // ===================== DOM =====================
    const $ = (id) => document.getElementById(id);

    // ===================== UI HELPERS =====================
    function nowString(){
      const d = new Date();
      return d.toLocaleString("en-US", {
        weekday:"short", day:"2-digit", month:"short", year:"numeric",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }
    function setStatus(ok, msg){
      const dot = $("statusDot");
      dot.classList.remove("ok","bad");
      dot.classList.add(ok ? "ok" : "bad");
      $("statusText").textContent = msg;
    }
    function sanitize(v){
      if (v === null || v === undefined) return "N/A";
      const s = String(v).replace(/\u00A0/g," ").trim();
      return s === "" ? "N/A" : s;
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }
    function toNumberMaybe(v){
      // tolerate spaces, commas, and stray text
      const s = String(v ?? "")
        .replace(/\u00A0/g," ")
        .trim()
        .replace(/,/g,""); // remove thousand separators or accidental commas
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : null;
    }
    function stableHash(str){
      let h = 2166136261;
      const s = String(str || "");
      for (let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);
      }
      return Math.abs(h >>> 0);
    }
    function symbolForType(type){
      const key = sanitize(type);
      const h = stableHash(key);
      return {
        color: COLOR_PALETTE[h % COLOR_PALETTE.length],
        shape: SHAPES[h % SHAPES.length]
      };
    }
    function getFirstKey(row, candidates){
      if (!row) return null;
      for (const k of candidates){
        if (Object.prototype.hasOwnProperty.call(row, k)) return k;
      }
      return null;
    }
    function buildDeviceKey(row){
      const idKey = getFirstKey(row, ["ID","Id","id"]);
      const tagKey = getFirstKey(row, ["ASSETTAG","AssetTag","asset tag","Asset Tag"]);
      const mxKey = getFirstKey(row, ["MXASSETNUM","MxAssetNum","mxassetnum"]);
      const gfcKey = getFirstKey(row, ["GFCODE","gfcode","Gfcode"]);
      return [
        sanitize(idKey ? row[idKey] : ""),
        sanitize(tagKey ? row[tagKey] : ""),
        sanitize(mxKey ? row[mxKey] : ""),
        sanitize(gfcKey ? row[gfcKey] : "")
      ].join("||");
    }
    function googleMapsUrl(lat, lon){ return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`; }
    function wazeUrl(lat, lon){ return `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`; }

    // ===================== THEME =====================
    function applyTheme(theme){
      document.body.setAttribute("data-theme", theme);
      $("themeToggle").textContent = theme === "light" ? "Light" : "Dark";
      localStorage.setItem("its_field_theme", theme);
    }
    function initTheme(){
      const saved = localStorage.getItem("its_field_theme");
      applyTheme(saved === "light" ? "light" : "dark");
      $("themeToggle").addEventListener("click", ()=>{
        const cur = document.body.getAttribute("data-theme") || "dark";
        applyTheme(cur === "dark" ? "light" : "dark");
      });
    }

    // ===================== CSV PARSER (NO LIBS) =====================
    function parseCSV(text){
      const rows = [];
      let i = 0, field = "", row = [];
      let inQuotes = false;

      const pushField = () => { row.push(field); field = ""; };
      const pushRow = () => { rows.push(row); row = []; };

      while (i < text.length){
        const c = text[i];

        if (inQuotes){
          if (c === '"'){
            if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += c; i++; continue;
        }

        if (c === '"'){ inQuotes = true; i++; continue; }
        if (c === ','){ pushField(); i++; continue; }
        if (c === '\r'){ i++; continue; }
        if (c === '\n'){ pushField(); pushRow(); i++; continue; }

        field += c; i++;
      }

      pushField();
      pushRow();

      while (rows.length && rows[rows.length-1].every(v => String(v ?? "").trim() === "")) rows.pop();
      return rows;
    }

    // ===================== DATA LOAD =====================
    async function loadCSV(){
      try{
        setStatus(false, "Loading...");
        $("lastSync").textContent = "—";
        $("hintText").textContent = "Loading data from Google Sheet (CSV)...";

        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`CSV fetch failed: HTTP ${res.status}`);
        const text = await res.text();

        const grid = parseCSV(text);
        if (!grid.length || grid.length < 2){
          rawRows = []; headers = []; filteredRows = [];
          setStatus(false, "Loaded (0 rows)");
          $("lastSync").textContent = nowString();
          $("hintText").textContent = "CSV loaded but contains no rows. Check the published sheet.";
          renderAll();
          refreshMapGraphics([]);
          return;
        }

        headers = grid[0].map(h => String(h ?? "").trim());
        const dataRows = grid.slice(1);

        rawRows = dataRows.map(arr=>{
          const obj = {};
          for (let c=0;c<headers.length;c++){
            obj[headers[c]] = (arr[c] ?? "");
          }
          obj.__blob = headers.map(h => sanitize(obj[h])).join(" | ").toLowerCase();
          return obj;
        });

        setStatus(true, "Loaded");
        $("lastSync").textContent = nowString();
        $("hintText").textContent = "Tip: Use the Layers button on the map to toggle boundaries/areas. Click a marker (or a table row) for navigation options (Google Maps / Waze).";

        renderAll();
        applyFilters();
      }catch(err){
        setStatus(false, "Load error");
        $("lastSync").textContent = nowString();
        $("hintText").textContent =
          "Data not loaded. Most common cause: opening the file directly from your PC (file://). " +
          "Upload to GitHub Pages or open using a local server. Error: " + (err?.message || err);
        rawRows = []; headers = []; filteredRows = [];
        renderAll();
        refreshMapGraphics([]);
      }
    }

    // ===================== RENDER (FILTER / KPI / LEGEND / TABLE) =====================
    function renderTypeFilter(){
      const sel = $("typeFilter");
      const prev = sel.value;
      sel.innerHTML = `<option value="__ALL__">All Device Types (GFCODE)</option>`;

      if (!rawRows.length) return;

      const gfcKey = getFirstKey(rawRows[0], ["GFCODE","gfcode","Gfcode"]);
      const types = new Set();
      for (const r of rawRows){
        types.add(sanitize(gfcKey ? r[gfcKey] : "UNKNOWN"));
      }
      [...types].sort((a,b)=>a.localeCompare(b)).forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });

      if ([...sel.options].some(o=>o.value===prev)) sel.value = prev;
    }

    function renderKPIs(rows){
      const wrap = $("kpiWrap");
      wrap.innerHTML = "";

      const totalCard = document.createElement("div");
      totalCard.className = "kpi";
      totalCard.innerHTML = `
        <div class="kpi-label"><span class="kpi-badge" style="background:${"#38bdf8"}"></span> Total Devices</div>
        <div class="kpi-value">${rows.length}</div>
      `;
      wrap.appendChild(totalCard);

      if (!rows.length) {
        $("deviceCountLabel").textContent = "0 devices";
        return;
      }

      const gfcKey = getFirstKey(rows[0], ["GFCODE","gfcode","Gfcode"]);
      const counts = new Map();
      for (const r of rows){
        const t = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
        counts.set(t, (counts.get(t) || 0) + 1);
      }
      const sorted = [...counts.entries()].sort((a,b)=>b[1]-a[1]);
      for (const [type,cnt] of sorted){
        const { color } = symbolForType(type);
        const card = document.createElement("div");
        card.className = "kpi";
        card.title = type;
        card.innerHTML = `
          <div class="kpi-label"><span class="kpi-badge" style="background:${color}"></span> ${escapeHtml(type)}</div>
          <div class="kpi-value">${cnt}</div>
        `;
        wrap.appendChild(card);
      }

      $("deviceCountLabel").textContent = `${rows.length} devices`;
    }
      const sorted = [...counts.entries()].sort((a,b)=>a[0].localeCompare(b[0]));

      for (const [t, cnt] of sorted){
        const { color, shape } = symbolForType(t);

        let swatchHTML = "";
        if (shape === "triangle"){
          swatchHTML = `<span class="swatch triangle" style="border-bottom-color:${color}"></span>`;
        } else if (shape === "diamond"){
          swatchHTML = `<span class="swatch diamond" style="background:${color}"></span>`;
        } else if (shape === "circle"){
          swatchHTML = `<span class="swatch circle" style="background:${color}"></span>`;
        } else {
          swatchHTML = `<span class="swatch" style="background:${color}"></span>`;
        }

        const item = document.createElement("li");
        item.className = "legend-item";
        item.innerHTML = `
          <div class="legend-left">
            ${swatchHTML}
            <span class="legend-type" title="${escapeHtml(t)}">${escapeHtml(t)}</span>
          </div>
          <span class="legend-count">${cnt}</span>
        `;
        list.appendChild(item);
      }

      function renderTable(rows){
      const headRow = $("tableHeadRow");
      const body = $("tableBody");
      headRow.innerHTML = "";
      body.innerHTML = "";

      if (!headers.length) return;

      for (const h of headers){
        const th = document.createElement("th");
        th.textContent = h;
        headRow.appendChild(th);
      }

      const frag = document.createDocumentFragment();
      for (const r of rows){
        const tr = document.createElement("tr");
        tr.dataset.key = buildDeviceKey(r);
        for (const h of headers){
          const td = document.createElement("td");
          td.textContent = sanitize(r[h]);
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      body.appendChild(frag);

      body.querySelectorAll("tr").forEach(tr=>{
        tr.addEventListener("click", ()=>{
          const key = tr.dataset.key;
          const g = deviceGraphicsByKey.get(key);
          if (g) focusGraphic(g, true);
        });
      });
    }

    function renderAll(){
      renderTypeFilter();
      renderKPIs(filteredRows.length ? filteredRows : rawRows);
      renderTable(filteredRows.length ? filteredRows : rawRows);
    }

    function applyFilters(){
      const search = $("globalSearch").value.trim().toLowerCase();
      const typeVal = $("typeFilter").value;

      if (!rawRows.length){
        filteredRows = [];
        renderKPIs([]);
        renderTable([]);
        refreshMapGraphics([]);
        return;
      }

      const gfcKey = getFirstKey(rawRows[0], ["GFCODE","gfcode","Gfcode"]);

      filteredRows = rawRows.filter(r=>{
        const t = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
        if (typeVal !== "__ALL__" && t !== typeVal) return false;
        if (search && !(r.__blob || "").includes(search)) return false;
        return true;
      });

      renderKPIs(filteredRows);
      renderTable(filteredRows);
      refreshMapGraphics(filteredRows);
    }

    function debounce(fn, ms){
      let t = null;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }

    // ===================== POPUP CONTENT (ALL FIELDS + PRIORITY) =====================
    function buildPopupRow(label, value){
      return `<tr><td>${escapeHtml(label)}</td><td>${escapeHtml(sanitize(value))}</td></tr>`;
    }

    function buildPopupHTML(row){
  // coords: try exact headers first then fallbacks
  const latKey = getFirstKey(row, ["Latitude WGS84","Latitude_WGS84","Latitude","LATITUDE","lat"]);
  const lonKey = getFirstKey(row, ["Longitude WGS84","Longitude_WGS84","Longitude","LONGITUDE","lon","LON"]);

  const latS = sanitize(latKey ? row[latKey] : "");
  const lonS = sanitize(lonKey ? row[lonKey] : "");
  const lat = toNumberMaybe(latS);
  const lon = toNumberMaybe(lonS);

  const gUrl = (lat !== null && lon !== null) ? googleMapsUrl(lat, lon) : "#";
  const wUrl = (lat !== null && lon !== null) ? wazeUrl(lat, lon) : "#";

  const idKey  = getFirstKey(row, ["ID","Id","id"]);
  const tagKey = getFirstKey(row, ["ASSETTAG","AssetTag","asset tag","Asset Tag"]);
  const gfcKey = getFirstKey(row, ["GFCODE","gfcode","Gfcode"]);

  const title = sanitize(idKey ? row[idKey] : "") !== "N/A"
    ? sanitize(row[idKey])
    : (sanitize(tagKey ? row[tagKey] : "") !== "N/A" ? sanitize(row[tagKey]) : "ITS Asset");

  // Build ONE table only: priority fields first, then the remaining fields (no duplicates).
  const existingKeys = new Set(headers);
  const used = new Set();
  let rowsHTML = "";

  const addRowByKey = (k) => {
    if (!k || !existingKeys.has(k) || used.has(k)) return;
    used.add(k);
    rowsHTML += buildPopupRow(k, row[k]);
  };

  // Priority fields (case-insensitive match to current headers)
  for (const want of POPUP_PRIORITY){
    const k = headers.find(h => String(h).trim().toLowerCase() === String(want).trim().toLowerCase());
    addRowByKey(k);
  }

  // Always include coordinates row (once)
  if (!used.has("Coordinates")){
    used.add("Coordinates");
    rowsHTML += buildPopupRow("Coordinates", (latS === "N/A" || lonS === "N/A") ? "N/A" : `${latS}, ${lonS}`);
  }

  // Remaining fields (in original sheet order)
  for (const h of headers){
    if (!used.has(h)) addRowByKey(h);
  }

  return `
    <div style="font-size:12px;line-height:1.35;">
      <div style="font-weight:800;font-size:13px;margin-bottom:6px;">${escapeHtml(title)}</div>
      <div style="color:rgba(156,163,175,.95);font-size:12px;margin-bottom:6px;">
        <strong>GFCODE:</strong> ${escapeHtml(sanitize(gfcKey ? row[gfcKey] : "UNKNOWN"))}
      </div>

      <div class="popup-kv">
        <table>
          ${rowsHTML}
        </table>
      </div>

      <div class="popup-btns">
        <a class="popup-link" href="${gUrl}" target="_blank" rel="noopener">Open in Google Maps</a>
        <a class="popup-link waze" href="${wUrl}" target="_blank" rel="noopener">Open in Waze</a>
      </div>
    </div>
  `;
}

    // ===================== MAP (ARCGIS) =====================
    function initMap(){
      return new Promise((resolve, reject)=>{
        if (typeof require !== "function"){
          reject(new Error("ArcGIS loader (require) is not available. Check if https://js.arcgis.com is blocked."));
          return;
        }

        require([
          "esri/Map",
          "esri/views/MapView",
          "esri/Graphic",
          "esri/layers/GraphicsLayer",
          "esri/layers/GeoJSONLayer",
          "esri/widgets/LayerList",
          "esri/widgets/Expand",
          "esri/geometry/Extent",
          "esri/geometry/Polygon",
          "esri/geometry/Point",
          "esri/geometry/geometryEngine",
          "esri/PopupTemplate"
        ], (Map, MapView, Graphic, GraphicsLayer, GeoJSONLayer, LayerList, Expand, Extent, Polygon, Point, geometryEngine, PopupTemplate) => {

          const qatarExtent = new Extent({
            xmin: QATAR_EXTENT_WGS84.xmin,
            ymin: QATAR_EXTENT_WGS84.ymin,
            xmax: QATAR_EXTENT_WGS84.xmax,
            ymax: QATAR_EXTENT_WGS84.ymax,
            spatialReference: { wkid: QATAR_EXTENT_WGS84.wkid }
          });
          const qatarPoly = Polygon.fromExtent(qatarExtent);


          const map = new Map({ basemap: "satellite" });

          // ===================== OVERLAY LAYERS (GEOJSON) =====================
          // Note: filenames contain spaces in your repo; URLs use %20 to be safe on GitHub Pages.
          const boundaryLayers = [
            new GeoJSONLayer({
              url: "./Qatar%20North%20Boundary.geojson",
              title: "Qatar North Boundary",
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [0,255,255,0.95], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Strategic%20Highways%20Boundary.geojson",
              title: "Strategic Highways Boundary",
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [255,255,0,0.90], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Area-01.geojson",
              title: "Area 01",
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [34,197,94,0.95], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Area-02.geojson",
              title: "Area 02",
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [59,130,246,0.95], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Area-03.geojson",
              title: "Area 03",
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [168,85,247,0.95], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Area-04.geojson",
              title: "Area 04",
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [249,115,22,0.95], width: 2 } }
              }
            })
          ];

          // Add boundaries first so device markers stay on top
          map.addMany(boundaryLayers);

          devicesLayer = new GraphicsLayer({ id: "devicesLayer" });
          myLayer = new GraphicsLayer({ id: "myLayer" });
          map.addMany([devicesLayer, myLayer]);

          view = new MapView({
            container: "mapView",
            map,
            extent: qatarExtent,
            constraints: {
              geometry: qatarPoly,
              minZoom: 7,
              maxZoom: 19,
              rotationEnabled: false
            },
            ui: { components: ["zoom", "attribution"] },
            popup: { dockEnabled: false, highlightEnabled: true }
          });

          // Layers toggle (left side)
          const layerList = new LayerList({ view: view });
          const layersExpand = new Expand({
            view: view,
            content: layerList,
            expandIcon: "layers",
            expandTooltip: "Layers"
          });
          view.ui.add(layersExpand, "top-left");


          function markerSymbol(type, selected=false){
            // Single, consistent symbol for all devices (to avoid confusion)
            return {
              type: "simple-marker",
              style: "circle",
              color: "#38bdf8",
              size: selected ? 14 : 11,
              outline: { color: "#ffffff", width: selected ? 2.5 : 1.5 }
            };
          }

          function clearSelection(){
            if (selectedGraphic){
              const t = selectedGraphic.attributes.__type;
              selectedGraphic.symbol = markerSymbol(t, false);
              selectedGraphic = null;
            }
          }

          function focusGraphicInternal(g, openPopup){
            if (!g) return;
            if (selectedGraphic && selectedGraphic !== g){
              const tPrev = selectedGraphic.attributes.__type;
              selectedGraphic.symbol = markerSymbol(tPrev, false);
            }
            selectedGraphic = g;
            g.symbol = markerSymbol(g.attributes.__type, true);

            view.goTo({ target: g.geometry, zoom: Math.max(view.zoom, 15) }, { duration: 450 }).then(()=>{
              if (openPopup) view.openPopup({ features:[g], location:g.geometry });
            });
          }

          function setMyLocation(lat, lon, accuracyMeters){
            myLayer.removeAll();
            const pt = new Point({ latitude: lat, longitude: lon, spatialReference: { wkid: 4326 } });

            const me = new Graphic({
              geometry: pt,
              symbol: {
                type:"simple-marker",
                style:"circle",
                color:"#22c55e",
                size:14,
                outline:{ color:"#ffffff", width:2.5 }
              },
              popupTemplate: {
                title: "My Location",
                content: () => `<div style="font-size:12px;"><strong>Lat/Lon:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}<br/><strong>Accuracy:</strong> ${Math.round(accuracyMeters || 0)} m</div>`
              }
            });
            myLayer.add(me);

            const acc = Math.max(10, Math.min(accuracyMeters || 50, 250));
            const circle = geometryEngine.geodesicBuffer(pt, acc, "meters");
            const accG = new Graphic({
              geometry: circle,
              symbol: {
                type: "simple-fill",
                color: [34,197,94,0.12],
                outline: { color: [34,197,94,0.75], width: 2 }
              }
            });
            myLayer.add(accG);
          }

          window.__GIS__ = {
            Graphic,
            PopupTemplate,
            Point,
            markerSymbol,
            clearSelection,
            focusGraphicInternal,
            setMyLocation
          };
            const collapsed = panel.classList.toggle("is-collapsed");

          view.on("click", (evt) => {
            view.hitTest(evt).then((res)=>{
              const hits = res.results || [];
              const devHit = hits.find(h => h.graphic && h.graphic.layer && h.graphic.layer.id === "devicesLayer");
              if (!devHit) clearSelection();
            });
          });

          resolve();
        }, (err)=>{
          reject(err || new Error("ArcGIS require() failed."));
        });
      });
    }

    function refreshMapGraphics(rows){
      if (!devicesLayer || !window.__GIS__) return;

      devicesLayer.removeAll();
      deviceGraphicsByKey.clear();
      window.__GIS__.clearSelection();
      skippedNoCoords = 0;

      if (!rows.length){
        $("mapFooterLeft").textContent = "Map is constrained to Qatar extent. Use “Layers” to toggle boundaries/areas. Use “Locate Me” to center on current position.";
        return;
      }

      // Best-match keys for coords/types based on actual headers present
      const latKey = getFirstKey(rows[0], ["Latitude WGS84","Latitude_WGS84","Latitude","LATITUDE","lat"]);
      const lonKey = getFirstKey(rows[0], ["Longitude WGS84","Longitude_WGS84","Longitude","LONGITUDE","lon","LON"]);
      const gfcKey = getFirstKey(rows[0], ["GFCODE","gfcode","Gfcode"]);

      require(["esri/Graphic","esri/geometry/Point","esri/PopupTemplate"], (Graphic, Point, PopupTemplate)=>{
        for (const r of rows){
          const lat = toNumberMaybe(latKey ? r[latKey] : null);
          const lon = toNumberMaybe(lonKey ? r[lonKey] : null);
          if (lat === null || lon === null){
            skippedNoCoords++;
            continue;
          }

          const type = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
          const pt = new Point({ latitude: lat, longitude: lon, spatialReference: { wkid: 4326 } });

          const g = new Graphic({
            geometry: pt,
            symbol: window.__GIS__.markerSymbol(type, false),
            attributes: { __key: buildDeviceKey(r), __type: type },
            popupTemplate: new PopupTemplate({
              title: "{__type}",
              content: () => buildPopupHTML(r)
            })
          });

          devicesLayer.add(g);
          // Note: duplicates overwrite the lookup map, but graphics still display
          deviceGraphicsByKey.set(buildDeviceKey(r), g);
        }

        $("mapFooterLeft").textContent =
          skippedNoCoords > 0
            ? `Map is constrained to Qatar extent. Skipped ${skippedNoCoords} row(s) with missing/invalid coordinates.`
            : "Map is constrained to Qatar extent. Use “Layers” to toggle boundaries/areas. Use “Locate Me” to center on current position.";
      });
    }

    function focusGraphic(g, openPopup){
      if (window.__GIS__ && typeof window.__GIS__.focusGraphicInternal === "function"){
        window.__GIS__.focusGraphicInternal(g, openPopup);
      }
    }

    // ===================== GEOLOCATION =====================
    function locateMe(){
      if (!navigator.geolocation){
        alert("Geolocation is not supported in this browser.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy || 50;
          if (window.__GIS__ && typeof window.__GIS__.setMyLocation === "function"){
            window.__GIS__.setMyLocation(lat, lon, acc);
          }
          if (view){
            view.goTo({ center:[lon,lat], zoom: Math.max(view.zoom, 15) }, { duration: 450 });
          }
        },
        ()=>{
          alert("Unable to get your location. Please allow location permissions and try again.");
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:8000 }
      );
    }

    // ===================== EXPORT (CSV + PDF) =====================
    function csvEscape(val){
      const s = sanitize(val);
      const needs = /[",\n\r]/.test(s);
      const out = s.replace(/"/g, '""');
      return needs ? `"${out}"` : out;
    }
    function buildCSV(rows){
      const lines = [];
      lines.push(headers.map(csvEscape).join(","));
      for (const r of rows){
        lines.push(headers.map(h => csvEscape(r[h])).join(","));
      }
      return lines.join("\n");
    }
    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function loadScript(url){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error("Failed to load: " + url));
        document.head.appendChild(s);
      });
    }

    async function ensurePdfLibs(){
      // Critical: ArcGIS uses AMD (dojo). Force UMD libs to attach to window.
      const savedDefine = window.define;
      const savedRequire = window.require;
      try{
        window.define = undefined;
        // keep window.require (ArcGIS) intact, but UMD libs mainly look for define/define.amd
        if (!jsPDF){
          await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
          jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
          if (!jsPDF) throw new Error("jsPDF library did not initialize.");
        }
        if (!autoTableLoaded){
          await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js");
          autoTableLoaded = true;
        }
      } finally {
        window.define = savedDefine;
        window.require = savedRequire;
      }
    }

    function exportCSV(){
      const rows = filteredRows.length ? filteredRows : rawRows;
      if (!headers.length) return;
      const csv = buildCSV(rows);
      downloadBlob(new Blob([csv], { type:"text/csv;charset=utf-8" }), `ITS_Field_Operations_${Date.now()}.csv`);
    }

    async function exportPDF(){
      const rows = filteredRows.length ? filteredRows : rawRows;
      if (!headers.length) return;
      try{
        await ensurePdfLibs();

        const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

        doc.setFont("helvetica","bold");
        doc.setFontSize(14);
        doc.text("ITS Field Operations Dashboard - Export", 40, 36);

        doc.setFont("helvetica","normal");
        doc.setFontSize(10);
        doc.text(`Exported: ${nowString()}`, 40, 52);
        doc.text(`Rows: ${rows.length}`, 40, 66);

        const body = rows.map(r => headers.map(h => sanitize(r[h])));

        const at = doc.autoTable || (doc.constructor && doc.constructor.API && doc.constructor.API.autoTable);
        if (!at) throw new Error("PDF table engine not available (autoTable).");

        (doc.autoTable ? doc.autoTable.bind(doc) : doc.constructor.API.autoTable.bind(doc))({
          head: [headers],
          body,
          startY: 80,
          styles: { fontSize: 7, cellPadding: 3, overflow: "linebreak" },
          headStyles: { fontStyle: "bold" },
          theme: "grid",
          margin: { left: 24, right: 24 }
        });

        downloadBlob(doc.output("blob"), `ITS_Field_Operations_${Date.now()}.pdf`);
      }catch(err){
        alert("PDF export failed: " + (err?.message || err));
      }
    }

    // ===================== EVENTS =====================
    function bindEvents(){
      $("globalSearch").addEventListener("input", debounce(applyFilters, 120));
      $("typeFilter").addEventListener("change", applyFilters);
      $("locateBtn").addEventListener("click", locateMe);

      $("clearBtn").addEventListener("click", ()=>{
        $("globalSearch").value = "";
        $("typeFilter").value = "__ALL__";
        applyFilters();
        if (window.__GIS) window.__GIS.clearSelection();
      });

      $("reloadBtn").addEventListener("click", loadCSV);

      $("exportCsvBtn").addEventListener("click", exportCSV);
      $("exportPdfBtn").addEventListener("click", exportPDF);
    }

    // ===================== CLOCK =====================
    function initClock(){
      const el = $("currentDateTime");
      const tick = ()=> el.textContent = nowString();
      tick();
      setInterval(tick, 1000);
    }

    // ===================== BOOT =====================
    (async function boot(){
      initTheme();
      initClock();
      bindEvents();

      try{
        await initMap();
      }catch(err){
        setStatus(false, "Map error");
        $("hintText").textContent = "Map failed to initialize. Check if js.arcgis.com is blocked. Error: " + (err?.message || err);
        return;
      }

      loadCSV();
    })();
  </script>
</body>
</html>