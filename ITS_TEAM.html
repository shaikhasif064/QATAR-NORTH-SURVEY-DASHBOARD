<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ITS Field Operations â€” ESRI Map + Table</title>

  <!-- ArcGIS JS API (ESRI) -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/dark/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#0b1120;
      --glass:rgba(15,23,42,.82);
      --glass2:rgba(15,23,42,.92);
      --border:rgba(148,163,184,.35);
      --border2:rgba(148,163,184,.55);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --muted2:#6b7280;
      --accent:#38bdf8;
      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#ef4444;
      --shadow:0 22px 55px rgba(15,23,42,.75);
      --radius:18px;
      --radius2:14px;
      --fast:180ms cubic-bezier(.22,.61,.36,1);
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    html,body{ height:100%; }
    body{
      min-height:100vh;
      color:var(--text);
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.22), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(168,85,247,.18), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249,115,22,.14), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(236,72,153,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg0) 100%);
      background-attachment: fixed;
    }

    .shell{
      max-width: 1900px;
      margin: 0 auto;
      padding: 12px 16px 18px;
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header{
      border-radius: 20px;
      padding: 10px 16px;
      background:
        linear-gradient(135deg, rgba(15,23,42,.97), rgba(15,23,42,.92)),
        linear-gradient(90deg, rgba(56,189,248,.25), rgba(168,85,247,.22), rgba(236,72,153,.18));
      box-shadow: 0 24px 60px rgba(15,23,42,.85), 0 0 0 1px rgba(148,163,184,.25);
      border: 1px solid rgba(148,163,184,.25);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .hdr-title{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .hdr-title h1{
      font-size: clamp(16px, 1.8vw, 22px);
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#f9fafb;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hdr-title .sub{
      font-size: 11px;
      color: var(--muted);
      letter-spacing:.05em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.45);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.14), transparent 60%),
        rgba(15,23,42,.82);
      color: var(--text);
      box-shadow: 0 14px 34px rgba(15,23,42,.65);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--ok));
      box-shadow: 0 0 12px rgba(56,189,248,.75);
      flex:0 0 auto;
    }

    .card{
      background:
        radial-gradient(circle at top left, rgba(248,250,252,.12), transparent 42%),
        linear-gradient(145deg, rgba(15,23,42,.96), rgba(15,23,42,.9));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
    }

    .toolbar{
      padding: 10px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(148,163,184,.18);
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      flex: 1 1 auto;
      min-width: 260px;
    }

    .control{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 260px;
      flex: 1 1 260px;
    }
    .control label{
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      padding-left: 2px;
    }
    .control input, .control select{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.6);
      background:
        radial-gradient(circle at 0 0, rgba(248,250,252,.06), transparent 60%),
        rgba(15,23,42,.92);
      color: var(--text);
      outline:none;
      transition: border-color var(--fast), box-shadow var(--fast), transform var(--fast);
      font-size: 12px;
    }
    .control input::placeholder{ color: rgba(148,163,184,.9); }
    .control input:focus, .control select:focus{
      border-color: rgba(56,189,248,.9);
      box-shadow: 0 0 0 1px rgba(56,189,248,.7);
      transform: translateY(-1px);
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex: 0 0 auto;
    }

    .btn{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.55);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.14), transparent 60%),
        rgba(15,23,42,.92);
      color: var(--text);
      cursor:pointer;
      transition: transform var(--fast), box-shadow var(--fast), border-color var(--fast), filter var(--fast);
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{
      border-color: rgba(56,189,248,.9);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.28), transparent 60%),
        linear-gradient(135deg, rgba(37,99,235,.92), rgba(56,189,248,.88));
      color:#ecfeff;
      box-shadow: 0 16px 35px rgba(30,64,175,.75);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(248,250,252,.55); filter:brightness(1.03); }
    .btn:active{ transform: translateY(0); filter:brightness(0.98); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .status{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      color: var(--muted);
      font-size: 12px;
      padding-right: 2px;
    }

    .cards{
      padding: 10px 12px 0;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:stretch;
    }
    .fcard{
      flex: 1 1 220px;
      min-width: 220px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.28);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.14), transparent 60%),
        rgba(15,23,42,.88);
      box-shadow: 0 16px 40px rgba(15,23,42,.72);
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .fcard .k{
      font-size: 10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      line-height:1.2;
    }
    .fcard .v{
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.02em;
      color: #f9fafb;
      line-height:1;
    }
    .sw{
      width: 10px; height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(248,250,252,.7);
      box-shadow: 0 0 12px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .fcard .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .fcard .txt{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    #viewDiv{
      width:100%;
      height: 56vh;
      min-height: 380px;
      margin: 10px 12px 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border2);
      box-shadow: 0 16px 40px rgba(15,23,42,.9);
      overflow:hidden;
    }

    .legend-host{
      margin: 0 12px 12px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(15,23,42,.86);
      box-shadow: 0 16px 40px rgba(15,23,42,.75);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .legend-host .title{
      font-size: 11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: var(--muted);
      white-space:nowrap;
    }
    .legend-items{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex: 1 1 auto;
    }
    .legend-item{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(3,7,18,.55);
      font-size: 12px;
      color: var(--text);
      white-space:nowrap;
    }

    .table-head{
      padding: 10px 12px 8px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-top: 1px solid rgba(148,163,184,.12);
      border-bottom: 1px solid rgba(148,163,184,.18);
    }
    .table-head .t1{
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .table-head .t2{
      margin-top: 3px;
      font-size: 11px;
      color: var(--muted2);
    }

    .table-scroll{
      margin: 10px 12px 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(55,65,81,.9);
      background:
        radial-gradient(circle at top left, rgba(15,23,42,.9), rgba(3,7,18,.98));
      box-shadow: 0 18px 45px rgba(15,23,42,.92);
      overflow:auto;
      max-height: 42vh;
      min-height: 240px;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      color: var(--text);
    }
    thead{
      position: sticky;
      top:0;
      z-index: 2;
    }
    th, td{
      padding: 7px 9px;
      border-bottom: 1px solid rgba(31,41,55,.9);
      text-align:left;
      white-space: nowrap;
      vertical-align: middle;
    }
    th{
      background: linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.95));
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .10em;
      font-size: 10px;
      color: var(--muted);
    }
    tbody tr:nth-child(even){ background: rgba(15,23,42,.78); }
    tbody tr:nth-child(odd){ background: rgba(3,7,18,.96); }
    tbody tr:hover{
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.16), transparent 55%),
        rgba(3,7,18,.98);
      cursor:pointer;
      transition: background var(--fast);
    }
    tbody tr.is-active{
      outline: 2px solid rgba(56,189,248,.55);
      outline-offset: -2px;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.22), transparent 55%),
        rgba(3,7,18,.98);
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    .toast{
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.45);
      background: rgba(15,23,42,.92);
      box-shadow: 0 18px 50px rgba(15,23,42,.85);
      color: var(--text);
      max-width: 720px;
      display:none;
      gap: 10px;
      align-items:flex-start;
      cursor:pointer;
    }
    .toast.show{ display:flex; }
    .toast .t-dot{
      width:10px; height:10px; border-radius:999px; margin-top: 3px;
      background: var(--warn);
      box-shadow: 0 0 12px rgba(251,191,36,.7);
      flex:0 0 auto;
    }
    .toast .t-msg{ font-size: 12px; color: var(--text); }
    .toast .t-sub{ margin-top: 2px; font-size: 11px; color: var(--muted); }

    @media (max-width: 520px){
      .shell{ padding: 10px 10px 16px; }
      header{ padding: 10px 12px; border-radius: 16px; }
      .pill{ display:none; }
      #viewDiv{ height: 50vh; min-height: 320px; }
      .table-scroll{ max-height: 45vh; }
    }

    /* ArcGIS UI tweaks */
    .esri-ui .esri-widget, .esri-ui .esri-component{
      border-radius: 14px !important;
      background: rgba(15,23,42,.92) !important;
      border: 1px solid rgba(148,163,184,.25) !important;
      color: var(--text) !important;
      box-shadow: 0 18px 45px rgba(15,23,42,.85) !important;
    }
    .esri-popup__main-container{
      border-radius: 14px !important;
      background: rgba(15,23,42,.95) !important;
      border: 1px solid rgba(148,163,184,.25) !important;
      color: var(--text) !important;
      box-shadow: 0 18px 45px rgba(15,23,42,.85) !important;
    }
    .esri-popup__header-title, .esri-popup__header-title:hover{
      color: #f9fafb !important;
      letter-spacing:.08em !important;
      text-transform: uppercase !important;
      font-weight: 800 !important;
      font-size: 12px !important;
    }
    .esri-popup__content{
      color: var(--text) !important;
      font-size: 12px !important;
    }
    .esri-popup__footer, .esri-popup__button{
      color: var(--text) !important;
    }
    .popup-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .popup-actions a{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 30px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.55);
      background: rgba(15,23,42,.9);
      color: var(--text);
      font-size: 11px;
      transition: transform var(--fast), border-color var(--fast), filter var(--fast);
      user-select:none;
    }
    .popup-actions a:hover{ transform: translateY(-1px); filter:brightness(1.03); border-color: rgba(248,250,252,.55); }
    .popup-actions a.gm{ border-color: rgba(56,189,248,.75); }
    .popup-actions a.wz{ border-color: rgba(34,197,94,.65); }
    .kv{
      display:grid;
      grid-template-columns: auto 1fr;
      gap: 3px 10px;
      font-size: 12px;
    }
    .kv .k{ color: var(--muted); font-size: 10px; letter-spacing:.10em; text-transform: uppercase; }
    .kv .v{ color: var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <div class="pill" title="Field Mode">
        <span class="dot"></span>
        <span>Field Navigation</span>
      </div>

      <div class="hdr-title">
        <h1>ITS Field Operations Dashboard</h1>
        <div class="sub">ESRI map + device-type pins + legend + global search + filter + my location</div>
      </div>

      <div class="pill" title="Live CSV from Google Sheets">
        <span class="dot"></span>
        <span id="lastSync">Not loaded</span>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <div class="controls">
          <div class="control">
            <label for="q">Global Search (IP / logic id / any field)</label>
            <input id="q" type="text" placeholder="Type to search across all columns..." autocomplete="off" />
          </div>

          <div class="control">
            <label for="gcode">Filter by GFCODE (Device Type)</label>
            <select id="gcode">
              <option value="__ALL__">All Types</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="locateBtn" type="button">Locate Me</button>
          <button class="btn" id="fitBtn" type="button">Fit Filtered</button>
          <button class="btn" id="reloadBtn" type="button">Reload</button>
        </div>

        <div class="status" aria-live="polite">
          <span id="countLabel">0 devices</span>
          <span id="csvState"></span>
        </div>
      </div>

      <div class="cards" id="cards">
        <!-- Flash cards injected here -->
      </div>

      <div id="viewDiv"></div>

      <div class="legend-host">
        <div class="title">Legend</div>
        <div class="legend-items" id="legendItems"></div>
      </div>

      <div class="table-head">
        <div>
          <div class="t1">All Data (from Excel/CSV)</div>
          <div class="t2">Tap a row to zoom to the device and open popup (Google/Waze available inside popup only).</div>
        </div>
      </div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" title="Click to dismiss">
    <div class="t-dot"></div>
    <div>
      <div class="t-msg" id="toastMsg">Message</div>
      <div class="t-sub" id="toastSub"></div>
    </div>
  </div>

  <script>
    // UPDATED CSV LINK (your latest)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSKAtXDwzYQCNXtLlFOz5fkof4kCLCtzkf7GokGaINUmrurF7CFPbsm6bF8HXXV3MA8PyfYOzMVK8Q/pub?gid=223122268&single=true&output=csv";

    const $ = (id) => document.getElementById(id);

    function showToast(msg, sub = "", kind = "warn") {
      const t = $("toast");
      const dot = t.querySelector(".t-dot");
      const colors = { ok:"var(--ok)", warn:"var(--warn)", bad:"var(--bad)", info:"var(--accent)" };
      const c = colors[kind] || colors.warn;
      dot.style.background = c;
      dot.style.boxShadow = `0 0 12px ${c}`;
      $("toastMsg").textContent = msg;
      $("toastSub").textContent = sub || "";
      t.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => t.classList.remove("show"), 4200);
    }

    function nowStamp() {
      const d = new Date();
      return d.toLocaleString("en-US", {
        year:"numeric", month:"short", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }

    function canonicalHeader(h) {
      return String(h ?? "")
        .trim()
        .toLowerCase()
        .replaceAll(/\s+/g, " ")
        .replaceAll(/[\u200B-\u200D\uFEFF]/g, "")
        .replaceAll(/[()]/g, "")
        .replaceAll(/[._-]/g, " ")
        .replaceAll(/\s+/g, " ")
        .trim();
    }

    function cleanValue(v) {
      if (v === null || v === undefined) return "";
      return String(v).replaceAll(/\u00A0/g, " ").trim().replaceAll(/\s+/g, " ");
    }

    function displayValue(v) {
      const s = cleanValue(v);
      if (!s || s.toLowerCase() === "nan") return "N/A";
      return s;
    }

    function parseNum(v) {
      const s = cleanValue(v);
      if (!s) return null;
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : null;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function gmapsLink(lat, lon) {
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat)},${encodeURIComponent(lon)}`;
    }
    function wazeLink(lat, lon) {
      return `https://waze.com/ul?ll=${encodeURIComponent(lat)},${encodeURIComponent(lon)}&navigate=yes`;
    }

    // Color mapping by device type (GFCODE keyword-based; extend as needed)
    function typeColor(gcode) {
      const s = cleanValue(gcode).toUpperCase();
      if (!s) return "#94a3b8";
      if (s.includes("CCTV")) return "#38bdf8";
      if (s.includes("PTZ")) return "#22c55e";
      if (s.includes("LPR")) return "#a855f7";
      if (s.includes("DMS")) return "#f97316";
      if (s.includes("LCS")) return "#ec4899";
      if (s.includes("RWIS")) return "#fbbf24";
      if (s.includes("RVD") || s.includes("VIVD") || s.includes("VID")) return "#60a5fa";
      if (s.includes("AQ") || s.includes("AQM")) return "#34d399";
      if (s.includes("WIM")) return "#fb7185";
      if (s.includes("MAG")) return "#c084fc";
      if (s.includes("OVD") || s.includes("OVERHEIGHT")) return "#f59e0b";
      return "#94a3b8";
    }

    function normalizeType(gcode) {
      // Use raw GFCODE if present; otherwise "UNKNOWN"
      const s = cleanValue(gcode);
      return s ? s : "UNKNOWN";
    }

    // State
    let rawHeaders = [];
    let headerMap = new Map();      // canonical -> original label
    let allRows = [];
    let filteredRows = [];
    let activeKey = null;

    // ArcGIS objects
    let view, map, devicesLayer, myLayer;
    let deviceGraphicsByKey = new Map();

    // My location objects
    let myPointGraphic = null;
    let myCircleGraphic = null;

    function buildHeaderMap(headers) {
      headerMap.clear();
      rawHeaders = [];
      for (const h of headers) {
        const label = cleanValue(h);
        if (!label) continue;
        rawHeaders.push(label);
        headerMap.set(canonicalHeader(label), label);
      }
    }

    function getAny(rawRow, names) {
      for (const n of names) {
        const key = canonicalHeader(n);
        const orig = headerMap.get(key);
        if (orig && Object.prototype.hasOwnProperty.call(rawRow, orig)) {
          const val = cleanValue(rawRow[orig]);
          if (val !== "") return val;
        }
        if (Object.prototype.hasOwnProperty.call(rawRow, n)) {
          const val2 = cleanValue(rawRow[n]);
          if (val2 !== "") return val2;
        }
      }
      return "";
    }

    function buildKey(r) {
      const id = cleanValue(r._id) || "NO_ID";
      const tag = cleanValue(r._assettag) || "NO_TAG";
      const lat = r._lat ?? "NO_LAT";
      const lon = r._lon ?? "NO_LON";
      return `${id}||${tag}||${lat}||${lon}||${r._rowIndex}`;
    }

    function normalizeRow(raw, rowIndex) {
      const obj = { _raw: {}, _rowIndex: rowIndex };

      for (const h of rawHeaders) obj._raw[h] = cleanValue(raw[h]);

      const latVal = getAny(obj._raw, ["Latitude (WGS84)", "Latitude WGS84", "Latitude", "Lat", "LAT"]);
      const lonVal = getAny(obj._raw, ["Longitude (WGS84)", "Longitude WGS84", "Longitude", "Lon", "LON", "Lng", "Long"]);
      const lat = parseNum(latVal);
      const lon = parseNum(lonVal);

      obj._lat = lat;
      obj._lon = lon;
      obj._hasCoords = (lat !== null && lon !== null);

      obj._id = getAny(obj._raw, ["ID", "Id", "id"]);
      obj._gcode = getAny(obj._raw, ["GFCODE", "Gfcode", "Asset Type", "Device Type"]);
      obj._assettag = getAny(obj._raw, ["ASSETTAG", "ASSET_TAG", "Asset Tag", "AssetTag", "asset tag"]);
      obj._desc = getAny(obj._raw, ["DESCRIPTION", "Description", "desc", "Name"]);
      obj._ip = getAny(obj._raw, ["IP Address", "IP", "IPAddress", "IPADDRESS"]);
      obj._logicId = getAny(obj._raw, ["logic id", "Logic ID", "Logic id", "LogicId"]);
      obj._projectId = getAny(obj._raw, ["Project id", "Project ID", "ProjectId"]);
      obj._cameraId = getAny(obj._raw, ["Camera ID", "Camera Id", "CameraId"]);

      const parts = [];
      for (const h of rawHeaders) parts.push(cleanValue(obj._raw[h]).toLowerCase());
      obj._searchIndex = parts.join(" | ");

      obj._type = normalizeType(obj._gcode);
      obj._key = buildKey(obj);

      return obj;
    }

    function buildTableHeader() {
      const tr = $("theadRow");
      tr.innerHTML = "";
      for (const h of rawHeaders) {
        const th = document.createElement("th");
        th.textContent = h;
        tr.appendChild(th);
      }
    }

    function renderTable(rows) {
      const tb = $("tbody");
      tb.innerHTML = "";

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.dataset.key = r._key;

        for (const h of rawHeaders) {
          const td = document.createElement("td");
          const val = displayValue(r._raw[h]);
          td.textContent = val;
          if (val !== "N/A" && String(val).length > 24) td.title = val;

          const hc = canonicalHeader(h);
          if (hc.includes("ip") || hc.includes("id") || hc.includes("asset") || hc.includes("mxasset") || hc.includes("sr no") || hc.includes("logic") || hc.includes("project") || hc.includes("camera")) {
            td.classList.add("mono");
          }
          tr.appendChild(td);
        }

        tr.addEventListener("click", () => {
          setActiveRow(r._key, true);
          if (!r._hasCoords) {
            showToast("No coordinates for this row.", "Add Latitude/Longitude later; it will appear on the map after reload.", "warn");
            return;
          }
          const g = deviceGraphicsByKey.get(r._key);
          if (g) {
            view.goTo({ target: g.geometry, zoom: Math.max(view.zoom, 16) }, { duration: 500 });
            view.popup.open({
              features: [g],
              location: g.geometry
            });
          }
        });

        tb.appendChild(tr);
      }

      if (activeKey) setActiveRow(activeKey, false);
    }

    function setActiveRow(key, scrollIntoView = true) {
      activeKey = key;
      const rows = document.querySelectorAll("#tbody tr");
      for (const r of rows) r.classList.toggle("is-active", r.dataset.key === key);
      if (scrollIntoView) {
        const r = document.querySelector(`#tbody tr[data-key="${CSS.escape(key)}"]`);
        if (r) r.scrollIntoView({ block:"nearest", behavior:"smooth" });
      }
    }

    function populateGcodeOptions() {
      const sel = $("gcode");
      const current = sel.value;

      const codes = Array.from(new Set(allRows.map(r => cleanValue(r._type)).filter(Boolean)))
        .sort((a,b) => a.localeCompare(b, undefined, { sensitivity:"base" }));

      sel.innerHTML = `<option value="__ALL__">All Types</option>`;
      for (const c of codes) {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      }

      if ([...sel.options].some(o => o.value === current)) sel.value = current;
    }

    function applyFilters() {
      const q = cleanValue($("q").value).toLowerCase();
      const g = $("gcode").value;

      filteredRows = allRows.filter(r => {
        if (g !== "__ALL__" && cleanValue(r._type) !== g) return false;
        if (q) return r._searchIndex.includes(q);
        return true;
      });

      $("countLabel").textContent = `${filteredRows.length} devices`;
      renderCards(filteredRows);
      renderLegendFromData(filteredRows);
      renderTable(filteredRows);
      renderGraphics(filteredRows);
    }

    function renderCards(rows) {
      // Total + each type counts
      const counts = new Map();
      for (const r of rows) {
        const t = cleanValue(r._type) || "UNKNOWN";
        counts.set(t, (counts.get(t) || 0) + 1);
      }

      const sorted = Array.from(counts.entries()).sort((a,b) => b[1] - a[1]);

      const cards = $("cards");
      cards.innerHTML = "";

      // Total card
      const totalCard = document.createElement("div");
      totalCard.className = "fcard";
      totalCard.innerHTML = `
        <div class="left">
          <span class="sw" style="background:linear-gradient(135deg,var(--accent),var(--ok));"></span>
          <div class="txt">
            <div class="k">Total Devices</div>
            <div class="v">${rows.length}</div>
          </div>
        </div>
        <div class="k">Filtered</div>
      `;
      cards.appendChild(totalCard);

      // Type cards (cap to keep clean on mobile; still shows key info)
      const cap = 10;
      const slice = sorted.slice(0, cap);
      for (const [type, n] of slice) {
        const c = typeColor(type);
        const el = document.createElement("div");
        el.className = "fcard";
        el.title = type;
        el.innerHTML = `
          <div class="left">
            <span class="sw" style="background:${c};"></span>
            <div class="txt">
              <div class="k">${escapeHtml(type)}</div>
              <div class="v">${n}</div>
            </div>
          </div>
          <div class="k">Count</div>
        `;
        cards.appendChild(el);
      }

      if (sorted.length > cap) {
        const more = document.createElement("div");
        more.className = "fcard";
        more.innerHTML = `
          <div class="left">
            <span class="sw" style="background:#94a3b8;"></span>
            <div class="txt">
              <div class="k">More types</div>
              <div class="v">+${sorted.length - cap}</div>
            </div>
          </div>
          <div class="k">Scroll legend</div>
        `;
        cards.appendChild(more);
      }
    }

    function renderLegendFromData(rows) {
      // Legend: show unique types in current filtered set (and My Location)
      const types = Array.from(new Set(rows.map(r => cleanValue(r._type)).filter(Boolean)))
        .sort((a,b) => a.localeCompare(b, undefined, { sensitivity:"base" }));

      const host = $("legendItems");
      host.innerHTML = "";

      // My location legend item
      const myItem = document.createElement("div");
      myItem.className = "legend-item";
      myItem.innerHTML = `<span class="sw" style="background:linear-gradient(135deg,#22c55e,#38bdf8);"></span> My Location`;
      host.appendChild(myItem);

      for (const t of types) {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `<span class="sw" style="background:${typeColor(t)};"></span> ${escapeHtml(t)}`;
        host.appendChild(item);
      }
    }

    // ArcGIS: build popup HTML
    function popupContentForRow(r) {
      const lat = r._lat, lon = r._lon;

      const id = displayValue(r._id);
      const gcode = displayValue(r._gcode);
      const tag = displayValue(r._assettag);
      const desc = displayValue(r._desc);
      const ip = displayValue(r._ip);
      const logicId = displayValue(r._logicId);
      const projectId = displayValue(r._projectId);
      const camId = displayValue(r._cameraId);

      const coord = (r._hasCoords) ? `${lat.toFixed(6)}, ${lon.toFixed(6)}` : "N/A";

      const gm = (r._hasCoords) ? gmapsLink(lat, lon) : "";
      const wz = (r._hasCoords) ? wazeLink(lat, lon) : "";

      return `
        <div class="kv">
          <div class="k">ID</div><div class="v mono">${escapeHtml(id)}</div>
          <div class="k">GFCODE</div><div class="v">${escapeHtml(gcode)}</div>
          <div class="k">ASSETTAG</div><div class="v mono">${escapeHtml(tag)}</div>
          <div class="k">DESC</div><div class="v" title="${escapeHtml(desc)}">${escapeHtml(desc)}</div>
          <div class="k">IP</div><div class="v mono">${escapeHtml(ip)}</div>
          <div class="k">LOGIC ID</div><div class="v mono">${escapeHtml(logicId)}</div>
          <div class="k">PROJECT</div><div class="v mono">${escapeHtml(projectId)}</div>
          <div class="k">CAMERA ID</div><div class="v mono">${escapeHtml(camId)}</div>
          <div class="k">COORD</div><div class="v mono">${escapeHtml(coord)}</div>
        </div>
        <div class="popup-actions">
          ${r._hasCoords ? `<a class="gm" href="${gm}" target="_blank" rel="noopener">Open in Google Maps</a>` : ``}
          ${r._hasCoords ? `<a class="wz" href="${wz}" target="_blank" rel="noopener">Open in Waze</a>` : ``}
        </div>
      `;
    }

    // ArcGIS init
    function initEsri() {
      return new Promise((resolve) => {
        require([
          "esri/Map",
          "esri/views/MapView",
          "esri/layers/GraphicsLayer",
          "esri/Graphic",
          "esri/geometry/Point",
          "esri/geometry/Circle",
          "esri/geometry/Extent",
          "esri/core/reactiveUtils"
        ], (Map, MapView, GraphicsLayer, Graphic, Point, Circle, Extent, reactiveUtils) => {

          map = new Map({
            basemap: "hybrid" // Esri imagery with labels
          });

          devicesLayer = new GraphicsLayer({ title: "Devices" });
          myLayer = new GraphicsLayer({ title: "My Location" });

          map.addMany([devicesLayer, myLayer]);

          view = new MapView({
            container: "viewDiv",
            map,
            center: [51.45, 25.30],
            zoom: 9,
            popup: {
              dockEnabled: false
            }
          });

          // Improve UX: highlight row when popup opens
          view.popup.watch("selectedFeature", (f) => {
            if (!f || !f.attributes) return;
            const key = f.attributes.__key;
            if (key) setActiveRow(key, true);
          });

          // Expose constructors we need in other functions
          window.__ESRI__ = { Graphic, Point, Circle, Extent };

          resolve();
        });
      });
    }

    function clearGraphics() {
      devicesLayer.removeAll();
      deviceGraphicsByKey.clear();
    }

    function makeDeviceSymbol(color) {
      return {
        type: "simple-marker",
        style: "circle",
        color: color,
        size: 10,
        outline: { color: [255,255,255,0.85], width: 1.5 }
      };
    }

    function makeMyLocationSymbol() {
      return {
        type: "simple-marker",
        style: "circle",
        color: [34,197,94,1],  // green
        size: 12,
        outline: { color: [56,189,248,0.95], width: 2 }
      };
    }

    function makeMyCircleSymbol() {
      return {
        type: "simple-fill",
        color: [34,197,94,0.14],
        outline: { color: [34,197,94,0.85], width: 2 }
      };
    }

    function renderGraphics(rows) {
      if (!view) return;
      clearGraphics();

      const { Graphic, Point } = window.__ESRI__;

      let mapped = 0;
      const pts = [];

      for (const r of rows) {
        if (!r._hasCoords) continue;

        const p = new Point({ longitude: r._lon, latitude: r._lat });
        pts.push(p);

        const sym = makeDeviceSymbol(typeColor(r._type));
        const g = new Graphic({
          geometry: p,
          symbol: sym,
          attributes: {
            __key: r._key,
            ID: r._id || "",
            GFCODE: r._gcode || "",
            ASSETTAG: r._assettag || "",
            DESCRIPTION: r._desc || "",
            IP: r._ip || "",
            LOGIC_ID: r._logicId || "",
            PROJECT_ID: r._projectId || "",
            CAMERA_ID: r._cameraId || "",
            LAT: r._lat,
            LON: r._lon
          },
          popupTemplate: {
            title: "{GFCODE}",
            content: popupContentForRow(r)
          }
        });

        devicesLayer.add(g);
        deviceGraphicsByKey.set(r._key, g);
        mapped++;
      }

      // Fit to filtered points
      if (pts.length) {
        view.goTo(pts, { duration: 450 }).catch(() => {});
      }

      return mapped;
    }

    function fitFiltered() {
      const pts = filteredRows.filter(r => r._hasCoords).map(r => deviceGraphicsByKey.get(r._key)?.geometry).filter(Boolean);
      if (!pts.length) {
        showToast("No mapped devices to fit.", "Filtered rows have no valid coordinates.", "warn");
        return;
      }
      view.goTo(pts, { duration: 450 }).catch(() => {});
    }

    function setMyLocation(lat, lon, accuracyMeters) {
      if (!view) return;
      const { Graphic, Point, Circle } = window.__ESRI__;

      const p = new Point({ longitude: lon, latitude: lat });

      // My location pin
      if (!myPointGraphic) {
        myPointGraphic = new Graphic({
          geometry: p,
          symbol: makeMyLocationSymbol(),
          attributes: { __key: "__MY_LOCATION__" },
          popupTemplate: {
            title: "My Location",
            content: `<div class="kv">
              <div class="k">COORD</div><div class="v mono">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
              <div class="k">ACCURACY</div><div class="v mono">${Number.isFinite(accuracyMeters) ? Math.round(accuracyMeters) + " m" : "N/A"}</div>
            </div>`
          }
        });
        myLayer.add(myPointGraphic);
      } else {
        myPointGraphic.geometry = p;
      }

      // Accuracy circle
      if (Number.isFinite(accuracyMeters) && accuracyMeters > 0) {
        const circle = new Circle({
          center: p,
          radius: accuracyMeters,
          radiusUnit: "meters"
        });

        if (!myCircleGraphic) {
          myCircleGraphic = new Graphic({
            geometry: circle,
            symbol: makeMyCircleSymbol(),
            attributes: { __key: "__MY_CIRCLE__" }
          });
          myLayer.add(myCircleGraphic);
        } else {
          myCircleGraphic.geometry = circle;
        }
      }

      view.goTo({ target: p, zoom: Math.max(view.zoom, 16) }, { duration: 600 }).catch(() => {});
    }

    function locateMe() {
      if (!navigator.geolocation) {
        showToast("Geolocation not supported.", "Use a modern browser and allow location access.", "bad");
        return;
      }

      const btn = $("locateBtn");
      btn.disabled = true;
      btn.textContent = "Locating...";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;

          setMyLocation(lat, lon, acc);
          showToast("Location updated.", `Accuracy: ${Math.round(acc)} m`, "ok");

          btn.disabled = false;
          btn.textContent = "Locate Me";
        },
        (err) => {
          let sub = err && err.message ? err.message : "Check permissions and GPS availability.";
          if (err && err.code === 1) sub = "Permission denied. Enable location access for this page.";
          if (err && err.code === 2) sub = "Position unavailable. Try moving outdoors or enabling GPS.";
          if (err && err.code === 3) sub = "Timeout. Try again.";
          showToast("Unable to fetch location.", sub, "bad");

          btn.disabled = false;
          btn.textContent = "Locate Me";
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:15000 }
      );
    }

    function loadCsv() {
      $("csvState").textContent = "Loading...";
      $("lastSync").textContent = "Loading...";
      $("reloadBtn").disabled = true;

      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: async (res) => {
          const headers = res.meta && res.meta.fields ? res.meta.fields : [];
          if (!headers.length) {
            $("csvState").textContent = "No headers";
            $("lastSync").textContent = "Load failed";
            $("reloadBtn").disabled = false;
            showToast("CSV has no headers.", "Check the published sheet tab and CSV export.", "bad");
            return;
          }

          buildHeaderMap(headers);
          buildTableHeader();

          const rows = Array.isArray(res.data) ? res.data : [];
          allRows = [];
          let dropped = 0;

          for (let i = 0; i < rows.length; i++) {
            const r = normalizeRow(rows[i], i + 2);
            const anyVal = rawHeaders.some(h => cleanValue(r._raw[h]) !== "");
            if (!anyVal) { dropped++; continue; }
            allRows.push(r);
          }

          populateGcodeOptions();
          applyFilters();

          $("csvState").textContent = "";
          $("lastSync").textContent = `Synced: ${nowStamp()}`;
          $("reloadBtn").disabled = false;

          showToast("Devices loaded.", `${allRows.length} rows ready. (${dropped} empty rows ignored)`, "ok");
        },
        error: (err) => {
          $("csvState").textContent = "Load failed";
          $("lastSync").textContent = "Load failed";
          $("reloadBtn").disabled = false;
          showToast("Failed to load CSV.", err && err.message ? err.message : "Check network access.", "bad");
        }
      });
    }

    function wireEvents() {
      $("q").addEventListener("input", () => applyFilters());
      $("gcode").addEventListener("change", () => applyFilters());
      $("locateBtn").addEventListener("click", locateMe);
      $("fitBtn").addEventListener("click", fitFiltered);
      $("reloadBtn").addEventListener("click", () => loadCsv());
      $("toast").addEventListener("click", () => $("toast").classList.remove("show"));
    }

    (async function boot(){
      await initEsri();
      wireEvents();
      loadCsv();
    })();
  </script>
</body>
</html>