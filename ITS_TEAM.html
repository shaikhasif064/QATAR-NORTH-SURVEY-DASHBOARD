<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ITS Field Ops | Qatar North</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --primary: #0ea5e9;
            --dark-bg: #0f172a;
            --surface: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(148, 163, 184, 0.2);
            --google-maps: #34a853;
            --waze: #33ccff;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, system-ui, sans-serif; background: var(--dark-bg); color: var(--text); overflow: hidden; }

        /* LAYOUT */
        #map { height: 100vh; width: 100vw; z-index: 1; }

        /* SEARCH BAR OVERLAY */
        .overlay-controls {
            position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px; pointer-events: none;
        }
        .search-box {
            background: var(--surface); padding: 12px; border-radius: 12px;
            border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; gap: 8px; pointer-events: auto;
        }
        .search-box input {
            background: transparent; border: none; color: white; flex: 1; font-size: 16px; outline: none;
        }

        /* NAVIGATION BUTTONS */
        .nav-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .nav-btn {
            padding: 10px; border-radius: 8px; text-decoration: none; color: white;
            font-weight: bold; text-align: center; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-google { background: var(--google-maps); }
        .btn-waze { background: var(--waze); color: #000; }

        /* BOTTOM DRAWER (Mobile Optimized Table) */
        .drawer {
            position: absolute; bottom: 0; left: 0; right: 0; height: 40vh;
            background: var(--surface); z-index: 1001; border-top: 1px solid var(--border);
            transition: transform 0.3s ease; transform: translateY(calc(100% - 40px));
            display: flex; flex-direction: column;
        }
        .drawer.open { transform: translateY(0); }
        .drawer-handle {
            height: 40px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: var(--surface);
        }
        .drawer-handle::after {
            content: ''; width: 40px; height: 4px; background: var(--text-muted); border-radius: 2px;
        }
        .table-container { overflow-y: auto; flex: 1; padding: 0 15px 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px; color: var(--text-muted); position: sticky; top: 0; background: var(--surface); border-bottom: 1px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); }

        /* RE-CENTER BUTTON */
        .locate-btn {
            position: absolute; bottom: calc(40vh + 20px); right: 20px; z-index: 1000;
            background: var(--primary); width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            cursor: pointer; border: none;
        }

        /* POPUP STYLING */
        .leaflet-popup-content-wrapper { background: var(--surface); color: white; border: 1px solid var(--border); }
        .leaflet-popup-tip { background: var(--surface); }
        .data-row { margin-bottom: 5px; font-size: 12px; }
        .data-label { color: var(--text-muted); font-weight: bold; margin-right: 5px; text-transform: uppercase; font-size: 10px; }
    </style>
</head>
<body>

    <div class="overlay-controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search Asset Tag, ID, or Type...">
        </div>
    </div>

    <button class="locate-btn" onclick="reCenter()" title="My Location">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </button>

    <div id="map"></div>

    <div class="drawer" id="drawer">
        <div class="drawer-handle" onclick="toggleDrawer()"></div>
        <div class="table-container">
            <table id="assetTable">
                <thead>
                    <tr>
                        <th>Asset Tag</th>
                        <th>Type</th>
                        <th>IP Address</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

<script>
    const CONFIG = {
        CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQn94G-4yvB12f78GcBYE8h9wdABMzF6rSZJ9ZSZUt_OwTvWCp20rXjg4waDw36Y3qLcBrjFNwhJwOH/pub?gid=1727354306&single=true&output=csv',
        MAP_CENTER: [25.3548, 51.1839],
        COLORS: { 'RDNDCCTV': '#0ea5e9', 'RDNDPTZC': '#0ea5e9', 'RDNDVIVD': '#f59e0b', 'RDNDDMS': '#ef4444' }
    };

    let map, userMarker, allAssets = [];

    // Initialize Map
    function initMap() {
        map = L.map('map', { zoomControl: false }).setView(CONFIG.MAP_CENTER, 10);
        
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri'
        }).addTo(map);

        const labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}').addTo(map);
        
        // Setup User Tracking
        map.locate({ watch: true, enableHighAccuracy: true });
        map.on('locationfound', (e) => {
            if (!userMarker) {
                userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: '#3b82f6', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map);
                userMarker.bindPopup("Your Current Location");
            } else {
                userMarker.setLatLng(e.latlng);
            }
        });
    }

    function reCenter() {
        if (userMarker) map.setView(userMarker.getLatLng(), 16);
    }

    // Load and Process Data
    function loadData() {
        Papa.parse(CONFIG.CSV_URL, {
            download: true,
            header: true,
            complete: (results) => {
                allAssets = results.data.filter(r => r["Latitude (WGS84)"]);
                renderAssets(allAssets);
            }
        });
    }

    function renderAssets(data) {
        if (window.markerLayer) map.removeLayer(window.markerLayer);
        const markers = [];
        const tbody = document.querySelector('#assetTable tbody');
        tbody.innerHTML = '';

        data.forEach(asset => {
            const lat = parseFloat(asset["Latitude (WGS84)"]);
            const lon = parseFloat(asset["Longitude (WGS84)"]);
            const type = asset["GFCODE"];
            
            // Map Marker
            const marker = L.circleMarker([lat, lon], {
                radius: 6,
                fillColor: CONFIG.COLORS[type] || '#94a3b8',
                color: '#fff',
                weight: 1,
                fillOpacity: 0.8
            });

            const popupHtml = `
                <div style="min-width: 200px">
                    <b style="font-size:14px">${asset.ASSET_TAG}</b><br/>
                    <div style="margin-top:8px">
                        <div class="data-row"><span class="data-label">Type:</span>${type}</div>
                        <div class="data-row"><span class="data-label">ID:</span>${asset.ID}</div>
                        <div class="data-row"><span class="data-label">IP:</span>${asset["IP Address "] || 'N/A'}</div>
                        <div class="data-row"><span class="data-label">Desc:</span>${asset.DESCRIPTION}</div>
                    </div>
                    <div class="nav-btn-group">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="nav-btn btn-google">Google</a>
                        <a href="https://waze.com/ul?ll=${lat},${lon}&navigate=yes" target="_blank" class="nav-btn btn-waze">Waze</a>
                    </div>
                </div>
            `;
            marker.bindPopup(popupHtml);
            markers.push(marker);

            // Table Row
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${asset.ASSET_TAG}</td>
                <td>${type}</td>
                <td>${asset["IP Address "] || '-'}</td>
                <td><button onclick="zoomTo(${lat}, ${lon})" style="background:none; border:none; color:#0ea5e9; cursor:pointer;">View</button></td>
            `;
            tr.onclick = () => { if(window.innerWidth > 768) zoomTo(lat, lon); };
            tbody.appendChild(tr);
        });

        window.markerLayer = L.layerGroup(markers).addTo(map);
    }

    function zoomTo(lat, lon) {
        map.setView([lat, lon], 18);
        if(window.innerWidth < 768) toggleDrawer();
    }

    function toggleDrawer() {
        document.getElementById('drawer').classList.toggle('open');
    }

    // Search Logic
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase();
        const filtered = allAssets.filter(a => 
            a.ASSET_TAG.toLowerCase().includes(val) || 
            a.ID.toLowerCase().includes(val) || 
            a.GFCODE.toLowerCase().includes(val)
        );
        renderAssets(filtered);
    });

    // Start
    initMap();
    loadData();
</script>
</body>
</html>