<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ITS Field Operations Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ArcGIS JS (Esri Map) -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/dark/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <!-- CSV + Export Helpers -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg0: #020617;
      --bg1: rgba(15, 23, 42, 0.88);
      --glass: rgba(15, 23, 42, 0.72);
      --glass2: rgba(15, 23, 42, 0.90);
      --border: rgba(148, 163, 184, 0.45);
      --shadow: 0 22px 45px rgba(15, 23, 42, 0.65);
      --radius-lg: 18px;
      --radius-md: 14px;
      --text0: #f9fafb;
      --text1: #e5e7eb;
      --text2: #9ca3af;
      --text3: #6b7280;

      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-amber: #fbbf24;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
      --accent-pink: #ec4899;
      --accent-orange: #f97316;

      --trans-fast: 180ms cubic-bezier(0.22, 0.61, 0.36, 1);
      --trans-med: 320ms cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    body[data-theme="light"]{
      --bg0: #f3f4f6;
      --bg1: rgba(255,255,255,0.92);
      --glass: rgba(255,255,255,0.90);
      --glass2: rgba(255,255,255,0.96);
      --border: rgba(148, 163, 184, 0.55);
      --shadow: 0 18px 50px rgba(15, 23, 42, 0.16);
      --text0: #020617;
      --text1: #111827;
      --text2: #374151;
      --text3: #6b7280;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    html, body{ height:100%; }
    body{
      min-height: 100vh;
      background: var(--bg0);
      color: var(--text1);
      overflow-x:hidden;
    }

    .page{
      min-height: 100vh;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.26), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(236, 72, 153, 0.22), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249, 115, 22, 0.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.22), transparent 60%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg0) 100%);
      padding-bottom: 18px;
    }

    .shell{
      max-width: 1880px;
      margin: 0 auto;
      padding: 12px 16px 24px;
    }

    header{
      width: 100%;
      border-radius: 20px;
      margin-bottom: 10px;
      padding: 10px 20px;
      background:
        linear-gradient(135deg, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.92)),
        linear-gradient(90deg, rgba(56, 189, 248, 0.35), rgba(168, 85, 247, 0.35), rgba(236, 72, 153, 0.26));
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 18px;
    }

    body[data-theme="light"] header{
      background:
        linear-gradient(135deg, rgba(255,255,255,0.94), rgba(255,255,255,0.92)),
        linear-gradient(90deg, rgba(56, 189, 248, 0.22), rgba(168, 85, 247, 0.20), rgba(236, 72, 153, 0.18));
    }

    .header-left,.header-right{ flex:0 0 auto; display:flex; align-items:center; gap:8px; }
    .header-center{ flex: 1 1 auto; text-align:center; }
    .header-logo{ max-height: 52px; height:auto; filter: drop-shadow(0 8px 20px rgba(15, 23, 42, 0.8)); }
    .header-logo-small{ max-height: 44px; }
    .header-title{
      font-size: clamp(18px, 2vw, 26px);
      font-weight: 800;
      letter-spacing: 0.08em;
      color: var(--text0);
      text-transform: uppercase;
    }
    .header-subtitle{
      font-size: 11px;
      color: var(--text2);
      margin-top: 4px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .header-meta{
      font-size: 11px;
      color: rgba(199,210,254,0.95);
      margin-top: 4px;
    }
    body[data-theme="light"] .header-meta{ color: rgba(55,65,81,0.95); }

    .top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 10px 0 10px;
      flex-wrap: wrap;
    }

    .pill{
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 6px 12px;
      font-size: 11px;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.20), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      color: var(--text2);
      box-shadow: 0 16px 35px rgba(15, 23, 42, 0.55);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    body[data-theme="light"] .pill{
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.12), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,0.96), rgba(243,244,246,0.96));
      box-shadow: 0 12px 28px rgba(148, 163, 184, 0.28);
    }

    .status-dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(148,163,184,0.8);
      box-shadow: 0 0 12px rgba(148,163,184,0.35);
    }
    .status-dot.ok{ background: var(--accent-green); box-shadow: 0 0 12px rgba(34,197,94,0.75); }
    .status-dot.bad{ background: var(--accent-red); box-shadow: 0 0 12px rgba(239,68,68,0.75); }

    .theme-toggle{
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background-image:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      color: var(--text2);
      cursor: pointer;
      transition: transform var(--trans-fast), box-shadow var(--trans-fast), border-color var(--trans-fast);
      white-space:nowrap;
    }
    .theme-toggle:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15,23,42,0.45);
      border-color: rgba(248, 250, 252, 0.75);
    }
    body[data-theme="light"] .theme-toggle{
      background-image:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.14), transparent 60%),
        linear-gradient(135deg, #ffffff, #f9fafb);
      color: rgba(55,65,81,0.95);
      border-color: rgba(148, 163, 184, 0.9);
    }

    .glass-card{
      position: relative;
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.14), transparent 42%),
        linear-gradient(145deg, var(--glass2), var(--glass));
      border-radius: var(--radius-lg);
      padding: 10px 14px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      overflow:hidden;
    }

    .kpi-wrap{
      display:flex;
      gap: 8px;
      flex-wrap: nowrap;
      overflow:auto hidden;
      padding-bottom: 4px;
      scroll-snap-type: x proximity;
    }
    .kpi-wrap::-webkit-scrollbar{ height: 8px; }
    .kpi-wrap::-webkit-scrollbar-thumb{ background: rgba(148,163,184,0.35); border-radius: 999px; }
    .kpi{
      min-width: 172px;
      scroll-snap-align: start;
      border-radius: var(--radius-md);
      padding: 10px 12px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background:
        linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.90)),
        linear-gradient(120deg, rgba(56, 189, 248, 0.18), rgba(168, 85, 247, 0.14), rgba(236, 72, 153, 0.12));
      box-shadow: 0 16px 35px rgba(15, 23, 42, 0.6);
      cursor: default;
      transition: transform var(--trans-fast), border-color var(--trans-fast), box-shadow var(--trans-fast);
    }
    body[data-theme="light"] .kpi{
      background:
        linear-gradient(145deg, rgba(255,255,255,0.96), rgba(243,244,246,0.96)),
        linear-gradient(120deg, rgba(56, 189, 248, 0.12), rgba(168, 85, 247, 0.10), rgba(236, 72, 153, 0.10));
      box-shadow: 0 14px 30px rgba(148, 163, 184, 0.22);
    }
    .kpi:hover{
      transform: translateY(-1px);
      border-color: rgba(248, 250, 252, 0.55);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.72);
    }
    .kpi-label{
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text2);
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .kpi-badge{
      width:10px; height:10px; border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.5);
      box-shadow: 0 0 14px rgba(15,23,42,0.55);
      flex: 0 0 auto;
    }
    body[data-theme="light"] .kpi-badge{ border-color: rgba(2,6,23,0.25); }
    .kpi-value{
      font-size: 24px;
      font-weight: 800;
      margin-top: 4px;
      color: var(--text0);
    }

    .controls-bar{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .search{
      flex: 1 1 420px;
      min-width: 220px;
    }
    .search input{
      width:100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 12px;
      background:
        radial-gradient(circle at 0 0, rgba(248, 250, 252, 0.06), transparent 60%),
        rgba(15, 23, 42, 0.96);
      color: var(--text1);
      outline:none;
      transition: border-color var(--trans-fast), box-shadow var(--trans-fast), transform var(--trans-fast);
    }
    body[data-theme="light"] .search input{
      background: rgba(255,255,255,0.96);
      color: var(--text1);
      border-color: rgba(148,163,184,0.85);
    }
    .search input:focus{
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.55);
      transform: translateY(-1px);
    }
    .search input::placeholder{ color: rgba(148,163,184,0.9); }

    .filter{
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .filter select{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 12px;
      background: rgba(15, 23, 42, 0.96);
      color: var(--text1);
      outline:none;
      min-width: 240px;
      transition: border-color var(--trans-fast), box-shadow var(--trans-fast), transform var(--trans-fast);
      appearance:none;
      -webkit-appearance:none;
    }
    body[data-theme="light"] .filter select{
      background: rgba(255,255,255,0.96);
      color: var(--text1);
      border-color: rgba(148,163,184,0.85);
    }
    .filter select:focus{
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.55);
      transform: translateY(-1px);
    }

    .btn{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.9);
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.32), transparent 55%),
        linear-gradient(135deg, rgba(37, 99, 235, 0.96), rgba(56, 189, 248, 0.95));
      color: #ecfeff;
      font-size: 12px;
      font-weight: 600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: 0 16px 35px rgba(30, 64, 175, 0.55);
      transition: transform var(--trans-fast), box-shadow var(--trans-fast), filter var(--trans-fast);
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 22px 48px rgba(30, 64, 175, 0.65);
      filter: brightness(1.04);
    }
    .btn.secondary{
      border-color: rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.88);
      color: var(--text2);
      box-shadow: 0 16px 35px rgba(15, 23, 42, 0.35);
    }
    body[data-theme="light"] .btn.secondary{
      background: rgba(255,255,255,0.92);
      color: rgba(55,65,81,0.95);
      box-shadow: 0 14px 30px rgba(148, 163, 184, 0.22);
    }

    .export-group{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-left:auto;
    }

    .map-card{
      padding: 10px;
    }
    .map-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      padding: 4px 6px 10px;
    }
    .map-title{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text2);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .map-title .dot{
      width: 8px; height: 8px; border-radius:999px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      box-shadow: 0 0 12px rgba(56,189,248,0.65);
    }
    .map-box{
      position: relative;
      width: 100%;
      height: 520px;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.55);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.65);
      background: rgba(0,0,0,0.12);
    }

    /* Legend panel (fix overlap) */
    .legend{
      position:absolute;
      top: 12px;
      right: 12px;
      width: 260px;
      max-width: calc(100% - 24px);
      max-height: calc(100% - 24px);
      overflow: hidden;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.55);
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.10), transparent 45%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.86));
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 18px 45px rgba(15,23,42,0.55);
      display:flex;
      flex-direction:column;
      z-index: 20;
    }
    body[data-theme="light"] .legend{
      background:
        radial-gradient(circle at top left, rgba(255,255,255,0.85), transparent 55%),
        linear-gradient(145deg, rgba(255,255,255,0.94), rgba(243,244,246,0.94));
      box-shadow: 0 18px 45px rgba(148,163,184,0.22);
    }
    .legend-head{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.28);
    }
    .legend-title{
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text2);
    }
    .legend-toggle{
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.70);
      color: var(--text2);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      cursor:pointer;
      transition: transform var(--trans-fast), box-shadow var(--trans-fast);
      white-space:nowrap;
    }
    body[data-theme="light"] .legend-toggle{ background: rgba(255,255,255,0.75); }
    .legend-toggle:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(15,23,42,0.25); }

    .legend-body{
      padding: 10px 12px 12px;
      overflow:auto;
      max-height: 420px;
    }
    .legend-body::-webkit-scrollbar{ width: 10px; }
    .legend-body::-webkit-scrollbar-thumb{ background: rgba(148,163,184,0.35); border-radius: 999px; }
    .legend-list{
      list-style:none;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap: 10px;
      color: var(--text1);
      font-size: 12px;
    }
    .swatch{
      width: 14px; height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.45);
      flex: 0 0 auto;
      box-shadow: 0 0 10px rgba(15,23,42,0.35);
    }
    body[data-theme="light"] .swatch{ border-color: rgba(2,6,23,0.20); }
    .swatch.circle{ border-radius: 999px; }
    .swatch.diamond{ transform: rotate(45deg); border-radius: 3px; }
    .swatch.triangle{
      width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent;
      border-bottom: 14px solid;
      border-radius: 0;
      border: 0;
      box-shadow: 0 0 10px rgba(15,23,42,0.35);
    }
    .legend-note{
      margin-top: 10px;
      font-size: 10px;
      color: var(--text3);
      line-height: 1.35;
    }

    .legend.is-collapsed .legend-body{ display:none; }
    .legend.is-collapsed{ width: 180px; }

    .map-footer{
      padding: 10px 6px 2px;
      font-size: 11px;
      color: var(--text3);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .table-card{ padding: 12px 14px; }
    .table-title{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .table-hint{
      font-size: 11px;
      color: var(--text3);
      letter-spacing: 0.02em;
      text-transform:none;
    }

    .table-wrap{
      width: 100%;
      max-height: 380px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background:
        radial-gradient(circle at top left, rgba(15, 23, 42, 0.86), rgba(3, 7, 18, 0.96));
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.55);
    }
    body[data-theme="light"] .table-wrap{
      background: rgba(255,255,255,0.92);
      border-color: rgba(148,163,184,0.55);
      box-shadow: 0 18px 45px rgba(148,163,184,0.18);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      color: var(--text1);
    }
    thead{
      position: sticky;
      top: 0;
      z-index: 2;
    }
    th, td{
      padding: 8px 10px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.6);
      text-align:left;
      white-space: nowrap;
    }
    th{
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.92));
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
      color: var(--text2);
    }
    body[data-theme="light"] th{
      background: linear-gradient(180deg, rgba(243,244,246,0.98), rgba(229,231,235,0.98));
      color: rgba(55,65,81,0.95);
      border-bottom-color: rgba(148,163,184,0.55);
    }
    tbody tr:nth-child(even){ background: rgba(15, 23, 42, 0.72); }
    tbody tr:nth-child(odd){ background: rgba(3, 7, 18, 0.92); }
    body[data-theme="light"] tbody tr:nth-child(even){ background: rgba(249,250,251,0.98); }
    body[data-theme="light"] tbody tr:nth-child(odd){ background: rgba(243,244,246,0.98); }
    tbody tr:hover{
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.14), transparent 55%),
        rgba(3, 7, 18, 0.96);
      cursor:pointer;
    }
    body[data-theme="light"] tbody tr:hover{
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.10), transparent 55%),
        rgba(255,255,255,0.98);
    }

    .small-muted{ color: var(--text3); font-size: 11px; }

    /* Responsive */
    @media (max-width: 980px){
      header{ flex-wrap: wrap; padding: 10px 14px; }
      .header-center{ text-align: left; }
      .map-box{ height: 440px; }
      .filter select{ min-width: 220px; }
      .legend{ width: 240px; }
    }
    @media (max-width: 640px){
      .shell{ padding: 10px 10px 20px; }
      .map-box{ height: 380px; }
      .legend{
        right: 10px;
        left: 10px;
        width: auto;
        bottom: 10px;
        top: auto;
        max-height: 48%;
      }
      .legend.is-collapsed{ width: auto; }
      .legend-body{ max-height: 220px; }
      .filter select{ min-width: 100%; }
      .controls-bar{ gap: 8px; }
      .export-group{ width: 100%; justify-content: flex-start; margin-left: 0; }
      .btn{ width: 100%; justify-content: center; }
      .btn.secondary{ width: 100%; justify-content: center; }
    }

    /* ArcGIS popup theming */
    .esri-popup__main-container{
      border-radius: 14px !important;
      border: 1px solid rgba(148,163,184,0.35) !important;
      overflow:hidden !important;
      box-shadow: 0 18px 45px rgba(15,23,42,0.55) !important;
    }
    body[data-theme="light"] .esri-popup__main-container{
      box-shadow: 0 18px 45px rgba(148,163,184,0.22) !important;
    }
    .popup-btns{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .popup-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.9);
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.28), transparent 55%),
        linear-gradient(135deg, rgba(37, 99, 235, 0.96), rgba(56, 189, 248, 0.95));
      color: #ecfeff !important;
      text-decoration:none !important;
      font-weight: 700;
      font-size: 12px;
      box-shadow: 0 14px 30px rgba(30, 64, 175, 0.45);
      white-space:nowrap;
    }
    .popup-link.waze{
      border-color: rgba(168, 85, 247, 0.9);
      background:
        radial-gradient(circle at 0 0, rgba(168, 85, 247, 0.28), transparent 55%),
        linear-gradient(135deg, rgba(147, 51, 234, 0.96), rgba(168, 85, 247, 0.95));
      box-shadow: 0 14px 30px rgba(88, 28, 135, 0.35);
    }
  </style>
</head>

<body data-theme="dark">
  <div class="page">
    <div class="shell">
      <header>
        <div class="header-left">
          <img src="aktor-logo.png" alt="Aktor Qatar" class="header-logo" />
        </div>

        <div class="header-center">
          <div class="header-title">ITS FIELD OPERATIONS DASHBOARD</div>
          <div class="header-subtitle">Live from Google Sheet — Map + Full Data Table + Global Search + Type Filter + My Location</div>
          <div class="header-meta"><span id="currentDateTime"></span></div>
        </div>

        <div class="header-right">
          <img src="MRTC-AKTOR JV.png" alt="MRTC-AKTOR JV" class="header-logo header-logo-small" />
        </div>
      </header>

      <div class="top-row">
        <div class="pill">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Not loaded</span>
        </div>

        <button class="theme-toggle" id="themeToggle" type="button">Dark</button>

        <div class="pill">
          <span class="small-muted">Last Sync:</span>
          <span id="lastSync">—</span>
        </div>
      </div>

      <div class="glass-card">
        <div class="kpi-wrap" id="kpiWrap">
          <!-- dynamic -->
        </div>

        <div class="controls-bar">
          <div class="search">
            <input id="globalSearch" type="text" placeholder="Global search (IP / logic id / ID / ASSETTAG / DESCRIPTION / any field)..." />
          </div>

          <div class="filter">
            <select id="typeFilter">
              <option value="__ALL__">All Device Types (GFCODE)</option>
            </select>
          </div>

          <button class="btn" id="locateBtn" type="button">Locate Me</button>
          <button class="btn secondary" id="clearBtn" type="button">Clear</button>
          <button class="btn secondary" id="reloadBtn" type="button">Reload</button>

          <div class="export-group">
            <button class="btn" id="exportCsvBtn" type="button">CSV</button>
            <button class="btn" id="exportXlsxBtn" type="button">Excel (XLSX)</button>
            <button class="btn" id="exportPdfBtn" type="button">PDF</button>
          </div>
        </div>
        <div class="small-muted" style="margin-top:6px;">Tip: Click a marker (or a table row) to open navigation options (Google Maps / Waze).</div>
      </div>

      <div class="glass-card map-card" style="margin-top:12px;">
        <div class="map-header">
          <div class="map-title"><span class="dot"></span><span>ESRI Map (Satellite) — Locked to Qatar</span></div>
          <div class="small-muted" id="deviceCountLabel">0 devices</div>
        </div>

        <div class="map-box">
          <div id="mapView" style="width:100%; height:100%;"></div>

          <div class="legend" id="legendPanel" aria-label="Legend panel">
            <div class="legend-head">
              <div class="legend-title">Legend</div>
              <button class="legend-toggle" id="legendToggleBtn" type="button">Collapse</button>
            </div>
            <div class="legend-body">
              <ul class="legend-list" id="legendList"></ul>
              <div class="legend-note">My Location is shown with a unique marker and an accuracy circle (when available).</div>
            </div>
          </div>
        </div>

        <div class="map-footer">
          <div>Map is constrained to Qatar extent. Use “Locate Me” to center on current position.</div>
          <div class="small-muted">Data source: Google Sheet (CSV)</div>
        </div>
      </div>

      <div class="glass-card table-card" style="margin-top:12px;">
        <div class="table-title">
          <div>All Data (from Excel/CSV)</div>
          <div class="table-hint">Click a row to zoom to the device and open navigation options.</div>
        </div>
        <div class="table-wrap">
          <table id="dataTable">
            <thead><tr id="tableHeadRow"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSKAtXDwzYQCNXtLlFOz5fkof4kCLCtzkf7GokGaINUmrurF7CFPbsm6bF8HXXV3MA8PyfYOzMVK8Q/pub?gid=223122268&single=true&output=csv";

    // Qatar extent (buffered) - WGS84
    const QATAR_EXTENT_WGS84 = { xmin: 50.45, ymin: 24.25, xmax: 52.15, ymax: 26.35, wkid: 4326 };

    // Palette + Shapes (high contrast)
    const COLOR_PALETTE = [
      "#22c55e", "#38bdf8", "#f97316", "#a855f7", "#ef4444", "#fbbf24",
      "#06b6d4", "#e11d48", "#16a34a", "#2563eb", "#7c3aed", "#ea580c",
      "#0ea5e9", "#db2777", "#84cc16", "#f43f5e", "#14b8a6", "#9333ea",
      "#fb7185", "#f59e0b"
    ];
    const SHAPES = ["circle", "square", "diamond", "triangle", "cross", "x"];

    // ===================== STATE =====================
    let rawRows = [];
    let headers = [];
    let filteredRows = [];

    let view, devicesLayer, myLayer;
    let deviceGraphicsByKey = new Map();
    let selectedGraphic = null;

    let myLocationGraphic = null;
    let myAccuracyGraphic = null;

    // ===================== UTIL =====================
    const $ = (id) => document.getElementById(id);

    function nowString(){
      const d = new Date();
      return d.toLocaleString("en-US", {
        weekday: "short", day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }

    function setStatus(ok, msg){
      const dot = $("statusDot");
      const text = $("statusText");
      dot.classList.remove("ok","bad");
      dot.classList.add(ok ? "ok" : "bad");
      text.textContent = msg;
    }

    function sanitize(v){
      if (v === null || v === undefined) return "N/A";
      const s = String(v).replace(/\u00A0/g, " ").trim();
      return s === "" ? "N/A" : s;
    }

    function getFirstKey(row, candidates){
      for (const k of candidates){
        if (row.hasOwnProperty(k)) return k;
      }
      return null;
    }

    function toNumberMaybe(v){
      const n = parseFloat(String(v).trim());
      return Number.isFinite(n) ? n : null;
    }

    function stableHash(str){
      // simple deterministic hash
      let h = 2166136261;
      const s = String(str || "");
      for (let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
      }
      return Math.abs(h >>> 0);
    }

    function symbolForType(type){
      const key = sanitize(type);
      const h = stableHash(key);
      const color = COLOR_PALETTE[h % COLOR_PALETTE.length];
      const shape = SHAPES[h % SHAPES.length];
      return { color, shape };
    }

    function buildSearchBlob(row){
      // global search across all fields
      const parts = [];
      for (const h of headers){
        parts.push(sanitize(row[h]));
      }
      return parts.join(" | ").toLowerCase();
    }

    function buildDeviceKey(row){
      // stable unique-ish key for mapping row <-> graphic
      const idKey = getFirstKey(row, ["ID","Id","id"]);
      const tagKey = getFirstKey(row, ["ASSETTAG","AssetTag","asset tag","Asset Tag"]);
      const mxKey = getFirstKey(row, ["MXASSETNUM","MxAssetNum","mxassetnum"]);
      const gfcKey = getFirstKey(row, ["GFCODE","Gfcode","gfcode"]);
      return [
        sanitize(idKey ? row[idKey] : ""),
        sanitize(tagKey ? row[tagKey] : ""),
        sanitize(mxKey ? row[mxKey] : ""),
        sanitize(gfcKey ? row[gfcKey] : ""),
      ].join("||");
    }

    function googleMapsUrl(lat, lon){
      return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
    }
    function wazeUrl(lat, lon){
      return `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`;
    }

    // ===================== THEME =====================
    function applyTheme(theme){
      document.body.setAttribute("data-theme", theme);
      $("themeToggle").textContent = theme === "light" ? "Light" : "Dark";
      localStorage.setItem("its_field_theme", theme);

      // ArcGIS theme CSS is "dark". For light mode, we keep the same basemap and UI mostly OK.
      // If you want full ArcGIS light theme, replace the CSS href dynamically. Keeping stable to avoid UI shifts.
    }

    function initTheme(){
      const saved = localStorage.getItem("its_field_theme");
      applyTheme(saved === "light" ? "light" : "dark");
      $("themeToggle").addEventListener("click", () => {
        const cur = document.body.getAttribute("data-theme") || "dark";
        applyTheme(cur === "dark" ? "light" : "dark");
      });
    }

    // ===================== EXPORT =====================
    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCSV(){
      const rows = filteredRows.length ? filteredRows : rawRows;
      const csv = Papa.unparse(rows, { columns: headers });
      downloadBlob(new Blob([csv], { type: "text/csv;charset=utf-8" }), `ITS_Field_Operations_${Date.now()}.csv`);
    }

    function exportXLSX(){
      const rows = filteredRows.length ? filteredRows : rawRows;
      const ws = XLSX.utils.json_to_sheet(rows, { header: headers });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ITS_DATA");
      const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      downloadBlob(new Blob([out], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), `ITS_Field_Operations_${Date.now()}.xlsx`);
    }

    function exportPDF(){
      const rows = filteredRows.length ? filteredRows : rawRows;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

      const title = "ITS Field Operations Dashboard - Export";
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text(title, 40, 36);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Exported: ${nowString()}`, 40, 52);
      doc.text(`Rows: ${rows.length}`, 40, 66);

      const body = rows.map(r => headers.map(h => sanitize(r[h])));
      doc.autoTable({
        head: [headers],
        body,
        startY: 80,
        styles: { fontSize: 7, cellPadding: 3, overflow: "linebreak" },
        headStyles: { fontStyle: "bold" },
        theme: "grid",
        margin: { left: 24, right: 24 }
      });

      const pdfBlob = doc.output("blob");
      downloadBlob(pdfBlob, `ITS_Field_Operations_${Date.now()}.pdf`);
    }

    // ===================== RENDER: KPI / FILTER / TABLE / LEGEND =====================
    function renderTypeFilter(){
      const sel = $("typeFilter");
      const prev = sel.value;
      sel.innerHTML = `<option value="__ALL__">All Device Types (GFCODE)</option>`;

      const gfcKey = getFirstKey(rawRows[0] || {}, ["GFCODE","gfcode","Gfcode"]);
      const types = new Set();
      for (const r of rawRows){
        const t = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
        types.add(t);
      }
      [...types].sort((a,b)=>a.localeCompare(b)).forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });

      if ([...sel.options].some(o=>o.value===prev)) sel.value = prev;
    }

    function renderKPIs(rows){
      const wrap = $("kpiWrap");
      wrap.innerHTML = "";

      const gfcKey = getFirstKey(rawRows[0] || {}, ["GFCODE","gfcode","Gfcode"]);
      const counts = new Map();
      for (const r of rows){
        const t = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
        counts.set(t, (counts.get(t) || 0) + 1);
      }

      // Total
      const totalCard = document.createElement("div");
      totalCard.className = "kpi";
      totalCard.innerHTML = `
        <div class="kpi-label"><span class="kpi-badge" style="background:${"#38bdf8"}"></span> Total Devices</div>
        <div class="kpi-value">${rows.length}</div>
      `;
      wrap.appendChild(totalCard);

      // Per-type cards (sorted by count desc)
      const sorted = [...counts.entries()].sort((a,b)=>b[1]-a[1]);
      for (const [type, cnt] of sorted){
        const { color } = symbolForType(type);
        const card = document.createElement("div");
        card.className = "kpi";
        card.title = type;
        card.innerHTML = `
          <div class="kpi-label"><span class="kpi-badge" style="background:${color}"></span> ${type}</div>
          <div class="kpi-value">${cnt}</div>
        `;
        wrap.appendChild(card);
      }

      $("deviceCountLabel").textContent = `${rows.length} devices`;
    }

    function renderLegend(rows){
      const list = $("legendList");
      list.innerHTML = "";

      // Always include My Location (fixed)
      const myItem = document.createElement("li");
      myItem.className = "legend-item";
      myItem.innerHTML = `<span class="swatch circle" style="background:${"#22c55e"}"></span> My Location`;
      list.appendChild(myItem);

      const gfcKey = getFirstKey(rawRows[0] || {}, ["GFCODE","gfcode","Gfcode"]);
      const types = new Set();
      for (const r of rows){
        types.add(sanitize(gfcKey ? r[gfcKey] : "UNKNOWN"));
      }

      // Stable sort alpha
      const sorted = [...types].sort((a,b)=>a.localeCompare(b));

      for (const t of sorted){
        const { color, shape } = symbolForType(t);

        const item = document.createElement("li");
        item.className = "legend-item";

        // show swatch with shape hint (css)
        let swatchHTML = "";
        if (shape === "triangle"){
          swatchHTML = `<span class="swatch triangle" style="border-bottom-color:${color}"></span>`;
        } else if (shape === "diamond"){
          swatchHTML = `<span class="swatch diamond" style="background:${color}"></span>`;
        } else if (shape === "circle"){
          swatchHTML = `<span class="swatch circle" style="background:${color}"></span>`;
        } else {
          swatchHTML = `<span class="swatch" style="background:${color}"></span>`;
        }

        item.innerHTML = `${swatchHTML} ${t}`;
        list.appendChild(item);
      }
    }

    function renderTable(rows){
      const headRow = $("tableHeadRow");
      const body = $("tableBody");

      headRow.innerHTML = "";
      body.innerHTML = "";

      for (const h of headers){
        const th = document.createElement("th");
        th.textContent = h;
        headRow.appendChild(th);
      }

      // Keep manageable DOM on huge lists, but your size (~1500) is OK.
      const frag = document.createDocumentFragment();
      for (const r of rows){
        const tr = document.createElement("tr");
        tr.dataset.key = buildDeviceKey(r);
        for (const h of headers){
          const td = document.createElement("td");
          td.textContent = sanitize(r[h]);
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      body.appendChild(frag);

      body.querySelectorAll("tr").forEach(tr=>{
        tr.addEventListener("click", ()=>{
          const key = tr.dataset.key;
          const g = deviceGraphicsByKey.get(key);
          if (g) {
            focusGraphic(g, true);
          }
        });
      });
    }

    // ===================== FILTERING =====================
    function applyFilters(){
      const search = $("globalSearch").value.trim().toLowerCase();
      const typeVal = $("typeFilter").value;

      const gfcKey = getFirstKey(rawRows[0] || {}, ["GFCODE","gfcode","Gfcode"]);

      filteredRows = rawRows.filter(r=>{
        const t = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
        if (typeVal !== "__ALL__" && t !== typeVal) return false;
        if (search){
          const blob = r.__blob || "";
          if (!blob.includes(search)) return false;
        }
        return true;
      });

      renderKPIs(filteredRows);
      renderLegend(filteredRows);
      renderTable(filteredRows);
      refreshMapGraphics(filteredRows);
    }

    // ===================== MAP (ARCGIS) =====================
    function initMap(){
      return new Promise((resolve, reject)=>{
        require([
          "esri/Map",
          "esri/views/MapView",
          "esri/Graphic",
          "esri/layers/GraphicsLayer",
          "esri/geometry/Extent",
          "esri/geometry/Polygon",
          "esri/geometry/Point",
          "esri/geometry/geometryEngine",
          "esri/PopupTemplate"
        ], (Map, MapView, Graphic, GraphicsLayer, Extent, Polygon, Point, geometryEngine, PopupTemplate) => {

          const qatarExtent = new Extent({
            xmin: QATAR_EXTENT_WGS84.xmin,
            ymin: QATAR_EXTENT_WGS84.ymin,
            xmax: QATAR_EXTENT_WGS84.xmax,
            ymax: QATAR_EXTENT_WGS84.ymax,
            spatialReference: { wkid: QATAR_EXTENT_WGS84.wkid }
          });

          const qatarPoly = Polygon.fromExtent(qatarExtent);

          const map = new Map({ basemap: "satellite" });

          devicesLayer = new GraphicsLayer({ id: "devicesLayer" });
          myLayer = new GraphicsLayer({ id: "myLayer" });

          map.addMany([devicesLayer, myLayer]);

          view = new MapView({
            container: "mapView",
            map,
            extent: qatarExtent,
            constraints: {
              geometry: qatarPoly,  // lock panning to Qatar extent
              minZoom: 7,
              maxZoom: 19,
              rotationEnabled: false
            },
            ui: {
              components: ["zoom", "attribution"]
            },
            popup: {
              dockEnabled: false,
              highlightEnabled: true
            }
          });

          // Build popup HTML safely (simple)
          function popupContentFromRow(row){
            const idKey = getFirstKey(row, ["ID","Id","id"]);
            const gfcKey = getFirstKey(row, ["GFCODE","gfcode","Gfcode"]);
            const tagKey = getFirstKey(row, ["ASSETTAG","AssetTag","asset tag","Asset Tag"]);
            const descKey = getFirstKey(row, ["DESCRIPTION","Description","description"]);
            const ipKey  = getFirstKey(row, ["IP Address","IP","ip address","IPAddress","Ip Address"]);
            const latKey = getFirstKey(row, ["Latitude WGS84","Latitude","lat","LATITUDE","Latitude_WGS84"]);
            const lonKey = getFirstKey(row, ["Longitude WGS84","Longitude","lon","LON","LONGITUDE","Longitude_WGS84"]);

            const id = sanitize(idKey ? row[idKey] : "");
            const gfc = sanitize(gfcKey ? row[gfcKey] : "");
            const tag = sanitize(tagKey ? row[tagKey] : "");
            const desc = sanitize(descKey ? row[descKey] : "");
            const ip = sanitize(ipKey ? row[ipKey] : "");
            const lat = sanitize(latKey ? row[latKey] : "");
            const lon = sanitize(lonKey ? row[lonKey] : "");

            const latN = toNumberMaybe(lat);
            const lonN = toNumberMaybe(lon);

            const gUrl = (latN !== null && lonN !== null) ? googleMapsUrl(latN, lonN) : "#";
            const wUrl = (latN !== null && lonN !== null) ? wazeUrl(latN, lonN) : "#";

            const html = `
              <div style="font-size:12px; line-height:1.35;">
                <div style="font-weight:800; font-size:13px; margin-bottom:6px;">${escapeHtml(id !== "N/A" ? id : (tag !== "N/A" ? tag : "ITS Asset"))}</div>
                <div><strong>ID:</strong> ${escapeHtml(id)}</div>
                <div><strong>GFCODE:</strong> ${escapeHtml(gfc)}</div>
                <div><strong>ASSETTAG:</strong> ${escapeHtml(tag)}</div>
                <div><strong>DESCRIPTION:</strong> ${escapeHtml(desc)}</div>
                <div><strong>IP Address:</strong> ${escapeHtml(ip)}</div>
                <div><strong>Coordinates:</strong> ${escapeHtml(lat)}, ${escapeHtml(lon)}</div>
                <div class="popup-btns">
                  <a class="popup-link" href="${gUrl}" target="_blank" rel="noopener">Open in Google Maps</a>
                  <a class="popup-link waze" href="${wUrl}" target="_blank" rel="noopener">Open in Waze</a>
                </div>
              </div>
            `;
            return html;
          }

          function escapeHtml(s){
            return String(s).replace(/[&<>"']/g, (c) => ({
              "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;"
            }[c]));
          }

          function markerSymbol(type, selected=false){
            const { color, shape } = symbolForType(type);
            const size = selected ? 14 : 11;
            const outlineWidth = selected ? 2.5 : 1.5;

            // ArcGIS SimpleMarkerSymbol style options: "circle","square","diamond","triangle","cross","x"
            return {
              type: "simple-marker",
              style: shape,
              color: color,
              size: size,
              outline: { color: "#ffffff", width: outlineWidth }
            };
          }

          function addDeviceGraphic(row){
            const latKey = getFirstKey(row, ["Latitude WGS84","Latitude","lat","LATITUDE","Latitude_WGS84"]);
            const lonKey = getFirstKey(row, ["Longitude WGS84","Longitude","lon","LON","LONGITUDE","Longitude_WGS84"]);
            const gfcKey = getFirstKey(row, ["GFCODE","gfcode","Gfcode"]);

            const lat = toNumberMaybe(row[latKey]);
            const lon = toNumberMaybe(row[lonKey]);
            if (lat === null || lon === null) return null;

            const type = sanitize(gfcKey ? row[gfcKey] : "UNKNOWN");

            const pt = new Point({ latitude: lat, longitude: lon, spatialReference: { wkid: 4326 } });

            const g = new Graphic({
              geometry: pt,
              symbol: markerSymbol(type, false),
              attributes: {
                __key: buildDeviceKey(row),
                __type: type
              },
              popupTemplate: new PopupTemplate({
                title: "{__type}",
                content: () => popupContentFromRow(row)
              })
            });

            devicesLayer.add(g);
            return g;
          }

          function clearDevices(){
            devicesLayer.removeAll();
            deviceGraphicsByKey.clear();
            selectedGraphic = null;
          }

          function setMyLocation(lat, lon, accuracyMeters){
            myLayer.removeAll();
            myLocationGraphic = null;
            myAccuracyGraphic = null;

            const pt = new Point({ latitude: lat, longitude: lon, spatialReference: { wkid: 4326 } });

            // marker
            myLocationGraphic = new Graphic({
              geometry: pt,
              symbol: {
                type: "simple-marker",
                style: "circle",
                color: "#22c55e",
                size: 14,
                outline: { color: "#ffffff", width: 2.5 }
              },
              attributes: { __type: "My Location" },
              popupTemplate: {
                title: "My Location",
                content: () => `<div style="font-size:12px;"><strong>Lat/Lon:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}<br/><strong>Accuracy:</strong> ${Math.round(accuracyMeters)} m</div>`
              }
            });
            myLayer.add(myLocationGraphic);

            // accuracy circle
            const acc = Math.max(10, Math.min(accuracyMeters || 50, 250));
            const circle = geometryEngine.geodesicBuffer(pt, acc, "meters");
            myAccuracyGraphic = new Graphic({
              geometry: circle,
              symbol: {
                type: "simple-fill",
                color: [34, 197, 94, 0.12],
                outline: { color: [34, 197, 94, 0.75], width: 2 }
              }
            });
            myLayer.add(myAccuracyGraphic);
          }

          // Expose a few functions to outer scope
          window.__GIS__ = {
            Graphic,
            geometryEngine,
            markerSymbol,
            addDeviceGraphic,
            clearDevices,
            setMyLocation
          };

          // Legend collapse toggle
          $("legendToggleBtn").addEventListener("click", ()=>{
            const panel = $("legendPanel");
            const collapsed = panel.classList.toggle("is-collapsed");
            $("legendToggleBtn").textContent = collapsed ? "Expand" : "Collapse";
          });

          // Clicking on map clears selection if click on empty
          view.on("click", (evt) => {
            view.hitTest(evt).then((res)=>{
              const hits = res.results || [];
              const devHit = hits.find(h => h.graphic && h.graphic.layer && h.graphic.layer.id === "devicesLayer");
              if (!devHit) {
                clearSelection();
              }
            });
          });

          function clearSelection(){
            if (selectedGraphic) {
              const type = selectedGraphic.attributes.__type;
              selectedGraphic.symbol = window.__GIS__.markerSymbol(type, false);
              selectedGraphic = null;
            }
          }

          function focusGraphicInternal(g, openPopup){
            if (!g) return;
            if (selectedGraphic && selectedGraphic !== g){
              const tPrev = selectedGraphic.attributes.__type;
              selectedGraphic.symbol = window.__GIS__.markerSymbol(tPrev, false);
            }
            selectedGraphic = g;
            const t = g.attributes.__type;
            g.symbol = window.__GIS__.markerSymbol(t, true);

            view.goTo({ target: g.geometry, zoom: Math.max(view.zoom, 15) }, { duration: 450 }).then(()=>{
              if (openPopup) view.openPopup({ features: [g], location: g.geometry });
            });
          }

          window.__focusGraphicInternal = focusGraphicInternal;
          window.__clearSelection = clearSelection;

          resolve();
        });
      });
    }

    function refreshMapGraphics(rows){
      if (!devicesLayer || !window.__GIS__) return;

      window.__GIS__.clearDevices();

      for (const r of rows){
        const g = window.__GIS__.addDeviceGraphic(r);
        if (g) {
          deviceGraphicsByKey.set(buildDeviceKey(r), g);
        }
      }
    }

    function focusGraphic(g, openPopup){
      if (typeof window.__focusGraphicInternal === "function"){
        window.__focusGraphicInternal(g, openPopup);
      }
    }

    // ===================== GEOLOCATION =====================
    function locateMe(){
      if (!navigator.geolocation){
        alert("Geolocation is not supported in this browser.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy || 50;

          if (window.__GIS__ && typeof window.__GIS__.setMyLocation === "function"){
            window.__GIS__.setMyLocation(lat, lon, acc);
          }
          if (view){
            view.goTo({ center: [lon, lat], zoom: Math.max(view.zoom, 15) }, { duration: 450 });
          }
        },
        (err)=>{
          alert("Unable to get your location. Please allow location permissions and try again.");
        },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 8000 }
      );
    }

    // ===================== DATA LOAD =====================
    function loadCSV(){
      setStatus(false, "Loading...");
      $("lastSync").textContent = "—";

      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          const data = res.data || [];
          if (!data.length){
            setStatus(false, "Loaded (0 rows)");
            rawRows = [];
            headers = [];
            filteredRows = [];
            renderKPIs([]);
            renderLegend([]);
            renderTable([]);
            refreshMapGraphics([]);
            $("lastSync").textContent = nowString();
            return;
          }

          // Normalize headers order from Papa
          headers = Object.keys(data[0] || {});
          rawRows = data.map(r => {
            const obj = {};
            for (const h of headers){
              // keep original values; display uses sanitize()
              obj[h] = r[h];
            }
            obj.__blob = buildSearchBlob(obj);
            return obj;
          });

          setStatus(true, "Loaded");
          $("lastSync").textContent = nowString();

          renderTypeFilter();
          applyFilters();
        },
        error: () => {
          setStatus(false, "Load error");
          $("lastSync").textContent = nowString();
        }
      });
    }

    // ===================== EVENTS =====================
    function bindEvents(){
      $("globalSearch").addEventListener("input", debounce(applyFilters, 120));
      $("typeFilter").addEventListener("change", applyFilters);

      $("locateBtn").addEventListener("click", locateMe);

      $("clearBtn").addEventListener("click", ()=>{
        $("globalSearch").value = "";
        $("typeFilter").value = "__ALL__";
        applyFilters();
        if (typeof window.__clearSelection === "function") window.__clearSelection();
      });

      $("reloadBtn").addEventListener("click", ()=>{
        loadCSV();
      });

      $("exportCsvBtn").addEventListener("click", exportCSV);
      $("exportXlsxBtn").addEventListener("click", exportXLSX);
      $("exportPdfBtn").addEventListener("click", exportPDF);
    }

    function debounce(fn, ms){
      let t = null;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }

    // ===================== CLOCK =====================
    function initClock(){
      const el = $("currentDateTime");
      const tick = ()=> el.textContent = nowString();
      tick();
      setInterval(tick, 1000);
    }

    // ===================== BOOT =====================
    (async function boot(){
      initTheme();
      initClock();
      bindEvents();

      await initMap();
      loadCSV();
    })();
  </script>
</body>
</html>