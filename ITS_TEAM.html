<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ITS Field Operations â€” Map + Table + Navigation</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg0:#020617;
      --bg1:#0b1120;
      --glass:rgba(15,23,42,.78);
      --glass2:rgba(15,23,42,.92);
      --border:rgba(148,163,184,.35);
      --border2:rgba(148,163,184,.55);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --muted2:#6b7280;
      --accent:#38bdf8;
      --ok:#22c55e;
      --warn:#fbbf24;
      --bad:#ef4444;
      --shadow:0 22px 55px rgba(15,23,42,.75);
      --radius:18px;
      --radius2:14px;
      --fast:180ms cubic-bezier(.22,.61,.36,1);
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    html,body{ height:100%; }
    body{
      min-height:100vh;
      color:var(--text);
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.22), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(168,85,247,.18), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249,115,22,.14), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(236,72,153,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg0) 100%);
      background-attachment: fixed;
    }

    .shell{
      max-width: 1900px;
      margin: 0 auto;
      padding: 12px 16px 18px;
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header{
      border-radius: 20px;
      padding: 10px 16px;
      background:
        linear-gradient(135deg, rgba(15,23,42,.97), rgba(15,23,42,.92)),
        linear-gradient(90deg, rgba(56,189,248,.25), rgba(168,85,247,.22), rgba(236,72,153,.18));
      box-shadow: 0 24px 60px rgba(15,23,42,.85), 0 0 0 1px rgba(148,163,184,.25);
      border: 1px solid rgba(148,163,184,.25);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .hdr-title{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .hdr-title h1{
      font-size: clamp(16px, 1.8vw, 22px);
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#f9fafb;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hdr-title .sub{
      font-size: 11px;
      color: var(--muted);
      letter-spacing:.05em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.45);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.14), transparent 60%),
        rgba(15,23,42,.82);
      color: var(--text);
      box-shadow: 0 14px 34px rgba(15,23,42,.65);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--ok));
      box-shadow: 0 0 12px rgba(56,189,248,.75);
      flex:0 0 auto;
    }

    .card{
      background:
        radial-gradient(circle at top left, rgba(248,250,252,.12), transparent 42%),
        linear-gradient(145deg, rgba(15,23,42,.96), rgba(15,23,42,.9));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
    }

    .toolbar{
      padding: 10px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(148,163,184,.18);
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      flex: 1 1 auto;
      min-width: 260px;
    }

    .control{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 260px;
      flex: 1 1 260px;
    }
    .control label{
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      padding-left: 2px;
    }
    .control input, .control select{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.6);
      background:
        radial-gradient(circle at 0 0, rgba(248,250,252,.06), transparent 60%),
        rgba(15,23,42,.92);
      color: var(--text);
      outline:none;
      transition: border-color var(--fast), box-shadow var(--fast), transform var(--fast);
      font-size: 12px;
    }
    .control input::placeholder{ color: rgba(148,163,184,.9); }
    .control input:focus, .control select:focus{
      border-color: rgba(56,189,248,.9);
      box-shadow: 0 0 0 1px rgba(56,189,248,.7);
      transform: translateY(-1px);
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex: 0 0 auto;
    }

    .btn{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.55);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.14), transparent 60%),
        rgba(15,23,42,.92);
      color: var(--text);
      cursor:pointer;
      transition: transform var(--fast), box-shadow var(--fast), border-color var(--fast), filter var(--fast);
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{
      border-color: rgba(56,189,248,.9);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.28), transparent 60%),
        linear-gradient(135deg, rgba(37,99,235,.92), rgba(56,189,248,.88));
      color:#ecfeff;
      box-shadow: 0 16px 35px rgba(30,64,175,.75);
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(248,250,252,.55); filter:brightness(1.03); }
    .btn:active{ transform: translateY(0); filter:brightness(0.98); }

    .status{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      color: var(--muted);
      font-size: 12px;
      padding-right: 2px;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .layout{
      display:grid;
      grid-template-columns: minmax(0, 1.45fr) minmax(0, 1fr);
      gap:12px;
      align-items:stretch;
      min-height: 0;
      flex: 1 1 auto;
    }

    .map-wrap{
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    #map{
      width:100%;
      height: 66vh;
      min-height: 360px;
      border-radius: var(--radius2);
      border: 1px solid var(--border2);
      box-shadow: 0 16px 40px rgba(15,23,42,.9);
      overflow:hidden;
      margin: 10px 12px 12px;
    }
    .map-foot{
      padding: 0 14px 12px;
      color: var(--muted2);
      font-size: 11px;
      letter-spacing:.02em;
    }

    .table-wrap{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .table-head{
      padding: 10px 12px 8px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(148,163,184,.18);
    }
    .table-head .t1{
      font-size: 11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .table-head .t2{
      margin-top: 3px;
      font-size: 11px;
      color: var(--muted2);
    }

    .table-scroll{
      margin: 10px 12px 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(55,65,81,.9);
      background:
        radial-gradient(circle at top left, rgba(15,23,42,.9), rgba(3,7,18,.98));
      box-shadow: 0 18px 45px rgba(15,23,42,.92);
      overflow:auto;
      max-height: calc(66vh - 120px);
      min-height: 260px;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      color: var(--text);
    }
    thead{
      position: sticky;
      top:0;
      z-index: 2;
    }
    th, td{
      padding: 7px 9px;
      border-bottom: 1px solid rgba(31,41,55,.9);
      text-align:left;
      white-space: nowrap;
      vertical-align: middle;
    }
    th{
      background: linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.95));
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .10em;
      font-size: 10px;
      color: var(--muted);
    }
    tbody tr:nth-child(even){ background: rgba(15,23,42,.78); }
    tbody tr:nth-child(odd){ background: rgba(3,7,18,.96); }
    tbody tr:hover{
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.16), transparent 55%),
        rgba(3,7,18,.98);
      cursor:pointer;
      transition: background var(--fast);
    }
    tbody tr.is-active{
      outline: 2px solid rgba(56,189,248,.55);
      outline-offset: -2px;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.22), transparent 55%),
        rgba(3,7,18,.98);
    }

    .navbtns{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .a-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 28px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.55);
      background: rgba(15,23,42,.9);
      color: var(--text);
      text-decoration:none;
      font-size: 11px;
      transition: transform var(--fast), border-color var(--fast), filter var(--fast);
      user-select:none;
    }
    .a-btn.gm{ border-color: rgba(56,189,248,.75); }
    .a-btn.wz{ border-color: rgba(34,197,94,.65); }
    .a-btn:hover{ transform: translateY(-1px); filter:brightness(1.03); border-color: rgba(248,250,252,.55); }

    .toast{
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.45);
      background: rgba(15,23,42,.92);
      box-shadow: 0 18px 50px rgba(15,23,42,.85);
      color: var(--text);
      max-width: 720px;
      display:none;
      gap: 10px;
      align-items:flex-start;
      cursor:pointer;
    }
    .toast.show{ display:flex; }
    .toast .t-dot{
      width:10px; height:10px; border-radius:999px; margin-top: 3px;
      background: var(--warn);
      box-shadow: 0 0 12px rgba(251,191,36,.7);
      flex:0 0 auto;
    }
    .toast .t-msg{ font-size: 12px; color: var(--text); }
    .toast .t-sub{ margin-top: 2px; font-size: 11px; color: var(--muted); }

    /* Leaflet popup styling */
    .leaflet-popup-content-wrapper{
      background: rgba(15,23,42,.95);
      color: var(--text);
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.35);
      box-shadow: 0 22px 55px rgba(15,23,42,.85);
    }
    .leaflet-popup-tip{ background: rgba(15,23,42,.95); }
    .popup-title{
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.08em;
      text-transform: uppercase;
      margin-bottom: 6px;
      color:#f9fafb;
    }
    .kv{
      display:grid;
      grid-template-columns: auto 1fr;
      gap: 3px 10px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .kv .k{ color: var(--muted); font-size: 10px; letter-spacing:.10em; text-transform: uppercase; }
    .kv .v{ color: var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 260px; }
    .popup-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .popup-actions a{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 30px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.55);
      background: rgba(15,23,42,.9);
      color: var(--text);
      font-size: 11px;
      transition: transform var(--fast), border-color var(--fast), filter var(--fast);
      user-select:none;
    }
    .popup-actions a:hover{ transform: translateY(-1px); filter:brightness(1.03); border-color: rgba(248,250,252,.55); }
    .popup-actions a.gm{ border-color: rgba(56,189,248,.75); }
    .popup-actions a.wz{ border-color: rgba(34,197,94,.65); }

    /* Different colored pins (devices vs my location) */
    .device-pin{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(248,250,252,.9);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      position: relative;
    }
    .device-pin::after{
      content:"";
      position:absolute;
      width: 30px; height: 30px;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      background: radial-gradient(circle, rgba(56,189,248,.18), transparent 60%);
      pointer-events:none;
    }
    .my-pin{
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(248,250,252,.95);
      background: linear-gradient(135deg, #22c55e, #38bdf8);
      box-shadow: 0 0 0 7px rgba(34,197,94,.14), 0 16px 30px rgba(0,0,0,.35);
      position: relative;
    }
    .my-pin::after{
      content:"";
      position:absolute;
      width: 34px; height: 34px;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      background: radial-gradient(circle, rgba(34,197,94,.20), transparent 62%);
      pointer-events:none;
    }

    @media (max-width: 1100px){
      .layout{ grid-template-columns: 1fr; }
      #map{ height: 52vh; min-height: 320px; }
      .table-scroll{ max-height: calc(52vh - 120px); }
    }

    @media (max-width: 520px){
      .shell{ padding: 10px 10px 16px; }
      header{ padding: 10px 12px; border-radius: 16px; }
      .pill{ display:none; }
      #map{ height: 48vh; }
      .table-scroll{ min-height: 240px; }
      th,td{ padding: 7px 8px; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <div class="pill" title="Field Mode">
        <span class="dot"></span>
        <span>Field Navigation</span>
      </div>

      <div class="hdr-title">
        <h1>ITS Field Operations Dashboard</h1>
        <div class="sub">Map + full Excel table + global search + Google/Waze navigation</div>
      </div>

      <div class="pill" title="Live CSV from Google Sheets">
        <span class="dot"></span>
        <span id="lastSync">Not loaded</span>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <div class="controls">
          <div class="control">
            <label for="q">Global Search (IP / logic id / name / anything)</label>
            <input id="q" type="text" placeholder="Type to search across all columns..." autocomplete="off" />
          </div>

          <div class="control">
            <label for="gcode">Filter by GFCODE (Asset Type)</label>
            <select id="gcode">
              <option value="__ALL__">All Types</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="locateBtn" type="button" title="Get your current position and center the map">Locate Me</button>
          <button class="btn" id="fitBtn" type="button" title="Fit map to currently filtered assets">Fit Assets</button>
          <button class="btn" id="reloadBtn" type="button" title="Reload data from CSV">Reload</button>
        </div>

        <div class="status" aria-live="polite">
          <span id="countLabel">0 assets</span>
          <span class="mono" id="csvState"></span>
        </div>
      </div>

      <div class="layout">
        <div class="card map-wrap">
          <div id="map"></div>
          <div class="map-foot" id="mapFoot">
            Tap a device marker (or table row) to view details and open navigation. My Location uses a different colored pin.
          </div>
        </div>

        <div class="card table-wrap">
          <div class="table-head">
            <div>
              <div class="t1">Asset List (All Excel Columns)</div>
              <div class="t2">Tap a row to zoom and open the marker popup. Rows without valid coordinates will not have map markers.</div>
            </div>
          </div>

          <div class="table-scroll">
            <table>
              <thead>
                <tr id="theadRow"></tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" title="Click to dismiss">
    <div class="t-dot"></div>
    <div>
      <div class="t-msg" id="toastMsg">Message</div>
      <div class="t-sub" id="toastSub"></div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSKAtXDwzYQCNXtLlFOz5fkof4kCLCtzkf7GokGaINUmrurF7CFPbsm6bF8HXXV3MA8PyfYOzMVK8Q/pub?gid=223122268&single=true&output=csv";

    // =========================
    // STATE
    // =========================
    let allRows = [];            // normalized rows with meta (coords, key, searchIndex)
    let filteredRows = [];
    let rawHeaders = [];         // original header order
    let headerMap = new Map();   // normalized header => original header label

    let map, deviceLayer;
    let markersByKey = new Map();
    let activeKey = null;

    let myMarker = null;
    let myAccuracyCircle = null;

    // =========================
    // DOM HELPERS
    // =========================
    const $ = (id) => document.getElementById(id);

    function showToast(msg, sub = "", kind = "warn") {
      const t = $("toast");
      const dot = t.querySelector(".t-dot");
      const colors = { ok:"var(--ok)", warn:"var(--warn)", bad:"var(--bad)", info:"var(--accent)" };
      const c = colors[kind] || colors.warn;
      dot.style.background = c;
      dot.style.boxShadow = `0 0 12px ${c}`;
      $("toastMsg").textContent = msg;
      $("toastSub").textContent = sub || "";
      t.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => t.classList.remove("show"), 4200);
    }

    function nowStamp() {
      const d = new Date();
      return d.toLocaleString("en-US", {
        year:"numeric", month:"short", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function canonicalHeader(h) {
      // Normalize headers to match even if casing/spaces differ.
      return String(h ?? "")
        .trim()
        .toLowerCase()
        .replaceAll(/\s+/g, " ")
        .replaceAll(/[\u200B-\u200D\uFEFF]/g, "")  // zero-width
        .replaceAll(/[()]/g, "")
        .replaceAll(/[._-]/g, " ")
        .replaceAll(/\s+/g, " ")
        .trim();
    }

    function cleanValue(v) {
      if (v === null || v === undefined) return "";
      // preserve as string; trim; collapse excessive spaces
      return String(v).replaceAll(/\u00A0/g, " ").trim().replaceAll(/\s+/g, " ");
    }

    function displayValue(v) {
      const s = cleanValue(v);
      if (!s || s.toLowerCase() === "nan") return "N/A";
      return s;
    }

    function parseNum(v) {
      const s = cleanValue(v);
      if (!s) return null;
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : null;
    }

    function getAny(row, names) {
      for (const n of names) {
        const key = canonicalHeader(n);
        const orig = headerMap.get(key);
        if (orig && Object.prototype.hasOwnProperty.call(row, orig)) {
          const val = cleanValue(row[orig]);
          if (val !== "") return val;
        }
        // also allow direct access if already exact (fallback)
        if (Object.prototype.hasOwnProperty.call(row, n)) {
          const val2 = cleanValue(row[n]);
          if (val2 !== "") return val2;
        }
      }
      return "";
    }

    function buildKey(rowObj, lat, lon) {
      const id = cleanValue(rowObj._id) || "NO_ID";
      const tag = cleanValue(rowObj._assettag) || "NO_TAG";
      return `${id}||${tag}||${lat ?? "NO_LAT"}||${lon ?? "NO_LON"}||${rowObj._rowIndex}`;
    }

    function gmapsLink(lat, lon) {
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat)},${encodeURIComponent(lon)}`;
    }
    function wazeLink(lat, lon) {
      return `https://waze.com/ul?ll=${encodeURIComponent(lat)},${encodeURIComponent(lon)}&navigate=yes`;
    }

    // =========================
    // DEVICE PIN COLORS (by GFCODE keywords)
    // =========================
    function typeColor(gcode) {
      const s = cleanValue(gcode).toUpperCase();
      if (!s) return "#94a3b8";
      if (s.includes("CCTV")) return "#38bdf8";
      if (s.includes("PTZ")) return "#22c55e";
      if (s.includes("LPR")) return "#a855f7";
      if (s.includes("DMS")) return "#f97316";
      if (s.includes("LCS")) return "#ec4899";
      if (s.includes("RWIS")) return "#fbbf24";
      if (s.includes("RVD") || s.includes("VIVD") || s.includes("VID")) return "#60a5fa";
      if (s.includes("AQ") || s.includes("AQM")) return "#34d399";
      if (s.includes("WIM")) return "#fb7185";
      if (s.includes("MAG")) return "#c084fc";
      if (s.includes("OVD") || s.includes("OVERHEIGHT")) return "#f59e0b";
      return "#94a3b8";
    }

    function deviceIcon(gcode) {
      const c = typeColor(gcode);
      return L.divIcon({
        className: "",
        html: `<div class="device-pin" style="background:${c};"></div>`,
        iconSize: [18,18],
        iconAnchor: [9,9],
        popupAnchor: [0,-10]
      });
    }

    function myLocationIcon() {
      // Different colored pin for current location (green/blue)
      return L.divIcon({
        className: "",
        html: `<div class="my-pin"></div>`,
        iconSize: [20,20],
        iconAnchor: [10,10],
        popupAnchor: [0,-10]
      });
    }

    // =========================
    // MAP
    // =========================
    function initMap() {
      map = L.map("map", { zoomControl: true, preferCanvas: true });
      map.setView([25.30, 51.45], 9);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      deviceLayer = L.layerGroup().addTo(map);
    }

    function clearDevices() {
      deviceLayer.clearLayers();
      markersByKey.clear();
    }

    function popupHtml(r) {
      // Required fields + show available extras (without crashing)
      const lat = r._lat, lon = r._lon;

      const id = displayValue(r._id);
      const gcode = displayValue(r._gcode);
      const tag = displayValue(r._assettag);
      const desc = displayValue(r._desc);
      const ip = displayValue(r._ip);

      const gm = (r._hasCoords) ? gmapsLink(lat, lon) : "";
      const wz = (r._hasCoords) ? wazeLink(lat, lon) : "";

      // Include a few common extra fields if present (still field-friendly)
      const logicId = displayValue(r._logicId);
      const projectId = displayValue(r._projectId);
      const camId = displayValue(r._cameraId);

      return `
        <div class="popup-title">${escapeHtml(gcode === "N/A" ? "DEVICE" : gcode)}</div>
        <div class="kv">
          <div class="k">ID</div><div class="v mono">${escapeHtml(id)}</div>
          <div class="k">GFCODE</div><div class="v">${escapeHtml(gcode)}</div>
          <div class="k">ASSETTAG</div><div class="v mono">${escapeHtml(tag)}</div>
          <div class="k">DESC</div><div class="v" title="${escapeHtml(desc)}">${escapeHtml(desc)}</div>
          <div class="k">IP</div><div class="v mono">${escapeHtml(ip)}</div>
          <div class="k">LOGIC ID</div><div class="v mono">${escapeHtml(logicId)}</div>
          <div class="k">PROJECT</div><div class="v mono">${escapeHtml(projectId)}</div>
          <div class="k">CAMERA ID</div><div class="v mono">${escapeHtml(camId)}</div>
          <div class="k">COORD</div><div class="v mono">${escapeHtml(r._hasCoords ? (lat.toFixed(6) + ", " + lon.toFixed(6)) : "N/A")}</div>
        </div>
        <div class="popup-actions">
          ${r._hasCoords ? `<a class="gm" href="${gm}" target="_blank" rel="noopener">Open in Google Maps</a>` : ``}
          ${r._hasCoords ? `<a class="wz" href="${wz}" target="_blank" rel="noopener">Open in Waze</a>` : ``}
        </div>
      `;
    }

    function renderMap(rows) {
      clearDevices();

      let countMarkers = 0;
      for (const r of rows) {
        if (!r._hasCoords) continue;

        const key = r._key;
        const m = L.marker([r._lat, r._lon], {
          icon: deviceIcon(r._gcode),
          title: cleanValue(r._id) || cleanValue(r._assettag) || "Device"
        }).bindPopup(popupHtml(r), { maxWidth: 380 });

        m.on("click", () => setActiveRow(key, true));
        markersByKey.set(key, m);
        m.addTo(deviceLayer);
        countMarkers++;
      }

      return countMarkers;
    }

    function fitToRows(rows) {
      const pts = rows.filter(r => r._hasCoords).map(r => [r._lat, r._lon]);
      if (!pts.length) return false;
      const b = L.latLngBounds(pts);
      map.fitBounds(b.pad(0.12), { animate: true, duration: 0.35 });
      return true;
    }

    function flyToKey(key, openPopup = true) {
      const m = markersByKey.get(key);
      if (!m) return;
      const ll = m.getLatLng();
      map.flyTo(ll, Math.max(map.getZoom(), 16), { animate: true, duration: 0.55 });
      if (openPopup) setTimeout(() => m.openPopup(), 220);
    }

    // =========================
    // TABLE (ALL COLUMNS + NAV COLUMN)
    // =========================
    function buildTableHeader() {
      const tr = $("theadRow");
      tr.innerHTML = "";

      // Navigation column always first for technician workflow
      const thNav = document.createElement("th");
      thNav.textContent = "NAV";
      thNav.style.minWidth = "180px";
      tr.appendChild(thNav);

      for (const h of rawHeaders) {
        const th = document.createElement("th");
        th.textContent = h;
        tr.appendChild(th);
      }
    }

    function navButtonsForRow(r) {
      if (!r._hasCoords) {
        return `<span class="mono" style="color:rgba(156,163,175,.9); font-size:11px;">N/A</span>`;
      }
      return `
        <div class="navbtns">
          <a class="a-btn gm" href="${gmapsLink(r._lat, r._lon)}" target="_blank" rel="noopener">Google Maps</a>
          <a class="a-btn wz" href="${wazeLink(r._lat, r._lon)}" target="_blank" rel="noopener">Waze</a>
        </div>
      `;
    }

    function renderTable(rows) {
      const tb = $("tbody");
      tb.innerHTML = "";

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.dataset.key = r._key;

        // NAV cell first
        const tdNav = document.createElement("td");
        tdNav.innerHTML = navButtonsForRow(r);
        tr.appendChild(tdNav);

        for (const h of rawHeaders) {
          const td = document.createElement("td");
          const val = displayValue(r._raw[h]);
          td.textContent = val;
          if (val !== "N/A" && String(val).length > 24) td.title = val;
          if (val !== "N/A" && String(val).length > 30) {
            td.style.maxWidth = "360px";
            td.style.overflow = "hidden";
            td.style.textOverflow = "ellipsis";
          }
          // monospaced for likely IDs/IP fields
          const hc = canonicalHeader(h);
          if (hc.includes("ip") || hc.includes("id") || hc.includes("asset") || hc.includes("mxasset") || hc.includes("sr no") || hc.includes("logic") || hc.includes("project") || hc.includes("camera")) {
            td.classList.add("mono");
          }
          tr.appendChild(td);
        }

        tr.addEventListener("click", (e) => {
          const a = e.target.closest("a");
          if (a) return; // allow nav links
          setActiveRow(r._key, true);
          if (r._hasCoords) flyToKey(r._key, true);
          else showToast("No coordinates for this row.", "Add Latitude/Longitude later; it will appear on the map after reload.", "warn");
        });

        tb.appendChild(tr);
      }

      if (activeKey) setActiveRow(activeKey, false);
    }

    function setActiveRow(key, scrollIntoView = true) {
      activeKey = key;
      const rows = document.querySelectorAll("#tbody tr");
      for (const r of rows) r.classList.toggle("is-active", r.dataset.key === key);
      if (scrollIntoView) {
        const r = document.querySelector(`#tbody tr[data-key="${CSS.escape(key)}"]`);
        if (r) r.scrollIntoView({ block:"nearest", behavior:"smooth" });
      }
    }

    // =========================
    // FILTERING (GLOBAL SEARCH + GFCODE)
    // =========================
    function populateGcodeOptions() {
      const sel = $("gcode");
      const current = sel.value;

      const codes = Array.from(new Set(allRows.map(r => cleanValue(r._gcode)).filter(Boolean)))
        .sort((a,b) => a.localeCompare(b, undefined, { sensitivity:"base" }));

      sel.innerHTML = `<option value="__ALL__">All Types</option>`;
      for (const c of codes) {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      }

      if ([...sel.options].some(o => o.value === current)) sel.value = current;
    }

    function applyFilters() {
      const q = cleanValue($("q").value).toLowerCase();
      const g = $("gcode").value;

      filteredRows = allRows.filter(r => {
        if (g !== "__ALL__" && cleanValue(r._gcode) !== g) return false;
        if (q) return r._searchIndex.includes(q);
        return true;
      });

      $("countLabel").textContent = `${filteredRows.length} assets`;
      const markerCount = renderMap(filteredRows);
      renderTable(filteredRows);

      if (filteredRows.length === 0) {
        $("mapFoot").textContent = "No assets match current filters.";
      } else {
        $("mapFoot").textContent = `Showing ${filteredRows.length} assets (${markerCount} mapped). Tap a marker or row to navigate.`;
      }
    }

    // =========================
    // GEOLOCATION (MY LOCATION - DIFFERENT PIN COLOR)
    // =========================
    function setMyLocation(lat, lon, accuracyMeters) {
      const ll = L.latLng(lat, lon);

      if (!myMarker) {
        myMarker = L.marker(ll, { icon: myLocationIcon(), title: "My Location" })
          .bindPopup(
            `<div class="popup-title">My Location</div>
             <div class="kv">
               <div class="k">COORD</div><div class="v mono">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
             </div>`,
            { maxWidth: 320 }
          );
        myMarker.addTo(map);
      } else {
        myMarker.setLatLng(ll);
      }

      if (Number.isFinite(accuracyMeters) && accuracyMeters > 0) {
        if (!myAccuracyCircle) {
          myAccuracyCircle = L.circle(ll, {
            radius: accuracyMeters,
            color: "rgba(34,197,94,.85)",
            weight: 2,
            fillColor: "rgba(34,197,94,.15)",
            fillOpacity: 0.35
          }).addTo(map);
        } else {
          myAccuracyCircle.setLatLng(ll);
          myAccuracyCircle.setRadius(accuracyMeters);
        }
      }

      map.flyTo(ll, Math.max(map.getZoom(), 16), { animate:true, duration:0.6 });
    }

    function locateMe() {
      if (!navigator.geolocation) {
        showToast("Geolocation not supported.", "Use a modern browser and allow location access.", "bad");
        return;
      }

      const btn = $("locateBtn");
      btn.disabled = true;
      btn.textContent = "Locating...";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;

          setMyLocation(lat, lon, acc);
          showToast("Location updated.", `Accuracy: ${Math.round(acc)} m`, "ok");

          btn.disabled = false;
          btn.textContent = "Locate Me";
        },
        (err) => {
          let sub = err && err.message ? err.message : "Check permissions and GPS availability.";
          if (err && err.code === 1) sub = "Permission denied. Enable location access for this page.";
          if (err && err.code === 2) sub = "Position unavailable. Try moving outdoors or enabling GPS.";
          if (err && err.code === 3) sub = "Timeout. Try again.";
          showToast("Unable to fetch location.", sub, "bad");

          btn.disabled = false;
          btn.textContent = "Locate Me";
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:15000 }
      );
    }

    // =========================
    // CSV LOADING (ROBUST TO EMPTY SPACES)
    // =========================
    function buildHeaderMap(headers) {
      headerMap.clear();
      rawHeaders = [];
      for (const h of headers) {
        const label = cleanValue(h);
        if (!label) continue;
        rawHeaders.push(label);
        headerMap.set(canonicalHeader(label), label);
      }
    }

    function normalizeRow(raw, rowIndex) {
      // keep raw in original labels
      const obj = { _raw: {}, _rowIndex: rowIndex };

      for (const h of rawHeaders) obj._raw[h] = cleanValue(raw[h]);

      // coords (support typical variants)
      const latVal = getAny(obj._raw, ["Latitude (WGS84)", "Latitude WGS84", "Latitude", "Lat", "LAT"]);
      const lonVal = getAny(obj._raw, ["Longitude (WGS84)", "Longitude WGS84", "Longitude", "Lon", "LON", "Lng", "Long"]);
      const lat = parseNum(latVal);
      const lon = parseNum(lonVal);

      obj._lat = lat;
      obj._lon = lon;
      obj._hasCoords = (lat !== null && lon !== null);

      // common fields for popup + coloring + filtering
      obj._id = getAny(obj._raw, ["ID", "Id", "id"]);
      obj._gcode = getAny(obj._raw, ["GFCODE", "Gfcode", "Asset Type", "Device Type"]);
      obj._assettag = getAny(obj._raw, ["ASSETTAG", "ASSET_TAG", "Asset Tag", "AssetTag", "asset tag"]);
      obj._desc = getAny(obj._raw, ["DESCRIPTION", "Description", "desc", "Name"]);
      obj._ip = getAny(obj._raw, ["IP Address", "IP", "IPAddress", "IPADDRESS"]);
      obj._logicId = getAny(obj._raw, ["logic id", "Logic ID", "Logic id", "LogicId"]);
      obj._projectId = getAny(obj._raw, ["Project id", "Project ID", "ProjectId"]);
      obj._cameraId = getAny(obj._raw, ["Camera ID", "Camera Id", "CameraId"]);

      // global search index across ALL columns (defensive against empty spaces)
      const parts = [];
      for (const h of rawHeaders) parts.push(cleanValue(obj._raw[h]).toLowerCase());
      obj._searchIndex = parts.join(" | ");

      obj._key = buildKey(obj, obj._lat, obj._lon);

      return obj;
    }

    function loadCsv() {
      $("csvState").textContent = "Loading...";
      $("lastSync").textContent = "Loading...";
      $("reloadBtn").disabled = true;

      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          const headers = res.meta && res.meta.fields ? res.meta.fields : [];
          if (!headers.length) {
            $("csvState").textContent = "No headers";
            $("lastSync").textContent = "Load failed";
            $("reloadBtn").disabled = false;
            showToast("CSV has no headers.", "Check the published sheet tab and CSV export.", "bad");
            return;
          }

          buildHeaderMap(headers);
          buildTableHeader();

          const rows = Array.isArray(res.data) ? res.data : [];
          allRows = [];
          let dropped = 0;

          for (let i = 0; i < rows.length; i++) {
            // Keep rows even if coords missing (table should show everything)
            const r = normalizeRow(rows[i], i + 2); // +2 to approximate sheet row number
            // Drop completely empty rows
            const anyVal = rawHeaders.some(h => cleanValue(r._raw[h]) !== "");
            if (!anyVal) { dropped++; continue; }
            allRows.push(r);
          }

          populateGcodeOptions();
          applyFilters();

          $("csvState").textContent = "";
          $("lastSync").textContent = `Synced: ${nowStamp()}`;
          $("reloadBtn").disabled = false;

          // Fit to assets (prefer mapped points)
          const okFit = fitToRows(allRows);
          if (!okFit) map.setView([25.30, 51.45], 9);

          showToast("Assets loaded.", `${allRows.length} rows ready. (${dropped} empty rows ignored)`, "ok");
        },
        error: (err) => {
          $("csvState").textContent = "Load failed";
          $("lastSync").textContent = "Load failed";
          $("reloadBtn").disabled = false;
          showToast("Failed to load CSV.", err && err.message ? err.message : "Check network access.", "bad");
        }
      });
    }

    // =========================
    // EVENTS
    // =========================
    function wireEvents() {
      $("q").addEventListener("input", () => applyFilters());
      $("gcode").addEventListener("change", () => applyFilters());
      $("locateBtn").addEventListener("click", locateMe);
      $("fitBtn").addEventListener("click", () => {
        if (filteredRows.length === 0) {
          showToast("Nothing to fit.", "No assets match current filters.", "warn");
          return;
        }
        const ok = fitToRows(filteredRows);
        showToast(ok ? "Fitted to assets." : "No mapped assets to fit.", ok ? "Map centered to filtered devices." : "Filtered rows have no valid coordinates.", ok ? "info" : "warn");
      });
      $("reloadBtn").addEventListener("click", () => loadCsv());
      $("toast").addEventListener("click", () => $("toast").classList.remove("show"));
    }

    // =========================
    // BOOT
    // =========================
    (function boot(){
      initMap();
      wireEvents();
      loadCsv();
    })();
  </script>
</body>

</html>
