<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ITS Field Operations Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Maps JavaScript API -->
  <!-- NOTE: Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual Google Maps API key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCgMYUs6ubjoSNrjKX9nDs1Y3BdG_SpxsQ"></script>

  <style>
    :root{
      --bg0:#020617;
      --glass:rgba(15,23,42,.72);
      --glass2:rgba(15,23,42,.90);
      --border:rgba(148,163,184,.45);
      --shadow:0 22px 45px rgba(15,23,42,.65);
      --radius-lg:18px;
      --radius-md:14px;

      --text0:#f9fafb;
      --text1:#e5e7eb;
      --text2:#9ca3af;
      --text3:#6b7280;

      --accent-blue:#38bdf8;
      --accent-green:#22c55e;
      --accent-red:#ef4444;

      --trans:180ms cubic-bezier(.22,.61,.36,1);
    }
    body[data-theme="light"]{
      --bg0:#f3f4f6;
      --glass:rgba(255,255,255,.90);
      --glass2:rgba(255,255,255,.96);
      --border:rgba(148,163,184,.55);
      --shadow:0 18px 50px rgba(15,23,42,.16);

      --text0:#020617;
      --text1:#111827;
      --text2:#374151;
      --text3:#6b7280;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    html,body{height:100%}
    body{min-height:100vh;background:var(--bg0);color:var(--text1);overflow-x:hidden}
    .page{
      min-height:100vh;
      background:
        linear-gradient(180deg, rgba(2,6,23,.15), rgba(2,6,23,.25)),
        url("bg-image.png") center / cover no-repeat fixed,
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(236,72,153,.14), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249,115,22,.12), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(168,85,247,.14), transparent 60%);
      padding-bottom:18px;
    }
    .shell{max-width:1880px;margin:0 auto;padding:12px 16px 24px}

    header{
      width:100%;
      border-radius:20px;
      margin-bottom:10px;
      padding:10px 20px;
      background:
        linear-gradient(135deg, rgba(15,23,42,.97), rgba(15,23,42,.92)),
        linear-gradient(90deg, rgba(56,189,248,.35), rgba(168,85,247,.35), rgba(236,72,153,.26));
      box-shadow:0 24px 60px rgba(15,23,42,.85), 0 0 0 1px rgba(148,163,184,.35);
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
    }
    body[data-theme="light"] header{
      background:
        linear-gradient(135deg, rgba(255,255,255,.94), rgba(255,255,255,.92)),
        linear-gradient(90deg, rgba(56,189,248,.22), rgba(168,85,247,.20), rgba(236,72,153,.18));
    }

    .header-left,.header-right{flex:0 0 auto;display:flex;align-items:center;gap:8px}
    .header-center{flex:1 1 auto;text-align:center}
    .header-logo{max-height:52px;height:auto;filter:drop-shadow(0 8px 20px rgba(15,23,42,.8))}
    .header-logo-small{max-height:44px}
    .header-title{
      font-size:clamp(18px,2vw,26px);
      font-weight:800;
      letter-spacing:.08em;
      color:var(--text0);
      text-transform:uppercase;
    }
    .header-subtitle{
      font-size:11px;
      color:var(--text2);
      margin-top:4px;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .header-meta{font-size:11px;color:rgba(199,210,254,.95);margin-top:4px}
    body[data-theme="light"] .header-meta{color:rgba(55,65,81,.95)}

    .top-row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0;flex-wrap:wrap
    }
    .pill{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      padding:6px 12px;
      font-size:11px;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.20), transparent 55%),
        linear-gradient(135deg, rgba(15,23,42,.96), rgba(15,23,42,.98));
      color:var(--text2);
      box-shadow:0 16px 35px rgba(15,23,42,.55);
      display:inline-flex;align-items:center;gap:8px;user-select:none;
    }
    body[data-theme="light"] .pill{
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.12), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.96), rgba(243,244,246,.96));
      box-shadow:0 12px 28px rgba(148,163,184,.28);
    }
    .status-dot{width:10px;height:10px;border-radius:999px;background:rgba(148,163,184,.8);box-shadow:0 0 12px rgba(148,163,184,.35)}
    .status-dot.ok{background:var(--accent-green);box-shadow:0 0 12px rgba(34,197,94,.75)}
    .status-dot.bad{background:var(--accent-red);box-shadow:0 0 12px rgba(239,68,68,.75)}
    .theme-toggle{
      padding:6px 14px;border-radius:999px;font-size:10px;letter-spacing:.12em;text-transform:uppercase;
      border:1px solid rgba(148,163,184,.75);
      background-image:
        radial-gradient(circle at top left, rgba(56,189,248,.18), transparent 60%),
        linear-gradient(135deg, rgba(15,23,42,.96), rgba(15,23,42,.98));
      color:var(--text2);
      cursor:pointer;
      transition:transform var(--trans), box-shadow var(--trans), border-color var(--trans);
      white-space:nowrap;
    }
    .theme-toggle:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(15,23,42,.45);border-color:rgba(248,250,252,.75)}
    body[data-theme="light"] .theme-toggle{
      background-image:
        radial-gradient(circle at top left, rgba(59,130,246,.14), transparent 60%),
        linear-gradient(135deg,#fff,#f9fafb);
      color:rgba(55,65,81,.95);
      border-color:rgba(148,163,184,.9);
    }

    .glass-card{
      position:relative;
      background:
        radial-gradient(circle at top left, rgba(248,250,252,.14), transparent 42%),
        linear-gradient(145deg, var(--glass2), var(--glass));
      border-radius:var(--radius-lg);
      padding:10px 14px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      overflow:hidden;
    }

    /* KPI cards: wrap to 2+ lines (no horizontal scroll) */
    .kpi-wrap{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:stretch;
      padding-bottom:2px;
    }
    .kpi{
      flex:0 0 auto;
      min-width:172px;
      max-width:220px;
      border-radius:var(--radius-md);
      padding:10px 12px;
      border:1px solid rgba(148,163,184,.55);
      background:
        linear-gradient(145deg, rgba(15,23,42,.96), rgba(15,23,42,.90)),
        linear-gradient(120deg, rgba(56,189,248,.18), rgba(168,85,247,.14), rgba(236,72,153,.12));
      box-shadow:0 16px 35px rgba(15,23,42,.6);
    }
    body[data-theme="light"] .kpi{
      background:
        linear-gradient(145deg, rgba(255,255,255,.96), rgba(243,244,246,.96)),
        linear-gradient(120deg, rgba(56,189,248,.12), rgba(168,85,247,.10), rgba(236,72,153,.10));
      box-shadow:0 14px 30px rgba(148,163,184,.22);
    }
    .kpi-label{
      font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--text2);
      display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .kpi-badge{
      width:10px;height:10px;border-radius:3px;border:1px solid rgba(255,255,255,.5);
      box-shadow:0 0 14px rgba(15,23,42,.55);flex:0 0 auto;
    }
    body[data-theme="light"] .kpi-badge{border-color:rgba(2,6,23,.25)}
    .kpi-value{font-size:24px;font-weight:800;margin-top:4px;color:var(--text0)}

    .controls-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
    .search{flex:1 1 420px;min-width:220px}
    .search input{
      width:100%;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      font-size:12px;
      background:
        radial-gradient(circle at 0 0, rgba(248,250,252,.06), transparent 60%),
        rgba(15,23,42,.96);
      color:var(--text1);
      outline:none;
      transition:border-color var(--trans), box-shadow var(--trans), transform var(--trans);
    }
    body[data-theme="light"] .search input{background:rgba(255,255,255,.96);color:var(--text1);border-color:rgba(148,163,184,.85)}
    .search input:focus{border-color:rgba(56,189,248,.9);box-shadow:0 0 0 1px rgba(56,189,248,.55);transform:translateY(-1px)}
    .search input::placeholder{color:rgba(148,163,184,.9)}

    .filter{flex:0 0 auto;display:flex;align-items:center;gap:8px}
    .filter select{
      padding:10px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.7);
      font-size:12px;background:rgba(15,23,42,.96);color:var(--text1);outline:none;min-width:240px;
      transition:border-color var(--trans), box-shadow var(--trans), transform var(--trans);
      appearance:none;-webkit-appearance:none;
    }
    body[data-theme="light"] .filter select{background:rgba(255,255,255,.96);color:var(--text1);border-color:rgba(148,163,184,.85)}
    .filter select:focus{border-color:rgba(56,189,248,.9);box-shadow:0 0 0 1px rgba(56,189,248,.55);transform:translateY(-1px)}

    .btn{
      padding:10px 14px;border-radius:999px;border:1px solid rgba(56,189,248,.9);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.32), transparent 55%),
        linear-gradient(135deg, rgba(37,99,235,.96), rgba(56,189,248,.95));
      color:#ecfeff;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 16px 35px rgba(30,64,175,.55);
      transition:transform var(--trans), box-shadow var(--trans), filter var(--trans);
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 22px 48px rgba(30,64,175,.65);filter:brightness(1.04)}
    .btn.secondary{
      border-color:rgba(148,163,184,.7);
      background:rgba(15,23,42,.88);
      color:var(--text2);
      box-shadow:0 16px 35px rgba(15,23,42,.35);
    }
    body[data-theme="light"] .btn.secondary{background:rgba(255,255,255,.92);color:rgba(55,65,81,.95);box-shadow:0 14px 30px rgba(148,163,184,.22)}
    .export-group{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}

    .map-card{padding:10px}
    .map-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:4px 6px 10px;flex-wrap:wrap}
    .map-title{
      font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:var(--text2);
      display:flex;align-items:center;gap:8px;
    }
    .map-title .dot{width:8px;height:8px;border-radius:999px;background:linear-gradient(135deg,var(--accent-blue),var(--accent-green));box-shadow:0 0 12px rgba(56,189,248,.65)}
    .map-box{
      position:relative;width:100%;height:520px;border-radius:var(--radius-md);overflow:hidden;
      border:1px solid rgba(148,163,184,.55);
      box-shadow:0 16px 40px rgba(15,23,42,.65);
      background:rgba(0,0,0,.12);
    }

    .map-footer{padding:10px 6px 2px;font-size:11px;color:var(--text3);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}

    .table-card{padding:12px 14px}
    .table-title{
      font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:var(--text2);
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;flex-wrap:wrap;
    }
    .table-hint{font-size:11px;color:var(--text3);letter-spacing:.02em;text-transform:none}
    .table-wrap{
      width:100%;max-height:380px;overflow:auto;border-radius:12px;border:1px solid rgba(55,65,81,.9);
      background:radial-gradient(circle at top left, rgba(15,23,42,.86), rgba(3,7,18,.96));
      box-shadow:0 18px 45px rgba(15,23,42,.55);
    }
    body[data-theme="light"] .table-wrap{
      background:rgba(255,255,255,.92);
      border-color:rgba(148,163,184,.55);
      box-shadow:0 18px 45px rgba(148,163,184,.18);
    }
    table{width:100%;border-collapse:collapse;font-size:12px;color:var(--text1)}
    thead{position:sticky;top:0;z-index:2}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(31,41,55,.6);text-align:left;white-space:nowrap}
    th{
      background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.92));
      font-weight:800;text-transform:uppercase;letter-spacing:.12em;font-size:10px;color:var(--text2);
    }
    body[data-theme="light"] th{
      background:linear-gradient(180deg, rgba(243,244,246,.98), rgba(229,231,235,.98));
      color:rgba(55,65,81,.95);
      border-bottom-color:rgba(148,163,184,.55);
    }
    tbody tr:nth-child(even){background:rgba(15,23,42,.72)}
    tbody tr:nth-child(odd){background:rgba(3,7,18,.92)}
    body[data-theme="light"] tbody tr:nth-child(even){background:rgba(249,250,251,.98)}
    body[data-theme="light"] tbody tr:nth-child(odd){background:rgba(243,244,246,.98)}
    tbody tr:hover{
      background:radial-gradient(circle at 0 0, rgba(56,189,248,.14), transparent 55%), rgba(3,7,18,.96);
      cursor:pointer;
    }
    body[data-theme="light"] tbody tr:hover{
      background:radial-gradient(circle at 0 0, rgba(56,189,248,.10), transparent 55%), rgba(255,255,255,.98);
    }

    .small-muted{color:var(--text3);font-size:11px}

    .esri-popup__main-container{
      border-radius:14px !important;
      border:1px solid rgba(148,163,184,.35) !important;
      overflow:hidden !important;
      box-shadow:0 18px 45px rgba(15,23,42,.55) !important;
      max-width:520px !important;
    }
    body[data-theme="light"] .esri-popup__main-container{box-shadow:0 18px 45px rgba(148,163,184,.22) !important}

    .popup-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .popup-link{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:8px 10px;border-radius:999px;border:1px solid rgba(56,189,248,.9);
      background:radial-gradient(circle at 0 0, rgba(56,189,248,.28), transparent 55%), linear-gradient(135deg, rgba(37,99,235,.96), rgba(56,189,248,.95));
      color:#ecfeff !important;text-decoration:none !important;font-weight:700;font-size:12px;
      box-shadow:0 14px 30px rgba(30,64,175,.45);
      white-space:nowrap;
    }
    .popup-link.waze{
      border-color:rgba(168,85,247,.9);
      background:radial-gradient(circle at 0 0, rgba(168,85,247,.28), transparent 55%), linear-gradient(135deg, rgba(147,51,234,.96), rgba(168,85,247,.95));
      box-shadow:0 14px 30px rgba(88,28,135,.35);
    }

    .popup-kv{
      margin-top:8px;
      border:1px solid rgba(148,163,184,.25);
      border-radius:12px;
      overflow:hidden;
    }
    .popup-kv table{width:100%;border-collapse:collapse;font-size:12px}
    .popup-kv td{
      padding:6px 10px;
      border-bottom:1px solid rgba(148,163,184,.18);
      vertical-align:top;
      white-space:normal;
    }
    .popup-kv tr:last-child td{border-bottom:none}
    .popup-kv td:first-child{
      width:40%;
      color:rgba(156,163,175,.95);
      font-weight:700;
      letter-spacing:.02em;
    }
    body[data-theme="light"] .popup-kv td:first-child{color:rgba(55,65,81,.85)}
    .popup-details{
      margin-top:10px;
      border:1px solid rgba(148,163,184,.22);
      border-radius:12px;
      overflow:hidden;
    }
    .popup-details summary{
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:rgba(156,163,175,.95);
      background:rgba(15,23,42,.35);
      user-select:none;
      list-style:none;
    }
    .popup-details summary::-webkit-details-marker{display:none}
    body[data-theme="light"] .popup-details summary{background:rgba(243,244,246,.75);color:rgba(55,65,81,.85)}
    .popup-details .inner{padding:8px 10px}

    @media (max-width:980px){
      header{flex-wrap:wrap;padding:10px 14px}
      .header-center{text-align:left}
      .map-box{height:440px}
      .filter select{min-width:220px}
      .legend{width:280px}
    }
    @media (max-width:640px){
      .shell{padding:10px 10px 20px}
      .map-box{height:380px}
      .legend{right:10px;left:10px;width:auto;bottom:10px;top:auto;max-height:48%}
      .legend.is-collapsed{width:auto}
      .legend-body{max-height:220px}
      .filter select{min-width:100%}
      .controls-bar{gap:8px}
      .export-group{width:100%;justify-content:flex-start;margin-left:0}
      .btn{width:100%;justify-content:center}
      .btn.secondary{width:100%;justify-content:center}
    }
  
    /* ===================== AUTH OVERLAY ===================== */
    .auth-overlay{
      position:fixed; inset:0; z-index:9999;
      display:none;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      padding:16px;
    }
    .auth-overlay.show{ display:flex; }
    .auth-card{
      width:min(420px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(16,24,40,.92), rgba(2,6,23,.86));
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      padding:18px 18px 16px;
    }
    .auth-title{ font-weight:800; letter-spacing:.02em; font-size:18px; }
    .auth-subtitle{ opacity:.8; font-size:12px; margin-top:4px; margin-bottom:12px; }
    .auth-label{ display:block; font-size:12px; opacity:.9; margin:10px 0 6px; }
    .auth-input{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      outline:none;
    }
    .auth-input:focus{ border-color: rgba(96,165,250,.55); box-shadow:0 0 0 3px rgba(59,130,246,.18); }
    .auth-btn{ width:100%; margin-top:12px; justify-content:center; }
    .auth-msg{ margin-top:10px; font-size:12px; min-height:16px; }
    .auth-msg.ok{ color: #86efac; }
    .auth-msg.err{ color: #fca5a5; }
    .auth-hint{ margin-top:10px; font-size:11px; opacity:.75; line-height:1.3; }

    /* ===================== TEAM TRACKING UI ===================== */
    .btn.warn{
      background: rgba(245,158,11,.18);
      border-color: rgba(245,158,11,.32);
    }
    .btn.warn:hover{ filter: brightness(1.06); }

  
    /* Move Locate and Logout to the top right */
    .header-right { display: flex; gap: 10px; align-items: center; }

    /* Re-organize the controls bar to appear below the map */
    .controls-bar {
        display: flex;
        position: relative;
        order: 10; /* Move to bottom of its parent */
        margin-top: 20px;
        padding: 15px;
        background: var(--glass);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Hide tracking buttons */
    #trackBtn, #stopTrackBtn { display: none !important; }

    /* Ensure the search bar takes priority space */
    .search { flex: 2; min-width: 300px; }
    .filter { flex: 1; min-width: 200px; }

    /* Layout adjustment for the whole page */
    .glass-card:has(.controls-bar) {
        display: flex;
        flex-direction: column;
    }

    /* Move the controls bar specifically below the map card */
    .page .shell { display: flex; flex-direction: column; }
    .glass-card:has(.kpi-wrap) { order: 1; }
    .map-card { order: 2; margin-top: 15px; }
    .glass-card:has(.controls-bar) { order: 3; margin-top: 15px; }
    .table-card { order: 4; margin-top: 15px; }

  

    /* ==============================
       MOBILE VIEW (APP-LIKE)
       - Single column flow
       - Sticky top row (status/theme/last sync)
       - Controls bar becomes stacked + sticky under top row
       - Map height optimized
       - Table becomes card-like rows (optional) with horizontal scroll fallback
       ============================== */
    @media (max-width: 640px){
      .page{ padding-bottom: 10px; }
      .shell{ padding: 10px 10px 14px; }

      header{
        padding: 10px 12px;
        gap: 10px;
      }
      .header-left img.header-logo{ max-height: 38px; }
      .header-right img.header-logo-small{ max-height: 34px; }
      .header-title{ letter-spacing: .05em; font-size: 16px; }
      .header-subtitle{ display:none; }
      .header-meta{ display:none; }

      /* Make the top pills row feel like a mobile status bar */
      .top-row{
        position: sticky;
        top: 8px;
        z-index: 50;
        background: transparent;
        margin: 8px 0 10px;
      }
      .top-row .pill{ flex: 1 1 auto; justify-content:center; }
      .theme-toggle{ flex: 0 0 auto; }

      /* KPI: 2 columns grid feel */
      .kpi-wrap{ gap: 8px; }
      .kpi{ min-width: calc(50% - 4px); max-width: none; flex: 1 1 calc(50% - 4px); }
      .kpi-value{ font-size: 20px; }

      /* Controls: stacked, full-width, sticky under the top row */
      .glass-card{ padding: 10px 10px; }
      .controls-bar{
        position: sticky;
        top: 64px; /* below sticky top-row */
        z-index: 60;
        margin-top: 10px;
        padding: 10px;
        gap: 8px;
        backdrop-filter: blur(22px);
      }
      .search{ flex: 1 1 100%; min-width: 100%; }
      .filter{ flex: 1 1 100%; min-width: 100%; }
      .filter select{ width: 100%; min-width: 100%; }

      /* Buttons: 2-per-row grid */
      .controls-bar .btn{ width: calc(50% - 4px); justify-content:center; }
      .controls-bar .btn.secondary{ width: calc(50% - 4px); justify-content:center; }
      .export-group{ width: 100%; margin-left: 0; }
      .export-group .btn{ width: calc(50% - 4px); }

      /* Map: shorter but still usable */
      .map-box{ height: 360px; border-radius: 14px; }
      .map-card{ padding: 10px; }

      /* Fix stray closing div in markup causing layout issues on small screens:
         visually contain the map card even if HTML has a mismatch */
      .map-card{ overflow: hidden; }

      /* Table: stronger affordance and better scroll */
      .table-card{ padding: 10px; }
      .table-wrap{ max-height: 55vh; -webkit-overflow-scrolling: touch; }
      th, td{ padding: 10px 10px; }

      /* Reduce hover effects that feel odd on touch */
      tbody tr:hover{ background: inherit; }

      /* Make popup buttons fit mobile */
      .popup-btns{ gap: 8px; }
      .popup-link{ flex: 1 1 auto; width: 100%; justify-content:center; }
    }


    /* ========== MOVE KPI TO BOTTOM AS COLLAPSIBLE PANEL ========== */
    .kpi-wrap {
        display: none !important; /* Hide original KPI cards */
    }

    /* Mini stats bar at top */
    .mini-stats-bar {
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 12px 16px;
        background: var(--glass);
        border-radius: var(--radius-lg);
        margin-bottom: 12px;
        border: 1px solid var(--border);
        flex-wrap: wrap;
        gap: 12px;
    }

    .mini-stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text1);
    }

    .mini-stat-value {
        font-size: 20px;
        font-weight: 800;
        color: var(--accent-blue);
    }

    /* Statistics panel at bottom */
    .stats-panel {
        margin-top: 16px;
        background: var(--glass);
        border-radius: var(--radius-lg);
        padding: 16px;
        border: 1px solid var(--border);
    }

    .stats-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: var(--radius-md);
        transition: background var(--trans);
        user-select: none;
    }

    .stats-toggle:hover {
        background: rgba(56, 189, 248, 0.08);
    }

    .stats-toggle-title {
        font-size: 13px;
        font-weight: 800;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--text2);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stats-arrow {
        font-size: 16px;
        color: var(--text2);
        transition: transform var(--trans);
    }

    .stats-arrow.open {
        transform: rotate(180deg);
    }

    .stats-content {
        display: none;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
    }

    .stats-content.open {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
    }

    .stat-card {
        background: linear-gradient(145deg, rgba(15,23,42,.96), rgba(15,23,42,.90));
        border: 1px solid rgba(148,163,184,.55);
        border-radius: var(--radius-md);
        padding: 14px 16px;
        box-shadow: 0 8px 20px rgba(15,23,42,.4);
    }

    body[data-theme="light"] .stat-card {
        background: linear-gradient(145deg, rgba(255,255,255,.96), rgba(243,244,246,.96));
        box-shadow: 0 8px 20px rgba(148,163,184,.15);
    }

    .stat-card-label {
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--text2);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-card-value {
        font-size: 28px;
        font-weight: 800;
        color: var(--text0);
    }

    .stat-badge {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        background: var(--accent-blue);
        box-shadow: 0 0 12px rgba(56, 189, 248, 0.6);
    }

    @media (max-width: 640px) {
        .mini-stats-bar {
            flex-direction: column;
            align-items: flex-start;
        }

        .stats-content.open {
            grid-template-columns: repeat(2, 1fr);
        }
    }

</style>

  <!-- Firebase (App + Auth + Firestore) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // Project config (from Firebase Console)
    const firebaseConfig = {
      apiKey: "AIzaSyCDi3nqYLnlDPEzhFquWHo0Be5t2Bhmyvs",
      authDomain: "qatar-north-its-dashboard.firebaseapp.com",
      projectId: "qatar-north-its-dashboard",
      storageBucket: "qatar-north-its-dashboard.firebasestorage.app",
      messagingSenderId: "1038045527292",
      appId: "1:1038045527292:web:087b3d29d3e7c15686ab79"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.__FIREBASE__ = {
      app, auth, db,
      onAuthStateChanged, signInWithEmailAndPassword, signOut,
      doc, setDoc, serverTimestamp, collection, onSnapshot, query, orderBy
    };

    window.dispatchEvent(new CustomEvent("firebase-ready"));
  </script>

</head>

<body data-theme="dark">

  <!-- Auth Overlay (shown when not signed in) -->
  <div id="authOverlay" class="auth-overlay" aria-hidden="true">
    <div class="auth-card">
      <div class="auth-title">Sign in</div>
      <div class="auth-subtitle">ITS Field Operations Dashboard</div>

      <form id="authForm" autocomplete="on">
        <label class="auth-label" for="authEmail">Email</label>
        <input id="authEmail" class="auth-input" type="email" placeholder="name@company.com" required />

        <label class="auth-label" for="authPassword">Password</label>
        <input id="authPassword" class="auth-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />

        <label class="auth-label" for="deviceName">Device name (optional)</label>
        <input id="deviceName" class="auth-input" type="text" placeholder="Tab-01 / Kim / Team-1" />

        <button class="btn auth-btn" type="submit">Sign in</button>
        <div id="authMsg" class="auth-msg"></div>
        <div class="auth-hint">Tip: Each tablet should have its own login (recommended) so locations are shown separately.</div>
      </form>
    </div>
  </div>

  <div class="page">
    <div class="shell">
      <header>
        <div class="header-left">
          <img src="aktor-logo.png" alt="Aktor Qatar" class="header-logo" />
        </div>

        <div class="header-center">
          <div class="header-title">ITS FIELD OPERATIONS DASHBOARD</div>
          <div class="header-subtitle">Live from Google Sheet ‚Äî Map + Full Data Table + Global Search + Type Filter + My Location</div>
          <div class="header-meta"><span id="currentDateTime"></span></div>
        </div>

        <div class="header-right">
          <img src="MRTC-AKTOR JV.png" alt="MRTC-AKTOR JV" class="header-logo header-logo-small" />
        </div>
      </header>

      <div class="top-row">
        <div class="pill">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Not loaded</span>
        </div>

        <button class="theme-toggle" id="themeToggle" type="button">Dark</button>
        <!-- Navigation button to switch to Traffic dashboard -->
        <button class="theme-toggle" id="navTrafficBtn" type="button" onclick="window.location.href='TRAFFIC_TEAM.html'">TRAFFIC</button>

        <div class="pill">
          <span class="small-muted">Last Sync:</span>
          <span id="lastSync">‚Äî</span>
        </div>
      </div>

      
      <!-- Mini Stats Bar (One-line summary) -->
      <div class="mini-stats-bar" id="miniStatsBar">
        <div class="mini-stat-item">
          <span>Total:</span>
          <span class="mini-stat-value" id="miniTotal">0</span>
        </div>
<div class="mini-stat-item">
          <span>Types:</span>
          <span class="mini-stat-value" id="miniTypes">0</span>
        </div>
      </div>

<div class="glass-card">
        <div class="kpi-wrap" id="kpiWrap"></div>

        <div class="controls-bar">
          <div class="search">
            <input id="globalSearch" type="text" placeholder="Global search (IP / logic id / ID / ASSETTAG / DESCRIPTION / any field)..." />
          </div>

          <div class="filter">
            <select id="typeFilter">
              <option value="__ALL__">All Device Types (GFCODE)</option>
            </select>
          </div>

          <button class="btn" id="locateBtn" type="button">Locate Me</button>
          <button class="btn warn" id="trackBtn" type="button" title="Share your live location to the Team map">Start Tracking</button>
          <button class="btn secondary" id="stopTrackBtn" type="button" title="Stop sharing your live location" disabled>Stop</button>
          <button class="btn secondary" id="logoutBtn" type="button" title="Sign out" style="display:none;">Logout</button>
          <button class="btn secondary" id="clearBtn" type="button">Clear</button>
          <button class="btn secondary" id="reloadBtn" type="button">Reload</button>

          <div class="export-group">
            <button class="btn" id="exportCsvBtn" type="button">CSV</button>
            <button class="btn" id="exportPdfBtn" type="button">PDF</button>
          </div>
        </div>

        <div class="small-muted" style="margin-top:6px;" id="hintText">
          Tip: Use the Layers button on the map to toggle boundaries/areas. Click a marker (or a table row) for navigation options (Google Maps / Waze).
        </div>
      </div>

      <div class="glass-card map-card" style="margin-top:12px;">
        <div class="map-header">
          <div class="map-title"><span class="dot"></span><span>GOOGLE MAP (ROAD & SATELLITE) ‚Äî LOCKED TO QATAR</span></div>
          <div class="small-muted" id="deviceCountLabel">0 devices</div>
        </div>

        <div class="map-box">
          <div id="mapView" style="width:100%;height:100%;"></div>
        </div>

        <div class="map-footer">
          <div id="mapFooterLeft">Map is constrained to Qatar extent. Use the map type control to toggle between road and satellite. Use ‚ÄúLocate Me‚Äù to center on your position.</div>
          <div class="small-muted">Data source: Google Sheet (CSV)</div>
        </div>
      </div>

      <div class="glass-card table-card" style="margin-top:4px;">
        <div class="table-title">
          <div>All Data (from Excel/CSV)</div>
          <div class="table-hint">Click a row to zoom to the device and open navigation options.</div>
        </div>
        <div class="table-wrap">
          <table id="dataTable">
            <thead><tr id="tableHeadRow"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

    
      <!-- Statistics Panel (Collapsible) -->
      <div class="stats-panel">
        <div class="stats-toggle" id="statsToggle">
          <div class="stats-toggle-title">
            <span>üìä</span>
            <span>Statistics</span>
          </div>
          <span class="stats-arrow" id="statsArrow">‚ñº</span>
        </div>
        <div class="stats-content" id="statsContent">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

</div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSKAtXDwzYQCNXtLlFOz5fkof4kCLCtzkf7GokGaINUmrurF7CFPbsm6bF8HXXV3MA8PyfYOzMVK8Q/pub?gid=223122268&single=true&output=csv";

    // Qatar extent (buffered) - WGS84
    const QATAR_EXTENT_WGS84 = { xmin: 50.45, ymin: 24.25, xmax: 52.15, ymax: 26.35, wkid: 4326 };

    // High-contrast palette + shapes
    const COLOR_PALETTE = [
      "#22c55e","#38bdf8","#f97316","#a855f7","#ef4444","#fbbf24",
      "#06b6d4","#e11d48","#16a34a","#2563eb","#7c3aed","#ea580c",
      "#0ea5e9","#db2777","#84cc16","#f43f5e","#14b8a6","#9333ea",
      "#fb7185","#f59e0b"
    ];
    const SHAPES = ["circle","square","diamond","triangle","cross","x"];

    // Priority fields in popup (match your typical Excel names)
    const POPUP_PRIORITY = [
      "Sr No.","SR NO","SrNo","SrNo.","Serial No.","Serial Number",
      "Project id","Project ID","PROJECT ID","project id",
      "logic id","Logic id","Logic ID","LOGIC ID",
      "MXASSETNUM","MxAssetNum","Maximo Asset","Maximo Asset Number",
      "IP Address","IP","IPAddress","Ip Address",
      "ASSETTAG","Asset Tag","AssetTag",
      "Existing ID","ExistingID","Existing Id",
      "Camera ID","CameraID","Camera Id",
      "Username","User Name","USER NAME","User",
      "Password","PASSWORD","Pass","PASS",
      "ID","Id","id",
      "DESCRIPTION","Description","description",
      "Camera ID","CAMERA ID","camera id",
      "User","USER","username","Username",
      "Password","PASSWORD","pass","Pass",
      "GFCODE","gfcode","Gfcode",
      "Type","TYPE","Device Type","DEVICE TYPE",
      "Latitude WGS84","Longitude WGS84","Latitude","Longitude"
    ];

    // ===================== STATE =====================
    let rawRows = [];
    let headers = [];
    let filteredRows = [];
    let skippedNoCoords = 0;

    let view, devicesGroup, boundariesGroup, teamLayer, myLayer;
    const deviceTypeLayers = new Map();
    const deviceGraphicsByKey = new Map();
    let selectedGraphic = null;

    // Export libs
    let jsPDF = null;
    let autoTableLoaded = false;

    // ===================== DOM =====================
    const $ = (id) => document.getElementById(id);

    // ===================== FIREBASE (AUTH + TEAM LIVE LOCATION) =====================
    const firebaseReady = new Promise((resolve) => {
      if (window.__FIREBASE__) return resolve(window.__FIREBASE__);
      window.addEventListener("firebase-ready", () => resolve(window.__FIREBASE__), { once: true });
      // Safety timeout (dashboard will still work without auth/tracking)
      setTimeout(() => resolve(window.__FIREBASE__ || null), 4000);
    });

    let fb = null;
    let authUser = null;
    let teamUnsub = null;
    let trackingTimer = null;

    const DEVICE_ID_KEY = "its_team_device_id_v1";
    const DEVICE_NAME_KEY = "its_team_device_name_v1";

    function getDeviceId(){
      let id = localStorage.getItem(DEVICE_ID_KEY);
      if (!id){
        id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("dev_" + Math.random().toString(36).slice(2) + Date.now());
        localStorage.setItem(DEVICE_ID_KEY, id);
      }
      return id;
    }

    function getDeviceName(){
      return (localStorage.getItem(DEVICE_NAME_KEY) || "").trim();
    }

    function setDeviceName(v){
      localStorage.setItem(DEVICE_NAME_KEY, (v || "").trim());
    }

    function showAuthOverlay(show){
      const o = $("authOverlay");
      if (!o) return;
      o.classList.toggle("show", !!show);
      o.setAttribute("aria-hidden", show ? "false" : "true");
      document.body.style.overflow = show ? "hidden" : "";
    }

    function setAuthMsg(text, kind){
      const el = $("authMsg");
      if (!el) return;
      el.textContent = text || "";
      el.className = "auth-msg" + (kind ? (" " + kind) : "");
    }

    async function initAuthAndTracking(){
      fb = await firebaseReady;
      if (!fb) return; // Firebase not available (offline / blocked)
      const { auth, onAuthStateChanged, signInWithEmailAndPassword, signOut } = fb;

      // Pre-fill device name
      const dn = $("deviceName");
      if (dn) dn.value = getDeviceName();

      $("authForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        setAuthMsg("Signing in...", "");
        const email = ($("authEmail")?.value || "").trim();
        const pass  = $("authPassword")?.value || "";
        const devn  = ($("deviceName")?.value || "").trim();
        if (devn) setDeviceName(devn);

        try{
          await signInWithEmailAndPassword(auth, email, pass);
          setAuthMsg("Signed in.", "ok");
        } catch(err){
          setAuthMsg(err?.message || "Sign-in failed.", "err");
        }
      });

      $("logoutBtn")?.addEventListener("click", async () => {
        try{
          await signOut(auth);
        } catch(_){}
      });

      $("trackBtn")?.addEventListener("click", async () => {
        await startTracking();
      });

      $("stopTrackBtn")?.addEventListener("click", async () => {
        stopTracking(true);
      });

      onAuthStateChanged(auth, (u) => {
        authUser = u || null;
        $("logoutBtn") && ($("logoutBtn").style.display = authUser ? "" : "none");
        showAuthOverlay(!authUser);
        if (!authUser){
          stopTracking(true);
          stopTeamSubscribe();
        } else {
          startTeamSubscribe();
          // Start dashboard after login
          window.__START_APP__ && window.__START_APP__();
        }
      });
    }

    function stopTeamSubscribe(){
      if (typeof teamUnsub === "function"){ try{ teamUnsub(); }catch(_){} }
      teamUnsub = null;
      // Clear team graphics
      if (teamLayer) teamLayer.removeAll();
    }

    function startTeamSubscribe(){
      if (!fb || !authUser) return;
      if (!teamLayer) return; // map not ready yet
      stopTeamSubscribe();
      const { db, collection, onSnapshot, query, orderBy } = fb;
      const q = query(collection(db, "team_locations"), orderBy("ts", "desc"));
      teamUnsub = onSnapshot(q, (snap) => {
        try{
          renderTeamLocations(snap);
        } catch(err){
          console.warn("Team locations render error:", err);
        }
      }, (err) => {
        console.warn("Team locations subscribe error:", err);
      });
    }

    function renderTeamLocations(snap){
      if (!teamLayer) return;
      teamLayer.removeAll();

      const markerSym = {
        type: "simple-marker",
        color: [245, 158, 11, 0.95],
        size: 12,
        outline: { color: [0,0,0,0.35], width: 1 }
      };

      snap.forEach((d) => {
        const v = d.data() || {};
        const lat = toNumberMaybe(v.lat);
        const lon = toNumberMaybe(v.lon);
        if (lat === null || lon === null) return;

        const title = (v.name || v.email || d.id || "Team").toString();
        const acc = (v.accuracy != null && isFinite(Number(v.accuracy))) ? `${Math.round(Number(v.accuracy))} m` : "N/A";
        const ts  = v.ts && v.ts.toDate ? v.ts.toDate().toLocaleString() : "";

        const G = window.__ESRI_GRAPHIC__;
      if (!G) return;

      const g = new G({
          geometry: { type:"point", latitude: lat, longitude: lon },
          symbol: markerSym,
          attributes: { title, lat, lon, acc, ts, email: v.email || "" },
          popupTemplate: {
            title: `Team: ${escapeHtml(title)}`,
            content: `
              <div class="popup-details">
                <div class="inner">
                  <div class="kv"><b>Location</b>: ${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
                  <div class="kv"><b>Accuracy</b>: ${escapeHtml(acc)}</div>
                  <div class="kv"><b>Last update</b>: ${escapeHtml(ts || "N/A")}</div>
                </div>
              </div>
            `
          }
        });

        teamLayer.add(g);
      });
    }

    async function startTracking(){
      if (!fb || !authUser){
        setAuthMsg("Please sign in first.", "err");
        showAuthOverlay(true);
        return;
      }

      if (trackingTimer) return;

      $("trackBtn") && ($("trackBtn").disabled = true);
      $("stopTrackBtn") && ($("stopTrackBtn").disabled = false);

      const deviceId = getDeviceId();
      const deviceName = (getDeviceName() || authUser.email || deviceId);

      const pushOnce = async () => {
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos?.coords?.latitude;
          const lon = pos?.coords?.longitude;
          const acc = pos?.coords?.accuracy;

          if (!isFinite(lat) || !isFinite(lon)) return;

          try{
            const { db, doc, setDoc, serverTimestamp } = fb;
            await setDoc(doc(db, "team_locations", deviceId), {
              lat, lon,
              accuracy: acc ?? null,
              name: deviceName,
              email: authUser.email || "",
              ts: serverTimestamp()
            }, { merge: true });
          } catch(err){
            console.warn("Location write failed:", err);
          }
        }, (err) => {
          console.warn("Geolocation error:", err);
        }, { enableHighAccuracy: true, maximumAge: 15000, timeout: 10000 });
      };

      // Send immediately + every 30 seconds
      await pushOnce();
      trackingTimer = setInterval(pushOnce, 30000);
    }

    function stopTracking(clearRemote){
      if (trackingTimer){
        clearInterval(trackingTimer);
        trackingTimer = null;
      }
      $("trackBtn") && ($("trackBtn").disabled = false);
      $("stopTrackBtn") && ($("stopTrackBtn").disabled = true);

      if (clearRemote && fb && authUser){
        const deviceId = getDeviceId();
        const { db, doc, setDoc, serverTimestamp } = fb;
        // Mark offline (keep last position)
        setDoc(doc(db, "team_locations", deviceId), { offline: true, ts: serverTimestamp() }, { merge: true }).catch(()=>{});
      }
    }


    // ===================== UI HELPERS =====================
    function nowString(){
      const d = new Date();
      return d.toLocaleString("en-US", {
        weekday:"short", day:"2-digit", month:"short", year:"numeric",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }
    function setStatus(ok, msg){
      const dot = $("statusDot");
      dot.classList.remove("ok","bad");
      dot.classList.add(ok ? "ok" : "bad");
      $("statusText").textContent = msg;
    }
    function sanitize(v){
      if (v === null || v === undefined) return "N/A";
      const s = String(v).replace(/\u00A0/g," ").trim();
      return s === "" ? "N/A" : s;
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }
    function toNumberMaybe(v){
      // tolerate spaces, commas, and stray text
      const s = String(v ?? "")
        .replace(/\u00A0/g," ")
        .trim()
        .replace(/,/g,""); // remove thousand separators or accidental commas
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : null;
    }
    function stableHash(str){
      let h = 2166136261;
      const s = String(str || "");
      for (let i=0;i<s.length;i++){
        h ^= s.charCodeAt(i);
        h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);
      }
      return Math.abs(h >>> 0);
    }
    function symbolForType(type){
      // Single, consistent style for all device types (legend removed).
      return {
        color: "#38bdf8",
        shape: "circle"
      };
    }
    function getFirstKey(row, candidates){
      if (!row) return null;
      for (const k of candidates){
        if (Object.prototype.hasOwnProperty.call(row, k)) return k;
      }
      return null;
    }
    function buildDeviceKey(row){
      const idKey = getFirstKey(row, ["ID","Id","id"]);
      const tagKey = getFirstKey(row, ["ASSETTAG","AssetTag","asset tag","Asset Tag"]);
      const mxKey = getFirstKey(row, ["MXASSETNUM","MxAssetNum","mxassetnum"]);
      const gfcKey = getFirstKey(row, ["GFCODE","gfcode","Gfcode"]);
      return [
        sanitize(idKey ? row[idKey] : ""),
        sanitize(tagKey ? row[tagKey] : ""),
        sanitize(mxKey ? row[mxKey] : ""),
        sanitize(gfcKey ? row[gfcKey] : "")
      ].join("||");
    }
    function googleMapsUrl(lat, lon){ return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`; }
    function wazeUrl(lat, lon){ return `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`; }

    // ===================== THEME =====================
    function applyTheme(theme){
      document.body.setAttribute("data-theme", theme);
      $("themeToggle").textContent = theme === "light" ? "Light" : "Dark";
      localStorage.setItem("its_field_theme", theme);
    }
    function initTheme(){
      const saved = localStorage.getItem("its_field_theme");
      applyTheme(saved === "light" ? "light" : "dark");
      $("themeToggle").addEventListener("click", ()=>{
        const cur = document.body.getAttribute("data-theme") || "dark";
        applyTheme(cur === "dark" ? "light" : "dark");
      });
    }

    // ===================== CSV PARSER (NO LIBS) =====================
    function parseCSV(text){
      const rows = [];
      let i = 0, field = "", row = [];
      let inQuotes = false;

      const pushField = () => { row.push(field); field = ""; };
      const pushRow = () => { rows.push(row); row = []; };

      while (i < text.length){
        const c = text[i];

        if (inQuotes){
          if (c === '"'){
            if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += c; i++; continue;
        }

        if (c === '"'){ inQuotes = true; i++; continue; }
        if (c === ','){ pushField(); i++; continue; }
        if (c === '\r'){ i++; continue; }
        if (c === '\n'){ pushField(); pushRow(); i++; continue; }

        field += c; i++;
      }

      pushField();
      pushRow();

      while (rows.length && rows[rows.length-1].every(v => String(v ?? "").trim() === "")) rows.pop();
      return rows;
    }

    // ===================== DATA LOAD =====================
    async function loadCSV(){
      try{
        setStatus(false, "Loading...");
        $("lastSync").textContent = "‚Äî";
        $("hintText").textContent = "Loading data from Google Sheet (CSV)...";

        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`CSV fetch failed: HTTP ${res.status}`);
        const text = await res.text();

        const grid = parseCSV(text);
        if (!grid.length || grid.length < 2){
          rawRows = []; headers = []; filteredRows = [];
          setStatus(false, "Loaded (0 rows)");
          $("lastSync").textContent = nowString();
          $("hintText").textContent = "CSV loaded but contains no rows. Check the published sheet.";
          renderAll();
          refreshMapGraphics([]);
          return;
        }

        headers = grid[0].map(h => String(h ?? "").trim());
        const dataRows = grid.slice(1);

        rawRows = dataRows.map(arr=>{
          const obj = {};
          for (let c=0;c<headers.length;c++){
            obj[headers[c]] = (arr[c] ?? "");
          }
          obj.__blob = headers.map(h => sanitize(obj[h])).join(" | ").toLowerCase();
          return obj;
        });

        setStatus(true, "Loaded");
        $("lastSync").textContent = nowString();
        $("hintText").textContent = "Tip: Use the Layers button on the map to toggle boundaries/areas. Click a marker (or a table row) for navigation options (Google Maps / Waze).";

        renderAll();
        applyFilters();
      }catch(err){
        setStatus(false, "Load error");
        $("lastSync").textContent = nowString();
        $("hintText").textContent =
          "Data not loaded. Most common cause: opening the file directly from your PC (file://). " +
          "Upload to GitHub Pages or open using a local server. Error: " + (err?.message || err);
        rawRows = []; headers = []; filteredRows = [];
        renderAll();
        refreshMapGraphics([]);
      }
    }

    // ===================== RENDER (FILTER / KPI / LEGEND / TABLE) =====================
    function renderTypeFilter(){
      const sel = $("typeFilter");
      const prev = sel.value;
      sel.innerHTML = `<option value="__ALL__">All Device Types (GFCODE)</option>`;

      if (!rawRows.length) return;

      const gfcKey = getFirstKey(rawRows[0], ["GFCODE","gfcode","Gfcode"]);
      const types = new Set();
      for (const r of rawRows){
        types.add(sanitize(gfcKey ? r[gfcKey] : "UNKNOWN"));
      }
      [...types].sort((a,b)=>a.localeCompare(b)).forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });

      if ([...sel.options].some(o=>o.value===prev)) sel.value = prev;
    }

    function renderKPIs(rows){
      const wrap = $("kpiWrap");
      wrap.innerHTML = "";

      const totalCard = document.createElement("div");
      totalCard.className = "kpi";
      totalCard.innerHTML = `
        <div class="kpi-label"><span class="kpi-badge" style="background:${"#38bdf8"}"></span> Total Devices</div>
        <div class="kpi-value">${rows.length}</div>
      `;
      wrap.appendChild(totalCard);

      if (!rows.length) {
        $("deviceCountLabel").textContent = "0 devices";
        return;
      }

      const gfcKey = getFirstKey(rows[0], ["GFCODE","gfcode","Gfcode"]);
      const counts = new Map();
      for (const r of rows){
        const t = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
        counts.set(t, (counts.get(t) || 0) + 1);
      }
      const sorted = [...counts.entries()].sort((a,b)=>b[1]-a[1]);
      for (const [type,cnt] of sorted){
        const { color } = symbolForType(type);
        const card = document.createElement("div");
        card.className = "kpi";
        card.title = type;
        card.innerHTML = `
          <div class="kpi-label"><span class="kpi-badge" style="background:${color}"></span> ${escapeHtml(type)}</div>
          <div class="kpi-value">${cnt}</div>
        `;
        wrap.appendChild(card);
      }

      $("deviceCountLabel").textContent = `${rows.length} devices`;
    }

      function renderTable(rows){
      const headRow = $("tableHeadRow");
      const body = $("tableBody");
      headRow.innerHTML = "";
      body.innerHTML = "";

      if (!headers.length) return;

      for (const h of headers){
        const th = document.createElement("th");
        th.textContent = h;
        headRow.appendChild(th);
      }

      const frag = document.createDocumentFragment();
      for (const r of rows){
        const tr = document.createElement("tr");
        tr.dataset.key = buildDeviceKey(r);
        for (const h of headers){
          const td = document.createElement("td");
          td.textContent = sanitize(r[h]);
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      body.appendChild(frag);

      body.querySelectorAll("tr").forEach(tr=>{
        tr.addEventListener("click", ()=>{
          const key = tr.dataset.key;
          // For Google Maps implementation, look up the marker from the global map storage
          let g = null;
          if (window.__GMAP__ && window.__GMAP__.deviceMarkersByKey){
            g = window.__GMAP__.deviceMarkersByKey.get(key);
          } else {
            // Fall back to existing map for ArcGIS (legacy)
            g = deviceGraphicsByKey.get(key);
          }
          if (g) focusGraphic(g, true);
        });
      });
    }

    function renderAll(){
      renderTypeFilter();
      renderKPIs(filteredRows.length ? filteredRows : rawRows);
      renderTable(filteredRows.length ? filteredRows : rawRows);
    }

    function applyFilters(){
      const search = $("globalSearch").value.trim().toLowerCase();
      const typeVal = $("typeFilter").value;

      if (!rawRows.length){
        filteredRows = [];
        renderKPIs([]);
        renderTable([]);
        refreshMapGraphics([]);
        return;
      }

      const gfcKey = getFirstKey(rawRows[0], ["GFCODE","gfcode","Gfcode"]);

      filteredRows = rawRows.filter(r=>{
        const t = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
        if (typeVal !== "__ALL__" && t !== typeVal) return false;
        if (search && !(r.__blob || "").includes(search)) return false;
        return true;
      });

      renderKPIs(filteredRows);
      renderTable(filteredRows);
      refreshMapGraphics(filteredRows);
    }

    function debounce(fn, ms){
      let t = null;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }

    // ===================== POPUP CONTENT (ALL FIELDS + PRIORITY) =====================
    function buildPopupRow(label, value){
      return `<tr><td>${escapeHtml(label)}</td><td>${escapeHtml(sanitize(value))}</td></tr>`;
    }

    function buildPopupHTML(row){
  // coords: try exact headers first then fallbacks
  const latKey = getFirstKey(row, ["Latitude WGS84","Latitude_WGS84","Latitude","LATITUDE","lat"]);
  const lonKey = getFirstKey(row, ["Longitude WGS84","Longitude_WGS84","Longitude","LONGITUDE","lon","LON"]);

  const latS = sanitize(latKey ? row[latKey] : "");
  const lonS = sanitize(lonKey ? row[lonKey] : "");
  const lat = toNumberMaybe(latS);
  const lon = toNumberMaybe(lonS);

  const gUrl = (lat !== null && lon !== null) ? googleMapsUrl(lat, lon) : "#";
  const wUrl = (lat !== null && lon !== null) ? wazeUrl(lat, lon) : "#";

  const idKey  = getFirstKey(row, ["ID","Id","id"]);
  const tagKey = getFirstKey(row, ["ASSETTAG","AssetTag","asset tag","Asset Tag"]);
  const gfcKey = getFirstKey(row, ["GFCODE","gfcode","Gfcode"]);

  const title = sanitize(idKey ? row[idKey] : "") !== "N/A"
    ? sanitize(row[idKey])
    : (sanitize(tagKey ? row[tagKey] : "") !== "N/A" ? sanitize(row[tagKey]) : "ITS Asset");

  // Build ONE table only: priority fields first, then the remaining fields (no duplicates).
  const existingKeys = new Set(headers);
  const used = new Set();
  let rowsHTML = "";

  const addRowByKey = (k) => {
    if (!k || !existingKeys.has(k) || used.has(k)) return;
    used.add(k);
    rowsHTML += buildPopupRow(k, row[k]);
  };

  // Priority fields (case-insensitive match to current headers)
  for (const want of POPUP_PRIORITY){
    const k = headers.find(h => String(h).trim().toLowerCase() === String(want).trim().toLowerCase());
    addRowByKey(k);
  }

  // Always include coordinates row (once)
  if (!used.has("Coordinates")){
    used.add("Coordinates");
    rowsHTML += buildPopupRow("Coordinates", (latS === "N/A" || lonS === "N/A") ? "N/A" : `${latS}, ${lonS}`);
  }

  // Remaining fields (in original sheet order)
  for (const h of headers){
    if (!used.has(h)) addRowByKey(h);
  }

  return `
    <div style="font-size:12px;line-height:1.35;">
      <div style="font-weight:800;font-size:13px;margin-bottom:6px;">${escapeHtml(title)}</div>
      <div style="color:rgba(156,163,175,.95);font-size:12px;margin-bottom:6px;">
        <strong>GFCODE:</strong> ${escapeHtml(sanitize(gfcKey ? row[gfcKey] : "UNKNOWN"))}
      </div>

      <div class="popup-kv">
        <table>
          ${rowsHTML}
        </table>
      </div>

      <div class="popup-btns">
        <a class="popup-link" href="${gUrl}" target="_blank" rel="noopener">Open in Google Maps</a>
        <a class="popup-link waze" href="${wUrl}" target="_blank" rel="noopener">Open in Waze</a>
      </div>
    </div>
  `;
}

    // ===================== MAP (ARCGIS) =====================
    function initArcGISMap(){
      return new Promise((resolve, reject)=>{
        if (typeof require !== "function"){
          reject(new Error("ArcGIS loader (require) is not available. Check if https://js.arcgis.com is blocked."));
          return;
        }

        require([
          "esri/Map",
          "esri/views/MapView",
          "esri/Graphic",
          "esri/layers/GraphicsLayer",
          "esri/layers/GroupLayer",
          "esri/layers/GeoJSONLayer",
          "esri/widgets/LayerList",
          "esri/widgets/Expand",
          "esri/geometry/Extent",
          "esri/geometry/Polygon",
          "esri/geometry/Point",
          "esri/geometry/geometryEngine",
          "esri/PopupTemplate"
        ], (Map, MapView, Graphic, GraphicsLayer, GroupLayer, GeoJSONLayer, LayerList, Expand, Extent, Polygon, Point, geometryEngine, PopupTemplate) => {

          const qatarExtent = new Extent({
            xmin: QATAR_EXTENT_WGS84.xmin,
            ymin: QATAR_EXTENT_WGS84.ymin,
            xmax: QATAR_EXTENT_WGS84.xmax,
            ymax: QATAR_EXTENT_WGS84.ymax,
            spatialReference: { wkid: QATAR_EXTENT_WGS84.wkid }
          });
          const qatarPoly = Polygon.fromExtent(qatarExtent);


          const map = new Map({ basemap: "satellite" });

          // Expose Graphic class for Team Live layer
          window.__ESRI_GRAPHIC__ = Graphic;

          // ===================== OVERLAY LAYERS (GEOJSON) =====================
          // Note: filenames contain spaces in your repo; URLs use %20 to be safe on GitHub Pages.
          const boundaryLayers = [
            new GeoJSONLayer({
              url: "./Qatar%20North%20Boundary.geojson",
              title: "Qatar North Boundary",
              visible: false,
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [0,255,255,0.95], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Strategic%20Highways%20Boundary.geojson",
              title: "Strategic Highways Boundary",
              visible: false,
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [255,255,0,0.90], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Area-01.geojson",
              title: "Area 01",
              visible: false,
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [34,197,94,0.95], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Area-02.geojson",
              title: "Area 02",
              visible: false,
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [59,130,246,0.95], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Area-03.geojson",
              title: "Area 03",
              visible: false,
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [168,85,247,0.95], width: 2 } }
              }
            }),
            new GeoJSONLayer({
              url: "./Area-04.geojson",
              title: "Area 04",
              visible: false,
              opacity: 1,
              renderer: {
                type: "simple",
                symbol: { type: "simple-fill", color: [0,0,0,0], outline: { color: [249,115,22,0.95], width: 2 } }
              }
            })
          ];

          // Group layers for clean LayerList
          boundariesGroup = new GroupLayer({
            title: "Boundaries",
            visibilityMode: "independent",
            visible: false,
            layers: boundaryLayers
          });

          devicesGroup = new GroupLayer({
            title: "Devices",
            visibilityMode: "independent",
            visible: true
          });

          myLayer = new GraphicsLayer({ id: "myLocationLayer", title: "My Location", visible: true });

          // Add in order: boundaries (below), devices, my location (top)
          // Team Live layer removed as tracking is no longer used

          // Add in order: boundaries (below), devices, team live, my location (top)
          map.addMany([boundariesGroup, devicesGroup, myLayer]);

          view = new MapView({
            container: "mapView",
            map,
            extent: qatarExtent,
            constraints: {
              geometry: qatarPoly,
              minZoom: 7,
              maxZoom: 19,
              rotationEnabled: false
            },
            ui: { components: ["zoom", "attribution"] },
            popup: { dockEnabled: false, highlightEnabled: true }
          });

          // Layers toggle (left side)
          const layerList = new LayerList({ view: view });
          const layersExpand = new Expand({
            view: view,
            content: layerList,
            expandIcon: "layers",
            expandTooltip: "Layers"
          });
          view.ui.add(layersExpand, "top-left");


          // ===================== ICON MARKERS (12 TYPES) =====================
          // Icons are in the SAME folder as this HTML (repo root in your screenshot).
          // We build absolute URLs using document.baseURI so it works whether you open:
          //   .../ITS_TEAMSS.html  OR  .../ITS_TEAMSS  (GitHub Pages)
          const ICON_FILES = {
            "RDNDAIDC": "RDNDAIDC.png",
            "RDNDCCTV": "RDNDCCTV.png",
            "RDNDDYMS": "RDNDDYMS.png",
            "RDNDFIXC": "RDNDFIXC.png",
            "RDNDLCS":  "RDNDLCS.png",
            "RDNDLPRD": "RDNDLPRD.png",
            "RDNDMMAP": "RDNDMMAP.png",
            "RDNDMMDS": "RDNDMMDS.png",
            "RDNDPTZC": "RDNDPTZC.png",
            "RDNDRVDE": "RDNDRVDE.png",
            "RDNDSDMS": "RDNDSDMS.png",
            "RDNDVIVD": "RDNDVIVD.png"
          };

          // Absolute repo base (icons are stored in repo root)
          const REPO_BASE = `${location.origin}/QATAR-NORTH-SURVEY-DASHBOARD/`;


          // Also accept some alternate GFCODE variants found in sheets
          const ICON_ALIASES = {
            "RDNDPRD": "RDNDLPRD",
            "RDNDMAP": "RDNDMMAP",
            "RDNDMDS": "RDNDMMDS",
            "PRD": "RDNDLPRD",
            "MAP": "RDNDMMAP",
            "MDS": "RDNDMMDS"
          };

          function resolveIconUrl(gfcode){
            const k = normalizeGfcode(gfcode);
            const key = ICON_FILES[k]
              ? k
              : (ICON_ALIASES[k] || (ICON_FILES["RDND"+k] ? ("RDND"+k) : null));
            if (!key) return null;
            const file = ICON_FILES[key];

            // Primary: repo root absolute (works even if this page is opened as /ITS_TEAMSS or from subfolders)
            const abs = new URL(file, REPO_BASE).href;

            // Secondary: same-folder relative (useful if you later move icons next to the HTML)
            const rel = new URL(file, new URL('.', window.location.href)).href;

            // Return both so browser can try; ArcGIS will use the first, but we keep rel for debugging.
            return abs || rel;
          }

          function normalizeGfcode(v){

            return String(v || "").toUpperCase().replace(/[^A-Z0-9]/g, "");
          }

          function markerSymbol(type, selected=false){
            const raw = String(type || "");
            const key = normalizeGfcode(raw);
            // Match both: "RDNDAIDC" and also "AIDC" (will map to "RDNDAIDC")
            const iconUrl = resolveIconUrl(raw);
            if (iconUrl){
              const size = selected ? 30 : 24;
              return {
                type: "picture-marker",
                url: iconUrl,
                width: size,
                height: size,
                yoffset: Math.round(size/2)
              };
            }
            // Fallback = original blue pin
            return {
              type: "simple-marker",
              style: "circle",
              color: "#38bdf8",
              size: selected ? 14 : 11,
              outline: { color: "#ffffff", width: selected ? 2.5 : 1.5 }
            };
          }

          function clearSelection(){
            if (selectedGraphic){
              const t = selectedGraphic.attributes.__type;
              selectedGraphic.symbol = markerSymbol(t, false);
              selectedGraphic = null;
            }
          }

          function focusGraphicInternal(g, openPopup){
            if (!g) return;
            if (selectedGraphic && selectedGraphic !== g){
              const tPrev = selectedGraphic.attributes.__type;
              selectedGraphic.symbol = markerSymbol(tPrev, false);
            }
            selectedGraphic = g;
            g.symbol = markerSymbol(g.attributes.__type, true);

            view.goTo({ target: g.geometry, zoom: Math.max(view.zoom, 15) }, { duration: 450 }).then(()=>{
              if (openPopup) view.openPopup({ features:[g], location:g.geometry });
            });
          }

          function setMyLocation(lat, lon, accuracyMeters){
            myLayer.removeAll();
            const pt = new Point({ latitude: lat, longitude: lon, spatialReference: { wkid: 4326 } });

            const me = new Graphic({
              geometry: pt,
              symbol: {
                type:"simple-marker",
                style:"circle",
                color:"#22c55e",
                size:14,
                outline:{ color:"#ffffff", width:2.5 }
              },
              popupTemplate: {
                title: "My Location",
                content: () => `<div style="font-size:12px;"><strong>Lat/Lon:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}<br/><strong>Accuracy:</strong> ${Math.round(accuracyMeters || 0)} m</div>`
              }
            });
            myLayer.add(me);

            const acc = Math.max(10, Math.min(accuracyMeters || 50, 250));
            const circle = geometryEngine.geodesicBuffer(pt, acc, "meters");
            const accG = new Graphic({
              geometry: circle,
              symbol: {
                type: "simple-fill",
                color: [34,197,94,0.12],
                outline: { color: [34,197,94,0.75], width: 2 }
              }
            });
            myLayer.add(accG);
          }

          window.__GIS__ = {
            Graphic,
            PopupTemplate,
            Point,
            markerSymbol,
            clearSelection,
            focusGraphicInternal,
            setMyLocation
          };

          view.on("click", (evt) => {
            view.hitTest(evt).then((res)=>{
              const hits = res.results || [];
              const devHit = hits.find(h => h.graphic && h.graphic.layer && typeof h.graphic.layer.id === "string" && h.graphic.layer.id.startsWith("dev_"));
              if (!devHit) clearSelection();
            });
          });

          resolve();
        }, (err)=>{
          reject(err || new Error("ArcGIS require() failed."));
        });
      });
    }

    // ===================== MAP (GOOGLE MAPS) =====================
    /**
     * Initializes the Google map. This function sets up the map instance, configures
     * base layers and map type controls (road vs satellite), and exposes helper
     * functions on `window.__GIS__` for compatibility with existing code.
     * The map is restricted to Qatar by setting a LatLngBounds restriction.
     * Note: Google Maps requires an API key. Replace the key in the script tag above.
     */
    async function initMap(){
      // Create the map and store on a global so other functions can reference it.
      const qatarBounds = {
        north: QATAR_EXTENT_WGS84.ymax,
        south: QATAR_EXTENT_WGS84.ymin,
        east:  QATAR_EXTENT_WGS84.xmax,
        west:  QATAR_EXTENT_WGS84.xmin
      };
      const centerLat = (qatarBounds.north + qatarBounds.south) / 2;
      const centerLon = (qatarBounds.east + qatarBounds.west) / 2;

      const gmap = new google.maps.Map(document.getElementById("mapView"), {
        center: { lat: centerLat, lng: centerLon },
        zoom: 9,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        gestureHandling: "greedy",
        restriction: {
          latLngBounds: qatarBounds,
          strictBounds: false
        },
        mapTypeControl: true,
        mapTypeControlOptions: {
          position: google.maps.ControlPosition.TOP_RIGHT,
          style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
          mapTypeIds: ["roadmap", "hybrid"]
        },
        streetViewControl: false,
        fullscreenControl: false
      });

      window.__GMAP__ = {
        map: gmap,
        markers: [],
        deviceMarkersByKey: new Map(),
        myLocationMarker: null,
        myLocationCircle: null,
        infoWindow: new google.maps.InfoWindow()
      };

      // Helper functions replicating the ArcGIS API signature. These functions are
      // attached to `window.__GIS__` so that existing code can call them.
      window.__GIS__ = {
        /**
         * Generates a Google Maps marker icon for a given device type.
         * If `isSelected` is true, the icon will be drawn slightly larger.
         */
        markerSymbol: (type, isSelected)=>{
          const url = resolveIconUrl(type);
          const size = isSelected ? 44 : 32;
          return {
            url,
            scaledSize: new google.maps.Size(size, size),
            anchor: new google.maps.Point(size / 2, size / 2)
          };
        },
        /**
         * Clears selection highlight on the previously selected marker.
         */
        clearSelection: ()=>{
          if (window.__GMAP__.selectedMarker){
            const m = window.__GMAP__.selectedMarker;
            m.setIcon(window.__GIS__.markerSymbol(m.__type, false));
            window.__GMAP__.selectedMarker = null;
          }
        },
        /**
         * Highlights the given marker and optionally opens a popup.
         */
        focusGraphicInternal: (markerOrGraphic, openPopup)=>{
          // Accept both our Google marker or the old Graphic object
          const marker = markerOrGraphic && markerOrGraphic.marker ? markerOrGraphic.marker : markerOrGraphic;
          if (!marker) return;
          // Clear old selection and update icon for selected marker
          window.__GIS__.clearSelection();
          marker.setIcon(window.__GIS__.markerSymbol(marker.__type, true));
          window.__GMAP__.selectedMarker = marker;
          if (openPopup && marker.__popupContent){
            window.__GMAP__.infoWindow.setContent(marker.__popupContent);
            window.__GMAP__.infoWindow.open(window.__GMAP__.map, marker);
          }
        },
        /**
         * Sets or updates the "My Location" marker on the map.
         */
        setMyLocation: (lat, lon, acc)=>{
          const map = window.__GMAP__.map;
          // Remove existing markers if present
          if (window.__GMAP__.myLocationMarker){
            window.__GMAP__.myLocationMarker.setMap(null);
            window.__GMAP__.myLocationMarker = null;
          }
          if (window.__GMAP__.myLocationCircle){
            window.__GMAP__.myLocationCircle.setMap(null);
            window.__GMAP__.myLocationCircle = null;
          }
          window.__GMAP__.myLocationMarker = new google.maps.Marker({
            position: { lat, lng: lon },
            map: map,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: "#38bdf8",
              fillOpacity: 1,
              strokeColor: "#ffffff",
              strokeWeight: 2
            },
            zIndex: 9999
          });
          window.__GMAP__.myLocationCircle = new google.maps.Circle({
            strokeColor: "#38bdf8",
            strokeOpacity: 0.8,
            strokeWeight: 1,
            fillColor: "#38bdf8",
            fillOpacity: 0.2,
            map: map,
            center: { lat, lng: lon },
            radius: acc
          });
        }
      };

      // Resolves after initialization; map is ready to be used.
      return true;
    }

    function refreshMapGraphics(rows){
      // Ensure map and helper objects are available
      if (!window.__GMAP__ || !window.__GIS__) return;
      const gmap = window.__GMAP__.map;
      const markersList = window.__GMAP__.markers;
      const markersByKey = window.__GMAP__.deviceMarkersByKey;

      // Clear existing markers from the map
      for (const m of markersList){
        m.setMap(null);
      }
      markersList.length = 0;
      markersByKey.clear();

      window.__GIS__.clearSelection();
      skippedNoCoords = 0;

      if (!rows.length){
        $("mapFooterLeft").textContent = "Map is constrained to Qatar extent. Use the map type control to toggle between road and satellite. Use ‚ÄúLocate Me‚Äù to center on your position.";
        return;
      }

      // Determine coordinate and type keys
      const latKey = getFirstKey(rows[0], ["Latitude WGS84","Latitude_WGS84","Latitude","LATITUDE","lat"]);
      const lonKey = getFirstKey(rows[0], ["Longitude WGS84","Longitude_WGS84","Longitude","LONGITUDE","lon","LON"]);
      const gfcKey = getFirstKey(rows[0], ["GFCODE","gfcode","Gfcode"]);

      for (const r of rows){
        const lat = toNumberMaybe(latKey ? r[latKey] : null);
        const lon = toNumberMaybe(lonKey ? r[lonKey] : null);
        if (lat === null || lon === null){
          skippedNoCoords++;
          continue;
        }
        const type = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
        const key = buildDeviceKey(r);

        const marker = new google.maps.Marker({
          position: { lat: lat, lng: lon },
          map: gmap,
          icon: window.__GIS__.markerSymbol(type, false),
          title: type
        });
        // Attach extra info used for selection and popups
        marker.__type = type;
        marker.__key = key;
        marker.__row = r;
        marker.__popupContent = buildPopupHTML(r);
        // Click handler to focus marker and highlight row in table
        marker.addListener("click", () => {
          window.__GIS__.focusGraphicInternal(marker, true);
          // When a marker is clicked, the InfoWindow will open. Row highlighting is handled via other UI interactions.
        });
        markersList.push(marker);
        markersByKey.set(key, marker);
      }

      $("mapFooterLeft").textContent =
        skippedNoCoords > 0
          ? `Map is constrained to Qatar extent. Skipped ${skippedNoCoords} row(s) with missing/invalid coordinates.`
          : "Map is constrained to Qatar extent. Use the map type control to toggle between road and satellite. Use ‚ÄúLocate Me‚Äù to center on your position.";
    }

    function focusGraphic(g, openPopup){
      if (window.__GIS__ && typeof window.__GIS__.focusGraphicInternal === "function"){
        window.__GIS__.focusGraphicInternal(g, openPopup);
      }
    }

    // ===================== GEOLOCATION =====================
    function locateMe(){
      if (!navigator.geolocation){
        alert("Geolocation is not supported in this browser.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy || 50;
          if (window.__GIS__ && typeof window.__GIS__.setMyLocation === "function"){
            window.__GIS__.setMyLocation(lat, lon, acc);
          }
          // Pan and zoom the Google map instead of Esri view
          if (window.__GMAP__ && window.__GMAP__.map){
            const m = window.__GMAP__.map;
            m.panTo({ lat: lat, lng: lon });
            if (m.getZoom() < 15) m.setZoom(15);
          }
        },
        ()=>{
          alert("Unable to get your location. Please allow location permissions and try again.");
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:8000 }
      );
    }

    // ===================== EXPORT (CSV + PDF) =====================
    function csvEscape(val){
      const s = sanitize(val);
      const needs = /[",\n\r]/.test(s);
      const out = s.replace(/"/g, '""');
      return needs ? `"${out}"` : out;
    }
    function buildCSV(rows){
      const lines = [];
      lines.push(headers.map(csvEscape).join(","));
      for (const r of rows){
        lines.push(headers.map(h => csvEscape(r[h])).join(","));
      }
      return lines.join("\n");
    }
    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function loadScript(url){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        s.onload = resolve;
        s.onerror = () => reject(new Error("Failed to load: " + url));
        document.head.appendChild(s);
      });
    }

    async function ensurePdfLibs(){
      // Critical: ArcGIS uses AMD (dojo). Force UMD libs to attach to window.
      const savedDefine = window.define;
      const savedRequire = window.require;
      try{
        window.define = undefined;
        // keep window.require (ArcGIS) intact, but UMD libs mainly look for define/define.amd
        if (!jsPDF){
          await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
          jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
          if (!jsPDF) throw new Error("jsPDF library did not initialize.");
        }
        if (!autoTableLoaded){
          await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js");
          autoTableLoaded = true;
        }
      } finally {
        window.define = savedDefine;
        window.require = savedRequire;
      }
    }

    function exportCSV(){
      const rows = filteredRows.length ? filteredRows : rawRows;
      if (!headers.length) return;
      const csv = buildCSV(rows);
      downloadBlob(new Blob([csv], { type:"text/csv;charset=utf-8" }), `ITS_Field_Operations_${Date.now()}.csv`);
    }

    async function exportPDF(){
      const rows = filteredRows.length ? filteredRows : rawRows;
      if (!headers.length) return;
      try{
        await ensurePdfLibs();

        const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

        doc.setFont("helvetica","bold");
        doc.setFontSize(14);
        doc.text("ITS Field Operations Dashboard - Export", 40, 36);

        doc.setFont("helvetica","normal");
        doc.setFontSize(10);
        doc.text(`Exported: ${nowString()}`, 40, 52);
        doc.text(`Rows: ${rows.length}`, 40, 66);

        const body = rows.map(r => headers.map(h => sanitize(r[h])));

        const at = doc.autoTable || (doc.constructor && doc.constructor.API && doc.constructor.API.autoTable);
        if (!at) throw new Error("PDF table engine not available (autoTable).");

        (doc.autoTable ? doc.autoTable.bind(doc) : doc.constructor.API.autoTable.bind(doc))({
          head: [headers],
          body,
          startY: 80,
          styles: { fontSize: 7, cellPadding: 3, overflow: "linebreak" },
          headStyles: { fontStyle: "bold" },
          theme: "grid",
          margin: { left: 24, right: 24 }
        });

        downloadBlob(doc.output("blob"), `ITS_Field_Operations_${Date.now()}.pdf`);
      }catch(err){
        alert("PDF export failed: " + (err?.message || err));
      }
    }

    // ===================== EVENTS =====================
    function bindEvents(){
      $("globalSearch").addEventListener("input", debounce(applyFilters, 120));
      $("typeFilter").addEventListener("change", applyFilters);
      $("locateBtn").addEventListener("click", locateMe);

      $("clearBtn").addEventListener("click", ()=>{
        $("globalSearch").value = "";
        $("typeFilter").value = "__ALL__";
        applyFilters();
        if (window.__GIS) window.__GIS.clearSelection();
      });

      $("reloadBtn").addEventListener("click", loadCSV);

      $("exportCsvBtn").addEventListener("click", exportCSV);
      $("exportPdfBtn").addEventListener("click", exportPDF);
    }

    // ===================== CLOCK =====================
    function initClock(){
      const el = $("currentDateTime");
      const tick = ()=> el.textContent = nowString();
      tick();
      setInterval(tick, 1000);
    }


    // ===================== APP START =====================
    async function startApp(){
      if (window.__APP_BOOTED__) return;
      window.__APP_BOOTED__ = true;
      // initialized
    }
    window.__START_APP__ = startApp;

    // ===================== BOOT =====================
    (async function boot(){
      initTheme();
      initClock();
      bindEvents();


      await initAuthAndTracking();
      // If Firebase is available, require sign-in before loading data/map
      if (fb){
        // wait briefly for auth state
        for (let i=0; i<200; i++){
          if (authUser) break;
          await new Promise(r=>setTimeout(r, 50));
        }
        if (!authUser){
          // keep overlay; stop booting until user signs in
          return;
        }
      }

      try{
        await initMap();
      }catch(err){
        setStatus(false, "Map error");
        $("hintText").textContent = "Map failed to initialize. Ensure the Google Maps API has loaded and your API key is valid. Error: " + (err?.message || err);
        return;
      }

      // After map is ready, start team live subscription (if signed in)
      if (authUser) startTeamSubscribe();

      loadCSV();
    })();
    // ========== MINI STATS BAR & STATISTICS PANEL ==========
    function updateMiniStats(rows) {
        const total = rows.length;

        // Count unique device types (GFCODE)
        const gfcKey = getFirstKey(rows[0] || {}, ["GFCODE","gfcode","Gfcode"]);
        const types = new Set();
        for (const r of rows) {
            const type = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
            types.add(type);
        }

        // Update mini stats bar
        const miniTotal = document.getElementById("miniTotal");
        const miniTypes = document.getElementById("miniTypes");
        if (miniTotal) miniTotal.textContent = total;
        if (miniTypes) miniTypes.textContent = types.size;
    }

    function updateStatsPanel(rows) {
        const statsContent = document.getElementById("statsContent");
        if (!statsContent) return;

        statsContent.innerHTML = "";

        if (!rows.length) return;

        const gfcKey = getFirstKey(rows[0], ["GFCODE","gfcode","Gfcode"]);

        // Total card
        const totalCard = document.createElement("div");
        totalCard.className = "stat-card";
        totalCard.innerHTML = `
            <div class="stat-card-label">
                <span class="stat-badge"></span>
                <span>Total Devices</span>
            </div>
            <div class="stat-card-value">${rows.length}</div>
        `;
        statsContent.appendChild(totalCard);

        // Count by type
        const counts = new Map();
        for (const r of rows) {
            const t = sanitize(gfcKey ? r[gfcKey] : "UNKNOWN");
            counts.set(t, (counts.get(t) || 0) + 1);
        }

        const sorted = [...counts.entries()].sort((a,b) => b[1] - a[1]);
        for (const [type, cnt] of sorted) {
            const card = document.createElement("div");
            card.className = "stat-card";
            card.innerHTML = `
                <div class="stat-card-label">
                    <span class="stat-badge"></span>
                    <span>${escapeHtml(type)}</span>
                </div>
                <div class="stat-card-value">${cnt}</div>
            `;
            statsContent.appendChild(card);
        }
    }

    // Toggle statistics panel
    const statsToggle = document.getElementById("statsToggle");
    const statsContent = document.getElementById("statsContent");
    const statsArrow = document.getElementById("statsArrow");

    if (statsToggle && statsContent && statsArrow) {
        statsToggle.addEventListener("click", () => {
            statsContent.classList.toggle("open");
            statsArrow.classList.toggle("open");
        });
    }

    // Override renderKPIs to update both mini stats and stats panel
    const originalRenderKPIs = renderKPIs;
    renderKPIs = function(rows) {
        // Update mini stats bar
        updateMiniStats(rows);

        // Update statistics panel
        updateStatsPanel(rows);

        // Don't call original renderKPIs since we're replacing it
        document.getElementById("deviceCountLabel").textContent = `${rows.length} devices`;
    };


  </script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        const headerRight = document.querySelector('.header-right');
        const locateBtn = document.getElementById('locateBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const themeToggle = document.getElementById('themeToggle');

        if(headerRight && locateBtn && logoutBtn) {
            headerRight.prepend(logoutBtn);
            headerRight.prepend(locateBtn);
            // Ensure they are visible
            locateBtn.style.display = 'inline-flex';
        }
    });
</script>
</body>
</html>