<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qatar North Traffic Junctions Survey Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --aktor-blue: #111827;
      --aktor-red: #e0283b;
      --algo-blue: #0070c9;
      --card-bg: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color: #111827;
      
      /* FIX: Using explicit properties for reliable background loading */
      background-image: url('bg-image.png'); 
      background-color: #020617; /* Fallback color */
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-size: cover;
    }

    .page {
      width: 100%;
      min-height: 100vh;
      margin: 0;
      /* Overlay to ensure text is readable over the background image */
      background: linear-gradient(
        180deg,
        rgba(15, 23, 42, 0.5),
        rgba(15, 23, 42, 0.8)
      );
    }

    /* ===== HEADER ===== */
    header {
      width: 100%;
      background: linear-gradient(90deg, #020617, #111827);
      backdrop-filter: blur(8px);
      border-bottom: 3px solid rgba(224, 40, 59, 0.9);
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .header-left,
    .header-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
    }

    .header-center {
      flex: 1 1 auto;
      text-align: center;
    }

    .logo-img {
      max-height: 56px;
      height: auto;
    }

    .logo-img-small {
      max-height: 42px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: #f9fafb;
    }

    header .subtitle {
      font-size: 11px;
      color: #e5e7eb;
      margin-top: 2px;
    }

    .datetime-header {
      font-size: 11px;
      color: #cbd5ff;
      margin-top: 4px;
    }

    /* ===== MAIN GRID ===== */
    .container {
      padding: 12px 16px 20px;
      display: grid;
      grid-template-columns: 1.55fr 1.15fr;
      grid-gap: 16px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(155px, 1fr));
      grid-gap: 10px;
      margin-bottom: 14px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: 0 3px 12px rgba(15, 23, 42, 0.35);
    }

    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .card-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .card-sub {
      font-size: 11px;
      color: #4b5563;
      margin-top: 4px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 12px;
      overflow: hidden;
    }

    .map-card {
      margin-bottom: 12px;
    }

    .right-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .filters-row-title {
      font-size: 11px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
      margin-top: 4px;
    }

    .filters label {
      font-size: 11px;
      color: #374151;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .filters select {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 11px;
      min-width: 110px;
      background: #f9fafb;
    }

    .filters select:focus {
      outline: none;
      border-color: var(--algo-blue);
      box-shadow: 0 0 0 1px rgba(0, 112, 201, 0.3);
    }

    .active-filters {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0, 112, 201, 0.12);
      color: #1d4ed8;
    }

    .filter-chip button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 11px;
      line-height: 1;
    }

    .export-btn {
      margin-top: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #0070c9;
      background: #0070c9;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
    }

    .export-btn:hover {
      background: #005fa3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    th,
    td {
      padding: 4px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    td:nth-child(2) {
      white-space: normal;
    }

    .table-wrapper {
      max-height: 310px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }

    tbody tr:nth-child(even) {
      background: #f3f4f6;
    }

    tbody tr:hover {
      background: #e5edff;
      cursor: pointer;
    }

    .status-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      color: #fff;
    }

    .status-completed {
      background: #16a34a;
    }

    .status-pending {
      background: #dc2626;
    }

    .zone-chart-wrapper {
      height: 220px;
    }

    .zone-card {
      background: linear-gradient(135deg, #eff6ff, #ffffff);
      margin-top: 4px;
      margin-bottom: 10px;
    }

    .scope-card {
      background: linear-gradient(135deg, #fef9c3, #ffffff);
    }

    .attention-card {
      margin-top: 6px;
      /* NEW STYLES: added for list container flexibility */
      flex-grow: 1; 
      min-height: 100px;
      padding: 12px 14px; 
    }
    
    /* --- New Styles for Attention Card Enhancement (Priority Cards) --- */
    #attention-list {
        display: flex;
        flex-direction: column;
        gap: 8px; /* Space between zone items */
        padding-top: 4px;
    }

    /* Style for each Zone Priority Item (a mini-card) */
    .zone-priority-item {
        background-color: #f8fafc; /* Light grey background */
        border-left: 5px solid; /* Color will be set by JS */
        border-radius: 4px;
        padding: 6px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: transform 0.1s ease-out;
    }
    
    .zone-priority-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .zone-item-left {
        display: flex;
        align-items: center;
        font-weight: 700;
    }

    .zone-item-stat {
        font-size: 10px;
        color: #6b7280;
        font-weight: 500;
        margin-left: 8px;
    }
    /* --- End New Styles --- */

    .progress-wrapper {
      margin-top: 6px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
      transition: width 0.6s ease;
    }

    .progress-label {
      font-size: 11px;
      color: #4b5563;
      margin-top: 3px;
    }

    #lastUpdated {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .table-search {
      flex: 1;
    }

    .table-search input {
      width: 100%;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 11px;
      background: #f9fafb;
    }

    .table-search input:focus {
      outline: none;
      border-color: var(--algo-blue);
      box-shadow: 0 0 0 1px rgba(0, 112, 201, 0.3);
    }

    @media (max-width: 1024px) {
      header {
        padding: 8px 12px;
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .header-center {
        text-align: left;
      }
      .container {
        padding: 8px 12px 16px;
        grid-template-columns: 1fr;
        grid-gap: 10px;
      }
      .right-col {
        order: 2;
      }
      .container > div:first-child {
        order: 1;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-left">
        <img src="aktor-logo.png" alt="AKTOR Qatar" class="logo-img" />
      </div>

      <div class="header-center">
        <h1>Qatar North Traffic Junctions Survey Dashboard</h1>
        <div class="subtitle">
          Live from Google Sheet — Junctions, Survey Completion &amp; Operations Status
        </div>
        <div class="datetime-header" id="currentDateTime"></div>
      </div>

      <div class="header-right">
        <img
          src="algosystems-logo.png"
          alt="ALGOSYSTEMS Qatar"
          class="logo-img logo-img-small"
        />
      </div>
    </header>

    <div class="container">
      <div>
        <div class="kpi-grid">
          <div class="card">
            <div class="card-title">Total Junctions</div>
            <div class="card-value" id="kpi-total">–</div>
          </div>

          <div class="card">
            <div class="card-title">Doha Region</div>
            <div class="card-value" id="kpi-doha-total">–</div>
            <div class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="doha-progress-fill"></div>
              </div>
              <div class="progress-label" id="kpi-doha-pct">–</div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">North Region</div>
            <div class="card-value" id="kpi-north-total">–</div>
            <div class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="north-progress-fill"></div>
              </div>
              <div class="progress-label" id="kpi-north-pct">–</div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">Pole Survey Status</div>
            <div class="card-value" id="kpi-pole-completed">–</div>
            <div class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="pole-progress-fill"></div>
              </div>
              <div class="progress-label" id="kpi-pole-pct">–</div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">Controller Survey Status</div>
            <div class="card-value" id="kpi-ctrl-completed">–</div>
            <div class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="ctrl-progress-fill"></div>
              </div>
              <div class="progress-label" id="kpi-ctrl-pct">–</div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">Junctions Under O&amp;M</div>
            <div class="card-value" id="kpi-om">–</div>
          </div>

          <div class="card">
            <div class="card-title">Junctions Under Projects</div>
            <div class="card-value" id="kpi-projects">–</div>
          </div>

          <div class="card">
            <div class="card-title">Junctions Switched Off</div>
            <div class="card-value" id="kpi-off">–</div>
          </div>

          <div class="card">
            <div class="card-title">SCATS Operated</div>
            <div class="card-value" id="kpi-scats-operated">–</div>
          </div>

          <div class="card">
            <div class="card-title">Non-SCATS (Isolated)</div>
            <div class="card-value" id="kpi-non-scats">–</div>
          </div>

          <div class="card">
            <div class="card-title">Survey Completed</div>
            <div class="card-value" id="kpi-survey-completed">–</div>
            <div class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="survey-progress-fill"></div>
              </div>
              <div class="progress-label" id="kpi-survey-pct">–</div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">Survey Pending</div>
            <div class="card-value" id="kpi-survey-pending">–</div>
          </div>
        </div>

        <div class="card map-card">
          <div class="card-title">Junction Map (Leaflet / OpenStreetMap)</div>
          <div id="map"></div>
          <div id="lastUpdated"></div>
        </div>

        <div class="card zone-card">
          <div class="card-title">Zone-wise Survey Completion</div>
          <div class="zone-chart-wrapper">
            <canvas id="zoneChart"></canvas>
          </div>
          <div class="card-sub">
            Percentage of junctions with completed survey status in each zone.
          </div>
        </div>

        <div class="card attention-card">
          <div class="card-title">⚠️ Priority Zones (Survey Lag)</div>
          <div id="attention-list"></div>
        </div>
        </div>

      <div class="right-col">
        <div class="card">
          <div class="filters-row-title">Filters</div>
          <div class="filters">
            <label>
              Region
              <select id="filter-region">
                <option value="">All</option>
              </select>
            </label>
            
             <label>
              Area
              <select id="filter-area">
                <option value="">All</option>
              </select>
            </label>

            <label>
              Zone
              <select id="filter-zone">
                <option value="">All</option>
              </select>
            </label>
            <label>
              Survey Status
              <select id="filter-survey">
                <option value="">All</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
              </select>
            </label>
            <label>
              Remarks
              <select id="filter-remarks">
                <option value="">All</option>
                <option value="om">Under O&amp;M</option>
                <option value="projects">Under Projects</option>
                <option value="off">Switched Off</option>
                <option value="other">Other</option>
              </select>
            </label>
          </div>
          <div class="active-filters" id="active-filters"></div>
          <button id="export-btn" class="export-btn">
            Download Current View (CSV)...
          </button>
        </div>

        <div class="card">
          <div class="card-title">Junction List</div>
          <div class="table-controls">
            <div class="table-search">
              <input
                type="text"
                id="table-search"
                placeholder="Search junction, street, zone, district or remarks..."
              />
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Junct No</th>
                  <th>Region</th>
                  <th>Zone</th>
                  <th>Area</th>
                  <th>Street</th>
                  <th>Remarks</th>
                  <th>Pole Survey</th>
                  <th>Ctrl Survey</th>
                  <th>Survey</th>
                </tr>
              </thead>
              <tbody id="junction-table-body"></tbody>
            </table>
          </div>
        </div>

        <div class="card scope-card">
          <div class="card-title">Scope Distribution</div>
          <canvas id="scopeChart" height="160"></canvas>
          <div class="card-sub">
            Split of junctions by Remarks (Under O&amp;M / Under Projects /
            Switched Off / Other).
          </div>
        </div>
      </div>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /* ===== DATA CONFIG ===== */
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5pFct4J8nDgw7VLuUJpfVgxewoZSkjh-cNxjgtOOZcjEM5Hx0xyJsziL9MUrEmK6wuls0C2Ffd1ku/pub?gid=1921347271&single=true&output=csv";
    const COLS = {
      junctNo: "Junct No",
      street: "Street Details",
      lat: "Latitude",
      lon: "Longitude",
      zone: "Zone No",
      district: "District",
      remarks: "Remarks",
      surveyStatus: "Survey Status",
      poleSurvey: "Pole Survey",
      ctrlSurvey: "Controller Survey",
      scats: "SCATS & Non SCATS",
      region: "Region",
      area: "Area",
    };

    let allData = [];
    let currentFiltered = [];
    let map = null;
    let markersLayer = null;
    let zoneChart = null;
    let scopeChart = null;
    let tableSearchTerm = "";

    /* ===== UTILS ===== */
    function isTruthy(value) {
      if (typeof value === "string") {
        return value.trim().toLowerCase() === "true";
      }
      return !!value;
    }

    function classifySurvey(status) {
      return isTruthy(status) ? "completed" : "pending";
    }

    function classifyRemarks(remarks) {
      const lower = (remarks || "").toLowerCase();
      if (lower.includes("o&m")) return "om";
      if (lower.includes("projects")) return "projects";
      if (lower.includes("switched off")) return "off";
      return "other";
    }

    function classifyScats(scats) {
      const lower = (scats || "").toLowerCase();
      if (lower.includes("scats")) return "scats";
      if (lower.includes("non scats") || lower.includes("isolated")) return "non-scats";
      return "other";
    }

    function getStatusHtml(status) {
      const isDone = isTruthy(status);
      const className = isDone ? "status-completed" : "status-pending";
      const text = isDone ? "Completed" : "Pending";
      return `<span class="status-pill ${className}">${text}</span>`;
    }

    /* ===== MAP FUNCTIONS ===== */
    function initMap() {
      if (map) map.remove();
      const qatarCoords = [25.3548, 51.1839]; // Center of Qatar
      map = L.map("map").setView(qatarCoords, 10);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    function addMarkers(data) {
      if (!map || !markersLayer) return;

      markersLayer.clearLayers();

      data.forEach((row) => {
        const lat = parseFloat(row[COLS.lat]);
        const lon = parseFloat(row[COLS.lon]);
        if (isNaN(lat) || isNaN(lon)) return;

        const surveyClass = classifySurvey(row[COLS.surveyStatus]);
        const color = surveyClass === "completed" ? "#16a34a" : "#dc2626";

        const marker = L.circleMarker([lat, lon], {
          radius: 5,
          color,
          fillColor: color,
          fillOpacity: 0.9,
          weight: 1,
        });

        const popupHtml = `
          <strong>Junction ${row[COLS.junctNo] || ""}</strong><br/>
          ${row[COLS.street] || ""}<br/>
          Region: ${row[COLS.region] || ""} · Area: ${row[COLS.area] || ""}<br/>
          Zone: ${row[COLS.zone] || ""} · District: ${row[COLS.district] || ""}<br/>
          Remarks: ${row[COLS.remarks] || ""}<br/>
          Survey: ${surveyClass === "completed" ? "Completed" : "Pending"}
        `;

        marker.bindPopup(popupHtml);
        marker.addTo(markersLayer);
      });

      if (data.length > 0) {
        const bounds = markersLayer.getBounds();
        if (bounds && bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        }
      }
    }

    /* ===== KPIs ===== */
    function updateKPIs(data) {
      const total = data.length;
      let om = 0, proj = 0, off = 0, surveyCompleted = 0, surveyPending = 0, scatsOperated = 0, nonScats = 0, dohaTotal = 0, dohaCompleted = 0, northTotal = 0, northCompleted = 0, poleCompleted = 0, ctrlCompleted = 0;
      
      data.forEach((row) => {
        // Remarks Count
        const remarksType = classifyRemarks(row[COLS.remarks]);
        if (remarksType === "om") om++;
        else if (remarksType === "projects") proj++;
        else if (remarksType === "off") off++;
        
        // Survey Count
        const isDone = isTruthy(row[COLS.surveyStatus]);
        if (isDone) {
          surveyCompleted++;
        } else {
          surveyPending++;
        }

        // Pole Survey Count
        if (isTruthy(row[COLS.poleSurvey])) {
          poleCompleted++;
        }

        // Controller Survey Count
        if (isTruthy(row[COLS.ctrlSurvey])) {
          ctrlCompleted++;
        }

        // SCATS Count
        const scatsType = classifyScats(row[COLS.scats]);
        if (scatsType === "scats") scatsOperated++;
        else if (scatsType === "non-scats") nonScats++;

        // Region Count
        const region = (row[COLS.region] || "").toLowerCase();
        if (region.includes("doha")) {
          dohaTotal++;
          if (isDone) dohaCompleted++;
        } else if (region.includes("north")) {
          northTotal++;
          if (isDone) northCompleted++;
        }
      });

      // 1. Total & Survey Status
      document.getElementById("kpi-total").textContent = total;
      document.getElementById("kpi-survey-completed").textContent = surveyCompleted;
      document.getElementById("kpi-survey-pending").textContent = surveyPending;

      const pctSurvey = total > 0 ? (surveyCompleted / total) * 100 : 0;
      document.getElementById("kpi-survey-pct").textContent = (total > 0 ? pctSurvey.toFixed(1) + "%" : "–") + " Completed";
      const surveyFill = document.getElementById("survey-progress-fill");
      if (surveyFill) surveyFill.style.width = pctSurvey.toFixed(1) + "%";

      // 2. Remarks
      document.getElementById("kpi-om").textContent = om;
      document.getElementById("kpi-projects").textContent = proj;
      document.getElementById("kpi-off").textContent = off;

      // 3. SCATS
      document.getElementById("kpi-scats-operated").textContent = scatsOperated;
      document.getElementById("kpi-non-scats").textContent = nonScats;

      // 4. Pole Survey Percentage
      const pctPole = total > 0 ? (poleCompleted / total) * 100 : 0;
      document.getElementById("kpi-pole-completed").textContent = poleCompleted;
      document.getElementById("kpi-pole-pct").textContent = (total > 0 ? pctPole.toFixed(1) + "%" : "–") + " Completed";
      const poleFill = document.getElementById("pole-progress-fill");
      if (poleFill) poleFill.style.width = pctPole.toFixed(1) + "%";

      // 5. Controller Survey Percentage
      const pctCtrl = total > 0 ? (ctrlCompleted / total) * 100 : 0;
      document.getElementById("kpi-ctrl-completed").textContent = ctrlCompleted;
      document.getElementById("kpi-ctrl-pct").textContent = (total > 0 ? pctCtrl.toFixed(1) + "%" : "–") + " Completed";
      const ctrlFill = document.getElementById("ctrl-progress-fill");
      if (ctrlFill) ctrlFill.style.width = pctCtrl.toFixed(1) + "%";

      // 6. Doha & North Region Stats
      const dohaPct = dohaTotal > 0 ? (dohaCompleted / dohaTotal) * 100 : 0;
      document.getElementById("kpi-doha-total").textContent = dohaTotal;
      document.getElementById("kpi-doha-pct").textContent = dohaTotal > 0 ? `${dohaPct.toFixed(1)}% Completed` : "0% Completed";
      const dohaFill = document.getElementById("doha-progress-fill");
      if (dohaFill) dohaFill.style.width = dohaPct.toFixed(1) + "%";

      const northPct = northTotal > 0 ? (northCompleted / northTotal) * 100 : 0;
      document.getElementById("kpi-north-total").textContent = northTotal;
      document.getElementById("kpi-north-pct").textContent = northTotal > 0 ? `${northPct.toFixed(1)}% Completed` : "0% Completed";
      const northFill = document.getElementById("north-progress-fill");
      if (northFill) northFill.style.width = northPct.toFixed(1) + "%";
    }

    /* ===== FILTER POPULATION ===== */
    function populateDropdown(data, column, elementId) {
      const select = document.getElementById(elementId);
      // Get unique values, sort them, filter out empties
      const values = Array.from(
        new Set(data.map((row) => String(row[column] || "").trim()).filter(v => v !== ""))
      ).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

      const currentVal = select.value;
      select.innerHTML = '<option value="">All</option>'; // Reset dropdown

      values.forEach((value) => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });

      // Restore previously selected value if it still exists
      if (currentVal && values.includes(currentVal)) {
          select.value = currentVal;
      }
    }

    /* ===== TABLE RENDERING ===== */
    function renderTable(data) {
      const tbody = document.getElementById("junction-table-body");
      if (!tbody) return;

      tbody.innerHTML = ""; // Clear existing rows

      // Apply search filter
      const search = tableSearchTerm.toLowerCase().trim();
      const filteredData = search 
        ? data.filter(row => 
            Object.keys(COLS).some(key => 
              (String(row[COLS[key]] || "")).toLowerCase().includes(search)
            )
          )
        : data;

      // Limit to first 100 for performance
      const displayData = filteredData.slice(0, 100);

      displayData.forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row[COLS.junctNo] || ""}</td>
          <td>${row[COLS.region] || ""}</td>
          <td>${row[COLS.zone] || ""}</td>
          <td>${row[COLS.area] || ""}</td>
          <td>${row[COLS.street] || ""}</td>
          <td>${row[COLS.remarks] || ""}</td>
          <td>${getStatusHtml(row[COLS.poleSurvey])}</td>
          <td>${getStatusHtml(row[COLS.ctrlSurvey])}</td>
          <td>${getStatusHtml(row[COLS.surveyStatus])}</td>
        `;

        tr.addEventListener("click", () => {
          const lat = parseFloat(row[COLS.lat]);
          const lon = parseFloat(row[COLS.lon]);
          if (!isNaN(lat) && !isNaN(lon) && map) {
            map.setView([lat, lon], 14, { animate: true });
          }
        });

        tbody.appendChild(tr);
      });

      // Display count above table (optional, but good practice)
      const tableTitle = document.querySelector('.card-title:last-of-type');
      if (tableTitle && filteredData.length !== data.length) {
          tableTitle.textContent = `Junction List (Showing ${displayData.length} of ${filteredData.length} matches)`;
      } else if (tableTitle) {
          tableTitle.textContent = `Junction List (Total: ${data.length})`;
      }
    }

    /* ===== CHARTS ===== */
    function buildZoneChart(data) {
      const zoneMap = new Map();
      data.forEach((row) => {
        const zone = row[COLS.zone] || "NA";
        if (!zoneMap.has(zone)) {
          zoneMap.set(zone, { total: 0, completed: 0 });
        }
        const entry = zoneMap.get(zone);
        entry.total++;
        if (isTruthy(row[COLS.surveyStatus])) entry.completed++;
      });

      const labels = Array.from(zoneMap.keys()).sort((a, b) =>
        String(a).localeCompare(String(b), undefined, { numeric: true })
      );
      const values = labels.map((z) => {
        const { total, completed } = zoneMap.get(z);
        return total > 0 ? +(completed / total) * 100 : 0;
      });

      const ctx = document.getElementById("zoneChart");
      if (!ctx) return;

      if (zoneChart) zoneChart.destroy();

      zoneChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Survey Completion %",
              data: values,
              backgroundColor: "rgba(0, 112, 201, 0.75)",
            },
          ],
        },
        // UPDATED: Chart options to include 60% threshold line
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.parsed.y}% completed`,
              },
            },
          },
          scales: {
            x: {
              title: { display: true, text: "Zone No" },
              ticks: { font: { size: 10 } }
            },
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: "Completion %" },
              ticks: {
                callback: (v) => v + "%",
                font: { size: 10 }
              },
              // *** ADDED: Target Line at 60% ***
              // Draw a horizontal line at 60
              afterBuildTicks: function(scale) {
                const ticks = scale.ticks;
                // Add the 60 value if it doesn't exist to force a tick mark
                if (!ticks.find(t => t.value === 60)) {
                    ticks.push({ value: 60, label: 'Target' });
                }
                scale.ticks = ticks;
              },
              grid: {
                  // Make the grid line at 60% red and thick
                  color: (context) => context.tick.value === 60 ? 'rgba(224, 40, 59, 0.7)' : 'rgba(0, 0, 0, 0.1)', // Red line for 60%
                  lineWidth: (context) => context.tick.value === 60 ? 2 : 1, // Thicker line for 60%
              },
              // *** END ADDED ***
            },
          },
        },
      });
    }

    function buildScopeChart(data) {
      const remarksMap = new Map();
      let total = 0;
      data.forEach((row) => {
        const type = classifyRemarks(row[COLS.remarks]);
        remarksMap.set(type, (remarksMap.get(type) || 0) + 1);
        total++;
      });

      // Ensure all keys are present even if count is 0
      const labelsMap = {
        om: "Under O&M",
        projects: "Under Projects",
        off: "Switched Off",
        other: "Other/Unknown",
      };

      const labels = Object.values(labelsMap);
      const values = Object.keys(labelsMap).map(
        (key) => remarksMap.get(key) || 0
      );
      
      const backgroundColors = [
        'rgba(59, 130, 246, 0.8)', // Blue for O&M
        'rgba(245, 158, 11, 0.8)', // Amber for Projects
        'rgba(220, 38, 38, 0.8)',  // Red for Off
        'rgba(107, 114, 128, 0.8)', // Gray for Other
      ];

      const ctx = document.getElementById("scopeChart");
      if (!ctx) return;

      if (scopeChart) scopeChart.destroy();

      scopeChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [
            {
              data: values,
              backgroundColor: backgroundColors,
              hoverOffset: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "right",
              labels: {
                font: { size: 10 },
                boxWidth: 10,
                padding: 10
              },
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const label = ctx.label;
                  const value = ctx.parsed;
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                },
              },
            },
          },
        },
      });
    }

    // REPLACED FUNCTION: New version implements Priority Cards
    /* ===== AI-STYLE INSIGHTS (NEW: Priority Cards) ===== */
    function updateInsights(data) {
      const el = document.getElementById("attention-list");
      if (!el) return;

      if (!data || data.length === 0) {
        el.innerHTML = `<span style="color: #6b7280; font-style: italic;">No data for current selection.</span>`;
        return;
      }

      const zoneMap = new Map();
      data.forEach((row) => {
        const zone = row[COLS.zone] || "NA";
        if (!zoneMap.has(zone)) {
          zoneMap.set(zone, { total: 0, completed: 0 });
        }
        const entry = zoneMap.get(zone);
        entry.total++;
        if (isTruthy(row[COLS.surveyStatus])) entry.completed++;
      });

      const zones = Array.from(zoneMap.entries()).map(
        ([zone, { total, completed }]) => {
          const pct = total > 0 ? (completed / total) * 100 : 0;
          return { zone, total, completed, pct };
        }
      );

      // Sort by lowest percentage first
      zones.sort((a, b) => a.pct - b.pct);

      const threshold = 60;
      const needing = zones.filter((z) => z.pct < threshold);

      el.innerHTML = ""; // Clear previous content

      if (needing.length === 0) {
        el.innerHTML = `<span style="color: #10b981; font-weight: 600;">✅ All ${zones.length} zones have survey completion ≥ ${threshold}% in the current view.</span>`;
        return;
      }

      const top5 = needing.slice(0, 5);
      el.innerHTML += `<div style="font-size:10px; color:#ef4444; margin-bottom: 4px;">Top ${top5.length} zones below ${threshold}% completion:</div>`;
      
      top5.forEach((z) => {
        // Determine border color based on urgency (lower completion = more red)
        let borderColor = '#facc15'; // Yellow (Caution: 40-60%)
        if (z.pct < 40) {
            borderColor = '#ef4444'; // Red (Critical: < 40%)
        } else if (z.pct > 70) {
            borderColor = '#3b82f6'; // Blue (Good: > 70%)
        }

        const item = document.createElement("div");
        item.className = "zone-priority-item";
        item.style.borderColor = borderColor;

        item.innerHTML = `
          <div class="zone-item-left">
            ${z.pct < threshold ? '⚠️' : '✅'} Zone ${z.zone}
          </div>
          <div class="zone-item-stat">
            ${z.completed}/${z.total} (${z.pct.toFixed(1)}%)
          </div>
        `;
        el.appendChild(item);
      });
    }
    // END REPLACED FUNCTION

    /* ===== FILTER TAGS ===== */
    function updateFilterTags() {
      const regionVal = document.getElementById("filter-region").value;
      const areaVal = document.getElementById("filter-area").value;
      const zoneVal = document.getElementById("filter-zone").value;
      const surveyVal = document.getElementById("filter-survey").value;
      const remarksVal = document.getElementById("filter-remarks").value;
      const container = document.getElementById("active-filters");
      if (!container) return;

      container.innerHTML = "";
      const filters = [];

      if (regionVal) filters.push({ key: "region", label: "Region: " + regionVal });
      if (areaVal) filters.push({ key: "area", label: "Area: " + areaVal });
      if (zoneVal) filters.push({ key: "zone", label: "Zone: " + zoneVal });
      if (surveyVal) {
        const status = surveyVal.charAt(0).toUpperCase() + surveyVal.slice(1);
        filters.push({ key: "survey", label: "Survey Status: " + status });
      }
      if (remarksVal) {
        const labelText = document.getElementById("filter-remarks").options.find(opt => opt.value === remarksVal).textContent;
        filters.push({ key: "remarks", label: "Remarks: " + labelText });
      }

      filters.forEach((f) => {
        const chip = document.createElement("span");
        chip.className = "filter-chip";
        chip.innerHTML = `${f.label} <button data-key="${f.key}">x</button>`;
        chip.querySelector("button").addEventListener("click", () => {
          if (f.key === "region") document.getElementById("filter-region").value = "";
          if (f.key === "area") document.getElementById("filter-area").value = "";
          if (f.key === "zone") document.getElementById("filter-zone").value = "";
          if (f.key === "survey") document.getElementById("filter-survey").value = "";
          if (f.key === "remarks") document.getElementById("filter-remarks").value = "";
          applyFilters();
        });
        container.appendChild(chip);
      });
    }

    /* ===== APPLY GLOBAL FILTERS ===== */
    function applyFilters() {
      const regionVal = document.getElementById("filter-region").value;
      const areaVal = document.getElementById("filter-area").value;
      const zoneVal = document.getElementById("filter-zone").value;
      const surveyVal = document.getElementById("filter-survey").value;
      const remarksVal = document.getElementById("filter-remarks").value;

      let filtered = allData.slice();

      // Region Filter
      if (regionVal) {
        filtered = filtered.filter((row) => String(row[COLS.region]) === regionVal);
      }
      // Area Filter
      if (areaVal) {
        filtered = filtered.filter((row) => String(row[COLS.area]) === areaVal);
      }
      // Zone Filter
      if (zoneVal) {
        filtered = filtered.filter((row) => String(row[COLS.zone]) === zoneVal);
      }
      // Survey Status Filter
      if (surveyVal) {
        filtered = filtered.filter(
          (row) => classifySurvey(row[COLS.surveyStatus]) === surveyVal
        );
      }
      // Remarks Filter
      if (remarksVal) {
        filtered = filtered.filter(
          (row) => classifyRemarks(row[COLS.remarks]) === remarksVal
        );
      }

      currentFiltered = filtered;
      updateKPIs(filtered);
      addMarkers(filtered);
      renderTable(filtered);
      buildZoneChart(filtered);
      buildScopeChart(filtered);
      updateInsights(filtered);
      updateFilterTags();
      // Re-populate area/zone dropdowns based on new region/area filter
      // (This prevents users from selecting an area/zone that doesn't exist in the selected region/area)
      if (regionVal) populateDropdown(filtered, COLS.area, 'filter-area');
      else populateDropdown(allData, COLS.area, 'filter-area');

      if (areaVal) populateDropdown(filtered, COLS.zone, 'filter-zone');
      else populateDropdown(allData, COLS.zone, 'filter-zone');
    }

    /* ===== EXPORT FUNCTION ===== */
    function exportCurrentView() {
      if (currentFiltered.length === 0) {
        alert("No data to export in the current view.");
        return;
      }

      // Convert the filtered array of objects to CSV format
      const csv = Papa.unparse(currentFiltered);

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "junctions_dashboard_export.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        alert("Your browser does not support downloading files automatically. Please try exporting from a different browser.");
      }
    }

    /* ===== DATA LOADING ===== */
    function loadData() {
      Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          allData = results.data;
          
          // Initial population of all unique values
          populateDropdown(allData, COLS.region, 'filter-region');
          populateDropdown(allData, COLS.area, 'filter-area');
          populateDropdown(allData, COLS.zone, 'filter-zone');

          // Initial filter application
          applyFilters();

          // Update last fetch time
          const now = new Date();
          document.getElementById("lastUpdated").textContent = 
            `Data last refreshed: ${now.toLocaleString()}`;

          // Set up listeners for new filter elements
          document.getElementById("filter-region").addEventListener("change", applyFilters);
          document.getElementById("filter-area").addEventListener("change", applyFilters);
        },
        error: (err) => {
          console.error("Error loading CSV:", err);
          alert("Error loading data. Check the CSV URL or internet connection.");
        },
      });
    }

    /* ===== HEADER DATE/TIME ===== */
    function updateCurrentDateTime() {
      const el = document.getElementById("currentDateTime");
      if (!el) return;
      const now = new Date();
      el.textContent = now.toLocaleString(undefined, {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    /* ===== INIT ===== */
    document.addEventListener("DOMContentLoaded", function () {
      initMap();
      loadData();

      document
        .getElementById("filter-zone")
        .addEventListener("change", applyFilters);
      document
        .getElementById("filter-survey")
        .addEventListener("change", applyFilters);
      document
        .getElementById("filter-remarks")
        .addEventListener("change", applyFilters);

      document
        .getElementById("export-btn")
        .addEventListener("click", exportCurrentView);

      document
        .getElementById("table-search")
        .addEventListener("input", (e) => {
          tableSearchTerm = e.target.value;
          renderTable(currentFiltered);
        });

      updateCurrentDateTime();
      setInterval(updateCurrentDateTime, 30 * 1000);
    });
  </script>
</body>
</html>