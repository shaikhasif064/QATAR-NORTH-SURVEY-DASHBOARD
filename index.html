<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Qatar North Traffic Junctions Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse (for Google Sheets CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --aktor-blue: #111827;
      --aktor-red: #e0283b;
      --algo-blue: #0070c9;
      --bg: #e5e7eb;
      --card-bg: #ffffff;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif;
      background: radial-gradient(circle at top, #f9fafb 0, #e5e7eb 45%, #d1d5db 100%);
      color: #111827;
    }
    .page { max-width: 1440px; margin: 0 auto; }
    header {
      background: linear-gradient(90deg, #f9fafb 70%, #cbedea 100%);
      backdrop-filter: blur(8px);
      border-bottom: 3px solid rgba(224, 40, 59, 0.8);
      padding: 10px 24px;
      display: flex; align-items: center; justify-content: space-between; gap: 16px;
    }
    .header-left, .header-right { flex: 0 0 auto; display: flex; align-items: center; }
    .header-center { flex: 1 1 auto; text-align: center; }
    .logo-img { max-height: 56px; height: auto; filter: drop-shadow(0 2px 8px #0ea5e99c);}
    .logo-img-small { max-height: 42px; }
    .container { padding: 16px 24px 24px; display: grid; grid-template-columns: 1.55fr 1.15fr; grid-gap: 16px;}
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(155px, 1fr)); grid-gap: 10px; margin-bottom: 14px;}
    .card { background: rgba(255,255,255,0.88); border-radius: 18px; padding: 10px 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.14); backdrop-filter: blur(6px);}
    .card-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: #6b7280; margin-bottom: 4px;}
    .card-value { font-size: 24px; font-weight: 700; color: #111827;}
    .card-sub { font-size: 11px; color: #6b7280; margin-top: 4px;}
    #map { width: 100%; height: 420px; border-radius: 12px; overflow: hidden;}
    .zone-chart-wrapper { height: 220px; }
    .scope-card { background: linear-gradient(135deg, #FEF9C3, #FFF);}
    .progress-bar { width: 100%; height: 6px; border-radius: 999px; background: #e5e7eb; overflow: hidden;}
    .progress-fill { height: 100%; width: 0; border-radius: 999px; background: linear-gradient(90deg,#22c55e,#0ea5e9); transition: width 0.6s ease;}
    .progress-label { font-size: 11px; color: #4b5563; margin-top: 3px;}
    .right-col { display: flex; flex-direction: column; gap:12px;}
    .filters-row-title { font-size: 11px; font-weight: 600; color: #374151; margin-bottom: 4px;}
    label { font-size: 11px;}
    select { padding: 4px 8px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 11px; background: #f9fafb;}
    .export-btn { margin-top: 8px; padding: 4px 10px; border-radius: 999px; border: 1px solid #0070c9; background:#0070c9; color:#fff; font-size:11px;}
    .table-wrapper { max-height: 310px; overflow: auto; border-radius: 8px; border: 1px solid #e5e7eb; background:#fff;}
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    th, td { padding: 4px 6px; border-bottom: 1px solid #e5e7eb; text-align: left; white-space: nowrap;}
    th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; z-index: 1;}
    tbody tr:nth-child(even) { background: #f3f4f6;}
    tbody tr:hover { background: #e5edff; cursor: pointer;}
    .status-pill { display: inline-block; padding: 2px 6px; border-radius: 999px; font-size: 10px; font-weight: 600; color: #fff;}
    .status-completed { background: #16a34a;}
    .status-pending { background: #dc2626;}
    @media (max-width: 1024px) { .container { grid-template-columns: 1fr; grid-gap: 10px;} }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-left">
        <img src="aktor-logo.png" alt="AKTOR Qatar" class="logo-img">
      </div>
      <div class="header-center">
        <h1>Qatar North Traffic Junctions Dashboard</h1>
        <div class="subtitle">Live from Google Sheet &mdash; Junctions, Survey Completion &amp; Operations Status</div>
      </div>
      <div class="header-right">
        <img src="algosystems-logo.png" alt="ALGOSYSTEMS Qatar" class="logo-img logo-img-small">
      </div>
    </header>
    <div class="container">
      <!-- LEFT COLUMN -->
      <div>
        <!-- KPIs -->
        <div class="kpi-grid">
          <div class="card"><div class="card-title">Total Junctions</div><div class="card-value" id="kpi-total">0</div></div>
          <div class="card"><div class="card-title">Junctions Under O&M</div><div class="card-value" id="kpi-om">0</div></div>
          <div class="card"><div class="card-title">Junctions Under Projects</div><div class="card-value" id="kpi-projects">0</div></div>
          <div class="card"><div class="card-title">Junctions Switched Off</div><div class="card-value" id="kpi-off">0</div></div>
          <div class="card"><div class="card-title">Survey Completed</div><div class="card-value" id="kpi-survey-completed">0</div>
            <div class="progress-bar"><div class="progress-fill" id="survey-progress-fill"></div></div>
            <div class="progress-label" id="kpi-survey-pct">0%</div>
          </div>
          <div class="card"><div class="card-title">Pole Survey Completed</div><div class="card-value" id="kpi-pole-completed">0</div></div>
          <div class="card"><div class="card-title">Controller Survey Completed</div><div class="card-value" id="kpi-ctrl-completed">0</div></div>
        </div>
        <!-- MAP -->
        <div class="card">
          <div class="card-title">Junction Map (Leaflet / OpenStreetMap)</div>
          <div id="map"></div>
          <div id="lastUpdated"></div>
        </div>
        <!-- ZONE CHART -->
        <div class="card zone-card">
          <div class="card-title">Zone-wise Survey Completion</div>
          <div class="zone-chart-wrapper"><canvas id="zoneChart"></canvas></div>
          <div class="card-sub">Percentage of junctions with completed survey status in each zone.</div>
        </div>
        <!-- INSIGHTS -->
        <div class="card">
          <div class="card-title">Zones Needing Attention</div>
          <div id="attention-list" class="card-sub"></div>
        </div>
      </div>
      <!-- RIGHT COLUMN -->
      <div class="right-col">
        <!-- FILTERS -->
        <div class="card">
          <div class="filters-row-title">Filters</div>
          <div class="filters">
            <label>Zone
              <select id="filter-zone"><option value="All">All</option></select>
            </label>
            <label>Survey Status
              <select id="filter-survey">
                <option value="All">All</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
              </select>
            </label>
            <label>Remarks
              <select id="filter-remarks">
                <option value="All">All</option>
                <option value="om">Under O&M</option>
                <option value="projects">Under Projects</option>
                <option value="off">Switched Off</option>
                <option value="other">Other</option>
              </select>
            </label>
          </div>
          <div class="active-filters" id="active-filters"></div>
          <button id="export-btn" class="export-btn">Download Current View (CSV)</button>
        </div>
        <!-- TABLE -->
        <div class="card">
          <div class="card-title">Junction List</div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Junct No</th>
                  <th>Street</th>
                  <th>Zone</th>
                  <th>District</th>
                  <th>Remarks</th>
                  <th>Survey</th>
                </tr>
              </thead>
              <tbody id="junction-table-body"></tbody>
            </table>
          </div>
        </div>
        <!-- SCOPE DONUT -->
        <div class="card scope-card">
          <div class="card-title">Scope Distribution</div>
          <canvas id="scopeChart" height="160"></canvas>
          <div class="card-sub">Split of junctions by Remarks (Under O&M / Projects / Switched Off / Other).</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    // Change this to your Google Sheets CSV URL
    const SHEETCSVURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5pFct4J8nDgw7VLuUJpfVgxewoZSkjh-cNxjgtOOZcjEM5Hx0xyJsziL9MUrEmK6wuls0C2Ffd1ku/pub?gid=1921347271&single=true&output=csv";
    const COLS = {
      junctNo: "Junct No",
      street: "Street Details",
      lat: "Latitude",
      lon: "Longitude",
      zone: "Zone No",
      district: "District",
      remarks: "Remarks",
      surveyStatus: "Survey Status",
      poleSurvey: "Pole Survey",
      ctrlSurvey: "Controller Survey",
    };

    function isTruthy(val) {
      if (val == null) return false;
      const v = String(val).trim().toLowerCase();
      return ["true", "yes", "1", "y", "done", "completed", ""].includes(v);
    }

    function classifySurvey(v) {
      return isTruthy(v) ? "completed" : "pending";
    }
    function classifyRemarks(remarks) {
      const r = remarks ? String(remarks).toLowerCase() : "";
      if (r.includes("under o&m") || r.includes("under om")) return "om";
      if (r.includes("under projects") || r.includes("under project")) return "projects";
      if (r.includes("switched off") || r.includes("switch off")) return "off";
      return "other";
    }

    let allData = [];
    let currentFiltered = [];
    let map, markersLayer;
    let zoneChart = null;
    let scopeChart = null;

    function initMap() {
      map = L.map("map").setView([25.3, 51.4], 9);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    function clearMarkers() {
      markersLayer.clearLayers();
    }
    function addMarkers(data) {
      clearMarkers();
      data.forEach(row => {
        const lat = parseFloat(row[COLS.lat]);
        const lon = parseFloat(row[COLS.lon]);
        if (isNaN(lat) || isNaN(lon)) return;
        const surveyClass = classifySurvey(row[COLS.surveyStatus]);
        const color = surveyClass === "completed" ? "#16a34a" : "#dc2626";
        const marker = L.circleMarker([lat, lon], {
          radius: 5,
          color,
          fillColor: color,
          fillOpacity: 0.9,
          weight: 1,
        });
        const popupHtml = `<strong>Junction ${row[COLS.junctNo]}</strong><br>${row[COLS.street]}<br>Zone ${row[COLS.zone]} District ${row[COLS.district]}<br>Remarks: ${row[COLS.remarks]}<br>Survey: ${surveyClass === "completed" ? "Completed" : "Pending"}`;
        marker.bindPopup(popupHtml);
        marker.addTo(markersLayer);
      });
      if (data.length > 0) {
        const bounds = markersLayer.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
      }
    }

    function updateKPIs(data) {
      const total = data.length;
      let om = 0, proj = 0, off = 0, surveyCompleted = 0, poleCompleted = 0, ctrlCompleted = 0;
      data.forEach(row => {
        const remarksType = classifyRemarks(row[COLS.remarks]);
        if (remarksType == "om") om++;
        else if (remarksType == "projects") proj++;
        else if (remarksType == "off") off++;
        if (isTruthy(row[COLS.surveyStatus])) surveyCompleted++;
        if (isTruthy(row[COLS.poleSurvey])) poleCompleted++;
        if (isTruthy(row[COLS.ctrlSurvey])) ctrlCompleted++;
      });
      document.getElementById("kpi-total").textContent = total;
      document.getElementById("kpi-om").textContent = om;
      document.getElementById("kpi-projects").textContent = proj;
      document.getElementById("kpi-off").textContent = off;
      document.getElementById("kpi-survey-completed").textContent = surveyCompleted;
      document.getElementById("kpi-pole-completed").textContent = poleCompleted;
      document.getElementById("kpi-ctrl-completed").textContent = ctrlCompleted;
      const pctNum = total > 0 ? (surveyCompleted / total * 100) : 0;
      document.getElementById("kpi-survey-pct").textContent = `${pctNum.toFixed(1)}% of total`;
      const fill = document.getElementById("survey-progress-fill");
      if (fill) fill.style.width = `${pctNum.toFixed(1)}%`;
    }

    function updateZoneFilter(data) {
      const select = document.getElementById("filter-zone");
      const zones = Array.from(new Set(data.map(row => row[COLS.zone])).filter(z => z != null)).sort((a, b) => (String(a).localeCompare(String(b), undefined, {numeric:true})));
      while (select.options.length > 1) select.remove(1);
      zones.forEach(z => {
        const opt = document.createElement("option");
        opt.value = z; opt.textContent = z;
        select.appendChild(opt);
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById("junction-table-body");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        const surveyClass = classifySurvey(row[COLS.surveyStatus]);
        const statusText = surveyClass === "completed" ? "Completed" : "Pending";
        const statusClass = surveyClass === "completed" ? "status-completed" : "status-pending";
        tr.innerHTML = `<td>${row[COLS.junctNo]}</td><td>${row[COLS.street]}</td><td>${row[COLS.zone]}</td><td>${row[COLS.district]}</td><td>${row[COLS.remarks]}</td><td><span class="status-pill ${statusClass}">${statusText}</span></td>`;
        tr.addEventListener("click", () => {
          const lat = parseFloat(row[COLS.lat]); const lon = parseFloat(row[COLS.lon]);
          if (!isNaN(lat) && !isNaN(lon)) map.setView([lat, lon], 14, {animate:true});
        });
        tbody.appendChild(tr);
      });
    }

    function buildZoneChart(data) {
      const zoneMap = new Map();
      data.forEach(row => {
        const zone = row[COLS.zone] || "NA";
        if (!zoneMap.has(zone)) zoneMap.set(zone, {total:0, completed:0});
        const entry = zoneMap.get(zone); entry.total++;
        if (isTruthy(row[COLS.surveyStatus])) entry.completed++;
      });
      const labels = Array.from(zoneMap.keys()).sort((a,b) => String(a).localeCompare(String(b), undefined, {numeric:true}));
      const values = labels.map(z => {
        const {total, completed} = zoneMap.get(z);
        return total > 0 ? (completed / total * 100).toFixed(1) : 0;
      });
      const ctx = document.getElementById("zoneChart");
      if (!ctx) return;
      if (zoneChart) zoneChart.destroy();
      zoneChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Survey Completion (%)",
            data: values,
            backgroundColor: "rgba(0, 112, 201, 0.75)"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {legend: {display: false}},
          scales: {
            x: {title: {display:true, text:"Zone No"}},
            y: {beginAtZero: true, max: 100, title: {display:true, text:"Completion %"}}
          }
        }
      });
    }

    function buildScopeChart(data) {
      let om = 0, proj = 0, off = 0, other = 0;
      data.forEach(row => {
        const t = classifyRemarks(row[COLS.remarks]);
        if (t == "om") om++;
        else if (t == "projects") proj++;
        else if (t == "off") off++;
        else other++;
      });
      const ctx = document.getElementById("scopeChart");
      if (!ctx) return;
      if (scopeChart) scopeChart.destroy();
      scopeChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Under O&M", "Under Projects", "Switched Off", "Other"],
          datasets: [{
            data: [om, proj, off, other],
            backgroundColor: [
              "rgba(34,197,94,0.9)",
              "rgba(59,130,246,0.9)",
              "rgba(239,68,68,0.9)",
              "rgba(148,163,184,0.95)"
            ],
            borderWidth: 0
          }]
        },
        options: {
          plugins: {
            legend: {position: "bottom", labels: {boxWidth: 12}}
          },
          cutout: "60%"
        }
      });
    }

    function updateInsights(data) {
      const el = document.getElementById("attention-list");
      if (!el) return;
      if (!data || data.length == 0) {
        el.textContent = "No data for current selection.";
        return;
      }
      const zoneMap = new Map();
      data.forEach(row => {
        const zone = row[COLS.zone] || "NA";
        if (!zoneMap.has(zone)) zoneMap.set(zone, {total:0, completed:0});
        const entry = zoneMap.get(zone);
        entry.total++;
        if (isTruthy(row[COLS.surveyStatus])) entry.completed++;
      });
      const zones = Array.from(zoneMap.entries()).map(([zone, {total, completed}]) => {
        const pct = total > 0 ? completed / total * 100 : 0;
        return {zone, total, completed, pct};
      });
      zones.sort((a,b) => a.pct - b.pct);
      const threshold = 60;
      const needing = zones.filter(z => z.pct < threshold);
      if (needing.length == 0) {
        el.textContent = "All zones have survey completion above threshold.";
        return;
      }
      const top5 = needing.slice(0,5);
      el.innerHTML = `<strong>Lowest completion zones (under ${threshold}%):</strong><br>`;
      top5.forEach(z => {
        const line = `Zone ${z.zone}: ${z.completed}/${z.total} (${z.pct.toFixed(1)}%)`;
        const div = document.createElement("div");
        div.textContent = line;
        el.appendChild(div);
      });
    }

    function updateFilterTags() {/*... skipped for brevity, see earlier steps */}
    function applyFilters() {/*... skipped for brevity, see earlier steps */}

    function setLastUpdated() {
      const el = document.getElementById("lastUpdated");
      if (!el) return;
      const now = new Date();
      el.textContent = `Last loaded ${now.toLocaleString(undefined,{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}`;
    }

    function exportCurrentView() {
      const rows = currentFiltered.length > 0 ? currentFiltered : allData;
      if (!rows || rows.length == 0) {
        alert("No data to export."); return;
      }
      const headers = [COLS.junctNo, COLS.street, COLS.zone, COLS.district, COLS.remarks, COLS.surveyStatus, COLS.poleSurvey, COLS.ctrlSurvey, COLS.lat, COLS.lon];
      const csvLines = [];
      csvLines.push(headers.join(","));
      rows.forEach(row => {
        const line = headers.map(h => row[h] == null ? "" : String(row[h]).replace(/,/g,"")).join(",");
        csvLines.push(line);
      });
      const blob = new Blob([csvLines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "qatarnorthjunctionsview.csv";
      document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function loadData() {
      Papa.parse(SHEETCSVURL, {
        download: true, header: true, skipEmptyLines: true,
        complete: function(results) {
          allData = results.data;
          updateZoneFilter(allData);
          applyFilters();
          setLastUpdated();
        },
        error: function(err) {
          console.error("Error loading CSV:", err);
          alert("Error loading data. Check CSV URL or internet connection.");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      loadData();
      document.getElementById("filter-zone").addEventListener("change", applyFilters);
      document.getElementById("filter-survey").addEventListener("change", applyFilters);
      document.getElementById("filter-remarks").addEventListener("change", applyFilters);
      document.getElementById("export-btn").addEventListener("click", exportCurrentView);
    });
  </script>
</body>
</html>