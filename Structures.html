<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qatar North Structures Survey Dashboard</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
    :root {
      --aktor-blue: #0b1120;
      --aktor-red: #e0283b;
      --algo-blue: #38bdf8;

      --bg-surface: rgba(15, 23, 42, 0.88);

      --glass-bg: rgba(15, 23, 42, 0.72);
      --glass-border: rgba(148, 163, 184, 0.45);
      --glass-shadow-soft: 0 22px 45px rgba(15, 23, 42, 0.65);
      --glass-radius-lg: 18px;
      --glass-radius-md: 14px;

      --text-soft: #9ca3af;
      --text-subtle: #6b7280;
      --text-strong: #e5e7eb;
      --text-stronger: #f9fafb;

      --accent-green: #22c55e;
      --accent-amber: #fbbf24;
      --accent-blue: #38bdf8;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
      --accent-pink: #ec4899;
      --accent-orange: #f97316;

      --transition-fast: 200ms cubic-bezier(0.22, 0.61, 0.36, 1);
      --transition-med: 320ms cubic-bezier(0.22, 0.61, 0.36, 1);
    }


    /* ===== THEME: AUTO DARK/LIGHT BASED ON SYSTEM PREFERENCE ===== */
    body[data-theme="dark"] {
      /* default (existing) dark theme */
    }

    body[data-theme="light"] {
      --bg-surface: rgba(255, 255, 255, 0.92);
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(148, 163, 184, 0.55);
      --text-soft: #6b7280;
      --text-subtle: #9ca3af;
      --text-strong: #111827;
      --text-stronger: #020617;
    }

    body[data-theme="light"] {
      background: #f3f4f6;
      color: var(--text-stronger);
    }

    body[data-theme="light"] .page {
      background:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.08), transparent 55%),
        radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.09), transparent 55%),
        linear-gradient(135deg, #e5e7eb, #f9fafb);
    }

    body[data-theme="light"] header,
    body[data-theme="light"] .glass-card,
    body[data-theme="light"] .kpi-card {
      background:
        radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), transparent 55%),
        linear-gradient(145deg, #ffffff, #e5e7eb);
      border-color: rgba(148, 163, 184, 0.55);
      color: var(--text-stronger);
    }

    body[data-theme="light"] .kpi-badge,
    body[data-theme="light"] .filter-chip {
      background-color: rgba(15, 23, 42, 0.08);
      border-color: rgba(148, 163, 184, 0.8);
      color: var(--text-strong);
    }

    body[data-theme="light"] .filters-card,
    body[data-theme="light"] .table-card,
    body[data-theme="light"] .map-card,
    body[data-theme="light"] .chart-card {
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.16);
    }

    body[data-theme="light"] input,
    body[data-theme="light"] select {
      background-color: #ffffff;
      border-color: rgba(148, 163, 184, 0.9);
      color: var(--text-strong);
    }

    body[data-theme="light"] .table-wrapper {
      background:
        radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), rgba(243, 244, 246, 0.98));
      border-color: rgba(148, 163, 184, 0.8);
    }

    body[data-theme="light"] th {
      background: linear-gradient(180deg, #e5e7eb, #d1d5db);
      color: #4b5563;
    }

    body[data-theme="light"] tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    body[data-theme="light"] tbody tr:nth-child(odd) {
      background: #f3f4f6;
    }

    body[data-theme="light"] tbody tr:hover {
      background:
        radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.12), transparent 55%),
        #ffffff;
    }


    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    html,
    body {
      height: 100%;
    }

    body {
      min-height: 100vh;
      background-color: #020617;
      background-attachment: fixed;
      background-size: cover;
      color: var(--text-strong);
    }

    .page {
      width: 100%;
      min-height: 100vh;
      margin: 0;
      padding-bottom: 24px;
      /* Colorful multi-layer background */
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.26), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(236, 72, 153, 0.22), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249, 115, 22, 0.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.22), transparent 60%),
        linear-gradient(180deg, #020617 0%, #020617 18%, #020617 100%);
    }

    .shell {
      max-width: 1880px;
      margin: 0 auto;
      padding: 12px 16px 24px;
    }

    /* ===== HEADER ===== */
    header {
      width: 100%;
      border-radius: 20px;
      margin-bottom: 14px;
      padding: 10px 20px;
      background:
        linear-gradient(135deg, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.92)),
        linear-gradient(90deg, rgba(56, 189, 248, 0.35), rgba(168, 85, 247, 0.35), rgba(236, 72, 153, 0.26));
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      position: relative;
      top: auto;
      z-index: auto;
    }

    .header-left,
    .header-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-center {
      flex: 1 1 auto;
      text-align: center;
    }

    .header-logo {
      max-height: 52px;
      height: auto;
      filter: drop-shadow(0 8px 20px rgba(15, 23, 42, 0.8));
    }

    .header-logo-small {
      max-height: 42px;
    }

    .header-title {
      font-size: clamp(20px, 2vw, 26px);
      font-weight: 700;
      letter-spacing: 0.06em;
      color: var(--text-stronger);
      text-transform: uppercase;
    }

    .header-subtitle {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .header-meta {
      font-size: 11px;
      color: #c7d2fe;
      margin-top: 4px;
    }

    .header-meta-separator {
      margin: 0 6px;
      opacity: 0.75;
    }

    /* ===== NAV LINKS (if used) ===== */
    .top-nav-links {
      display: flex;
      gap: 12px;
      margin-top: 6px;
    }

    .top-nav-links a {
      font-size: 11px;
      font-weight: 500;
      padding: 6px 10px;
      border-radius: 999px;
      text-decoration: none;
      color: var(--text-soft);
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.8);
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
    }

    .top-nav-links a:hover {
      color: var(--text-strong);
      border-color: rgba(148, 163, 184, 0.5);
      transform: translateY(-1px);
    }

    .top-nav-links a.is-active {
      color: var(--text-stronger);
      border-color: var(--accent-blue);
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.3), transparent 60%),
        rgba(15, 23, 42, 0.95);
      box-shadow: 0 0 0 1px var(--accent-blue), 0 8px 15px rgba(56, 189, 248, 0.2);
    }


    /* ===== THEME TOGGLE BUTTON (from ITS.html) ===== */
    .theme-toggle {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background-image:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .theme-toggle:hover {
      border-color: var(--accent-blue);
      color: var(--text-strong);
      box-shadow: 0 0 0 1px var(--accent-blue), 0 8px 18px rgba(56, 189, 248, 0.25);
      transform: translateY(-1px);
    }

    .theme-toggle .icon {
      font-size: 14px;
    }

    /* Light mode styling for toggle */
    body[data-theme="light"] .theme-toggle {
      border-color: rgba(148, 163, 184, 0.75);
      color: var(--text-strong);
      background-image:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.12), transparent 60%),
        linear-gradient(135deg, #ffffff, #f9fafb);
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.25);
    }

    body[data-theme="light"] .theme-toggle:hover {
      border-color: rgba(37, 99, 235, 0.85);
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.45);
    }

    /* ===== LAYOUT: HIERARCHY ===== */
    main.dashboard {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
    }

    .section {
      display: block;
      animation: fade-slide-up 0.65s var(--transition-med);
    }

    .section-kpis {
      margin-top: 4px;
    }

    .section-insights,
    .section-filters,
    .section-main,
    .section-table {
      margin-top: 2px;
    }

    /* ===== GLASS CARD BASE ===== */
    .glass-card {
      position: relative;
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.16), transparent 40%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      border-radius: var(--glass-radius-lg);
      padding: 10px 14px;
      box-shadow: var(--glass-shadow-soft);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      overflow: hidden;
      transition:
        transform var(--transition-med),
        box-shadow var(--transition-med),
        border-color var(--transition-med),
        background var(--transition-med);
    }

    .glass-card::before {
      content: "";
      position: absolute;
      inset: -20%;
      opacity: 0;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.16), transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.16), transparent 45%);
      transition: opacity var(--transition-med);
      pointer-events: none;
    }

    .glass-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 26px 55px rgba(15, 23, 42, 0.95), 0 0 0 1px var(--glass-border);
    }

    .glass-card:hover::before {
      opacity: 1;
    }

    /* Map and Chart cards don't use hover effect */
    .map-card,
    .chart-card {
      transform: none !important;
      box-shadow: var(--glass-shadow-soft) !important;
    }

    /* === Card Header elements === */
    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-stronger);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0;
    }

    .card-sub {
      font-size: 10px;
      color: var(--text-subtle);
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--glass-border);
      text-align: center;
    }


    /* ===== KPI CARDS ===== */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 4px;
    }

    .kpi-card {
      padding: 12px 14px;
      border-radius: var(--glass-radius-md);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 10px;
    }

    .kpi-card.kpi-primary {
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), transparent 40%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.92));
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-subtle);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: -4px;
    }

    .kpi-value {
      font-size: clamp(20px, 1.8vw, 28px);
      font-weight: 700;
      line-height: 1;
      color: var(--text-stronger);
    }

    .kpi-subtext {
      font-size: 10px;
      color: var(--text-soft);
      line-height: 1.4;
      margin-top: 4px;
      flex-grow: 1;
    }

    .kpi-number {
      font-size: clamp(16px, 1.2vw, 20px);
      font-weight: 600;
      line-height: 1;
      color: var(--text-stronger);
      margin-top: 2px;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .kpi-number span.unit {
      font-size: 11px;
      color: var(--text-soft);
      font-weight: 500;
    }

    .kpi-caption {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 2px;
    }

    /* Circle KPI cards */
    .kpi-circle-layout {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .kpi-circle-compact {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      margin-top: 2px;
    }

    .kpi-circle-compact .circle-wrapper {
      width: 92px;
      height: 92px;
      position: relative;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 10%, #f9fafb, #374151);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 12px 34px rgba(15, 23, 42, 0.9);
    }

    body[data-theme="light"] .kpi-circle-compact .circle-wrapper {
      background: radial-gradient(circle at 30% 10%, #ffffff, #d1d5db);
      box-shadow: 0 12px 34px rgba(15, 23, 42, 0.15);
    }

    .kpi-circle-compact .circle-inner {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-soft);
      z-index: 2;
      background: var(--bg-surface);
    }

    .kpi-circle-compact .circle-fill {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: conic-gradient(
        var(--accent-green) 0%,
        var(--accent-green) 0%,
        var(--text-subtle) 0%
      );
      transition: background 1s ease-in-out;
      z-index: 1;
    }

    .kpi-circle-compact .circle-caption {
      font-size: 11px;
      color: var(--text-soft);
      line-height: 1.4;
    }

    .kpi-circle-compact .circle-caption strong {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-green);
      margin-right: 4px;
    }


    /* ===== FILTERS & SEARCH SECTION ===== */
    .section-filters .glass-card {
      padding: 14px 18px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px 20px;
    }

    .filters label {
      display: block;
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .filters select,
    .filters input[type="search"] {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--glass-border);
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98)) !important;
      color: var(--text-strong) !important;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
      appearance: none;
      -webkit-appearance: none;
      position: relative;
    }

    .filters select:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5), 0 0 10px rgba(56, 189, 248, 0.2);
    }

    /* Light theme styling for dropdowns */
    body[data-theme="light"] .filters select,
    body[data-theme="light"] .filters input[type="search"] {
      background-color: #ffffff !important;
      background-image:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.12), transparent 60%),
        linear-gradient(135deg, #ffffff, #f9fafb) !important;
      color: var(--text-stronger) !important;
      border-color: rgba(148, 163, 184, 0.75);
    }


    /* Filter Tags / Chips */
    .filter-tags-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--glass-border);
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      color: var(--text-strong);
      background-color: rgba(148, 163, 184, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.35);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .filter-chip strong {
      font-weight: 700;
      color: var(--accent-blue);
    }

    .filters-note {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--glass-border);
    }

    /* ===== MAP + CHARTS LAYOUT ===== */
    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 12px;
    }

    /* MAP CARD */
    .map-card {
      padding: 14px 18px;
    }

    .map-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .map-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-stronger);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .map-title .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
    }

    .map-toggle-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 5px 12px;
      font-size: 11px;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 60%),
        rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .map-toggle-btn:hover {
      border-color: var(--accent-blue);
      color: var(--text-strong);
      transform: translateY(-1px);
    }

    .map-toggle-btn-active {
      color: var(--text-stronger) !important;
      border-color: var(--accent-green) !important;
      background:
        radial-gradient(circle at top left, rgba(34, 197, 94, 0.25), transparent 60%),
        rgba(15, 23, 42, 0.98) !important;
      box-shadow: 0 0 0 1px var(--accent-green), 0 8px 15px rgba(34, 197, 94, 0.15);
    }

    body[data-theme="light"] .map-toggle-btn {
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-strong);
    }

    body[data-theme="light"] .map-toggle-btn-active {
      background:
        radial-gradient(circle at top left, rgba(34, 197, 94, 0.1), transparent 60%),
        #ffffff !important;
    }


    #map {
      width: 100%;
      height: 420px;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    .map-footer {
      font-size: 10px;
      color: var(--text-subtle);
      margin-top: 10px;
      padding-top: 6px;
      border-top: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .map-legend {
      display: flex;
      gap: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background-color: var(--text-subtle);
    }

    .legend-surveyed {
      background: var(--accent-green);
      box-shadow: 0 0 8px var(--accent-green);
    }

    .legend-pending {
      background: var(--accent-amber);
      box-shadow: 0 0 8px var(--accent-amber);
    }

    .legend-selected {
      width: 10px;
      height: 10px;
      background: var(--accent-blue);
      box-shadow: 0 0 10px var(--accent-blue);
      animation: pulse 1.5s infinite;
    }


    /* CHARTS COLUMN */
    .charts-stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chart-card {
      padding: 14px 18px;
    }

    .chart-wrapper {
      position: relative;
      height: 200px; /* Standard chart height */
      width: 100%;
      margin: 10px auto;
    }

    /* INSIGHTS / STATS */
    .insights-card {
      padding: 14px 18px;
    }

    .insights-content {
      font-size: 12px;
      color: var(--text-soft);
      line-height: 1.6;
      max-height: 200px;
      overflow-y: auto;
    }

    .insights-content strong {
      color: var(--text-stronger);
      font-weight: 700;
    }

    /* ===== TABLE SECTION ===== */
    .table-card {
      padding: 14px 18px;
      border-radius: var(--glass-radius-lg);
    }

    .table-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .table-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .table-header-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }

    .table-header-sub {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-stronger);
    }

    .table-export-buttons {
      display: flex;
      gap: 6px;
    }

    .export-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 5px 12px;
      font-size: 11px;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 60%),
        rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .export-btn:hover {
      border-color: var(--accent-blue);
      color: var(--text-strong);
      transform: translateY(-1px);
    }

    body[data-theme="light"] .export-btn {
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-strong);
    }


    .table-wrapper {
      width: 100%;
      max-height: 500px;
      overflow: auto;
      border-radius: var(--glass-radius-md);
      border: 1px solid var(--glass-border);
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.02), rgba(15, 23, 42, 0.98));
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.45);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      white-space: nowrap;
    }

    th,
    td {
      padding: 10px 14px;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }

    th {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.95));
      font-weight: 600;
      color: var(--text-soft);
      position: sticky;
      top: 0;
      z-index: 10;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--glass-border);
    }

    tbody tr {
      cursor: pointer;
      transition: background var(--transition-fast);
      color: var(--text-soft);
    }

    tbody tr:hover {
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.12), transparent 55%),
        rgba(15, 23, 42, 0.85);
      color: var(--text-strong);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.9);
    }

    td.status-completed {
      color: var(--accent-green);
      font-weight: 600;
    }

    td.status-pending {
      color: var(--accent-amber);
      font-weight: 600;
    }

    td.status-in-progress {
      color: var(--accent-blue);
      font-weight: 600;
    }


    /* ===== MODAL DETAIL VIEW ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 300ms ease, visibility 0ms 300ms;
    }

    .modal-backdrop.is-open {
      opacity: 1;
      visibility: visible;
      transition: opacity 300ms ease, visibility 0ms 0ms;
    }

    .modal-content {
      background: var(--bg-surface);
      border-radius: var(--glass-radius-lg);
      padding: 20px 24px;
      max-width: 600px;
      width: 90%;
      position: relative;
      border: 1px solid var(--glass-border);
      box-shadow: 0 40px 80px rgba(0, 0, 0, 0.9);
      transform: scale(0.9);
      transition: transform 300ms cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    .modal-backdrop.is-open .modal-content {
      transform: scale(1);
    }

    .modal-header {
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text-stronger);
    }

    .modal-body {
      font-size: 12px;
      color: var(--text-soft);
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 14px;
      border: none;
      background: transparent;
      color: var(--text-soft);
      font-size: 20px;
      cursor: pointer;
    }

    .detail-list {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 4px 12px;
    }

    .detail-list dt {
      font-weight: 600;
      color: var(--text-strong);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 11px;
    }

    .detail-list dd {
      margin: 0;
      color: var(--text-soft);
      font-weight: 500;
      font-size: 12px;
    }

    .detail-list dd a {
      color: var(--accent-blue);
      text-decoration: none;
      font-weight: 600;
    }

    .detail-list dd a:hover {
      text-decoration: underline;
    }


    /* ===== ANIMATIONS ===== */
    @keyframes fade-slide-up {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% {
        opacity: 0.55;
        transform: scale(1);
      }
      50% {
        opacity: 0;
        transform: scale(1.4);
      }
      100% {
        opacity: 0.55;
        transform: scale(1);
      }
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr); /* Stack map and charts vertically */
      }
      #map {
        height: 380px;
      }
    }

    @media (max-width: 768px) {
      .shell {
        padding: 8px;
      }
      header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
        padding: 10px 14px;
      }
      .header-left, .header-right {
        gap: 6px;
      }
      .header-center {
        order: -1;
      }
      .header-title {
        font-size: 20px;
      }
      .kpi-row {
        grid-template-columns: 1fr 1fr;
      }
      .filters-grid {
        grid-template-columns: 1fr;
      }
      .map-legend {
        flex-direction: column;
        gap: 4px;
      }
    }

    @media (max-width: 480px) {
      .kpi-row {
        grid-template-columns: 1fr;
      }
      .table-header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .table-export-buttons {
        margin-top: 8px;
        width: 100%;
        justify-content: space-between;
      }
    }

    </style>
  </head>
<body data-theme="dark">

    <div class="page">
        <div class="shell">
            <header>
                <div class="header-left">
                    <img
                        src="https://via.placeholder.com/100x52.png?text=LOGO+1"
                        alt="Logo 1"
                        class="header-logo"
                    />
                    <div class="top-nav-links">
                        <a href="ITS.html">ITS</a>
                        <a href="TRAFFIC.html">Traffic</a>
                        <a href="Structures.html" class="is-active">Structures</a>
                    </div>
                </div>

                <div class="header-center">
                    <h1 class="header-title">QATAR NORTH INFRASTRUCTURE</h1>
                    <div class="header-subtitle">STRUCTURES SURVEY DASHBOARD</div>
                    <div class="header-meta">
                        Last Updated: <span id="currentDateTime">--</span>
                        <span class="header-meta-separator">|</span>
                        Total Structures: <span id="total-structures-count">0</span>
                    </div>
                </div>

                <div class="header-right">
                    <button class="theme-toggle" id="themeToggle" type="button">
                        <span class="icon">üí°</span>
                        <span id="themeText">LIGHT MODE</span>
                    </button>
                    <img
                        src="https://via.placeholder.com/80x42.png?text=LOGO+2"
                        alt="Logo 2"
                        class="header-logo-small"
                    />
                </div>
            </header>

            <main class="dashboard">

                <section class="section section-kpis">
                    <div class="kpi-row">
                        <div class="glass-card kpi-card kpi-primary">
                            <div class="kpi-label">Total Structures in Scope</div>
                            <div class="kpi-value" id="total-structures-count-kpi">0</div>
                            <div class="kpi-circle-layout kpi-circle-compact">
                                <div class="circle-wrapper">
                                    <div id="circle-survey-fill" class="circle-fill"></div>
                                    <div id="circle-survey-inner" class="circle-inner">0 / 0</div>
                                </div>
                                <div class="kpi-circle-text">
                                    <div class="circle-caption">
                                        <strong id="circle-survey-pct">0%</strong> of structures surveyed
                                    </div>
                                    <div class="kpi-caption" id="survey-completion-text">--</div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card kpi-card">
                            <div class="kpi-label">Survey Completion Rate</div>
                            <div class="kpi-value" id="survey-completion-percent">--</div>
                            <div class="kpi-subtext"> Overall completion rate for all structures in the current filter. </div>
                        </div>

                        <div class="glass-card kpi-card">
                            <div class="kpi-label">Structures Completed</div>
                            <div class="kpi-value" id="structures-completed-count">0</div>
                            <div class="kpi-subtext">Structures with survey status ‚ÄúCompleted‚Äù.</div>
                        </div>

                        <div class="glass-card kpi-card">
                            <div class="kpi-label">Structures Pending</div>
                            <div class="kpi-value" id="structures-pending-count">0</div>
                            <div class="kpi-subtext">Structures with survey status ‚ÄúPending‚Äù.</div>
                        </div>

                        <div class="glass-card kpi-card">
                            <div class="kpi-label">MEP Assets</div>
                            <div class="kpi-circle-layout kpi-circle-compact">
                                <div class="circle-wrapper">
                                    <div id="circle-mep-fill" class="circle-fill"></div>
                                    <div id="circle-mep-inner" class="circle-inner">0 / 0</div>
                                </div>
                                <div class="kpi-circle-text">
                                    <div class="circle-caption">
                                        <strong id="circle-mep-pct">0%</strong> MEP surveyed
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card kpi-card">
                            <div class="kpi-label">Lighting Assets</div>
                            <div class="kpi-circle-layout kpi-circle-compact">
                                <div class="circle-wrapper">
                                    <div id="circle-lights-fill" class="circle-fill"></div>
                                    <div id="circle-lights-inner" class="circle-inner">0 / 0</div>
                                </div>
                                <div class="kpi-circle-text">
                                    <div class="circle-caption">
                                        <strong id="circle-lights-pct">0%</strong> Lights surveyed
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card kpi-card">
                            <div class="kpi-label">UPS Assets</div>
                            <div class="kpi-circle-layout kpi-circle-compact">
                                <div class="circle-wrapper">
                                    <div id="circle-ups-fill" class="circle-fill"></div>
                                    <div id="circle-ups-inner" class="circle-inner">0 / 0</div>
                                </div>
                                <div class="kpi-circle-text">
                                    <div class="circle-caption">
                                        <strong id="circle-ups-pct">0%</strong> UPS surveyed
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card kpi-card">
                            <div class="kpi-label">Electrical DB Assets</div>
                            <div class="kpi-circle-layout kpi-circle-compact">
                                <div class="circle-wrapper">
                                    <div id="circle-electricalDb-fill" class="circle-fill"></div>
                                    <div id="circle-electricalDb-inner" class="circle-inner">0 / 0</div>
                                </div>
                                <div class="kpi-circle-text">
                                    <div class="circle-caption">
                                        <strong id="circle-electricalDb-pct">0%</strong> Electrical DB surveyed
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card kpi-card">
                            <div class="kpi-label">FF / FA Assets</div>
                            <div class="kpi-circle-layout kpi-circle-compact">
                                <div class="circle-wrapper">
                                    <div id="circle-ff-fill" class="circle-fill"></div>
                                    <div id="circle-ff-inner" class="circle-inner">0 / 0</div>
                                </div>
                                <div class="kpi-circle-text">
                                    <div class="circle-caption">
                                        <strong id="circle-ff-pct">0%</strong> FF/FA surveyed
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </section>

                <section class="section section-filters">
                    <div class="glass-card filters-card">
                        <div class="card-header-row">
                            <p class="card-title">Filter Structures</p>
                        </div>
                        <div class="filters-grid">
                            <div class="filters">
                                <label for="zoneFilter">Zone</label>
                                <select id="zoneFilter">
                                    <option value="All">All Zones</option>
                                </select>
                            </div>

                            <div class="filters">
                                <label for="siteTypeFilter">Site Type</label>
                                <select id="siteTypeFilter">
                                    <option value="All">All Site Types</option>
                                </select>
                            </div>

                            <div class="filters">
                                <label for="surveyStatusFilter">Survey Status</label>
                                <select id="surveyStatusFilter">
                                    <option value="All">All Statuses</option>
                                </select>
                            </div>

                            <div class="filters">
                                <label for="structureSearch">Search by Site / Reference / Name</label>
                                <input type="search" id="structureSearch" placeholder="Enter keyword..." />
                            </div>
                        </div>
                        <div class="filter-tags-row" id="activeFiltersContainer">
                            <div class="filter-chip">No active filters.</div>
                        </div>
                    </div>
                </section>

                <section class="section section-main">
                    <div class="main-grid">
                        <div class="glass-card map-card">
                            <div class="map-card-header">
                                <div class="map-title">
                                    <span class="dot"></span> <span>Structures Map (Satellite Imagery)</span>
                                </div>
                                <button id="mapModeToggle" class="map-toggle-btn map-toggle-btn-active" type="button" > Map Mode: Selected Structure Only </button>
                            </div>
                            <div id="map"></div>
                            <div class="map-footer" id="map-footer">
                                <p>ESRI World Imagery showing surveyed (green) and pending (amber) structures.</p>
                                <div class="map-legend">
                                    <div class="legend-item">
                                        <span class="legend-dot legend-surveyed"></span> <span>Completed</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-dot legend-pending"></span> <span>Pending / In-Progress</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-dot legend-selected"></span> <span>Selected from table</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="charts-stack">
                            <div class="glass-card chart-card site-type-card">
                                <div class="card-header-row">
                                    <p class="card-title">Type of Site Distribution</p>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="siteTypeChart"></canvas>
                                </div>
                                <div class="card-sub"> Distribution of structures by 'Type of Site' for the current filter. </div>
                            </div>

                            <div class="glass-card chart-card zone-completion-card">
                                <div class="card-header-row">
                                    <p class="card-title">Zone-wise Survey Completion (%)</p>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="zoneCompletionChart"></canvas>
                                </div>
                                <div class="card-sub"> Completion percentage for each Zone in the current filter. </div>
                            </div>

                            <div class="glass-card insights-card">
                                <div class="card-header-row">
                                    <p class="card-title">Insights: Lowest Completion</p>
                                </div>
                                <div class="insights-content" id="insightsContent">
                                    Loading insights...
                                </div>
                            </div>

                        </div>
                    </div>
                </section>

                <section class="section section-table">
                    <div class="glass-card table-card">
                        <div class="table-header-row">
                            <div class="table-header-left">
                                <div class="table-header-title">Filtered Structures List</div>
                                <div class="table-header-sub">Showing <span id="filtered-count">0</span> of <span id="total-count">0</span> Structures</div>
                            </div>
                            <div class="table-export-buttons">
                                <button id="downloadCsvBtn" class="export-btn" type="button"> CSV </button>
                                <button id="downloadExcelBtn" class="export-btn" type="button"> Excel (XLSX) </button>
                                <button id="downloadPdfBtn" class="export-btn" type="button"> PDF </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="structuresTable">
                                <thead>
                                    <tr id="tableHeaderRow">
                                        </tr>
                                </thead>
                                <tbody id="tableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <div id="detailModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">Structure Details</h3>
                <button class="modal-close" aria-label="Close modal">√ó</button>
            </div>
            <div id="modalBody" class="modal-body">
                </div>
        </div>
    </div>

    <script>
        // === CONFIG =========================================================
        const DATA_SOURCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSILhpftsWRLXkhsD_yvv_2oeNtFRYSsKq9PtNF4PKnZQLNYu6xjFEU4W5OuavcIx9gRN5UprrNdfT1/pub?gid=1074651700&single=true&output=csv";

        // Column names (from original Structures.html)
        const COLS = {
            sn: "Sr.No",
            site: "Site",
            siteReference: "Site Reference",
            siteName: "Site Name",
            projectCode: "Project Code",
            surveyStatus: "Survey Status",
            typeOfSite: "Type of Site",
            maximoId: "Maximo ID",
            zone: "Zone",
            lat: "Latitude",
            lon: "Longitude",
            remarks: "Remarks",
            mep: "MEP",
            lights: "Lights",
            ups: "UPS",
            electricalDb: "Electrical DB",
            ff: "FF",
            fa: "FA", // Includes FA for completeness, will combine with FF
            hvac: "HVAC",
            elevators: "Elevators",
            escalator: "Escalator",
            its: "ITS",
            elv: "ELV",
        };

        const SUBSYSTEM_KPIS = [
            { key: "mep", col: COLS.mep, label: "MEP", pctId: "circle-mep-pct", fillId: "circle-mep-fill", innerId: "circle-mep-inner" },
            { key: "lights", col: COLS.lights, label: "Lights", pctId: "circle-lights-pct", fillId: "circle-lights-fill", innerId: "circle-lights-inner" },
            { key: "ups", col: COLS.ups, label: "UPS", pctId: "circle-ups-pct", fillId: "circle-ups-fill", innerId: "circle-ups-inner" },
            { key: "electricalDb", col: COLS.electricalDb, label: "Electrical DB", pctId: "circle-electricalDb-pct", fillId: "circle-electricalDb-fill", innerId: "circle-electricalDb-inner" },
            // Combining FF/FA for a single KPI
            { key: "ff", col: COLS.ff, col2: COLS.fa, label: "FF / FA", pctId: "circle-ff-pct", fillId: "circle-ff-fill", innerId: "circle-ff-inner" },
            // Add more if needed, but keeping the list short for the template:
            // { key: "hvac", col: COLS.hvac, label: "HVAC" },
            // { key: "elevators", col: COLS.elevators, label: "Elevators" },
        ];

        const MAP_TILE_URL =
            "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}";
        const MAP_ATTRIBUTION =
            'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';

        let mapInstance = null;
        let mapMarkers = L.layerGroup();
        let allStructures = [];
        let currentFiltered = [];
        let mapModeSelectedOnly = true;
        let siteTypeChartInstance = null;
        let zoneCompletionChartInstance = null;
        let lastSelectedMarker = null;

        // === UTILS ==========================================================

        function normalizeStatus(rawStatus) {
            const s = (rawStatus || "").toString().trim().toLowerCase();
            if (s.includes("completed")) return "Completed";
            if (s.includes("pending")) return "Pending";
            if (s.includes("in progress")) return "In-Progress";
            return s || "Unknown";
        }

        function hasSubsystem(rawValue) {
            const val = (rawValue || "").toString().trim().toLowerCase();
            return val === "yes" || val === "1" || val === "true" || val === "y";
        }

        function formatPercent(value) {
            if (!isFinite(value) || value < 0) return "0.0%";
            return value.toFixed(1) + "%";
        }

        function updateCurrentDateTime() {
            const span = document.getElementById("currentDateTime");
            if (!span) return;
            const now = new Date();
            span.textContent = now.toLocaleString("en-US", {
                weekday: "short",
                year: "numeric",
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: true,
            });
        }

        // === DATA LOADING & PROCESSING ======================================

        function loadData() {
            Papa.parse(DATA_SOURCE_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    allStructures = results.data
                        .map((row) => {
                            // Ensure basic structure and required fields exist
                            if (!row[COLS.lat] || !row[COLS.lon]) return null;

                            const lat = parseFloat(row[COLS.lat]);
                            const lon = parseFloat(row[COLS.lon]);

                            if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) return null;

                            const status = normalizeStatus(row[COLS.surveyStatus]);
                            const hasCoords = isFinite(lat) && isFinite(lon);

                            const structure = {
                                sn: row[COLS.sn] || "",
                                site: row[COLS.site] || "",
                                siteReference: row[COLS.siteReference] || "",
                                siteName: row[COLS.siteName] || "",
                                projectCode: row[COLS.projectCode] || "",
                                surveyStatus: status,
                                typeOfSite: row[COLS.typeOfSite] || "Unknown Type",
                                maximoId: row[COLS.maximoId] || "",
                                zone: row[COLS.zone] || "Unknown Zone",
                                lat: lat,
                                lon: lon,
                                remarks: row[COLS.remarks] || "",
                                hasCoords: hasCoords,
                                // Subsystem flags
                                flags: {
                                    mep: hasSubsystem(row[COLS.mep]),
                                    lights: hasSubsystem(row[COLS.lights]),
                                    ups: hasSubsystem(row[COLS.ups]),
                                    electricalDb: hasSubsystem(row[COLS.electricalDb]),
                                    // Combine FF and FA
                                    ff: hasSubsystem(row[COLS.ff]) || hasSubsystem(row[COLS.fa]),
                                    hvac: hasSubsystem(row[COLS.hvac]),
                                    elevators: hasSubsystem(row[COLS.elevators]),
                                    escalator: hasSubsystem(row[COLS.escalator]),
                                    its: hasSubsystem(row[COLS.its]),
                                    elv: hasSubsystem(row[COLS.elv]),
                                },
                                raw: row, // Keep raw data for modal
                            };

                            // Calculate subsystem totals for KPI denominators (only if they are 'Yes' in the data)
                            structure.subsystemsInScope = {};
                            SUBSYSTEM_KPIS.forEach(s => {
                                // A subsystem is "in scope" if the column value is 'Yes' (indicating the structure has this asset)
                                // In the context of this dashboard, we are tracking the completion *of* the subsystem survey.
                                // For simplicity and based on the provided data structure, we'll assume the number of total rows is the denominator
                                // and the numerator is the number of rows where the asset is 'Yes' AND the survey status is 'Completed'.

                                // However, based on the original logic: the KPI is "X% of structures *with* Y surveyed".
                                // This means: Numerator = (Structure Status == 'Completed' AND Subsystem == 'Yes')
                                // Denominator = (Subsystem == 'Yes')
                                const isSubsystemPresent = s.key === 'ff'
                                    ? structure.flags.ff
                                    : structure.flags[s.key];
                                structure.subsystemsInScope[s.key] = isSubsystemPresent;
                            });

                            return structure;
                        })
                        .filter(Boolean);

                    initFilters();
                    applyFilters();
                    document.getElementById("total-structures-count").textContent = allStructures.length.toString();
                    document.getElementById("total-count").textContent = allStructures.length.toString();
                    document.getElementById("total-structures-count-kpi").textContent = allStructures.length.toString();
                },
                error: (error) => {
                    console.error("Error loading data:", error);
                    alert("Could not load data from Google Sheet. Please check the URL and network connection.");
                },
            });
        }

        // === FILTERS & SEARCH ===============================================

        function initFilters() {
            const zoneSelect = document.getElementById("zoneFilter");
            const typeSelect = document.getElementById("siteTypeFilter");
            const statusSelect = document.getElementById("surveyStatusFilter");

            const zones = Array.from(new Set(allStructures.map((a) => a.zone).filter((x) => x))).sort();
            const types = Array.from(new Set(allStructures.map((a) => a.typeOfSite).filter((x) => x))).sort();
            const statuses = Array.from(new Set(allStructures.map((a) => a.surveyStatus).filter((x) => x))).sort((a,b) => {
                if(a === "Completed") return -1;
                if(b === "Completed") return 1;
                return a.localeCompare(b);
            });

            function populateSelect(el, values) {
                el.innerHTML = '<option value="All">All</option>';
                values.forEach((v) => {
                    const opt = document.createElement("option");
                    opt.value = v;
                    opt.textContent = v;
                    el.appendChild(opt);
                });
            }

            populateSelect(zoneSelect, zones);
            populateSelect(typeSelect, types);
            populateSelect(statusSelect, statuses);
        }

        function applyFilters() {
            const zoneFilter = document.getElementById("zoneFilter").value;
            const typeFilter = document.getElementById("siteTypeFilter").value;
            const statusFilter = document.getElementById("surveyStatusFilter").value;
            const searchTerm = document.getElementById("structureSearch").value.toLowerCase();

            const filtered = allStructures.filter((s) => {
                const zoneMatch = zoneFilter === "All" || s.zone === zoneFilter;
                const typeMatch = typeFilter === "All" || s.typeOfSite === typeFilter;
                const statusMatch = statusFilter === "All" || s.surveyStatus === statusFilter;
                const searchMatch = searchTerm === "" ||
                    s.site.toLowerCase().includes(searchTerm) ||
                    s.siteReference.toLowerCase().includes(searchTerm) ||
                    s.siteName.toLowerCase().includes(searchTerm);

                return zoneMatch && typeMatch && statusMatch && searchMatch;
            });

            currentFiltered = filtered;
            updateKPIs(filtered);
            addMarkers(filtered);
            renderTable(filtered);
            updateStructureCharts(filtered);
            updateFilterTags();
        }

        function updateFilterTags() {
            const container = document.getElementById("activeFiltersContainer");
            const zoneFilter = document.getElementById("zoneFilter").value;
            const typeFilter = document.getElementById("siteTypeFilter").value;
            const statusFilter = document.getElementById("surveyStatusFilter").value;
            const searchTerm = document.getElementById("structureSearch").value;
            const activeFilters = [];

            if (zoneFilter !== "All") activeFilters.push(`Zone: <strong>${zoneFilter}</strong>`);
            if (typeFilter !== "All") activeFilters.push(`Site Type: <strong>${typeFilter}</strong>`);
            if (statusFilter !== "All") activeFilters.push(`Status: <strong>${statusFilter}</strong>`);
            if (searchTerm !== "") activeFilters.push(`Search: <strong>"${searchTerm}"</strong>`);

            container.innerHTML = "";
            if (activeFilters.length === 0) {
                const chip = document.createElement("div");
                chip.className = "filter-chip";
                chip.textContent = "No active filters.";
                container.appendChild(chip);
            } else {
                activeFilters.forEach((text) => {
                    const chip = document.createElement("div");
                    chip.className = "filter-chip";
                    chip.innerHTML = text;
                    container.appendChild(chip);
                });
            }
        }

        // === SUMMARY CARDS & CIRCLES ========================================

        function subsystemStats(assets, subsystemKey) {
            const structuresInScope = assets.filter((a) => a.subsystemsInScope[subsystemKey]);
            const total = structuresInScope.length;
            const completed = structuresInScope.filter((a) => a.surveyStatus === "Completed").length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            return { total, completed, percent };
        }

        function updateCircularKpi({ fillId, innerId, pctId, numerator, denominator, pct }) {
            const fillEl = document.getElementById(fillId);
            const innerEl = document.getElementById(innerId);
            const pctEl = document.getElementById(pctId);
            const safeNum = Number.isFinite(numerator) ? numerator : 0;
            const safeDen = Number.isFinite(denominator) ? denominator : 0;
            const safePct = Number.isFinite(pct) && pct >= 0 ? Math.max(0, Math.min(100, pct)) : 0;

            if (fillEl) {
                fillEl.style.background = `conic-gradient(
                    var(--accent-green) ${safePct}%,
                    var(--text-subtle) ${safePct}%
                )`;
            }
            if (innerEl) {
                innerEl.textContent = `${safeNum} / ${safeDen}`;
            }
            if (pctEl) {
                pctEl.textContent = formatPercent(safePct);
                pctEl.style.color = safePct >= 80 ? 'var(--accent-green)' : safePct >= 40 ? 'var(--accent-amber)' : 'var(--accent-red)';
            }
        }

        function updateKPIs(assets) {
            const total = assets.length;
            const completed = assets.filter((a) => a.surveyStatus === "Completed").length;
            const pending = assets.filter((a) => a.surveyStatus === "Pending").length;
            const pctSurvey = total > 0 ? (completed / total) * 100 : 0;

            // Update main counts
            document.getElementById("filtered-count").textContent = total.toString();
            document.getElementById("structures-completed-count").textContent = completed.toString();
            document.getElementById("structures-pending-count").textContent = pending.toString();
            document.getElementById("survey-completion-percent").textContent = formatPercent(pctSurvey);
            document.getElementById("survey-completion-percent").style.color = pctSurvey >= 80 ? 'var(--accent-green)' : pctSurvey >= 40 ? 'var(--accent-amber)' : 'var(--accent-red)';


            // Update main survey completion circle
            updateCircularKpi({
                fillId: "circle-survey-fill",
                innerId: "circle-survey-inner",
                pctId: "circle-survey-pct",
                numerator: completed,
                denominator: total,
                pct: pctSurvey,
            });

            // Update subsystem circles
            SUBSYSTEM_KPIS.forEach(s => {
                const stats = subsystemStats(assets, s.key);
                updateCircularKpi({
                    fillId: s.fillId,
                    innerId: s.innerId,
                    pctId: s.pctId,
                    numerator: stats.completed,
                    denominator: stats.total,
                    pct: stats.percent,
                });
            });
        }

        // === MAP ============================================================

        function initMap() {
            if (mapInstance) return;

            mapInstance = L.map("map", {
                zoomControl: true,
            }).setView([25.32, 51.27], 10); // Center on Qatar North

            L.tileLayer(MAP_TILE_URL, {
                attribution: MAP_ATTRIBUTION,
                maxZoom: 18,
            }).addTo(mapInstance);

            mapMarkers.addTo(mapInstance);

            document.getElementById("mapModeToggle").addEventListener("click", toggleMapMode);
        }

        function getMarkerIcon(status, isSelected) {
            let color = status === "Completed" ? "green" : status === "Pending" ? "orange" : "blue";
            if (isSelected) color = "cyan"; // Custom color for selection

            return L.circleMarker([0, 0], {
                radius: isSelected ? 8 : 6,
                fillColor: color,
                color: isSelected ? "#020617" : "#000",
                weight: isSelected ? 3 : 1,
                opacity: 1,
                fillOpacity: isSelected ? 1 : 0.75,
            });
        }

        function buildMarkerPopupHtml(structure) {
            const hasCoords = structure.hasCoords;
            const lat = structure.lat;
            const lon = structure.lon;
            const navLink = hasCoords ? `<br/><br/> <a href="http://googleusercontent.com/maps/search/?api=1&query=${encodeURIComponent(lat)},${encodeURIComponent(lon)}" target="_blank" style=" display:inline-block; padding:6px 12px; background:#38bdf8; color:#020617; border-radius:999px; font-weight:600; text-decoration:none; box-shadow:0 10px 20px rgba(56,189,248,0.35); "> üöó Navigate to Site </a>` : '';

            let html = `
                <div style="font-family: sans-serif; font-size: 13px; max-width: 250px;">
                    <h4 style="margin: 0 0 6px 0; font-size: 14px; color: #38bdf8;">${structure.siteName || structure.site}</h4>
                    <p style="margin: 0 0 4px 0;"><strong>Status:</strong> <span style="font-weight: 700; color: ${structure.surveyStatus === 'Completed' ? '#22c55e' : '#fbbf24'};">${structure.surveyStatus}</span></p>
                    <p style="margin: 0 0 4px 0;"><strong>Site Ref:</strong> ${structure.siteReference}</p>
                    <p style="margin: 0 0 4px 0;"><strong>Type:</strong> ${structure.typeOfSite}</p>
                    <p style="margin: 0 0 4px 0;"><strong>Zone:</strong> ${structure.zone}</p>
                    ${navLink}
                </div>
            `;
            return html;
        }

        function flyToAsset(structure) {
            if (lastSelectedMarker) {
                lastSelectedMarker.setStyle(getMarkerIcon(lastSelectedMarker.options.status, false).options);
            }

            // Find the marker that matches the asset
            mapMarkers.eachLayer(function (layer) {
                if (layer.options.siteReference === structure.siteReference) {
                    layer.setStyle(getMarkerIcon(structure.surveyStatus, true).options);
                    lastSelectedMarker = layer;
                    mapInstance.flyTo(layer.getLatLng(), 15);
                    layer.openPopup();
                }
            });
        }

        function addMarkers(assets) {
            mapMarkers.clearLayers();
            const bounds = [];

            assets.forEach((s) => {
                if (!s.hasCoords) return;

                const marker = L.circleMarker([s.lat, s.lon], getMarkerIcon(s.surveyStatus, false).options);

                // Attach metadata to the marker for easy lookup/selection
                marker.options.siteReference = s.siteReference;
                marker.options.status = s.surveyStatus;

                marker.bindPopup(buildMarkerPopupHtml(s));

                marker.on('click', () => {
                    if (lastSelectedMarker) {
                        // Reset the style of the previously selected marker
                        lastSelectedMarker.setStyle(getMarkerIcon(lastSelectedMarker.options.status, false).options);
                    }
                    // Apply selected style to the current marker
                    marker.setStyle(getMarkerIcon(s.surveyStatus, true).options);
                    lastSelectedMarker = marker;
                });

                mapMarkers.addLayer(marker);
                bounds.push([s.lat, s.lon]);
            });

            if (bounds.length > 0) {
                mapInstance.fitBounds(bounds, { padding: [20, 20], maxZoom: 14 });
            } else {
                mapInstance.setView([25.32, 51.27], 10);
            }
            lastSelectedMarker = null; // Reset selection after re-render
        }

        function toggleMapMode() {
            const btn = document.getElementById("mapModeToggle");

            if (mapModeSelectedOnly) {
                mapModeSelectedOnly = false;
                btn.textContent = "Map Mode: All Filtered Markers";
                btn.classList.remove("map-toggle-btn-active");
                // Re-add markers to fit all filtered on map
                addMarkers(currentFiltered);
            } else {
                mapModeSelectedOnly = true;
                btn.textContent = "Map Mode: Selected Structure Only";
                btn.classList.add("map-toggle-btn-active");
                // Reset to show only one asset if one is selected, or fit all otherwise
                if (lastSelectedMarker) {
                    mapMarkers.clearLayers();
                    mapMarkers.addLayer(lastSelectedMarker);
                    mapInstance.flyTo(lastSelectedMarker.getLatLng(), 15);
                } else {
                    addMarkers(currentFiltered);
                }
            }
        }

        // === TABLE ===========================================================

        function buildTableHeader() {
            const headerRow = document.getElementById("tableHeaderRow");
            const headers = [
                { key: "sn", label: COLS.sn },
                { key: "siteReference", label: COLS.siteReference },
                { key: "siteName", label: COLS.siteName },
                { key: "zone", label: COLS.zone },
                { key: "typeOfSite", label: COLS.typeOfSite },
                { key: "surveyStatus", label: COLS.surveyStatus },
                { key: "mep", label: COLS.mep },
                { key: "lights", label: COLS.lights },
                { key: "ups", label: COLS.ups },
                { key: "remarks", label: COLS.remarks },
                { key: "maximoId", label: COLS.maximoId },
            ];
            headerRow.innerHTML = headers.map((h) => `<th>${h.label}</th>`).join("");
            return headers;
        }

        function renderTable(assets) {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            const headers = buildTableHeader(); // Re-fetch for column keys

            assets.forEach((structure, index) => {
                const tr = document.createElement("tr");

                headers.forEach((h) => {
                    const td = document.createElement("td");
                    let displayValue = structure[h.key] || structure.flags[h.key];

                    if (typeof displayValue === 'boolean') {
                        displayValue = displayValue ? 'Yes' : 'No';
                    }

                    if (h.key === "surveyStatus") {
                        td.className = `status-${structure.surveyStatus.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
                    }

                    if (h.key === "mep" || h.key === "lights" || h.key === "ups") {
                        displayValue = structure.flags[h.key] ? 'Yes' : 'No';
                        td.style.color = structure.flags[h.key] ? 'var(--accent-green)' : 'var(--text-subtle)';
                    }

                    td.textContent = displayValue;
                    td.title = displayValue; // Show full content on hover
                    tr.appendChild(td);
                });

                // clicking a row moves map to that asset and opens modal
                tr.addEventListener("click", () => {
                    if (structure.hasCoords) {
                        flyToAsset(structure);
                    }
                    openDetailModal(structure.raw); // Open the modal with the full raw data
                });

                tbody.appendChild(tr);
            });
        }

        // === CHARTS & INSIGHTS ===============================================

        function updateStructureCharts(assets) {
            // Chart 1: Site Type Distribution (Donut Chart)
            const typeCounts = {};
            assets.forEach((a) => {
                const type = a.typeOfSite || "Unknown";
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            buildSiteTypeChart(typeCounts);

            // Chart 2: Zone-wise Survey Completion (Bar Chart)
            const zoneCompletion = new Map();
            assets.forEach((s) => {
                const zone = s.zone || "Unknown Zone";
                const entry = zoneCompletion.get(zone) || { total: 0, completed: 0 };
                entry.total++;
                if (s.surveyStatus === "Completed") entry.completed++;
                zoneCompletion.set(zone, entry);
            });
            buildZoneCompletionChart(zoneCompletion);

            // Insights: Lowest Completion Zones
            updateInsights(zoneCompletion);
        }

        function buildSiteTypeChart(counts) {
            const ctxDonut = document.getElementById("siteTypeChart").getContext("2d");
            const labels = Object.keys(counts).sort();
            const data = labels.map(label => counts[label]);
            const backgroundColors = labels.map((_, i) => `hsl(${i * 45}, 70%, 50%)`); // Simple color generation

            if (siteTypeChartInstance) {
                siteTypeChartInstance.data.labels = labels;
                siteTypeChartInstance.data.datasets[0].data = data;
                siteTypeChartInstance.data.datasets[0].backgroundColor = backgroundColors;
                siteTypeChartInstance.update();
                return;
            }

            siteTypeChartInstance = new Chart(ctxDonut, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: 'var(--text-soft)' }
                        },
                        title: { display: false }
                    }
                }
            });
        }

        function buildZoneCompletionChart(zoneMap) {
            const ctxBar = document.getElementById("zoneCompletionChart").getContext("2d");

            const labels = Array.from(zoneMap.keys()).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            const values = labels.map((z) => {
                const { total, completed } = zoneMap.get(z);
                return total > 0 ? +(completed / total * 100).toFixed(1) : 0;
            });

            if (zoneCompletionChartInstance) {
                zoneCompletionChartInstance.data.labels = labels;
                zoneCompletionChartInstance.data.datasets[0].data = values;
                zoneCompletionChartInstance.update();
                return;
            }

            zoneCompletionChartInstance = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Completion %',
                        data: values,
                        backgroundColor: values.map(v => v >= 80 ? 'var(--accent-green)' : v >= 40 ? 'var(--accent-amber)' : 'var(--accent-red)'),
                        borderColor: 'transparent',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => context.dataset.label + ': ' + context.parsed.y + '%' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Completion Percentage', color: 'var(--text-soft)' },
                            ticks: { color: 'var(--text-soft)' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'var(--text-soft)' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateInsights(zoneMap) {
            const el = document.getElementById("insightsContent");
            const threshold = 60;
            const zonesArr = Array.from(zoneMap.entries()).map(([zone, { total, completed }]) => ({
                zone,
                total,
                completed,
                pct: total > 0 ? (completed / total) * 100 : 0
            }));

            // Sort by percentage completion (lowest first)
            zonesArr.sort((a, b) => a.pct - b.pct);

            const needing = zonesArr.filter((x) => x.pct < threshold);

            if (!needing.length) {
                el.textContent = "All Zones have survey completion ‚â• " + threshold + "%.";
                return;
            }

            const top5 = needing.slice(0, 5);
            el.innerHTML = "<strong>Lowest completion Zones (under " + threshold + "%):</strong><br/>";
            top5.forEach((z) => {
                const line = `Zone ${z.zone}: ${z.completed}/${z.total} (${z.pct.toFixed(1)}%)`;
                const div = document.createElement("div");
                div.textContent = line;
                el.appendChild(div);
            });
        }

        // === Modal ============================================================

        function setupModal() {
            const modalBackdrop = document.getElementById("detailModal");
            const modalBody = document.getElementById("modalBody");
            const modalCloseBtn = modalBackdrop ? modalBackdrop.querySelector(".modal-close") : null;

            function closeDetailModal() {
                if (!modalBackdrop) return;
                modalBackdrop.classList.remove("is-open");
                modalBackdrop.setAttribute("aria-hidden", "true");
            }

            window.openDetailModal = function(record) {
                if (!modalBackdrop || !modalBody) return;

                let html = "<dl class=\"detail-list\">";

                // Use the COLS mapping to display fields in a readable format
                for (const [key, label] of Object.entries(COLS)) {
                    const value = record[label] ?? "-";
                    let displayValue = value;

                    // Special handling for Lat/Lon to create a link
                    if (key === 'lat' || key === 'lon') {
                        // Skip raw lat/lon, they are handled with the map link
                        continue;
                    } else if (key === 'siteName' && record[COLS.lat] && record[COLS.lon]) {
                        const lat = record[COLS.lat];
                        const lon = record[COLS.lon];
                        displayValue += ` <a href="http://googleusercontent.com/maps/search/?api=1&query=${encodeURIComponent(lat)},${encodeURIComponent(lon)}" target="_blank">(View on Map)</a>`;
                    }

                    // Special handling for Yes/No fields
                    if (["mep", "lights", "ups", "electricalDb", "ff", "fa", "hvac", "elevators", "escalator", "its", "elv"].includes(key)) {
                        displayValue = hasSubsystem(value) ? `<span style="color: var(--accent-green); font-weight: 700;">Yes</span>` : `<span style="color: var(--text-subtle);">No</span>`;
                    }

                    if (key !== 'sn' && key !== 'lat' && key !== 'lon') { // Skip Serial No and raw coordinates
                        html += `<div><dt>${label}</dt><dd>${displayValue}</dd></div>`;
                    }
                }

                html += "</dl>";
                modalBody.innerHTML = html;
                modalBackdrop.classList.add("is-open");
                modalBackdrop.setAttribute("aria-hidden", "false");
                if (modalCloseBtn) modalCloseBtn.focus();
            };

            if (modalCloseBtn && modalBackdrop) {
                modalCloseBtn.addEventListener("click", closeDetailModal);
                modalBackdrop.addEventListener("click", (e) => {
                    if (e.target === modalBackdrop) closeDetailModal();
                });
                document.addEventListener("keydown", (e) => {
                    if (e.key === "Escape" && modalBackdrop.classList.contains("is-open")) {
                        closeDetailModal();
                    }
                });
            }
        }


        // === EXPORT LOGIC (Matching ITS.html/TRAFFIC.html implementation) ====

        function buildCurrentViewTableData() {
            const rows = currentFiltered.length > 0 ? currentFiltered : allStructures;
            if (!rows || !rows.length) return null;

            const tableHeaders = [
                COLS.sn, COLS.site, COLS.siteReference, COLS.siteName, COLS.projectCode,
                COLS.surveyStatus, COLS.typeOfSite, COLS.maximoId, COLS.zone,
                COLS.lat, COLS.lon, COLS.remarks, COLS.mep, COLS.lights, COLS.ups,
                COLS.electricalDb, COLS.ff, COLS.fa, COLS.hvac, COLS.elevators,
                COLS.escalator, COLS.its, COLS.elv
            ];

            const body = rows.map((s) => tableHeaders.map((col) => {
                // Get the value from the raw data for export simplicity
                return s.raw[col] ?? '';
            }));

            return { headers: tableHeaders, body: body };
        }

        function downloadCurrentViewCsv() {
            const data = buildCurrentViewTableData();
            if (!data) { alert("No data to export."); return; }

            const { headers, body } = data;
            const allRows = [headers, ...body];

            const csvContent = allRows
                .map((row) => row
                    .map((val) => {
                        const v = val == null ? "" : String(val);
                        // Escape double quotes by doubling them, and wrap in quotes if it contains separator, quote, or newline
                        if (/[",\n]/.test(v)) {
                            return `"${v.replace(/"/g, '""')}"`;
                        }
                        return v;
                    })
                    .join(",")
                )
                .join("\n");

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "Structures_Survey_Data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadCurrentViewExcel() {
            const data = buildCurrentViewTableData();
            if (!data) { alert("No data to export."); return; }

            const { headers, body } = data;
            const worksheet = XLSX.utils.aoa_to_sheet([headers, ...body]);

            // Add logos and header rows (matching ITS template)
            const title = "QATAR NORTH INFRASTRUCTURE STRUCTURES SURVEY DASHBOARD";
            const subtitle = "Filtered Data Export";
            const date = "Export Date: " + new Date().toLocaleString();

            const leftImgEl = document.querySelector("header .header-left img");
            const rightImgEl = document.querySelector("header .header-right img");
            const leftSrc = leftImgEl ? leftImgEl.src : null;
            const rightSrc = rightImgEl ? rightImgEl.src : null;

            // Utility to convert image URL to data URI (or null)
            const toDataURI = (url) => new Promise(resolve => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    canvas.getContext('2d').drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = () => resolve(null); // Resolve with null on error
                img.src = url;
            });

            // Convert logos to data URIs
            const [leftDataUri, rightDataUri] = await Promise.all([
                leftSrc ? toDataURI(leftSrc) : Promise.resolve(null),
                rightSrc ? toDataURI(rightSrc) : Promise.resolve(null),
            ]);

            const colCount = headers.length;
            const headerRows = [];

            // Row 1: images formulas
            const row1 = new Array(colCount).fill(null);
            if (leftDataUri) {
                row1[0] = { f: `IMAGE("${leftDataUri}")`, v: 'Logo 1', t: 's' };
            }
            if (rightDataUri) {
                row1[colCount - 1] = { f: `IMAGE("${rightDataUri}")`, v: 'Logo 2', t: 's' };
            }
            headerRows.push(row1);

            // Row 2: title
            const row2 = new Array(colCount).fill(null);
            row2[0] = { v: title, t: 's', s: { font: { sz: 18, bold: true }, alignment: { horizontal: "center" } } };
            headerRows.push(row2);

            // Row 3: subtitle
            const row3 = new Array(colCount).fill(null);
            row3[0] = { v: subtitle, t: 's', s: { font: { sz: 16 }, alignment: { horizontal: "center" } } };
            headerRows.push(row3);

            // Row 4: date
            const row4 = new Array(colCount).fill(null);
            row4[0] = { v: date, t: 's', s: { font: { sz: 8 }, alignment: { horizontal: "center" } } };
            headerRows.push(row4);

            // Row 5: spacer
            headerRows.push(new Array(colCount).fill(null));

            // Prepend header rows
            XLSX.utils.sheet_add_aoa(worksheet, headerRows, { origin: "A1" });

            // Merge cells for the title, subtitle, and date rows
            if (!worksheet['!merges']) worksheet['!merges'] = [];
            worksheet['!merges'].push(
                { s: { r: 1, c: 0 }, e: { r: 1, c: colCount - 1 } }, // Title
                { s: { r: 2, c: 0 }, e: { r: 2, c: colCount - 1 } }, // Subtitle
                { s: { r: 3, c: 0 }, e: { r: 3, c: colCount - 1 } }  // Date
            );

            // Set column widths (approximated for ITS dashboard)
            worksheet['!cols'] = [
                { wch: 6 }, // Sr.No
                { wch: 15 }, // Site
                { wch: 18 }, // Site Reference
                { wch: 25 }, // Site Name
                { wch: 12 }, // Project Code
                { wch: 15 }, // Survey Status
                { wch: 15 }, // Type of Site
                { wch: 15 }, // Maximo ID
                { wch: 12 }, // Zone
                { wch: 12 }, // Lat
                { wch: 12 }, // Lon
                { wch: 30 }, // Remarks
                { wch: 8 },  // MEP
                { wch: 8 },  // Lights
                { wch: 8 },  // UPS
                { wch: 12 }, // Electrical DB
                { wch: 8 },  // FF
                { wch: 8 },  // FA
                { wch: 8 },  // HVAC
                { wch: 8 },  // Elevators
                { wch: 8 },  // Escalator
                { wch: 8 },  // ITS
                { wch: 8 },  // ELV
            ].slice(0, colCount);


            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Structures Data");
            XLSX.writeFile(workbook, "Structures_Survey_Data.xlsx");
        }

        async function downloadCurrentViewPdf() {
            const { jsPDF } = window.jspdf;
            const data = buildCurrentViewTableData();
            if (!data) { alert("No data to export."); return; }

            const { headers, body } = data;
            const doc = new jsPDF({ orientation: "landscape" });

            const title = "QATAR NORTH INFRASTRUCTURE STRUCTURES SURVEY DASHBOARD";
            const subtitle = "Filtered Data Export";
            const date = new Date().toLocaleString();
            const pageWidth = doc.internal.pageSize.getWidth();
            const marginX = 10;
            const logoHeight = 12;

            const leftImgEl = document.querySelector("header .header-left img");
            const rightImgEl = document.querySelector("header .header-right img");

            // Utility to convert image URL to data URI (or null)
            const toDataURI = (url) => new Promise(resolve => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    canvas.getContext('2d').drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = () => resolve(null); // Resolve with null on error
                img.src = url;
            });

            // Handle images
            if (leftImgEl) {
                const leftDataUri = await toDataURI(leftImgEl.src);
                if (leftDataUri) {
                    const ratio = (leftImgEl.naturalWidth || 150) / (leftImgEl.naturalHeight || 50);
                    const w = logoHeight * ratio;
                    doc.addImage(leftDataUri, "PNG", marginX, 10, w, logoHeight);
                }
            }

            if (rightImgEl) {
                const rightDataUri = await toDataURI(rightImgEl.src);
                if (rightDataUri) {
                    const ratio = (rightImgEl.naturalWidth || 150) / (rightImgEl.naturalHeight || 50);
                    const w = logoHeight * ratio;
                    doc.addImage(rightDataUri, "PNG", pageWidth - marginX - w, 10, w, logoHeight);
                }
            }

            // Title
            doc.setFontSize(18);
            doc.text(title, pageWidth / 2, 20, { align: "center" });

            // Subtitle
            doc.setFontSize(14);
            doc.text(subtitle, pageWidth / 2, 26, { align: "center" });

            // Date
            doc.setFontSize(8);
            doc.text(date, pageWidth / 2, 32, { align: "center" });

            doc.autoTable({
                head: [headers],
                body: body,
                startY: 38,
                margin: { top: 10, left: marginX, right: marginX },
                styles: { fontSize: 6, cellPadding: 1.2 },
                headStyles: { fillColor: [15, 23, 42] },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text("Page " + data.pageNumber + " of " + pageCount, pageWidth / 2, doc.internal.pageSize.getHeight() - 5, { align: "center" });
                }
            });

            doc.save("Structures_Survey_Data.pdf");
        }


        // === INITIALIZATION =================================================

        document.addEventListener("DOMContentLoaded", () => {
            // Theme setup (default to dark, but check system preference)
            const themeToggle = document.getElementById("themeToggle");
            const themeText = document.getElementById("themeText");
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            let currentTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');

            document.body.setAttribute('data-theme', currentTheme);
            themeText.textContent = currentTheme === 'dark' ? 'LIGHT MODE' : 'DARK MODE';

            themeToggle.addEventListener('click', () => {
                currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', currentTheme);
                localStorage.setItem('theme', currentTheme);
                themeText.textContent = currentTheme === 'dark' ? 'LIGHT MODE' : 'DARK MODE';
                // Trigger chart and map re-render to pick up new CSS variables
                if(siteTypeChartInstance) siteTypeChartInstance.destroy();
                if(zoneCompletionChartInstance) zoneCompletionChartInstance.destroy();
                updateStructureCharts(currentFiltered);
                // Re-render map markers to update colors/styles
                addMarkers(currentFiltered);
            });


            initMap();
            buildTableHeader();
            loadData();
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 30 * 1000);

            // Filter event listeners
            document.getElementById("zoneFilter").addEventListener("change", applyFilters);
            document.getElementById("siteTypeFilter").addEventListener("change", applyFilters);
            document.getElementById("surveyStatusFilter").addEventListener("change", applyFilters);
            document.getElementById("structureSearch").addEventListener("input", applyFilters);

            // Export buttons
            document.getElementById("downloadCsvBtn").addEventListener("click", downloadCurrentViewCsv);
            document.getElementById("downloadExcelBtn").addEventListener("click", downloadCurrentViewExcel);
            document.getElementById("downloadPdfBtn").addEventListener("click", downloadCurrentViewPdf);

            // Map Mode Toggle
            document.getElementById("mapModeToggle").addEventListener("click", toggleMapMode);

            setupModal();
        });
    </script>
</body>
</html>