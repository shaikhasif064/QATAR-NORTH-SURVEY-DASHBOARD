<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qatar North Structures Survey Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
    /* Cloned CSS from TRAFFIC.html/ITS.html */
    :root {
      --aktor-blue: #0b1120;
      --aktor-red: #e0283b;
      --algo-blue: #38bdf8;

      --bg-surface: rgba(15, 23, 42, 0.88);

      --glass-bg: rgba(15, 23, 42, 0.72);
      --glass-border: rgba(148, 163, 184, 0.45);
      --glass-shadow-soft: 0 22px 45px rgba(15, 23, 42, 0.65);
      --glass-radius-lg: 18px;
      --glass-radius-md: 14px;

      --text-soft: #9ca3af;
      --text-subtle: #6b7280;
      --text-strong: #e5e7eb;
      --text-stronger: #f9fafb;

      --accent-green: #22c55e;
      --accent-amber: #fbbf24;
      --accent-blue: #38bdf8;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
      --accent-pink: #ec4899;
      --accent-orange: #f97316;

      --transition-fast: 200ms cubic-bezier(0.22, 0.61, 0.36, 1);
      --transition-med: 320ms cubic-bezier(0.22, 0.61, 0.36, 1);
    }


    /* ===== THEME: AUTO DARK/LIGHT BASED ON SYSTEM PREFERENCE (Dark is default) ===== */
    body[data-theme="light"] {
      --bg-surface: rgba(255, 255, 255, 0.92);
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(148, 163, 184, 0.55);
      --text-soft: #6b7280;
      --text-subtle: #9ca3af;
      --text-strong: #111827;
      --text-stronger: #020617;
      background: #f3f4f6;
      color: var(--text-stronger);
    }

    body[data-theme="light"] .page {
      background:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.08), transparent 55%),
        radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.09), transparent 55%),
        linear-gradient(135deg, #e5e7eb, #f9fafb);
    }

    body[data-theme="light"] header,
    body[data-theme="light"] .glass-card,
    body[data-theme="light"] .kpi-card {
      background:
        radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), transparent 55%),
        linear-gradient(145deg, #ffffff, #e5e7eb);
      border-color: rgba(148, 163, 184, 0.55);
      color: var(--text-stronger);
    }

    body[data-theme="light"] .kpi-badge,
    body[data-theme="light"] .filter-chip {
      background-color: rgba(15, 23, 42, 0.08);
      border-color: rgba(148, 163, 184, 0.8);
      color: var(--text-strong);
    }

    body[data-theme="light"] .filters-card,
    body[data-theme="light"] .table-card,
    body[data-theme="light"] .map-card,
    body[data-theme="light"] .chart-card {
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.16);
    }

    body[data-theme="light"] input,
    body[data-theme="light"] select {
      background-color: #ffffff;
      border-color: rgba(148, 163, 184, 0.9);
      color: var(--text-strong);
    }
     body[data-theme="light"] .filters select {
      background-color: #ffffff !important;
      background-image: radial-gradient(circle at top left, rgba(59, 130, 246, 0.12), transparent 60%), linear-gradient(135deg, #ffffff, #f9fafb) !important;
      color: var(--text-stronger) !important;
      border-color: rgba(148, 163, 184, 0.85);
    }

    body[data-theme="light"] .table-wrapper {
      background:
        radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), rgba(243, 244, 246, 0.98));
      border-color: rgba(148, 163, 184, 0.8);
    }

    body[data-theme="light"] th {
      background: linear-gradient(180deg, #e5e7eb, #d1d5db);
      color: #4b5563;
    }

    body[data-theme="light"] tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    body[data-theme="light"] tbody tr:nth-child(odd) {
      background: #f3f4f6;
    }

    body[data-theme="light"] tbody tr:hover {
      background:
        radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.12), transparent 55%),
        #ffffff;
    }


    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color: var(--text-strong);
      background-color: #020617;
      background-attachment: fixed;
      background-size: cover;
      -webkit-font-smoothing: antialiased;
    }

    .page {
      width: 100%;
      min-height: 100vh;
      margin: 0;
      padding-bottom: 24px;
      /* More colorful multi-layer background */
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.26), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(236, 72, 153, 0.22), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249, 115, 22, 0.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.22), transparent 60%),
        linear-gradient(180deg, #020617 0%, #020617 18%, #020617 100%);
    }

    .shell {
      max-width: 1880px;
      margin: 0 auto;
      padding: 12px 16px 24px;
    }

    /* ===== HEADER ===== */
    header {
      width: 100%;
      border-radius: 20px;
      margin-bottom: 14px;
      padding: 10px 20px;
      /* Slightly richer gradient in header */
      background:
        linear-gradient(135deg, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.92)),
        linear-gradient(90deg, rgba(56, 189, 248, 0.35), rgba(168, 85, 247, 0.35), rgba(236, 72, 153, 0.26));
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      position: relative;
      top: auto;
      z-index: auto;
    }

    .header-left,
    .header-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-center {
      flex: 1 1 auto;
      text-align: center;
    }

    .logo-img {
      max-height: 52px;
      height: auto;
      filter: drop-shadow(0 8px 20px rgba(15, 23, 42, 0.8));
    }

    .logo-img-small {
      max-height: 42px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(20px, 2vw, 26px);
      font-weight: 700;
      letter-spacing: 0.06em;
      color: var(--text-stronger);
      text-transform: uppercase;
    }

    header .subtitle {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .datetime-header {
      font-size: 11px;
      color: #c7d2fe;
      margin-top: 4px;
    }

    /* Top Nav Links (for TRAFFIC / ITS / STRUCTURES) */
    .top-nav-links {
      display: flex;
      gap: 8px;
      padding-top: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .top-nav-links a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 14px;
      border-radius: 999px;
      text-decoration: none;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-soft);
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.7);
      transition: color 200ms cubic-bezier(0.22, 0.61, 0.36, 1), background 200ms cubic-bezier(0.22, 0.61, 0.36, 1), transform 200ms cubic-bezier(0.22, 0.61, 0.36, 1);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .top-nav-links a.active {
      color: var(--text-stronger);
      border-color: rgba(56, 189, 248, 0.85);
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), transparent 60%),
        rgba(15, 23, 42, 0.95);
      font-weight: 700;
      box-shadow: 0 0 16px rgba(56, 189, 248, 0.35);
    }

    .top-nav-links a::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle at 0 0, rgba(56,189,248,0.15), transparent 55%);
      opacity: 0;
      transition: opacity 200ms cubic-bezier(0.22, 0.61, 0.36, 1);
      z-index: -1;
    }

    .top-nav-links a:hover, .top-nav-links a:focus-visible {
      color: var(--text-strong);
      border-color: rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }
     .top-nav-links a:hover::after {
        opacity: 1;
    }

    /* ===== LAYOUT: HIERARCHY ===== */
    main.dashboard {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
    }

    .section {
      display: block;
      animation: fade-slide-up 0.65s var(--transition-med);
    }

    .section-kpis {
      margin-top: 4px;
    }

    .section-kpis-inner {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .section-insights,
    .section-filters,
    .section-main,
    .section-table {
      margin-top: 2px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1fr);
      gap: 12px;
      align-items: stretch;
    }

    .charts-stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ===== GLASS CARD BASE ===== */
    .glass-card {
      position: relative;
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.16), transparent 40%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      border-radius: var(--glass-radius-lg);
      padding: 10px 14px;
      box-shadow: var(--glass-shadow-soft);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      overflow: hidden;
      transition:
        transform var(--transition-med),
        box-shadow var(--transition-med),
        border-color var(--transition-med),
        background var(--transition-med);
      isolation: isolate; /* Ensures pseudo-elements don't bleed */
    }

    .glass-card::before {
      content: "";
      position: absolute;
      inset: -20%;
      opacity: 0;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.16), transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.16), transparent 45%);
      transition: opacity var(--transition-med);
      pointer-events: none;
      z-index: -1;
    }

    .glass-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 26px 55px rgba(15, 23, 42, 0.95);
      border-color: rgba(248, 250, 252, 0.35);
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.22), transparent 40%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
    }

    .glass-card:hover::before {
      opacity: 1;
    }

    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* KPI Cards - Top Strip */
    .kpi-card {
      min-height: 100px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-stronger);
      line-height: 1;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .kpi-number span.unit {
      font-size: 11px;
      color: var(--text-soft);
      font-weight: 500;
    }

    .kpi-caption {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 2px;
    }

    .kpi-badge {
      font-size: 10px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background-color: rgba(248, 250, 252, 0.1);
      color: var(--text-strong);
      border: 1px solid rgba(148, 163, 184, 0.5);
      align-self: flex-start;
      margin-top: 6px;
    }

    .kpi-badge.bg-green {
      background-color: rgba(34, 197, 94, 0.15);
      color: var(--accent-green);
      border-color: rgba(34, 197, 94, 0.5);
    }

    .kpi-badge.bg-amber {
      background-color: rgba(251, 191, 36, 0.15);
      color: var(--accent-amber);
      border-color: rgba(251, 191, 36, 0.5);
    }

    .kpi-badge.bg-red {
      background-color: rgba(239, 68, 68, 0.15);
      color: var(--accent-red);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .kpi-badge.bg-blue {
      background-color: rgba(56, 189, 248, 0.15);
      color: var(--accent-blue);
      border-color: rgba(56, 189, 248, 0.5);
    }

    /* Circle KPI cards - compact style for the lower strip */
    .kpi-circle-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }
    .kpi-circle-card {
      min-height: 120px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .kpi-circle-layout {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-top: 2px;
    }

    .circle-wrapper {
      width: 92px;
      height: 92px;
      position: relative;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 10%, #f9fafb, #374151);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 12px 34px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    .circle-inner {
      width: 60px;
      height: 60px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-stronger);
      border-radius: 50%;
      background: var(--bg-surface);
      display: flex;
      align-items: center;
      justify-content: center;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }

    .circle-fill {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      clip: rect(0, 92px, 92px, 46px);
    }

    .kpi-circle-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .kpi-circle-text-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      margin-bottom: 2px;
      line-height: 1.2;
    }

    .kpi-circle-text .circle-caption {
      font-size: 12px;
      color: var(--text-subtle);
      line-height: 1.4;
    }
    .kpi-circle-text .circle-caption strong {
      font-weight: 700;
      color: var(--text-stronger);
    }

    /* ===== CHARTS ===== */
    .chart-card {
      min-height: 380px;
      display: flex;
      flex-direction: column;
      padding: 14px;
    }

    .chart-wrapper {
      flex-grow: 1;
      min-height: 0; /* Important for flex children with canvas/charts */
      position: relative;
      margin-top: 10px;
    }

    /* ===== FILTERS ===== */
    .filters-card {
      padding: 14px;
    }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .filters-grid label {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-subtle);
      margin-bottom: 4px;
    }

    .filters input[type="text"],
    .filters select {
      width: 100%;
      padding: 8px 12px;
      border-radius: var(--glass-radius-md);
      font-size: 14px;
      color: var(--text-strong);
      background-color: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.55);
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
      appearance: none;
      -webkit-appearance: none;
      position: relative;
    }

    .filters select {
      background-image:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98)) !important;
      background-position: right 10px center;
      background-repeat: no-repeat;
      background-size: 10px;
      cursor: pointer;
    }

    .filters select:focus,
    .filters input:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8);
      transform: translateY(-1px);
    }

    .filters-tags {
      padding: 10px 0 0;
      border-top: 1px solid var(--glass-border);
      margin-top: 10px;
    }

    .filter-tag-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-subtle);
      margin-bottom: 4px;
      display: block;
    }

    .filter-chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .filter-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text-strong);
      background-color: rgba(248, 250, 252, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.5);
      line-height: 1;
      transition: background var(--transition-fast);
    }

    .filter-chip-clear {
      font-size: 10px;
      font-weight: 600;
      color: var(--accent-red);
      cursor: pointer;
      line-height: 1;
      margin-left: 4px;
    }

    /* ===== MAP ===== */
    .map-card {
      min-height: 480px;
      display: flex;
      flex-direction: column;
      padding: 14px;
    }

    .map-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .map-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .map-title .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
    }

    #map {
      width: 100%;
      flex-grow: 1;
      border-radius: var(--glass-radius-md);
      overflow: hidden;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.55);
      z-index: 0;
    }

    .map-footer {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 10px;
      padding-top: 6px;
      border-top: 1px solid var(--glass-border);
    }

    .map-toggle-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 5px 12px;
      font-size: 11px;
      background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), transparent 60%), linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      color: var(--text-soft);
      cursor: pointer;
      transition: transform var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .map-toggle-btn:hover {
      transform: translateY(-1px);
      background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.12), transparent 60%), linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.99));
      border-color: rgba(248, 250, 252, 0.5);
    }

    .map-toggle-btn-active {
      border-color: var(--accent-blue);
      color: var(--accent-blue);
    }

    /* Map Legend */
    .map-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-completed { background-color: var(--accent-green); }
    .legend-no-access { background-color: var(--accent-amber); }
    .legend-pending { background-color: var(--accent-red); }
    .legend-selected { background-color: var(--accent-blue); box-shadow: 0 0 10px var(--accent-blue); }

    /* Leaflet Popups */
    .leaflet-popup-content-wrapper {
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-strong);
        border-radius: var(--glass-radius-md);
        padding: 10px 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.65);
    }
    .leaflet-popup-content {
        margin: 0;
        font-size: 13px;
    }
    .leaflet-popup-tip {
        background: rgba(15, 23, 42, 0.9);
    }
    .leaflet-popup-close-button {
        color: var(--text-soft);
    }

    /* ===== TABLE SECTION ===== */
    .table-card {
      padding: 14px;
    }

    .table-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .table-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .table-header-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }

    .table-header-sub {
      font-size: 11px;
      color: var(--text-subtle);
    }

    .export-buttons {
      display: flex;
      gap: 8px;
    }

    .export-btn {
      padding: 6px 12px;
      border-radius: var(--glass-radius-md);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--glass-border);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.1), transparent 60%), linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      color: var(--text-strong);
      transition: transform var(--transition-fast), border-color var(--transition-fast);
    }

    .export-btn:hover {
      transform: translateY(-1px);
      border-color: var(--accent-blue);
    }

    .table-wrapper {
      max-height: 500px;
      overflow-y: auto;
      border-radius: var(--glass-radius-md);
      border: 1px solid var(--glass-border);
      margin-top: 10px;
      background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.08), rgba(15, 23, 42, 0.98));
    }

    .dashboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .dashboard-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 10px 14px;
      text-align: left;
      white-space: nowrap;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.95));
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-stronger);
      border-bottom: 1px solid var(--glass-border);
    }

    td {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      color: var(--text-strong);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 200px; /* Constrain max width for overflow ellipsis */
    }
    td.td-status {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    td.status-completed { color: var(--accent-green); }
    td.status-no-access { color: var(--accent-amber); }
    td.status-other { color: var(--accent-red); }

    tbody tr {
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.85);
    }

    tbody tr:hover {
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.12), transparent 55%),
        rgba(15, 23, 42, 0.95);
    }

    .row-selected {
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.25), transparent 55%),
        rgba(56, 189, 248, 0.15) !important;
      border-left: 4px solid var(--accent-blue);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(56, 189, 248, 0.3);
    }
    .row-selected td {
      color: var(--text-stronger);
    }


    /* Utility */
    .text-center { text-align: center; }
    .text-green { color: var(--accent-green); }
    .text-red { color: var(--accent-red); }
    .text-amber { color: var(--accent-amber); }
    .text-blue { color: var(--accent-blue); }

    /* ===== ANIMATIONS ===== */
    @keyframes fade-slide-up {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1200px) {
      .main-grid { grid-template-columns: minmax(0, 1fr); }
      #map { height: 380px; }
    }
    @media (max-width: 1024px) {
      .shell { padding: 10px 8px 20px; }
      header { padding: 8px 12px; }
      header h1 { font-size: 20px; }
      .logo-img { max-height: 40px; }
      .section-kpis-inner { grid-template-columns: repeat(2, 1fr); }
      .kpi-circle-strip { grid-template-columns: repeat(2, 1fr); }
      .kpi-card, .glass-card { padding: 12px; }
      .kpi-value { font-size: 24px; }
    }
    @media (max-width: 640px) {
      .filters-grid { grid-template-columns: 1fr; }
      .section-kpis-inner { grid-template-columns: 1fr; }
      .kpi-circle-strip { grid-template-columns: 1fr; }
      .header-left, .header-right { display: none; }
      header { justify-content: center; }
      .top-nav-links { padding-top: 4px; }
    }
</style>
</head>
<body>

<div class="page">
  <div class="shell">

    <header>
      <div class="header-left">
        <img src="https://via.placeholder.com/150x50?text=LOGO+1" alt="Logo 1" class="logo-img logo-img-small">
      </div>
      <div class="header-center">
        <h1>Qatar North Structures Survey Dashboard</h1>
        <p class="subtitle">Real-time asset visibility and survey status for structural assets</p>
        <div class="top-nav-links">
            <a href="TRAFFIC.html" target="_self">Traffic</a>
            <a href="ITS.html" target="_self">ITS</a>
            <a href="#" class="active">Structures</a>
        </div>
      </div>
      <div class="header-right">
        <img src="https://via.placeholder.com/150x50?text=LOGO+2" alt="Logo 2" class="logo-img logo-img-small">
        <span class="datetime-header" id="currentDateTime"></span>
      </div>
    </header>

    <main class="dashboard">

      <section class="section section-filters">
        <div class="glass-card filters-card filters">
          <div class="card-header-row">
            <p class="card-title">Data Filters & Search</p>
          </div>

          <div class="filters-grid">
            <div class="filter-group">
              <label for="zoneFilter">Zone</label>
              <select id="zoneFilter" onchange="applyFilters()"></select>
            </div>
            <div class="filter-group">
              <label for="routeFilter">Route (RTE)</label>
              <select id="routeFilter" onchange="applyFilters()"></select>
            </div>
            <div class="filter-group">
              <label for="typeFilter">Structure Type</label>
              <select id="typeFilter" onchange="applyFilters()"></select>
            </div>
            <div class="filter-group">
              <label for="statusFilter">Status</label>
              <select id="statusFilter" onchange="applyFilters()"></select>
            </div>
            <div class="filter-group">
              <label for="remarksCategoryFilter">Remarks Category</label>
              <select id="remarksCategoryFilter" onchange="applyFilters()">
                <option value="">All Remarks</option>
                <option value="Pending">Pending to visit</option>
                <option value="Visited">Visited / Surveyed</option>
                <option value="Under">Under Construction/QP/MME/Other</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="filter-group" style="grid-column: span 1 / auto;">
              <label for="freeTextSearch">Search (Ref, Name, Route, Remarks, Type)</label>
              <input type="text" id="freeTextSearch" oninput="applyFilters()" placeholder="Enter search keywords...">
            </div>
          </div>

          <div class="filters-tags">
            <div class="filter-tag-label">Active Filters:</div>
            <div class="filter-chips-container" id="filterTags">
              <span class="filter-chip text-blue" id="dataLoadedCount">Total 0 Structures</span>
            </div>
          </div>
        </div>
      </section>

      <section class="section section-kpis">
        <div class="section-kpis-inner">
          <div class="glass-card kpi-card">
            <div class="kpi-label">Total Structures</div>
            <div class="kpi-value" id="totalStructuresCount">
              -
            </div>
            <div class="kpi-caption">Total number of structures in the filtered list.</div>
          </div>

          <div class="glass-card kpi-card">
            <div class="kpi-label">Completed Structures</div>
            <div class="kpi-value text-green" id="completedStructuresCount">
              -
            </div>
            <div class="kpi-caption">Structures with survey STATUS "COMPLETED".</div>
            <span class="kpi-badge bg-green">Status: COMPLETED</span>
          </div>

          <div class="glass-card kpi-card">
            <div class="kpi-label">No Access</div>
            <div class="kpi-value text-amber" id="noAccessStructuresCount">
              -
            </div>
            <div class="kpi-caption">Structures with survey STATUS "NO ACCESS".</div>
            <span class="kpi-badge bg-amber">Status: NO ACCESS</span>
          </div>

          <div class="glass-card kpi-card">
            <div class="kpi-label">Pending Visit</div>
            <div class="kpi-value text-red" id="pendingStructuresCount">
              -
            </div>
            <div class="kpi-caption">Structures with "Pending to visit" in Remarks.</div>
            <span class="kpi-badge bg-red">Remarks: PENDING</span>
          </div>

          <div class="glass-card kpi-card">
            <div class="kpi-label">Bridges</div>
            <div class="kpi-value text-blue" id="bridgesCount">
              -
            </div>
            <div class="kpi-caption">Structures with Type containing "Bridge".</div>
          </div>

          <div class="glass-card kpi-card">
            <div class="kpi-label">Underpasses</div>
            <div class="kpi-value text-blue" id="underpassesCount">
              -
            </div>
            <div class="kpi-caption">Structures with Type containing "Underpass".</div>
          </div>
        </div>
      </section>

      <section class="section section-kpis-circles">
        <div class="kpi-circle-strip">

          <div class="glass-card kpi-circle-card">
            <div class="kpi-label">Footbridges</div>
            <div class="kpi-value" id="footbridgesCount">-</div>
            <div class="kpi-circle-layout">
              <div class="circle-wrapper">
                <div id="circle-footbridge-fill" class="circle-fill"></div>
                <div id="circle-footbridge-inner" class="circle-inner">0 / 0</div>
              </div>
              <div class="kpi-circle-text">
                <div class="kpi-circle-text-title">Footbridge Completion</div>
                <div class="circle-caption">
                  <strong id="circle-footbridge-pct">0%</strong> Footbridges completed
                </div>
              </div>
            </div>
          </div>

          <div class="glass-card kpi-circle-card">
            <div class="kpi-label">Camel Crossings</div>
            <div class="kpi-value" id="camelCrossingsCount">-</div>
            <div class="kpi-circle-layout">
              <div class="circle-wrapper">
                <div id="circle-camel-fill" class="circle-fill"></div>
                <div id="circle-camel-inner" class="circle-inner">0 / 0</div>
              </div>
              <div class="kpi-circle-text">
                <div class="kpi-circle-text-title">Camel Crossing Completion</div>
                <div class="circle-caption">
                  <strong id="circle-camel-pct">0%</strong> Camel Crossings completed
                </div>
              </div>
            </div>
          </div>

          <div class="glass-card kpi-circle-card">
            <div class="kpi-label">Full MEP Systems</div>
            <div class="kpi-value" id="fullMepSystemsCount">-</div>
            <div class="kpi-circle-layout">
              <div class="circle-wrapper">
                <div id="circle-mep-fill" class="circle-fill"></div>
                <div id="circle-mep-inner" class="circle-inner">0 / 0</div>
              </div>
              <div class="kpi-circle-text">
                <div class="kpi-circle-text-title">Structures with Full MEP</div>
                <div class="circle-caption">
                  <strong id="circle-mep-pct">0%</strong> of filtered structures have all systems
                </div>
              </div>
            </div>
          </div>

          <div class="glass-card kpi-circle-card">
            <div class="kpi-label">Qatar North Completion</div>
            <div class="kpi-value text-green" id="surveyCompletionPercentText">-</div>
            <div class="kpi-circle-layout">
              <div class="circle-wrapper">
                <div id="circle-total-fill" class="circle-fill"></div>
                <div id="circle-total-inner" class="circle-inner">0 / 0</div>
              </div>
              <div class="kpi-circle-text">
                <div class="kpi-circle-text-title">Overall Survey Completion</div>
                <div class="circle-caption">
                  <strong id="circle-total-pct">0%</strong> of total filtered structures completed
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <section class="section section-main">
        <div class="main-grid">

          <div class="glass-card map-card">
            <div class="map-card-header">
              <div class="map-title">
                <span class="dot"></span>
                <span>Structural Assets Map (Satellite Imagery)</span>
              </div>
              <button id="mapModeToggle" class="map-toggle-btn" type="button" onclick="toggleMapMode()">
                 Map Mode: All Filtered Markers
              </button>
            </div>
            <div id="map"></div>
            <div class="map-footer" id="map-footer">
              ESRI World Imagery showing surveyed (green), no access (amber), and pending (red) structures.
              <div class="map-legend">
                <div class="legend-item"><span class="legend-dot legend-completed"></span> <span>Completed</span></div>
                <div class="legend-item"><span class="legend-dot legend-no-access"></span> <span>No Access</span></div>
                <div class="legend-item"><span class="legend-dot legend-pending"></span> <span>Pending Visit</span></div>
                <div class="legend-item"><span class="legend-dot legend-selected"></span> <span>Selected from list</span></div>
              </div>
            </div>
          </div>

          <div class="charts-stack">
            <div class="glass-card chart-card type-card">
              <div class="card-header-row">
                <p class="card-title">Structures by Type Distribution</p>
              </div>
              <div class="chart-wrapper">
                <canvas id="typeChart"></canvas>
              </div>
              <div class="kpi-caption text-center" id="type-chart-summary"></div>
            </div>

            <div class="glass-card chart-card status-card">
              <div class="card-header-row">
                <p class="card-title">Survey Status Distribution</p>
              </div>
              <div class="chart-wrapper">
                <canvas id="statusChart"></canvas>
              </div>
              <div class="kpi-caption text-center" id="status-chart-summary"></div>
            </div>
          </div>

        </div>
      </section>

      <section class="section section-table">
        <div class="glass-card table-card">
          <div class="table-header-row">
            <div class="table-header-left">
              <div class="table-header-title">Filtered Structures List</div>
              <div class="table-header-sub" id="table-summary-text">Showing 0 of 0 records.</div>
            </div>
            <div class="export-buttons">
              <button id="downloadCsvBtn" class="export-btn" type="button" onclick="exportCurrentViewCsv()">CSV</button>
              <button id="downloadXlsxBtn" class="export-btn" type="button" onclick="exportCurrentViewXlsx()">XLSX</button>
              <button id="downloadPdfBtn" class="export-btn" type="button" onclick="exportCurrentViewPdf()">PDF</button>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="dashboard-table">
              <thead>
                <tr>
                  <th>S.N</th>
                  <th>Struct. Ref.</th>
                  <th>Asset Name</th>
                  <th>Type</th>
                  <th>Route</th>
                  <th>Zone</th>
                  <th>Status</th>
                  <th>Maximo ID</th>
                  <th>Remarks</th>
                  <th>Systems Summary</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="10" class="text-center">Loading data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
// === CONSTANTS & GLOBALS =============================================
const STRUCTURES_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQx3ljhXIdh8M_D-TQHSXpBDZN7mIRf3qr7uQvnZsn2xbXSL1qtcb-0aIfDiUCtGZmsJcDDhOndhtH2/pub?gid=417753226&single=true&output=csv";

const COLS = {
    sn: "S.N",
    route: "RTE",
    structRef: "Struct. Ref.",
    assetName: "Asset Name",
    code: "CODE",
    status: "STATUS",
    type: "Type",
    maximoId: "Maximo ID",
    zone: "Zone",
    lat: "Latitude",
    lng: "Longitude",
    remarks: "Remarks",
    mep: "MEP",
    lights: "Lights",
    ups: "UPS",
    electricalDb: "Electrical DB",
    ff: "FF",
    fa: "FA",
    hvac: "HVAC",
    elevators: "Elevators",
    escalator: "Escalator",
    its: "ITS",
    elv: "ELV",
};

const MEP_SYSTEMS = [
    COLS.mep, COLS.lights, COLS.ups, COLS.electricalDb, COLS.ff, COLS.fa, COLS.hvac, COLS.elevators, COLS.escalator, COLS.its, COLS.elv,
];

let allData = [];
let currentFiltered = [];
let map;
let markerLayer = new L.LayerGroup();
let selectedAsset = null;

let typeChart, statusChart;
let chartColors = {
    primary: 'rgba(56, 189, 248, 1)', // accent-blue
    secondary: 'rgba(34, 197, 94, 1)', // accent-green
    tertiary: 'rgba(251, 191, 36, 1)', // accent-amber
    quaternary: 'rgba(239, 68, 68, 1)', // accent-red
    lightBlue: 'rgba(100, 150, 250, 1)',
    purple: 'rgba(168, 85, 247, 1)',
    pink: 'rgba(236, 72, 153, 1)',
    orange: 'rgba(249, 115, 22, 1)',
};

const CHART_CONFIG = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'right',
            labels: {
                color: 'var(--text-soft)',
                font: { size: 12, family: 'Inter' }
            }
        },
        tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.9)',
            titleColor: 'var(--text-stronger)',
            bodyColor: 'var(--text-strong)',
            borderColor: 'var(--glass-border)',
            borderWidth: 1,
            bodyFont: { size: 12, family: 'Inter' },
            titleFont: { size: 12, family: 'Inter', weight: 'bold' }
        }
    },
    scales: {
        x: {
            display: true,
            grid: { color: 'rgba(148, 163, 184, 0.1)', borderColor: 'rgba(148, 163, 184, 0.3)' },
            ticks: { color: 'var(--text-soft)' }
        },
        y: {
            display: true,
            grid: { color: 'rgba(148, 163, 184, 0.1)', borderColor: 'rgba(148, 163, 184, 0.3)' },
            ticks: { color: 'var(--text-soft)' }
        }
    }
};

// === UTILS ===========================================================
function isTruthy(value) {
    if (value === null || value === undefined || value === "") return false;
    const s = String(value).trim().toLowerCase();
    return s === "true" || s === "1" || s === "1.0" || s === "yes" || s === "y";
}

function normalizeType(rawType) {
    const txt = (rawType || "").toString().trim();
    if (txt === "") return "Unknown";
    return txt;
}

function getSystemSummary(row) {
    const present = MEP_SYSTEMS.filter(sys => isTruthy(row[sys]));
    const total = MEP_SYSTEMS.length;
    const isFull = present.length === total;

    if (isFull) return `Full System (${total}/${total})`;
    if (present.length === 0) return `No Systems`;
    return `${present.length}/${total} Systems Present`;
}

function classifyRemarks(rawRemarks) {
    const txt = (rawRemarks || "").toString().trim().toLowerCase();
    if (txt.includes("pending to visit")) return "Pending";
    if (txt.includes("visited on")) return "Visited";
    if (txt.includes("under construction") || txt.includes("under qp") || txt.includes("under mme")) return "Under";
    if (txt !== "") return "Other";
    return "";
}

function formatPercent(numerator, denominator) {
    if (denominator === 0 || !isFinite(numerator) || !isFinite(denominator)) return "0.0%";
    return ((numerator / denominator) * 100).toFixed(1) + "%";
}

function updateCurrentDateTime() {
    const span = document.getElementById("currentDateTime");
    if (!span) return;
    const now = new Date();
    span.textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' + now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// === DATA LOADING ====================================================
function loadData() {
    updateCurrentDateTime();
    PapaParse.parse(STRUCTURES_CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        transformHeader: (header) => header.trim(),
        complete: (results) => {
            allData = results.data.map((row, index) => {
                const newRow = {};
                // Map columns to friendly keys and normalize
                Object.keys(COLS).forEach(key => {
                    const colName = COLS[key];
                    let value = row[colName];

                    if (key === 'lat' || key === 'lng') {
                        // Ensure Latitude/Longitude are parsable numbers
                        newRow[key] = parseFloat(value);
                    } else if (MEP_SYSTEMS.map(c => Object.keys(COLS).find(k => COLS[k] === c)).includes(key)) {
                        // MEP fields: convert to boolean/boolean-like string
                        newRow[key] = isTruthy(value) ? '1.0' : '0.0';
                    } else {
                        // Default to trimmed string
                        newRow[key] = (value || "").toString().trim();
                    }
                });
                newRow.uniqueId = index + 1; // Unique ID for map/table linking
                newRow.sn = index + 1; // Use parsed index for SN
                return newRow;
            }).filter(d => d[COLS.structRef]); // Basic filter for valid records

            document.getElementById("dataLoadedCount").textContent = `Total ${allData.length} Structures`;

            initMap();
            initFilters();
            applyFilters();
        },
        error: (error) => {
            console.error("Error loading CSV:", error);
            document.getElementById("tableBody").innerHTML = `<tr><td colspan="10" class="text-red text-center">Failed to load data. Please check the network connection.</td></tr>`;
        }
    });
}

// === FILTERS & SEARCH ===============================================
function initFilters() {
    const zoneSelect = document.getElementById("zoneFilter");
    const routeSelect = document.getElementById("routeFilter");
    const typeSelect = document.getElementById("typeFilter");
    const statusSelect = document.getElementById("statusFilter");

    // Clear existing options, starting with default 'All' option
    [zoneSelect, routeSelect, typeSelect, statusSelect].forEach(select => {
        select.innerHTML = '<option value="">All</option>';
    });

    const uniqueValues = (col) => Array.from(new Set(allData.map(a => a[col]).filter(x => x).map(x => x.toString().trim()))).sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true }));

    uniqueValues(COLS.zone).forEach(val => zoneSelect.add(new Option(val, val)));
    uniqueValues(COLS.route).forEach(val => routeSelect.add(new Option(val, val)));
    uniqueValues(COLS.type).forEach(val => typeSelect.add(new Option(val, val)));
    uniqueValues(COLS.status).forEach(val => statusSelect.add(new Option(val, val)));
}

function applyFilters() {
    const zoneVal = document.getElementById("zoneFilter").value;
    const routeVal = document.getElementById("routeFilter").value;
    const typeVal = document.getElementById("typeFilter").value;
    const statusVal = document.getElementById("statusFilter").value;
    const remarksCategoryVal = document.getElementById("remarksCategoryFilter").value;
    const searchVal = document.getElementById("freeTextSearch").value.toLowerCase();

    let filtered = allData.filter(row => {
        // Dropdown filters
        if (zoneVal && row[COLS.zone] !== zoneVal) return false;
        if (routeVal && row[COLS.route] !== routeVal) return false;
        if (typeVal && row[COLS.type] !== typeVal) return false;
        if (statusVal && row[COLS.status] !== statusVal) return false;

        // Remarks Category filter
        if (remarksCategoryVal) {
            const category = classifyRemarks(row[COLS.remarks]);
            if (category !== remarksCategoryVal) return false;
        }

        // Free Text Search
        if (searchVal) {
            const searchableFields = [
                row[COLS.structRef], row[COLS.assetName], row[COLS.route], row[COLS.remarks], row[COLS.type]
            ].map(s => (s || "").toLowerCase()).join(" | ");

            if (!searchableFields.includes(searchVal)) return false;
        }

        return true;
    });

    currentFiltered = filtered;
    updateKPIs(filtered);
    updateCircularKpis(filtered);
    addMarkers(filtered);
    renderTable(filtered);
    updateCharts(filtered);
    updateFilterTags(filtered);
}

function updateFilterTags(filtered) {
    const filters = document.querySelectorAll(".filters select, .filters input[type='text']");
    const container = document.getElementById("filterTags");
    container.innerHTML = `<span class="filter-chip text-blue" id="dataLoadedCount">Total ${filtered.length} / ${allData.length} Structures</span>`;

    filters.forEach(filter => {
        let value = filter.value;
        let label = filter.previousElementSibling.textContent.replace(':', '');

        if (filter.type === 'select-one' && value) {
            const option = filter.querySelector(`option[value="${value}"]`);
            const displayValue = option ? option.textContent : value;
            const chip = document.createElement('span');
            chip.className = 'filter-chip';
            chip.innerHTML = `${label}: ${displayValue} <span class="filter-chip-clear" onclick="clearFilter('${filter.id}')">×</span>`;
            container.appendChild(chip);
        } else if (filter.type === 'text' && value) {
            const chip = document.createElement('span');
            chip.className = 'filter-chip';
            chip.innerHTML = `${label}: "${value}" <span class="filter-chip-clear" onclick="clearFilter('${filter.id}')">×</span>`;
            container.appendChild(chip);
        }
    });

    document.getElementById("table-summary-text").textContent = `Showing ${filtered.length} of ${allData.length} total records.`;
}

function clearFilter(filterId) {
    const filterEl = document.getElementById(filterId);
    if (filterEl.tagName === 'SELECT') {
        filterEl.value = ""; // Reset dropdown
    } else if (filterEl.tagName === 'INPUT') {
        filterEl.value = ""; // Clear text input
    }
    applyFilters();
}

// === KPI & CIRCLE LOGIC ==============================================
function updateKPIs(data) {
    const total = data.length;
    const completed = data.filter(row => row[COLS.status] === "COMPLETED").length;
    const noAccess = data.filter(row => row[COLS.status] === "NO ACCESS").length;
    const pending = data.filter(row => classifyRemarks(row[COLS.remarks]) === "Pending").length;
    const bridges = data.filter(row => (row[COLS.type] || "").toLowerCase().includes("bridge")).length;
    const underpasses = data.filter(row => (row[COLS.type] || "").toLowerCase().includes("underpass")).length;

    document.getElementById("totalStructuresCount").textContent = total.toLocaleString();
    document.getElementById("completedStructuresCount").textContent = completed.toLocaleString();
    document.getElementById("noAccessStructuresCount").textContent = noAccess.toLocaleString();
    document.getElementById("pendingStructuresCount").textContent = pending.toLocaleString();
    document.getElementById("bridgesCount").textContent = bridges.toLocaleString();
    document.getElementById("underpassesCount").textContent = underpasses.toLocaleString();

    // Overall Completion for the circle KPI section
    const completionPct = formatPercent(completed, total);
    document.getElementById("surveyCompletionPercentText").textContent = completionPct;
}

function updateCircularKpi({ fillId, innerId, pctId, numerator, denominator, pct }) {
    const fillEl = document.getElementById(fillId);
    const innerEl = document.getElementById(innerId);
    const pctEl = document.getElementById(pctId);

    const safeNum = Number.isFinite(numerator) ? numerator : 0;
    const safeDen = Number.isFinite(denominator) ? denominator : 0;
    const safePct = Number.isFinite(pct) && pct >= 0 ? Math.max(0, Math.min(100, pct)) : 0;

    if (fillEl) {
        // Calculate clip path angle (0deg is top, 180deg is halfway, 360deg is full)
        const angle = (safePct / 100) * 360;

        // Logic from existing dashboards for circle fill:
        // Clip rect starts at 0, goes to full width/height (92px here), clipped at 50% width (46px)
        // fill's background is a gradient. The clip path rotates the background to show progress.
        fillEl.style.transform = `rotate(${angle}deg)`;
        if (safePct > 50) {
             // For over 50%, show the whole semi-circle first (by clipping to the full circle), then rotate
             fillEl.style.clip = 'rect(auto, auto, auto, auto)';
        } else {
             // For 50% or less, clip to the right half
             fillEl.style.clip = 'rect(0, 92px, 92px, 46px)';
        }
    }

    if (innerEl) innerEl.textContent = `${safeNum} / ${safeDen}`;
    if (pctEl) pctEl.textContent = safePct.toFixed(1) + "%";
}


function updateCircularKpis(data) {
    const totalStructures = data.length;

    // 1. Footbridges
    const footbridges = data.filter(row => row[COLS.type] === "Footbridge");
    const footbridgesCompleted = footbridges.filter(row => row[COLS.status] === "COMPLETED").length;
    const footbridgesTotal = footbridges.length;
    const footbridgesPct = footbridgesTotal > 0 ? (footbridgesCompleted / footbridgesTotal) * 100 : 0;
    document.getElementById("footbridgesCount").textContent = footbridgesTotal.toLocaleString();
    updateCircularKpi({
        fillId: "circle-footbridge-fill", innerId: "circle-footbridge-inner", pctId: "circle-footbridge-pct",
        numerator: footbridgesCompleted, denominator: footbridgesTotal, pct: footbridgesPct,
    });

    // 2. Camel Crossings
    const camels = data.filter(row => row[COLS.type] === "Camel Crossing");
    const camelsCompleted = camels.filter(row => row[COLS.status] === "COMPLETED").length;
    const camelsTotal = camels.length;
    const camelsPct = camelsTotal > 0 ? (camelsCompleted / camelsTotal) * 100 : 0;
    document.getElementById("camelCrossingsCount").textContent = camelsTotal.toLocaleString();
    updateCircularKpi({
        fillId: "circle-camel-fill", innerId: "circle-camel-inner", pctId: "circle-camel-pct",
        numerator: camelsCompleted, denominator: camelsTotal, pct: camelsPct,
    });

    // 3. Full MEP Systems
    const fullMep = data.filter(row => {
        return MEP_SYSTEMS.every(sys => isTruthy(row[sys]));
    });
    const fullMepCount = fullMep.length;
    const fullMepPct = totalStructures > 0 ? (fullMepCount / totalStructures) * 100 : 0;
    document.getElementById("fullMepSystemsCount").textContent = fullMepCount.toLocaleString();
    updateCircularKpi({
        fillId: "circle-mep-fill", innerId: "circle-mep-inner", pctId: "circle-mep-pct",
        numerator: fullMepCount, denominator: totalStructures, pct: fullMepPct,
    });

    // 4. Overall Survey Completion (COMPLETED / Total)
    const overallCompleted = data.filter(row => row[COLS.status] === "COMPLETED").length;
    const overallPct = totalStructures > 0 ? (overallCompleted / totalStructures) * 100 : 0;
    updateCircularKpi({
        fillId: "circle-total-fill", innerId: "circle-total-inner", pctId: "circle-total-pct",
        numerator: overallCompleted, denominator: totalStructures, pct: overallPct,
    });
}


// === MAP LOGIC =======================================================
function initMap() {
    if (map) map.remove(); // Remove existing map if any

    const qatarBounds = L.latLngBounds(L.latLng(24.5, 50.5), L.latLng(26.5, 52.0)); // Rough bounds for Qatar
    map = L.map('map', {
        center: [25.35, 51.25], // Centered roughly in Qatar North area
        zoom: 10,
        maxBounds: qatarBounds,
        maxBoundsViscosity: 1.0,
        minZoom: 9
    });

    // ESRI World Imagery as requested
    L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }
    ).addTo(map);

    markerLayer.addTo(map);

    map.on('popupopen', (e) => {
        const marker = e.popup._source;
        const row = marker.options.row;
        highlightTableRow(row.uniqueId);
    });

    map.on('popupclose', (e) => {
        unhighlightTableRow();
    });
}

function getMarkerColor(row) {
    if (row.uniqueId === selectedAsset?.uniqueId) return chartColors.primary; // Blue for selected
    if (row[COLS.status] === "COMPLETED") return chartColors.secondary; // Green
    if (row[COLS.status] === "NO ACCESS") return chartColors.tertiary; // Amber
    if (classifyRemarks(row[COLS.remarks]) === "Pending") return chartColors.quaternary; // Red
    return 'grey'; // Default for other statuses
}

function createPopupContent(row) {
    const lat = row.lat;
    const lon = row.lng;
    const hasCoords = Number.isFinite(lat) && Number.isFinite(lon);

    const navLink = hasCoords ? `<br/><br/>
        <a href="http://www.google.com/maps/place/${encodeURIComponent(lat)},${encodeURIComponent(lon)}" target="_blank" style="
          display:inline-block; padding:6px 12px; background:#38bdf8; color:#020617; border-radius:999px; font-weight:600; text-decoration:none; box-shadow:0 10px 20px rgba(56,189,248,0.35);
        "> 🚗 Navigate to Site </a>` : "";

    const systemsSummary = getSystemSummary(row);

    return `
        <strong>${row[COLS.structRef] || "N/A"} - ${row[COLS.assetName] || "No Name"}</strong>
        <br/>
        Type: ${row[COLS.type] || "-"} | Route: ${row[COLS.route] || "-"}
        <br/>
        Status: <strong>${row[COLS.status] || "-"}</strong> | Zone: ${row[COLS.zone] || "-"}
        <br/>
        Maximo ID: ${row[COLS.maximoId] || "-"}
        <br/>
        Remarks: ${row[COLS.remarks] || "-"}
        <br/>
        MEP Summary: ${systemsSummary}
        ${navLink}
    `;
}

function getMarkerIcon(color) {
    // Simple colored circle marker for consistency with base dashboards
    const size = 8;
    return L.divIcon({
        className: 'custom-div-icon',
        html: `<div style="background-color:${color}; width:${size * 2}px; height:${size * 2}px; border-radius:50%; border:2px solid #fff; box-shadow: 0 0 8px ${color};"></div>`,
        iconSize: [size * 2, size * 2],
        iconAnchor: [size, size]
    });
}

function addMarkers(data) {
    markerLayer.clearLayers();
    let bounds = null;
    let validMarkers = 0;

    const markersToShow = selectedAsset && mapModeToggle.dataset.mode === 'selected'
        ? [selectedAsset]
        : data;

    markersToShow.forEach(row => {
        const lat = row.lat;
        const lng = row.lng;

        if (Number.isFinite(lat) && Number.isFinite(lng)) {
            const color = getMarkerColor(row);
            const icon = getMarkerIcon(color);
            const marker = L.marker([lat, lng], {
                icon: icon,
                row: row, // Attach data row to marker
                title: `${row[COLS.structRef]} - ${row[COLS.assetName]}`
            }).bindPopup(createPopupContent(row));

            marker.on('click', () => {
                selectAsset(row.uniqueId);
            });

            markerLayer.addLayer(marker);
            validMarkers++;

            if (!bounds) {
                bounds = L.latLngBounds([lat, lng], [lat, lng]);
            } else {
                bounds.extend([lat, lng]);
            }
        }
    });

    if (validMarkers > 0) {
        try {
             // Only zoom if markers are shown
            map.fitBounds(markerLayer.getBounds(), { padding: [50, 50], maxZoom: 16 });
        } catch (e) {
            // map.fitBounds throws if only one point and map is small, safe to ignore or just pan
            if (validMarkers === 1) map.setView(markerLayer.getLayers()[0].getLatLng(), 16);
        }
    } else {
         // Reset map view if no markers
        map.setView([25.35, 51.25], 10);
    }
}

function flyToAsset(row) {
    const lat = row.lat;
    const lng = row.lng;
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
        map.flyTo([lat, lng], 16, { duration: 0.8 });
        // After flying, open the popup
        setTimeout(() => {
            markerLayer.eachLayer(layer => {
                if (layer.options.row.uniqueId === row.uniqueId) {
                    layer.openPopup();
                }
            });
        }, 800);
    }
}

function selectAsset(uniqueId) {
    selectedAsset = currentFiltered.find(d => d.uniqueId === uniqueId);
    if (!selectedAsset) {
        selectedAsset = null;
        unhighlightTableRow();
    }
    // Re-render markers to update selected marker color
    addMarkers(currentFiltered);
    highlightTableRow(uniqueId);
    if (selectedAsset) flyToAsset(selectedAsset);
}

const mapModeToggle = document.getElementById("mapModeToggle");
mapModeToggle.dataset.mode = 'all';

function toggleMapMode() {
    if (mapModeToggle.dataset.mode === 'all') {
        mapModeToggle.dataset.mode = 'selected';
        mapModeToggle.textContent = "Map Mode: Selected Structure Only";
        mapModeToggle.classList.add("map-toggle-btn-active");
    } else {
        mapModeToggle.dataset.mode = 'all';
        mapModeToggle.textContent = "Map Mode: All Filtered Markers";
        mapModeToggle.classList.remove("map-toggle-btn-active");
    }
    addMarkers(currentFiltered); // Re-run marker function to apply mode
}

// === TABLE LOGIC =====================================================
function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    unhighlightTableRow(); // Clear any previous selection

    if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center">No structures found matching the current filters.</td></tr>`;
        return;
    }

    data.forEach(row => {
        const tr = document.createElement("tr");
        tr.dataset.uniqueId = row.uniqueId;

        const statusClass = row[COLS.status] === "COMPLETED" ? "status-completed" :
                            row[COLS.status] === "NO ACCESS" ? "status-no-access" :
                            "status-other";
        const remarksCategory = classifyRemarks(row[COLS.remarks]);
        const systemsSummary = getSystemSummary(row);

        tr.innerHTML = `
            <td>${row.sn}</td>
            <td>${row[COLS.structRef] || "-"}</td>
            <td>${row[COLS.assetName] || "-"}</td>
            <td>${row[COLS.type] || "-"}</td>
            <td>${row[COLS.route] || "-"}</td>
            <td>${row[COLS.zone] || "-"}</td>
            <td class="td-status ${statusClass}">${row[COLS.status] || "-"}</td>
            <td>${row[COLS.maximoId] || "-"}</td>
            <td title="${row[COLS.remarks]}">${remarksCategory}</td>
            <td title="${systemsSummary}">${systemsSummary}</td>
        `;

        // clicking a row moves map to that asset and selects it
        tr.addEventListener("click", () => selectAsset(row.uniqueId));

        tbody.appendChild(tr);
    });
}

function highlightTableRow(uniqueId) {
    unhighlightTableRow();
    const tr = document.querySelector(`tr[data-unique-id="${uniqueId}"]`);
    if (tr) {
        tr.classList.add("row-selected");
        tr.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function unhighlightTableRow() {
    document.querySelectorAll(".row-selected").forEach(row => {
        row.classList.remove("row-selected");
    });
}

// === CHARTS LOGIC ====================================================
function updateCharts(data) {
    // Chart 1: Structures by Type
    const typeCounts = data.reduce((acc, row) => {
        const type = normalizeType(row[COLS.type]);
        acc[type] = (acc[type] || 0) + 1;
        return acc;
    }, {});

    const typeLabels = Object.keys(typeCounts);
    const typeValues = Object.values(typeCounts);

    const typeCtx = document.getElementById("typeChart").getContext("2d");
    if (typeChart) typeChart.destroy();

    typeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: typeLabels,
            datasets: [{
                data: typeValues,
                backgroundColor: [chartColors.primary, chartColors.secondary, chartColors.tertiary, chartColors.quaternary, chartColors.purple, chartColors.pink, chartColors.orange, chartColors.lightBlue, 'grey'],
                hoverOffset: 4
            }]
        },
        options: {
            ...CHART_CONFIG,
            plugins: {
                ...CHART_CONFIG.plugins,
                legend: { position: 'right' },
            },
        }
    });

    document.getElementById("type-chart-summary").textContent = `Distribution across ${typeLabels.length} unique structure types.`;


    // Chart 2: Status Distribution
    const statusCounts = data.reduce((acc, row) => {
        const status = row[COLS.status] || "N/A";
        acc[status] = (acc[status] || 0) + 1;
        return acc;
    }, {});

    const statusLabels = Object.keys(statusCounts);
    const statusValues = Object.values(statusCounts);

    const statusCtx = document.getElementById("statusChart").getContext("2d");
    if (statusChart) statusChart.destroy();

    statusChart = new Chart(statusCtx, {
        type: 'bar',
        data: {
            labels: statusLabels,
            datasets: [{
                label: 'Structure Count',
                data: statusValues,
                backgroundColor: statusLabels.map(label => {
                    if (label === "COMPLETED") return chartColors.secondary;
                    if (label === "NO ACCESS") return chartColors.tertiary;
                    if (label === "PENDING") return chartColors.quaternary;
                    return chartColors.primary;
                }),
                borderColor: 'rgba(255, 255, 255, 0.2)',
                borderWidth: 1
            }]
        },
        options: {
            ...CHART_CONFIG,
            plugins: {
                ...CHART_CONFIG.plugins,
                legend: { display: false }
            },
            scales: {
                x: {
                    ...CHART_CONFIG.scales.x,
                    grid: { display: false }
                },
                y: {
                    ...CHART_CONFIG.scales.y,
                    beginAtZero: true
                }
            }
        }
    });

    document.getElementById("status-chart-summary").textContent = `Current survey status for ${data.length} filtered structures.`;
}

// === EXPORT LOGIC ====================================================

function buildTableData() {
    const rows = currentFiltered.length > 0 ? currentFiltered : allData;
    if (!rows || !rows.length) return null;

    const headers = [
        "S.N", "Struct. Ref.", "Asset Name", "Type", "Route", "Zone", "Status", "Maximo ID", "Remarks", "Systems Summary"
    ];

    const body = rows.map((row) => [
        row.sn,
        row[COLS.structRef] || "-",
        row[COLS.assetName] || "-",
        row[COLS.type] || "-",
        row[COLS.route] || "-",
        row[COLS.zone] || "-",
        row[COLS.status] || "-",
        row[COLS.maximoId] || "-",
        row[COLS.remarks] || "-",
        getSystemSummary(row),
    ]);

    return { headers, body };
}

function exportCurrentViewCsv() {
    const data = buildTableData();
    if (!data) { alert("No data to export."); return; }

    const { headers, body } = data;
    const allRows = [headers, ...body];
    const csvContent = allRows
        .map((row) => row
            .map((val) => {
                const v = val == null ? "" : String(val);
                // Simple CSV escaping: double quotes, newline, comma
                if (/[",\n]/.test(v)) {
                    return '"' + v.replace(/"/g, '""') + '"';
                }
                return v;
            })
            .join(",")
        )
        .join("\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Qatar_North_Structures_Survey_Data.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportCurrentViewXlsx() {
    const data = buildTableData();
    if (!data) { alert("No data to export."); return; }

    const { headers, body } = data;
    const allRows = [headers, ...body];

    const ws = XLSX.utils.aoa_to_sheet(allRows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Structures_Data");

    // Attempt to clone PDF header logic for extra info in XLSX
    const title = "Qatar North Structures Survey Dashboard";
    const subtitle = `Filtered Data Export (${currentFiltered.length} records)`;
    const date = `Export Date: ${new Date().toLocaleString()}`;

    const colCount = headers.length;
    const headerRows = [];

    // Row 1: Title (will merge)
    const row1 = new Array(colCount).fill("");
    row1[0] = title;
    headerRows.push(row1);

    // Row 2: Subtitle
    const row2 = new Array(colCount).fill("");
    row2[0] = subtitle;
    headerRows.push(row2);

    // Row 3: Date
    const row3 = new Array(colCount).fill("");
    row3[0] = date;
    headerRows.push(row3);

    XLSX.utils.sheet_add_aoa(ws, headerRows, { origin: "A1" });

    // Merges for the title, subtitle, date
    ws['!merges'] = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: colCount - 1 } },
        { s: { r: 1, c: 0 }, e: { r: 1, c: colCount - 1 } },
        { s: { r: 2, c: 0 }, e: { r: 2, c: colCount - 1 } },
    ];

    // Shift data down by 3 rows
    ws['!ref'] = XLSX.utils.encode_range({
        s: { r: 3, c: 0 },
        e: { r: ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']).e.r + 3 : body.length + 3, c: colCount - 1 }
    });

    XLSX.writeFile(wb, "Qatar_North_Structures_Survey_Data.xlsx");
}

function drawStructuresPdfHeader(doc) {
    const title = "Qatar North Structures Survey Dashboard";
    const subtitle = `Filtered Data Export (${currentFiltered.length} records)`;
    const date = `Export Date: ${new Date().toLocaleString()}`;
    const pageWidth = doc.internal.pageSize.getWidth();
    const marginX = 10;
    const logoHeight = 12;

    // Logos - assuming the placeholders are in the header
    const leftImg = document.querySelector("header .header-left img");
    const rightImg = document.querySelector("header .header-right img");

    if (leftImg) {
        // Simple sizing for placeholder images
        const ratio = 150 / 50; // Assume 150x50 placeholder
        const w = logoHeight * ratio;
        try { doc.addImage(leftImg.src, "PNG", marginX, 8, w, logoHeight); } catch(e) {}
    }

    if (rightImg) {
        const ratio = 150 / 50;
        const w = logoHeight * ratio;
        try { doc.addImage(rightImg.src, "PNG", pageWidth - marginX - w, 8, w, logoHeight); } catch(e) {}
    }

    // Title
    doc.setFontSize(16);
    doc.setTextColor(15, 23, 42); // Dark color for light background in PDF
    doc.text(title, pageWidth / 2, 16, { align: "center" });

    // Subtitle
    doc.setFontSize(10);
    doc.setTextColor(71, 85, 105);
    doc.text(subtitle, pageWidth / 2, 22, { align: "center" });

    // Date
    doc.setFontSize(8);
    doc.setTextColor(100, 116, 139);
    doc.text(date, pageWidth / 2, 26, { align: "center" });
}

function exportCurrentViewPdf() {
    const data = buildTableData();
    if (!data) { alert("No data to export."); return; }
    const { headers, body } = data;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape" });

    doc.autoTable({
        head: [headers],
        body: body,
        margin: { top: 30, left: 10, right: 10 },
        styles: { fontSize: 6, cellPadding: 1.2 },
        headStyles: { fillColor: [15, 23, 42] }, // Dark header
        didDrawPage: function () {
            drawStructuresPdfHeader(doc);
        },
    });

    doc.save("Qatar_North_Structures_Survey_Data.pdf");
}

// === INITIALIZATION ==================================================
document.addEventListener("DOMContentLoaded", loadData);

// Update datetime every minute
setInterval(updateCurrentDateTime, 60000);
</script>
</body>
</html>