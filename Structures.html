<!DOCTYPE html>
<!--  -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qatar North Structures Survey Dashboard</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --aktor-blue: #0b1120;
      --aktor-red: #e0283b;
      --algo-blue: #38bdf8;

      --bg-surface: rgba(15, 23, 42, 0.88);

      --glass-bg: rgba(15, 23, 42, 0.72);
      --glass-border: rgba(148, 163, 184, 0.45);
      --glass-shadow-soft: 0 22px 45px rgba(15, 23, 42, 0.65);
      --glass-radius-lg: 18px;
      --glass-radius-md: 14px;

      --text-soft: #9ca3af;
      --text-subtle: #6b7280;
      --text-strong: #e5e7eb;
      --text-stronger: #f9fafb;

      --accent-green: #22c55e;
      --accent-amber: #fbbf24;
      --accent-blue: #38bdf8;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
      --accent-pink: #ec4899;
      --accent-orange: #f97316;

      --transition-fast: 200ms cubic-bezier(0.22, 0.61, 0.36, 1);
      --transition-med: 320ms cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    /* THEME HANDLING */
    body[data-theme="dark"] {
      /* dark theme is the default defined by base tokens */
    }

    body[data-theme="light"] {
      --bg-surface: rgba(255, 255, 255, 0.92);
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(148, 163, 184, 0.55);
      --text-soft: #6b7280;
      --text-subtle: #9ca3af;
      --text-strong: #111827;
      --text-stronger: #020617;
    }

    body[data-theme="light"] {
      background: #f3f4f6;
      color: var(--text-stronger);
    }

    body[data-theme="light"] .page {
      background:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.08), transparent 55%),
        radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.09), transparent 55%),
        linear-gradient(135deg, #e5e7eb, #f9fafb);
    }

    body[data-theme="light"] header,
    body[data-theme="light"] .glass-card,
    body[data-theme="light"] .kpi-card {
      background:
        radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), transparent 55%),
        linear-gradient(145deg, #ffffff, #e5e7eb);
      border-color: rgba(148, 163, 184, 0.55);
      color: var(--text-stronger);
    }

    body[data-theme="light"] .kpi-badge,
    body[data-theme="light"] .filter-chip {
      background-color: rgba(15, 23, 42, 0.08);
      border-color: rgba(148, 163, 184, 0.8);
      color: var(--text-strong);
    }

    body[data-theme="light"] .filters-card,
    body[data-theme="light"] .table-card,
    body[data-theme="light"] .map-card,
    body[data-theme="light"] .chart-card {
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.16);
    }

    body[data-theme="light"] input,
    body[data-theme="light"] select {
      background-color: #ffffff;
      border-color: rgba(148, 163, 184, 0.9);
      color: var(--text-strong);
    }

    body[data-theme="light"] .table-wrapper {
      background:
        radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), rgba(243, 244, 246, 0.98));
      border-color: rgba(148, 163, 184, 0.8);
    }

    body[data-theme="light"] th {
      background: linear-gradient(180deg, #e5e7eb, #d1d5db);
      color: #4b5563;
    }

    body[data-theme="light"] tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    body[data-theme="light"] tbody tr:nth-child(odd) {
      background: #f3f4f6;
    }

    body[data-theme="light"] tbody tr:hover {
      background:
        radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.12), transparent 55%),
        #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    html,
    body {
      height: 100%;
    }

    body {
      min-height: 100vh;
      background-color: #020617;
      background-attachment: fixed;
      background-size: cover;
      color: var(--text-strong);
    }

    .page {
      width: 100%;
      min-height: 100vh;
      margin: 0;
      padding-bottom: 24px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.26), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(236, 72, 153, 0.22), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(249, 115, 22, 0.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.22), transparent 60%),
        linear-gradient(180deg, #020617 0%, #020617 18%, #020617 100%);
    }

    .shell {
      max-width: 1880px;
      margin: 0 auto;
      padding: 12px 16px 24px;
    }

    /* HEADER */

    header {
      width: 100%;
      border-radius: 20px;
      margin-bottom: 10px;
      padding: 10px 20px;
      background:
        linear-gradient(135deg, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.92)),
        linear-gradient(90deg, rgba(56, 189, 248, 0.35), rgba(168, 85, 247, 0.35), rgba(236, 72, 153, 0.26));
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      position: relative;
    }

    .header-left,
    .header-right {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-center {
      flex: 1 1 auto;
      text-align: center;
    }

    .header-logo {
      max-height: 52px;
      height: auto;
      filter: drop-shadow(0 8px 20px rgba(15, 23, 42, 0.8));
    }

    .header-logo-small {
      max-height: 42px;
    }

    .header-title {
      font-size: clamp(20px, 2vw, 26px);
      font-weight: 700;
      letter-spacing: 0.06em;
      color: var(--text-stronger);
      text-transform: uppercase;
    }

    .header-subtitle {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .header-meta {
      font-size: 11px;
      color: #c7d2fe;
      margin-top: 4px;
    }

    .header-meta-separator {
      margin: 0 6px;
      opacity: 0.75;
    }

    /* PAGE NAV (THEME + LINKS) */

    .page-nav {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .page-nav-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .page-nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .theme-toggle-btn {
      padding: 5px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), transparent 60%),
        rgba(15, 23, 42, 0.96);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        border-color var(--transition-fast),
        background var(--transition-fast),
        box-shadow var(--transition-fast),
        transform var(--transition-fast),
        color var(--transition-fast);
    }

    .theme-toggle-btn:hover {
      border-color: rgba(248, 250, 252, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
    }

    .top-nav-links {
      list-style: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 0;
      margin: 0;
    }

    .top-nav-links a {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
      transition:
        color var(--transition-fast),
        border-color var(--transition-fast),
        background var(--transition-fast),
        transform var(--transition-fast);
    }

    .top-nav-links a:hover {
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.8);
      transform: translateY(-1px);
    }

    .top-nav-links a.nav-active {
      border-color: rgba(56, 189, 248, 0.9);
      color: #e0f2fe;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.35), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.95);
    }

    main.dashboard {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
    }

    .section {
      display: block;
      animation: fade-slide-up 0.65s var(--transition-med);
    }

    .section-kpis {
      margin-top: 4px;
    }

    .section-insights,
    .section-filters,
    .section-main,
    .section-table {
      margin-top: 2px;
    }

    .glass-card {
      position: relative;
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.16), transparent 40%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
      border-radius: var(--glass-radius-lg);
      padding: 10px 14px;
      box-shadow: var(--glass-shadow-soft);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      overflow: hidden;
      transition:
        transform var(--transition-med),
        box-shadow var(--transition-med),
        border-color var(--transition-med),
        background var(--transition-med);
    }

    .glass-card::before {
      content: "";
      position: absolute;
      inset: -20%;
      opacity: 0;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.16), transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.16), transparent 45%);
      transition: opacity var(--transition-med);
      pointer-events: none;
    }

    .glass-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 26px 55px rgba(15, 23, 42, 0.95);
      border-color: rgba(248, 250, 252, 0.35);
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.22), transparent 40%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94));
    }

    .glass-card:hover::before {
      opacity: 1;
    }

    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title::before {
      content: "";
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.75);
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 2px;
    }

    /* KPI GRID */

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 8px;
    }

    .kpi-card {
      position: relative;
      background:
        linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9)),
        linear-gradient(120deg, rgba(56, 189, 248, 0.22), rgba(168, 85, 247, 0.18), rgba(236, 72, 153, 0.18));
      border-radius: var(--glass-radius-md);
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      box-shadow: 0 16px 35px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 4px;
      min-height: 100px;
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast),
        background var(--transition-fast);
      cursor: default;
    }

    .kpi-card::after {
      content: "";
      position: absolute;
      inset: 0;
      opacity: 0;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.25), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.25), transparent 55%);
      transition: opacity var(--transition-fast);
      pointer-events: none;
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.98);
      border-color: rgba(248, 250, 252, 0.5);
      background:
        linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.94)),
        linear-gradient(120deg, rgba(56, 189, 248, 0.28), rgba(168, 85, 247, 0.24), rgba(236, 72, 153, 0.24));
    }

    .kpi-card:hover::after {
      opacity: 1;
    }

    .kpi-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .kpi-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-stronger);
    }

    .kpi-subtext {
      font-size: 11px;
      color: var(--text-subtle);
    }

    .kpi-pct {
      font-size: 11px;
      color: var(--text-strong);
      margin-top: 2px;
    }

    /* CIRCLE KPIs */

    .kpi-circle-layout {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
    }

    .kpi-circle-compact .circle-wrapper {
      width: 92px;
      height: 92px;
      position: relative;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 10%, #f9fafb, #374151);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 12px 34px rgba(15, 23, 42, 0.9);
    }

    .kpi-circle-compact .circle-inner {
      width: 60px;
      height: 60px;
      font-size: 13px;
    }

    .kpi-circle-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .circle-caption {
      font-size: 10px;
      color: var(--text-subtle);
    }

    .circle-caption strong {
      font-weight: 600;
      color: var(--accent-green);
      margin-right: 2px;
    }

    .circle-wrapper {
      width: 72px;
      height: 72px;
      position: relative;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 10%, #f9fafb, #374151);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 10px 32px rgba(15, 23, 42, 0.9);
    }

    .circle-fill {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: conic-gradient(var(--accent-green) 0deg, rgba(15, 23, 42, 0.32) 0deg);
      opacity: 0.96;
      transition: background 360ms ease-out;
    }

    .circle-inner {
      position: relative;
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 0, #f9fafb, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #f9fafb;
      padding: 0 4px;
      line-height: 1.2;
      border: 1px solid rgba(248, 250, 252, 0.25);
    }

    /* INSIGHTS BAR */

    .insights-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .insights-main-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .insights-main-label span.badge-pulse {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-amber);
      box-shadow: 0 0 12px rgba(251, 191, 36, 0.9);
      position: relative;
    }

    .insights-main-label span.badge-pulse::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: inherit;
      border: 1px solid rgba(251, 191, 36, 0.6);
      opacity: 0;
      animation: pulse 1.5s infinite;
    }

    /* FILTER BAR */

    .filters-card {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filters-row-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 2px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .filters label {
      font-size: 10px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filters select {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.85);
      font-size: 11px;
      min-width: 130px;
      background-color: rgba(15, 23, 42, 0.98) !important;
      background-image:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98)) !important;
      color: var(--text-strong) !important;
      outline: none;
      transition:
        border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        background var(--transition-fast),
        transform var(--transition-fast);
      appearance: none;
      -webkit-appearance: none;
      position: relative;
    }

    .filters select:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8);
      background-image:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), transparent 60%),
        linear-gradient(135deg, rgba(15, 23, 42, 1), rgba(15, 23, 42, 1)) !important;
      transform: translateY(-1px);
    }

    .filters select:hover {
      border-color: rgba(248, 250, 252, 0.5);
    }

    .filters-row-extra {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .filters-note {
      font-size: 10px;
      color: var(--text-subtle);
    }

    .export-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .export-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.9);
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.35), transparent 55%),
        linear-gradient(135deg, rgba(37, 99, 235, 0.96), rgba(56, 189, 248, 0.95));
      color: #ecfeff;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 16px 35px rgba(30, 64, 175, 0.8);
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        filter var(--transition-fast);
    }

    .export-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 48px rgba(30, 64, 175, 0.95);
      filter: brightness(1.05);
    }

    .export-btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
    }

    /* MAIN GRID / MAP / CHARTS */

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
      gap: 12px;
      align-items: stretch;
    }

    .map-card {
      border-radius: var(--glass-radius-lg);
    }

    .map-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .map-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .map-title span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
    }

    .map-toggle-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 5px 12px;
      font-size: 11px;
      background:
        radial-gradient(circle at top left, rgba(248, 250, 252, 0.06), transparent 60%),
        rgba(15, 23, 42, 0.96);
      color: var(--text-soft);
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        border-color var(--transition-fast),
        background var(--transition-fast),
        box-shadow var(--transition-fast),
        transform var(--transition-fast),
        color var(--transition-fast);
    }

    .map-toggle-btn-active {
      border-color: rgba(56, 189, 248, 0.95);
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.25), transparent 55%),
        linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
      color: #e0f2fe;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.95);
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.55);
      transition: transform var(--transition-med), box-shadow var(--transition-med), border-color var(--transition-med);
    }

    .map-card:hover #map {
      transform: translateY(-1px);
      box-shadow: 0 20px 52px rgba(15, 23, 42, 0.98);
      border-color: rgba(248, 250, 252, 0.55);
    }

    .map-footer {
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .charts-stack {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chart-card {
      border-radius: var(--glass-radius-lg);
    }

    .chart-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      margin: 0;
    }

    .chart-wrapper {
      height: 230px;
      margin-top: 4px;
    }

    .chart-legend {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 4px;
    }

    /* TABLE SECTION */

    .table-card {
      border-radius: var(--glass-radius-lg);
    }

    .table-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .table-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .table-header-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }

    .table-header-sub {
      font-size: 11px;
      color: var(--text-subtle);
    }

    .table-controls {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      width: 100%;
    }

    .table-search {
      flex: 1;
      max-width: 360px;
    }

    .table-search input {
      width: 100%;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 11px;
      background:
        radial-gradient(circle at 0 0, rgba(248, 250, 252, 0.06), transparent 60%),
        rgba(15, 23, 42, 0.96);
      color: var(--text-strong);
      outline: none;
      transition:
        border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        background var(--transition-fast),
        transform var(--transition-fast);
    }

    .table-search input::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }

    .table-search input:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8);
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.2), transparent 60%),
        rgba(15, 23, 42, 0.98);
      transform: translateY(-1px);
    }

    .table-wrapper {
      max-height: 320px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background:
        radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(3, 7, 18, 0.98));
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.95);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      color: var(--text-strong);
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 5px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.95));
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
      color: #9ca3af;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.82);
    }

    tbody tr:nth-child(odd) {
      background: rgba(3, 7, 18, 0.96);
    }

    tbody tr:hover {
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), transparent 55%),
        rgba(3, 7, 18, 0.98);
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      color: white;
      box-shadow: 0 0 14px rgba(15, 23, 42, 0.9);
    }

    .badge-success {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    .badge-pending {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .badge-neutral {
      background: linear-gradient(135deg, #6b7280, #4b5563);
    }

    /* FOOTER */

    footer {
      margin-top: 10px;
      font-size: 10px;
      color: var(--text-subtle);
      text-align: right;
    }

    /* LOADING OVERLAY */

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 10% 0, rgba(56, 189, 248, 0.16), transparent 60%),
        radial-gradient(circle at 90% 100%, rgba(236, 72, 153, 0.18), transparent 60%),
        rgba(15, 23, 42, 0.95);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      color: #e5e7eb;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 4px solid rgba(148, 163, 184, 0.35);
      border-top-color: #38bdf8;
      animation: spin 1.1s linear infinite;
      box-shadow: 0 0 25px rgba(56, 189, 248, 0.85);
    }

    .loading-text {
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    /* ANIMATIONS */

    @keyframes fade-slide-up {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      from {
        opacity: 0.55;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(1.4);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* RESPONSIVE */

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      }

      #map {
        height: 380px;
      }
    }

    @media (max-width: 1024px) {
      .shell {
        padding: 10px 10px 20px;
      }

      header {
        flex-wrap: wrap;
        align-items: flex-start;
        padding: 10px 14px;
      }

      .header-center {
        text-align: left;
      }

      .main-grid {
        grid-template-columns: 1fr;
      }

      .charts-stack {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .charts-stack .chart-card {
        flex: 1 1 260px;
      }

      #map {
        height: 360px;
      }

      .table-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .table-search {
        max-width: 100%;
      }
    }

    @media (max-width: 768px) {
      header {
        border-radius: 16px;
      }

      .insights-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      #map {
        height: 320px;
      }
    }

    @media (max-width: 480px) {
      .page-nav {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading Structures Assets from Google Sheet…</div>
  </div>

  <div class="page">
    <div class="shell">
      <header>
        <div class="header-left">
          <img src="aktor-logo.png" alt="Aktor Logo" class="header-logo" />
        </div>
        <div class="header-center">
          <div class="header-title">
            QATAR NORTH STRUCTURES SURVEY DASHBOARD
          </div>
          <div class="header-subtitle">
            Live from Google Sheet – Structures Assets, Survey Completion &amp; Operation Status
          </div>
          <div class="header-meta">
            <span>Current Time:</span>
            <span id="currentDateTime"></span>
          </div>
        </div>
        <div class="header-right">
          <img src="MRTC-AKTOR JV.png" alt="MRTC-AKTOR JV" class="header-logo header-logo-small" />
        </div>
      </header>

      <nav class="page-nav">
        <div class="page-nav-left">
          <button id="themeToggleBtn" class="theme-toggle-btn" type="button">
            Toggle Theme
          </button>
        </div>
        <div class="page-nav-right">
          <ul class="top-nav-links">
            <li>
              <a href="TRAFFIC.html">Traffic Junctions</a>
            </li>
            <li>
              <a href="ITS.html">ITS Dashboard</a>
            </li>
          </ul>
        </div>
      </nav>

      <main class="dashboard">
        <!-- KPIs -->
        <section class="section section-kpis">
          <div class="glass-card">
            <div class="card-header-row">
              <div>
                <p class="card-title">Network KPIs – Qatar North Structures</p>
                <p class="card-sub">Overview of total structures, survey coverage and operational status.</p>
              </div>
            </div>

            <div class="kpi-grid">
              <!-- Total Structures -->
              <div class="kpi-card">
                <div class="kpi-label">Total Structures Assets</div>
                <div class="kpi-value" id="totalAssetsCount">0</div>
                <div class="kpi-subtext">All structures in Qatar North scope (bridges, underpasses, PB, PUP, etc.).</div>
              </div>

              <!-- Surveyed Assets + Circle -->
              <div class="kpi-card">
                <div class="kpi-label">Structures Surveyed</div>
                <div class="kpi-circle-layout">
                  <div class="kpi-circle-compact">
                    <div class="circle-wrapper">
                      <div class="circle-fill" id="surveyCompletionCircle"></div>
                      <div class="circle-inner" id="surveyCompletionPctText">0%</div>
                    </div>
                  </div>
                  <div class="kpi-circle-text">
                    <div class="kpi-value" id="assetsSurveyedCount">0</div>
                    <div class="circle-caption">
                      <strong id="surveyCompletionCaption">0%</strong>
                      of total structures have been surveyed.
                    </div>
                    <div class="kpi-subtext">Remaining assets are tracked under pending / no access.</div>
                  </div>
                </div>
              </div>

              <!-- Pending Structures -->
              <div class="kpi-card">
                <div class="kpi-label">Pending Survey</div>
                <div class="kpi-value" id="assetsPendingCount">0</div>
                <div class="kpi-pct" id="assetsPendingPctText">0% of total structures</div>
                <div class="kpi-subtext">Includes structures not yet surveyed or with incomplete data.</div>
              </div>

              <!-- No Access -->
              <div class="kpi-card">
                <div class="kpi-label">No Access / Restricted</div>
                <div class="kpi-value" id="noAccessCount">0</div>
                <div class="kpi-pct" id="noAccessPctText">0% of total structures</div>
                <div class="kpi-subtext">Assets with “No Access” or similar status during survey.</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Insights strip -->
        <section class="section section-insights">
          <div class="glass-card">
            <div class="insights-bar">
              <div class="insights-main-label">
                <span class="badge-pulse"></span>
                Structures survey status and asset distribution are updated live from the Google Sheet.
              </div>
              <div class="card-sub" id="insightsSummaryText">
                Loading insights…
              </div>
            </div>
          </div>
        </section>

        <!-- Filters -->
        <section class="section section-filters">
          <div class="glass-card filters-card">
            <div class="filters-row-title">Filters &amp; Export</div>
            <div class="filters">
              <label>
                Route (RTE)
                <select id="filterRoute">
                  <option value="ALL">All Routes</option>
                </select>
              </label>
              <label>
                Zone
                <select id="filterZone">
                  <option value="ALL">All Zones</option>
                </select>
              </label>
              <label>
                Structure Type
                <select id="filterType">
                  <option value="ALL">All Types</option>
                </select>
              </label>
              <label>
                Survey Status
                <select id="filterSurveyStatus">
                  <option value="ALL">All Status</option>
                  <option value="Completed">Completed</option>
                  <option value="Pending">Pending</option>
                  <option value="No Access">No Access</option>
                </select>
              </label>
            </div>

            <div class="filters-row-extra">
              <div class="filters-note" id="filtersNote">
                Showing all structures in Qatar North.
              </div>
              <div class="export-buttons">
                <button class="export-btn" id="downloadCsvBtn" type="button">
                  CSV
                </button>
                <button class="export-btn" id="downloadExcelBtn" type="button">
                  Excel (XLSX)
                </button>
                <button class="export-btn" id="downloadPdfBtn" type="button">
                  PDF
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Map + Charts -->
        <section class="section section-main">
          <div class="main-grid">
            <!-- Map -->
            <div class="glass-card map-card">
              <div class="map-card-header">
                <div class="map-title">
                  <span class="dot"></span>
                  Qatar North Structures Map – Satellite View
                </div>
                <button id="mapToggleBtn" class="map-toggle-btn map-toggle-btn-active" type="button">
                  Focus on filtered structures
                </button>
              </div>
              <div id="map"></div>
              <div class="map-footer" id="mapFooterText">
                Click a row in the table to zoom to that structure. Marker color reflects survey status.
              </div>
            </div>

            <!-- Charts -->
            <div class="charts-stack">
              <div class="glass-card chart-card">
                <div class="card-header-row">
                  <h3 class="chart-title">Structures by Type</h3>
                </div>
                <div class="chart-wrapper">
                  <canvas id="typeChart"></canvas>
                </div>
                <div class="chart-legend" id="typeChartLegend">
                  Distribution of structures by Type field from the Structures sheet.
                </div>
              </div>

              <div class="glass-card chart-card">
                <div class="card-header-row">
                  <h3 class="chart-title">Survey Status by Type</h3>
                </div>
                <div class="chart-wrapper">
                  <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-legend" id="statusChartLegend">
                  Completion vs Pending vs No Access for each structure type.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Table -->
        <section class="section section-table">
          <div class="glass-card table-card">
            <div class="table-header-row">
              <div class="table-header-left">
                <div class="table-header-title">Structures Asset List – Filtered View</div>
                <div class="table-header-sub" id="tableHeaderSub">
                  0 structures in current view.
                </div>
              </div>
            </div>

            <div class="table-controls">
              <div class="table-search">
                <input
                  type="text"
                  id="assetSearch"
                  placeholder="Search by Struct Ref, Asset Name, Route, Zone, Type, or Maximo ID…"
                />
              </div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Sr.No</th>
                    <th>Struct Ref</th>
                    <th>Asset Name</th>
                    <th>Type</th>
                    <th>Route (RTE)</th>
                    <th>Zone</th>
                    <th>Survey Status</th>
                    <th>Maximo ID</th>
                    <th>Remarks</th>
                  </tr>
                </thead>
                <tbody id="assetTableBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <footer>
          Qatar North Structures Survey Dashboard – Powered by GitHub Pages &amp; Google Sheets
        </footer>
      </main>
    </div>
  </div>

  <script>
    // ==============================
    // CONFIG
    // ==============================

    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQx3ljhXIdh8M_D-TQHSXpBDZN7mIRf3qr7uQvnZsn2xbXSL1qtcb-0aIfDiUCtGZmsJcDDhOndhtH2/pub?gid=417753226&single=true&output=csv";

    let allAssets = [];
    let filteredAssets = [];
    let map;
    let markersLayer;
    let typeChart;
    let statusChart;
    let focusFilteredOnMap = true;
    const markerByKey = {};

    // ==============================
    // UTILITIES
    // ==============================

    function toNumberSafe(val) {
      const n = parseFloat(val);
      return Number.isFinite(n) ? n : NaN;
    }

    function normaliseStatus(raw) {
      if (!raw) return "Pending";
      const s = String(raw).trim().toUpperCase();

      if (s.includes("COMP")) return "Completed";
      if (s === "DONE") return "Completed";
      if (s.includes("NO ACCESS")) return "No Access";
      if (s.includes("PENDING")) return "Pending";
      return s || "Pending";
    }

    function getUniqueValues(arr, key) {
      const set = new Set();
      arr.forEach((item) => {
        const v = (item[key] ?? "").toString().trim();
        if (v) set.add(v);
      });
      return Array.from(set).sort((a, b) => a.localeCompare(b));
    }

    function formatPercent(n) {
      if (!Number.isFinite(n)) return "0%";
      return `${n.toFixed(1).replace(/\.0$/, "")}%`;
    }

    function createBadge(text, status) {
      const span = document.createElement("span");
      span.textContent = text;
      span.classList.add("badge");
      if (status === "Completed") span.classList.add("badge-success");
      else if (status === "Pending") span.classList.add("badge-pending");
      else span.classList.add("badge-neutral");
      return span;
    }

    // ==============================
    // THEME + DATE/TIME
    // ==============================

    function initTheme() {
      const prefersDark = window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      document.body.dataset.theme = prefersDark ? "dark" : "light";

      const btn = document.getElementById("themeToggleBtn");
      if (!btn) return;
      btn.textContent = document.body.dataset.theme === "dark"
        ? "Switch to Light Mode"
        : "Switch to Dark Mode";

      btn.addEventListener("click", () => {
        document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
        btn.textContent = document.body.dataset.theme === "dark"
          ? "Switch to Light Mode"
          : "Switch to Dark Mode";
      });
    }

    function updateCurrentDateTime() {
      const el = document.getElementById("currentDateTime");
      if (!el) return;
      const now = new Date();
      // 12-hour format with seconds, similar to Traffic/ITS
      const options = {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "numeric",
        minute: "2-digit",
        second: "2-digit",
        hour12: true
      };
      el.textContent = now.toLocaleString("en-GB", options);
    }

    // ==============================
    // DATA LOADING
    // ==============================

    function transformRow(row, index) {
      const lat = toNumberSafe(row["Latitude"] ?? row["LAT"]);
      const lng = toNumberSafe(row["Longitude"] ?? row["LON"]);

      const asset = {
        srNo: index + 1,
        structRef: (row["Struct. Ref."] || row["Struct Ref"] || row["STRUCT_REF"] || "").trim(),
        assetName: (row["Asset Name"] || row["ASSET_NAME"] || "").trim(),
        type: (row["Type"] || row["STRUCT_TYPE"] || "").trim(),
        route: (row["RTE"] || row["Route"] || "").trim(),
        zone: (row["Zone"] || row["ZONE"] || "").trim(),
        maximoId: (row["Maximo ID"] || row["Maximo Id"] || row["MAXIMO_ID"] || "").trim(),
        statusRaw: (row["STATUS"] || row["Status"] || row["Survey Status"] || "").trim(),
        remarks: (row["Remarks"] || row["REMARKS"] || "").trim(),
        lat,
        lng,
        hasLocation: Number.isFinite(lat) && Number.isFinite(lng)
      };

      asset.surveyStatus = normaliseStatus(asset.statusRaw);
      return asset;
    }

    function loadData() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const data = results.data || [];
          allAssets = data.map(transformRow).filter((a) => a.structRef || a.assetName);
          filteredAssets = [...allAssets];

          initFilters();
          initMap();
          initCharts();
          applyFilters();
          hideLoadingOverlay();
        },
        error: (err) => {
          console.error("Error loading CSV:", err);
          hideLoadingOverlay();
          alert("Error loading Structures CSV. Please check console.");
        }
      });
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById("loadingOverlay");
      if (overlay) overlay.style.display = "none";
    }

    // ==============================
    // FILTERS
    // ==============================

    function initFilters() {
      populateSelectOptions("filterRoute", getUniqueValues(allAssets, "route"), "All Routes");
      populateSelectOptions("filterZone", getUniqueValues(allAssets, "zone"), "All Zones");
      populateSelectOptions("filterType", getUniqueValues(allAssets, "type"), "All Types");

      ["filterRoute", "filterZone", "filterType", "filterSurveyStatus"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("change", applyFilters);
        }
      });

      const searchInput = document.getElementById("assetSearch");
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          applyFilters();
        });
      }

      const mapToggleBtn = document.getElementById("mapToggleBtn");
      if (mapToggleBtn) {
        mapToggleBtn.addEventListener("click", () => {
          focusFilteredOnMap = !focusFilteredOnMap;
          mapToggleBtn.classList.toggle("map-toggle-btn-active", focusFilteredOnMap);
          mapToggleBtn.textContent = focusFilteredOnMap
            ? "Focus on filtered structures"
            : "Show all structures";
          updateMap();
        });
      }

      const csvBtn = document.getElementById("downloadCsvBtn");
      const excelBtn = document.getElementById("downloadExcelBtn");
      const pdfBtn = document.getElementById("downloadPdfBtn");

      if (csvBtn) csvBtn.addEventListener("click", downloadCurrentViewCsv);
      if (excelBtn) excelBtn.addEventListener("click", downloadCurrentViewExcel);
      if (pdfBtn) pdfBtn.addEventListener("click", downloadCurrentViewPdf);
    }

    function populateSelectOptions(selectId, values, allLabel) {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = allLabel;
      select.appendChild(allOpt);

      values.forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });
    }

    function applyFilters() {
      if (!allAssets.length) return;

      const routeSel = document.getElementById("filterRoute");
      const zoneSel = document.getElementById("filterZone");
      const typeSel = document.getElementById("filterType");
      const statusSel = document.getElementById("filterSurveyStatus");
      const searchInput = document.getElementById("assetSearch");

      const routeVal = routeSel ? routeSel.value : "ALL";
      const zoneVal = zoneSel ? zoneSel.value : "ALL";
      const typeVal = typeSel ? typeSel.value : "ALL";
      const statusVal = statusSel ? statusSel.value : "ALL";
      const searchVal = searchInput ? searchInput.value.trim().toLowerCase() : "";

      filteredAssets = allAssets.filter((asset) => {
        if (routeVal !== "ALL" && asset.route !== routeVal) return false;
        if (zoneVal !== "ALL" && asset.zone !== zoneVal) return false;
        if (typeVal !== "ALL" && asset.type !== typeVal) return false;
        if (statusVal !== "ALL" && asset.surveyStatus !== statusVal) return false;

        if (searchVal) {
          const haystack = [
            asset.structRef,
            asset.assetName,
            asset.route,
            asset.zone,
            asset.type,
            asset.maximoId,
            asset.remarks
          ]
            .join(" ")
            .toLowerCase();
          if (!haystack.includes(searchVal)) return false;
        }

        return true;
      });

      updateAllViews();
    }

    function updateAllViews() {
      updateKpis();
      updateInsights();
      updateFiltersNote();
      updateTable();
      updateMap();
      updateCharts();
    }

    function updateFiltersNote() {
      const el = document.getElementById("filtersNote");
      if (!el) return;

      const total = allAssets.length;
      const current = filteredAssets.length;
      if (!total) {
        el.textContent = "No structures data loaded.";
        return;
      }

      const pct = (current / total) * 100;
      el.textContent = `Showing ${current} of ${total} structures (${formatPercent(pct)} of network) after filters.`;
    }

    function updateInsights() {
      const el = document.getElementById("insightsSummaryText");
      if (!el || !allAssets.length) return;

      const total = allAssets.length;
      const completed = allAssets.filter((a) => a.surveyStatus === "Completed").length;
      const pending = allAssets.filter((a) => a.surveyStatus === "Pending").length;
      const noAccess = allAssets.filter((a) => a.surveyStatus === "No Access").length;

      const completedPct = formatPercent((completed / total) * 100);
      const pendingPct = formatPercent((pending / total) * 100);
      const noAccessPct = formatPercent((noAccess / total) * 100);

      el.textContent =
        `${completed} (${completedPct}) structures completed, ` +
        `${pending} (${pendingPct}) pending, ` +
        `${noAccess} (${noAccessPct}) marked as “No Access”.`;
    }

    // ==============================
    // KPI UPDATES
    // ==============================

    function updateKpis() {
      const total = allAssets.length;
      const completed = allAssets.filter((a) => a.surveyStatus === "Completed").length;
      const pending = allAssets.filter((a) => a.surveyStatus === "Pending").length;
      const noAccess = allAssets.filter((a) => a.surveyStatus === "No Access").length;

      const totalEl = document.getElementById("totalAssetsCount");
      const surveyedEl = document.getElementById("assetsSurveyedCount");
      const pendingEl = document.getElementById("assetsPendingCount");
      const noAccessEl = document.getElementById("noAccessCount");
      const surveyPctText = document.getElementById("surveyCompletionPctText");
      const surveyCaption = document.getElementById("surveyCompletionCaption");
      const pendingPctText = document.getElementById("assetsPendingPctText");
      const noAccessPctText = document.getElementById("noAccessPctText");
      const circleFill = document.getElementById("surveyCompletionCircle");

      if (totalEl) totalEl.textContent = total.toString();
      if (surveyedEl) surveyedEl.textContent = completed.toString();
      if (pendingEl) pendingEl.textContent = pending.toString();
      if (noAccessEl) noAccessEl.textContent = noAccess.toString();

      const surveyPct = total ? (completed / total) * 100 : 0;
      const pendingPct = total ? (pending / total) * 100 : 0;
      const noAccessPct = total ? (noAccess / total) * 100 : 0;

      if (surveyPctText) surveyPctText.textContent = formatPercent(surveyPct);
      if (surveyCaption) surveyCaption.textContent = formatPercent(surveyPct);

      if (pendingPctText) pendingPctText.textContent = `${formatPercent(pendingPct)} of total structures`;
      if (noAccessPctText) noAccessPctText.textContent = `${formatPercent(noAccessPct)} of total structures`;

      if (circleFill) {
        const angle = (surveyPct / 100) * 360;
        circleFill.style.background = `conic-gradient(var(--accent-green) 0deg, var(--accent-green) ${angle}deg, rgba(15, 23, 42, 0.32) ${angle}deg)`;
      }
    }

    // ==============================
    // TABLE
    // ==============================

    function updateTable() {
      const tbody = document.getElementById("assetTableBody");
      const sub = document.getElementById("tableHeaderSub");
      if (!tbody) return;

      tbody.innerHTML = "";

      filteredAssets.forEach((asset) => {
        const tr = document.createElement("tr");

        const tdSr = document.createElement("td");
        tdSr.textContent = asset.srNo.toString();
        tr.appendChild(tdSr);

        const tdRef = document.createElement("td");
        tdRef.textContent = asset.structRef || "-";
        tr.appendChild(tdRef);

        const tdName = document.createElement("td");
        tdName.textContent = asset.assetName || "-";
        tr.appendChild(tdName);

        const tdType = document.createElement("td");
        tdType.textContent = asset.type || "-";
        tr.appendChild(tdType);

        const tdRoute = document.createElement("td");
        tdRoute.textContent = asset.route || "-";
        tr.appendChild(tdRoute);

        const tdZone = document.createElement("td");
        tdZone.textContent = asset.zone || "-";
        tr.appendChild(tdZone);

        const tdStatus = document.createElement("td");
        const badge = createBadge(asset.surveyStatus, asset.surveyStatus);
        tdStatus.appendChild(badge);
        tr.appendChild(tdStatus);

        const tdMaximo = document.createElement("td");
        tdMaximo.textContent = asset.maximoId || "-";
        tr.appendChild(tdMaximo);

        const tdRemarks = document.createElement("td");
        tdRemarks.textContent = asset.remarks || "-";
        tr.appendChild(tdRemarks);

        tr.addEventListener("click", () => {
          focusStructureOnMap(asset);
        });

        tbody.appendChild(tr);
      });

      if (sub) {
        sub.textContent = `${filteredAssets.length} structures in current view.`;
      }
    }

    // ==============================
    // MAP
    // ==============================

    function initMap() {
      map = L.map("map", {
        center: [25.35, 51.45],
        zoom: 10,
        minZoom: 8,
        maxZoom: 18
      });

      L.tileLayer("https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}", {
        maxZoom: 20,
        subdomains: ["mt0", "mt1", "mt2", "mt3"]
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
      updateMap();
    }

    function getStatusColor(status) {
      if (status === "Completed") return "#22c55e";
      if (status === "Pending") return "#ef4444";
      if (status === "No Access") return "#fbbf24";
      return "#6b7280";
    }

    function updateMap() {
      if (!map || !markersLayer) return;

      markersLayer.clearLayers();
      Object.keys(markerByKey).forEach((k) => delete markerByKey[k]);

      const baseList = focusFilteredOnMap ? filteredAssets : allAssets;
      const withLocation = baseList.filter((a) => a.hasLocation);

      if (!withLocation.length) return;

      const bounds = [];
      withLocation.forEach((asset) => {
        const color = getStatusColor(asset.surveyStatus);

        const marker = L.circleMarker([asset.lat, asset.lng], {
          radius: 6,
          color,
          weight: 1.5,
          fillColor: color,
          fillOpacity: 0.85
        });

        marker.bindPopup(
          `<strong>${asset.structRef || asset.assetName || "Structure"}</strong><br/>
           Type: ${asset.type || "-"}<br/>
           Route: ${asset.route || "-"}<br/>
           Zone: ${asset.zone || "-"}<br/>
           Status: ${asset.surveyStatus}`
        );

        marker.on("click", () => {
          marker.openPopup();
        });

        markersLayer.addLayer(marker);
        bounds.push([asset.lat, asset.lng]);

        const key = asset.structRef || String(asset.srNo);
        markerByKey[key] = marker;
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    function focusStructureOnMap(asset) {
      if (!map) return;
      if (!asset.hasLocation) return;

      const key = asset.structRef || String(asset.srNo);
      const marker = markerByKey[key];
      if (marker) {
        map.setView(marker.getLatLng(), 17);
        marker.openPopup();
      } else {
        map.setView([asset.lat, asset.lng], 17);
      }
    }

    // ==============================
    // CHARTS
    // ==============================

    function initCharts() {
      const typeCtx = document.getElementById("typeChart");
      const statusCtx = document.getElementById("statusChart");

      if (typeCtx) {
        typeChart = new Chart(typeCtx, {
          type: "bar",
          data: {
            labels: [],
            datasets: [
              {
                label: "Structures",
                data: [],
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: { font: { size: 10 } }
              },
              y: {
                beginAtZero: true,
                ticks: { font: { size: 10 } }
              }
            },
            plugins: {
              legend: {
                labels: { font: { size: 10 } }
              }
            }
          }
        });
      }

      if (statusCtx) {
        statusChart = new Chart(statusCtx, {
          type: "bar",
          data: {
            labels: [],
            datasets: [
              {
                label: "Completed",
                data: [],
                borderWidth: 1
              },
              {
                label: "Pending",
                data: [],
                borderWidth: 1
              },
              {
                label: "No Access",
                data: [],
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                stacked: true,
                ticks: { font: { size: 10 } }
              },
              y: {
                stacked: true,
                beginAtZero: true,
                ticks: { font: { size: 10 } }
              }
            },
            plugins: {
              legend: {
                labels: { font: { size: 10 } }
              }
            }
          }
        });
      }
    }

    function updateCharts() {
      if (typeChart) {
        const countsByType = {};
        filteredAssets.forEach((a) => {
          const type = a.type || "Unknown";
          countsByType[type] = (countsByType[type] || 0) + 1;
        });

        const labels = Object.keys(countsByType).sort((a, b) => countsByType[b] - countsByType[a]);
        const data = labels.map((l) => countsByType[l]);

        typeChart.data.labels = labels;
        typeChart.data.datasets[0].data = data;
        typeChart.update();
      }

      if (statusChart) {
        const bucket = {};

        filteredAssets.forEach((a) => {
          const type = a.type || "Unknown";
          if (!bucket[type]) {
            bucket[type] = { Completed: 0, Pending: 0, "No Access": 0 };
          }
          if (a.surveyStatus === "Completed") bucket[type].Completed += 1;
          else if (a.surveyStatus === "Pending") bucket[type].Pending += 1;
          else if (a.surveyStatus === "No Access") bucket[type]["No Access"] += 1;
        });

        const labels = Object.keys(bucket);
        const completed = labels.map((l) => bucket[l].Completed);
        const pending = labels.map((l) => bucket[l].Pending);
        const noAccess = labels.map((l) => bucket[l]["No Access"]);

        statusChart.data.labels = labels;
        statusChart.data.datasets[0].data = completed;
        statusChart.data.datasets[1].data = pending;
        statusChart.data.datasets[2].data = noAccess;
        statusChart.update();
      }
    }

    // ==============================
    // EXPORTS
    // ==============================

    function buildExportRows() {
      const header = [
        "Sr.No",
        "Struct Ref",
        "Asset Name",
        "Type",
        "Route (RTE)",
        "Zone",
        "Survey Status",
        "Maximo ID",
        "Remarks",
        "Latitude",
        "Longitude"
      ];

      const rows = filteredAssets.map((a) => [
        a.srNo,
        a.structRef,
        a.assetName,
        a.type,
        a.route,
        a.zone,
        a.surveyStatus,
        a.maximoId,
        a.remarks,
        Number.isFinite(a.lat) ? a.lat : "",
        Number.isFinite(a.lng) ? a.lng : ""
      ]);

      return [header, ...rows];
    }

    function downloadCurrentViewCsv() {
      if (!filteredAssets.length) {
        alert("No data to export.");
        return;
      }

      const rows = buildExportRows();
      const csv = rows
        .map((r) =>
          r
            .map((cell) => {
              if (cell == null) return "";
              const v = String(cell).replace(/"/g, '""');
              return `"${v}"`;
            })
            .join(",")
        )
        .join("\r\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "Qatar_North_Structures_Current_View.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadCurrentViewExcel() {
      if (!filteredAssets.length) {
        alert("No data to export.");
        return;
      }

      const rows = buildExportRows();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Structures_View");
      XLSX.writeFile(wb, "Qatar_North_Structures_Current_View.xlsx");
    }

    function downloadCurrentViewPdf() {
      if (!filteredAssets.length) {
        alert("No data to export.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("l", "mm", "a4");

      doc.setFontSize(10);
      doc.text("QATAR NORTH STRUCTURES SURVEY DASHBOARD", 10, 10);
      doc.setFontSize(8);
      doc.text("Current filtered view – Structures assets", 10, 15);

      const rows = buildExportRows();
      const header = rows.shift();

      doc.autoTable({
        startY: 20,
        head: [header],
        body: rows,
        styles: {
          fontSize: 6
        },
        headStyles: {
          fillColor: [15, 23, 42]
        }
      });

      doc.save("Qatar_North_Structures_Current_View.pdf");
    }

    // ==============================
    // INIT
    // ==============================

    window.addEventListener("DOMContentLoaded", () => {
      initTheme();
      updateCurrentDateTime();
      setInterval(updateCurrentDateTime, 1000);
      loadData();
    });
  </script>
</body>
</html>